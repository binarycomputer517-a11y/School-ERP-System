<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add New Teacher/Staff</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Times+New+Roman&display=swap" rel="stylesheet">
    <style>
        /* --- CLASSIC STYLES (Adjusted for 3 Columns) --- */
        body { 
            font-family: 'Times New Roman', serif; 
            padding: 2em; 
            background-color: #f8f8f8; 
            color: #333;
        }
        .container { 
            max-width: 1100px; /* Increased max-width for 3 columns */
            margin: auto; 
            padding: 40px; 
            background-color: #ffffff; 
            border: 2px solid #333; 
            box-shadow: 4px 4px 0 #AAA; 
            border-radius: 0; 
        }
        h1 { 
            color: #000; 
            font-weight: bold; 
            text-transform: uppercase;
            border-bottom: 4px double #000; 
            padding-bottom: 10px; 
            margin-bottom: 30px; 
            font-size: 2em;
        }
        form { 
            /* MODIFIED: Changed grid to 3 equal columns */
            display: grid; 
            grid-template-columns: 1fr 1fr 1fr; 
            gap: 20px; 
        }
        .form-group { 
            display: flex; 
            flex-direction: column; 
        }
        /* Full width items (headers, button) span all 3 columns */
        .full-width { 
            grid-column: 1 / -1; 
        }
        label { 
            margin-bottom: 5px; 
            font-weight: bold; 
            text-decoration: underline; 
        }
        input, select { 
            width: 100%;
            padding: 10px; 
            border: 1px solid #555; 
            border-radius: 0; 
            box-sizing: border-box; 
        }
        
        /* Button Styles */
        button, .btn-secondary, .btn-info-link { /* Added .btn-info-link */
            padding: 10px 15px; 
            border: 1px solid #000; 
            border-radius: 0; 
            cursor: pointer; 
            font-size: 16px; 
            margin-top: 15px;
            box-shadow: 2px 2px 0 #000; 
            transition: none; 
            text-decoration: none; /* Ensure links look like buttons */
            display: inline-block;
        }
        button { 
            background-color: #005A9C; 
            color: white; 
        }
        .btn-secondary {
            background-color: #777;
            color: white;
            text-decoration: none;
        }
        /* NEW STYLE for Department Button */
        .btn-info-link {
            background-color: #17A2B8; /* Info Blue */
            color: white;
            box-shadow: 2px 2px 0 #000;
        }
        
        button:hover, .btn-secondary:hover, .btn-info-link:hover { 
            opacity: 0.9;
            transform: translate(1px, 1px); 
            box-shadow: 1px 1px 0 #000;
        }
        button:disabled { 
            background-color: #ccc; 
            color: #555;
            box-shadow: 2px 2px 0 #555;
        }
        
        .section-header { 
            grid-column: 1 / -1; 
            color: #000; 
            font-weight: bold;
            text-transform: capitalize;
            margin-top: 10px; 
            border-bottom: 2px solid #555; 
            padding-bottom: 5px; 
        }
        #department_input_container small {
            font-family: Arial, sans-serif; 
        }

        /* Responsive adjustment: Switch to 2 columns on small screens */
        @media (max-width: 900px) {
            form {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Add New Teacher / Staff</h1>
        <div class="nav-links" style="margin-bottom: 20px; display: flex; gap: 10px;">
            <a href="/view-teachers.html" class="btn btn-secondary">‚Üê Back to Teacher List</a>
            
            <a href="/manage-departments.html" class="btn-info-link">üè¢ Manage Departments</a>
            
        </div>
        <form id="add-teacher-form">

            <h3 class="section-header">Personal & Professional Info</h3>

            <div class="form-group">
                <label for="full_name">Full Name *</label>
                <input type="text" id="full_name" name="full_name" required>
            </div>
            
            <div class="form-group">
                <label for="employee_id">Employee ID *</label>
                <input type="text" id="employee_id" name="employee_id" required>
            </div>

            <div class="form-group">
                <label for="designation">Designation</label>
                <input type="text" id="designation" name="designation" value="Teacher">
            </div>
            
            <div class="form-group">
                <label for="department_input_container">Department Name</label>
                <div id="department_input_container">
                    <select id="department_select" name="department_name">
                        <option value="">-- Select Department --</option>
                        <option value="new_department_prompt">-- ADD NEW DEPARTMENT --</option>
                        </select>
                </div>
            </div>
            <div class="form-group">
                <label for="department_id">Department ID (Optional UUID)</label>
                <input type="text" id="department_id" name="department_id" placeholder="UUID of hr_departments table">
            </div>
            
            <div class="form-group">
                <label for="date_of_birth">Date of Birth</label>
                <input type="date" id="date_of_birth" name="date_of_birth">
            </div>
            
            <div class="form-group">
                <label for="hire_date">Hire Date</label>
                <input type="date" id="hire_date" name="hire_date">
            </div>

            <div class="form-group">
                <label for="email">Email *</label>
                <input type="email" id="email" name="email" required>
            </div>

            <div class="form-group">
                <label for="phone_number">Phone Number</label>
                <input type="tel" id="phone_number" name="phone_number">
            </div>
            
            <h3 class="section-header">System Access & Login</h3>

            <div class="form-group">
                <label for="username">Login Username *</label>
                <input type="text" id="username" name="username" required autocomplete="off">
            </div>

            <div class="form-group">
                <label for="password">Initial Password *</label>
                <input type="password" id="password" name="password" required autocomplete="new-password">
            </div>
            
            <div class="form-group full-width">
                <label for="address">Address</label>
                <input type="text" id="address" name="address">
            </div>

            <button type="submit" class="full-width" id="submit-button">Add Teacher</button>
            <p id="error-msg" class="full-width" style="color: red;"></p>
        </form>
    </div>

    <script>
        const token = localStorage.getItem('erp-token');
        const API_DEPARTMENTS_URL = '/api/hr/departments'; // ASSUMED API ENDPOINT for departments
        const DEPT_SELECT_ID = 'department_select';
        const DEPT_CONTAINER_ID = 'department_input_container';

        // --- Initial Auth Check ---
        if (!token || (localStorage.getItem('user-role') !== 'Admin' && localStorage.getItem('user-role') !== 'Super Admin' && localStorage.getItem('user-role') !== 'HR')) {
            window.location.href = '/login';
        }
        
        const headers = {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
        };

        async function handleApi(url, options = {}) {
            options.headers = { ...headers, ...options.headers };
            const response = await fetch(url, options);
            if (response.status === 401 || response.status === 403) {
                localStorage.clear();
                window.location.href = '/login';
                throw new Error('Session expired or unauthorized.');
            }
            return response;
        }
        
        // --- FEATURE: Fetch and Populate Departments ---
        async function fetchAndPopulateDepartments() {
            try {
                const departmentSelect = document.getElementById(DEPT_SELECT_ID);
                const response = await handleApi(API_DEPARTMENTS_URL, { method: 'GET' });

                if (!response.ok) {
                    console.warn('Failed to fetch departments. Switching to text input mode.');
                    switchToTextInput();
                    return;
                }

                const departments = await response.json();

                if (Array.isArray(departments)) {
                    // Remove dynamically inserted options before re-inserting
                    const optionsToRemove = departmentSelect.querySelectorAll('option:not([value=""]):not([value="new_department_prompt"])');
                    optionsToRemove.forEach(opt => opt.remove());

                    departments.sort((a, b) => a.name.localeCompare(b.name));
                    
                    // Re-insert the fetched options before the "Add New" prompt
                    departments.forEach(dept => {
                        const option = document.createElement('option');
                        option.value = dept.name;
                        option.textContent = dept.name;
                        option.setAttribute('data-id', dept.id); 
                        departmentSelect.insertBefore(option, departmentSelect.lastElementChild);
                    });
                }
            } catch (err) {
                console.error('Department loading error:', err);
                switchToTextInput(); // Switch to text input on error
            }
        }

        // --- FEATURE: Swap Dropdown to Text Input ---
        function switchToTextInput() {
            const container = document.getElementById(DEPT_CONTAINER_ID);
            
            // If it's already a text input, do nothing
            if (document.getElementById('department_name_text')) return;

            // Create the new text input
            const newInput = document.createElement('input');
            newInput.type = 'text';
            newInput.id = 'department_name_text';
            newInput.name = 'department_name'; // Use the same name attribute for form submission
            newInput.placeholder = 'Type new department name here...';
            newInput.required = true;
            
            // Remove old dropdown and insert new input
            container.innerHTML = '';
            container.appendChild(newInput);
            
            // Add a note below the input
            const note = document.createElement('small');
            note.textContent = 'This name will be submitted. The backend should create the new department if it does not exist.';
            note.style.color = '#007bff';
            note.style.display = 'block';
            note.style.marginTop = '5px';
            container.appendChild(note);
        }

        // --- Add listener for the "Add New" option ---
        document.addEventListener('change', function(event) {
            if (event.target.id === DEPT_SELECT_ID && event.target.value === 'new_department_prompt') {
                switchToTextInput();
            }
        });

        // --- Form Submission Handler ---
        document.getElementById('add-teacher-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            const errorMsg = document.getElementById('error-msg');
            const submitBtn = document.getElementById('submit-button');
            errorMsg.textContent = '';
            submitBtn.disabled = true;

            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData.entries());

            // Simple validation check for password
            if (data.password.length < 6) {
                errorMsg.textContent = 'Password must be at least 6 characters long.';
                submitBtn.disabled = false;
                return;
            }
            
            // --- Department Data Handling Logic ---
            const deptSelect = document.getElementById(DEPT_SELECT_ID);
            const deptTextInput = document.getElementById('department_name_text');
            
            data.department_id = null; // Reset ID for clarity

            // Case 1: Select dropdown is visible (existing department chosen)
            if (deptSelect && deptSelect.parentNode.id === DEPT_CONTAINER_ID && data.department_name) {
                if (data.department_name === 'new_department_prompt') {
                     // Should be unreachable if the change event worked correctly, but handle defensively
                     data.department_name = null;
                } else {
                     const selectedOption = deptSelect.querySelector(`option[value="${data.department_name}"]`);
                     data.department_id = selectedOption ? selectedOption.dataset.id : null;
                }
            } 
            // Case 2: Text input is visible (new department typed)
            else if (deptTextInput && deptTextInput.parentNode.id === DEPT_CONTAINER_ID) {
                data.department_name = deptTextInput.value || null;
                data.department_id = null; // Ensure ID is null for creation
            } else {
                // Case 3: No department selected/typed
                data.department_name = null;
                data.department_id = null;
            }
            
            // --- General Data cleanup/validation for DB compatibility ---
            data.date_of_birth = data.date_of_birth || null;
            data.hire_date = data.hire_date || new Date().toISOString().substring(0, 10);
            data.address = data.address || null;
            data.designation = data.designation || 'Teacher';
            data.phone_number = data.phone_number || null;
            
            // Final check on required fields that might become null
            data.department_name = data.department_name || null;
            
            data.initial_role = 'Teacher';


            try {
                // API route: POST /api/teachers
                const response = await handleApi('/api/teachers', {
                    method: 'POST',
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok) {
                    alert(`‚úÖ Success! Staff ${result.teacher.full_name} (${result.teacher.employee_id}) created with login ${data.username}.`);
                    event.target.reset(); 
                    // Refresh department list in case a new one was created
                    fetchAndPopulateDepartments(); 
                } else {
                    errorMsg.textContent = result.message || 'Failed to add teacher.';
                }

            } catch (err) {
                errorMsg.textContent = 'A network error occurred while submitting data.';
                console.error('Submission Error:', err);
            } finally {
                submitBtn.disabled = false;
            }
        });

        // --- Call the function on page load ---
        document.addEventListener('DOMContentLoaded', fetchAndPopulateDepartments);
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>