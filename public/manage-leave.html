<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leave Management Portal</title>
    <style>
        /* --- GLOBAL STYLES (CLASSIC DESIGN) --- */
        body { 
            font-family: 'Times New Roman', serif; 
            margin: 0; padding: 2em; 
            background-color: #EFEFEF; 
            color: #111; 
        }
        .container { 
            max-width: 1400px; margin: auto; padding: 40px; 
            background-color: #FFFFFF; 
            border: 2px solid #333; 
            box-shadow: 6px 6px 0 #AAA; 
            border-radius: 0; 
        }
        h1 { 
            color: #000; font-weight: bold; text-transform: uppercase; text-align: center; 
            border-bottom: 5px double #000; padding-bottom: 15px; margin-bottom: 30px; 
            font-size: 2.2em;
        }
        h2 { 
            color: #005A9C; font-weight: bold; text-transform: uppercase; border-bottom: 2px solid #555;
            padding-bottom: 8px; margin-top: 30px; font-size: 1.5em;
        }
        
        label { display: block; margin-top: 10px; font-weight: bold; color: #333; }
        input, select, textarea { 
            padding: 8px; margin-top: 5px; box-sizing: border-box; 
            border: 1px solid #555; border-radius: 0; background-color: #fff;
        }
        button { 
            background-color: #28a745; color: white; padding: 8px 12px; border: 2px solid #000; 
            cursor: pointer; margin-top: 10px; box-shadow: 2px 2px 0 #000; font-weight: bold;
            border-radius: 0; font-size: 0.9em;
        }
        .btn-reject { 
            background-color: #dc3545; 
        }
        .btn-reject:hover { 
            background-color: #c82333; 
        }
        .btn-search {
            background-color: #007bff;
        }
        .btn-search:hover {
            background-color: #0056b3;
        }
        .btn-back {
            background-color: #555; border-color: #333; margin-bottom: 20px;
        }
        .btn-back:hover {
            background-color: #333;
        }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; border: 1px solid #333; }
        th, td { padding: 10px; text-align: left; border: 1px solid #CCC; font-size: 0.9em; }
        th { background-color: #333; color: white; }
        
        /* Status Badges */
        .status-badge { padding: 3px 8px; border-radius: 0; font-weight: bold; font-size: 0.8em; text-transform: uppercase; border: 1px solid #333;}
        .status-badge.Pending { background-color: #ffc107; color: #333; }
        .status-badge.Approved { background-color: #28a745; color: white; border-color: #28a745;}
        .status-badge.Rejected { background-color: #dc3545; color: white; border-color: #dc3545;}

        /* Search Layout */
        #user-search-form { display: flex; gap: 15px; align-items: flex-end; margin-bottom: 20px; }
        #user-search-input { width: 350px !important; }

        /* Approval Table Specifics */
        .approval-actions button { margin: 2px; }
        .approval-actions { display: flex; flex-direction: column; }
        .reason-cell { max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .balance-item-search { border: 1px solid #555; padding: 10px; margin-right: 10px; display: inline-block; }
    </style>
</head>
<body>
    <div class="container">
        <a href="/admin-dashboard.html" class="btn btn-back">← Back to Dashboard</a> 

        <h1>Leave Management Portal</h1>

        <div class="card">
            <h2>Pending Leave Applications for Approval</h2>
            <table id="approvals-table">
                <thead>
                    <tr>
                        <th>User (Role)</th>
                        <th>Type</th>
                        <th>Dates</th>
                        <th>Days</th>
                        <th>Reason</th>
                        <th>Applied On</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="approvals-tbody">
                    <tr><td colspan="7">Loading pending applications...</td></tr>
                </tbody>
            </table>
        </div>
        
        <hr>

        <div class="card">
            <h2>Search User Leave Balance and History</h2>
            <form id="user-search-form">
                <div>
                    <label for="search-user-input">Search User (Name, Username, or ID):</label>
                    
                    <input type="text" id="search-user-input" list="user-list" placeholder="Start typing name, username, or email..." required>
                    
                    <datalist id="user-list"></datalist>
                    
                    <input type="hidden" id="selected-user-id" name="search_user_id">
                </div>
                <button type="submit" class="btn-search">Search</button>
            </form>

            <div id="search-results-display" style="margin-top: 20px;">
                <p>Enter a User ID/Username and click search to view their balance and history.</p>
            </div>
        </div>

    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="js/global-config.js"></script> 
    
    <script>
        // --- Configuration & Initialization ---
        const API_BASE = '/api/leave';
        const API_USERS_LOOKUP = '/api/users/lookup/all'; // New API route for user list
        const token = localStorage.getItem('erp-token');
        const userRole = localStorage.getItem('user-role');
        
        let allUsers = []; // Global array to store fetched user data

        // Ensure Admin/Manager role is logged in
        const allowedRoles = ['Admin', 'Super Admin', 'Coordinator'];
        if (!token || !allowedRoles.includes(userRole)) { 
            alert('Access Denied: Only Admins/Coordinators can access this page.');
            window.location.href = '/login.html'; 
        }

        // --- Helper: API Fetcher with Auth and Error Handling ---
        async function handleApi(url, options = {}) {
            const authHeaders = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` };
            const response = await fetch(url, { ...options, headers: authHeaders });
            
            if (response.status === 401 || response.status === 403) {
                localStorage.clear();
                alert('Session expired or unauthorized access.');
                window.location.href = '/login.html';
                throw new Error('Unauthorized or session expired.');
            }
            if (!response.ok) {
                const errorBody = await response.json().catch(() => ({ message: response.statusText || 'Server error.' }));
                throw new Error(errorBody.message || 'API call failed.');
            }
            return response.json();
        }
        
        
        // =========================================================
        // USER SEARCH/AUTOCOMPLETE LOGIC - NEW
        // =========================================================

        async function loadAllUsersForSearch() {
            try {
                const data = await handleApi(API_USERS_LOOKUP);
                allUsers = data; 
                const datalist = document.getElementById('user-list');
                
                if (!datalist) return;
                datalist.innerHTML = '';

                data.forEach(user => {
                    const option = document.createElement('option');
                    // Format for display/search: Username (Role) - Email
                    option.value = `${user.username} (${user.role}) - ${user.email}`;
                    // Store the actual ID (UUID) in a data attribute
                    option.setAttribute('data-id', user.id); 
                    datalist.appendChild(option);
                });

            } catch (error) {
                console.error('Failed to load user list for search:', error);
                const searchInput = document.getElementById('search-user-input');
                if (searchInput) {
                    searchInput.placeholder = 'Error loading user list.';
                }
            }
        }
        
        // =========================================================
        // PENDING APPROVALS LOGIC
        // =========================================================

        async function fetchPendingApprovals() {
            const tbody = document.getElementById('approvals-tbody');
            tbody.innerHTML = '<tr><td colspan="7">Loading pending applications...</td></tr>';
            try {
                // GET /api/leave/approvals/pending
                const approvals = await handleApi(`${API_BASE}/approvals/pending`);

                tbody.innerHTML = approvals.map(app => `
                    <tr data-application-id="${app.id}">
                        <td>${app.applicant_name} (${app.applicant_role})</td>
                        <td>${app.leave_type}</td>
                        <td>${moment(app.start_date).format('YYYY-MM-DD')} to ${moment(app.end_date).format('YYYY-MM-DD')}</td>
                        <td>${app.total_days}</td>
                        <td class="reason-cell" title="${app.reason}">${app.reason}</td>
                        <td>${moment(app.created_at).format('YYYY-MM-DD')}</td>
                        <td class="approval-actions">
                            <button onclick="processApproval('${app.id}', 'Approved')">Approve</button>
                            <button onclick="rejectApplication('${app.id}')" class="btn-reject">Reject</button>
                        </td>
                    </tr>
                `).join('') || '<tr><td colspan="7">No pending applications found.</td></tr>';

            } catch (error) {
                console.error('Error fetching approvals:', error);
                tbody.innerHTML = '<tr><td colspan="7" style="color:red;">Failed to load approval list.</td></tr>';
            }
        }
        
        // Universal Approval/Rejection Processor (remains the same)
        window.processApproval = async function(applicationId, status, rejectionReason = null) {
            if (!confirm(`Are you sure you want to ${status.toUpperCase()} this application?`)) return;

            try {
                // PUT /api/leave/approval/:applicationId
                await handleApi(`${API_BASE}/approval/${applicationId}`, { 
                    method: 'PUT', 
                    body: JSON.stringify({ status, rejection_reason: rejectionReason }) 
                });
                
                alert(`Application ${status.toLowerCase()} successfully.`);
                fetchPendingApprovals();
            } catch (error) {
                alert(`Failed to process approval: ${error.message}`);
            }
        }

        window.rejectApplication = function(applicationId) {
            const reason = prompt('Please enter the reason for rejection:');
            if (reason) {
                processApproval(applicationId, 'Rejected', reason);
            } else if (reason === null) {
                return;
            } else {
                alert('Rejection reason cannot be empty.');
            }
        }


        // =========================================================
        // USER BALANCE SEARCH EXECUTION LOGIC
        // =========================================================

        document.getElementById('user-search-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const searchInput = document.getElementById('search-user-input');
            const selectedUserId = document.getElementById('selected-user-id');
            const resultsDiv = document.getElementById('search-results-display');

            // Determine the final ID to search (UUID from hidden field if selected, otherwise raw text)
            const userId = selectedUserId.value.trim() || searchInput.value.trim();
            
            if (!userId) {
                resultsDiv.innerHTML = '<p style="color:red;">Please select a user or enter a valid ID/Username.</p>';
                return;
            }

            resultsDiv.innerHTML = `<p>Loading details for user ID: <strong>${userId}</strong>...</p>`;

            try {
                // API Call: GET /api/leave/admin/user-details/:userId
                const details = await handleApi(`${API_BASE}/admin/user-details/${userId}`); 

                const balanceHTML = details.balances.map(b => `
                    <div class="balance-item-search">
                        <strong>${b.current_balance}</strong> days
                        <span>(${b.leave_type_name} / ${b.type_code})</span>
                        <small style="display: block;">Allowance: ${b.allowance} days</small>
                    </div>
                `).join('');

                const historyHTML = details.history.map(h => `
                    <tr>
                        <td>${h.leave_type}</td>
                        <td>${moment(h.start_date).format('YYYY-MM-DD')}</td>
                        <td>${h.total_days}</td>
                        <td><span class="status-badge ${h.status}">${h.status}</span></td>
                        <td>${h.approver || 'N/A'}</td>
                    </tr>
                `).join('') || '<tr><td colspan="5">No application history found for this user.</td></tr>';
                
                resultsDiv.innerHTML = `
                    <h3>Details for ${details.username} (${details.role})</h3>
                    <h4>Current Leave Balances</h4>
                    <div style="margin-bottom: 20px;">${balanceHTML || '<p>No defined balances found for this user\'s role.</p>'}</div>
                    
                    <h4>Application History</h4>
                    <table>
                        <thead>
                            <tr><th>Type</th><th>Start Date</th><th>Days</th><th>Status</th><th>Approver</th></tr>
                        </thead>
                        <tbody>${historyHTML}</tbody>
                    </table>
                `;
                
            } catch (error) {
                console.error('Search Error:', error);
                resultsDiv.innerHTML = `<p style="color:red;">❌ Error loading data for ${userId}: ${error.message}</p>`;
            }
        });
        
        // --- Autocomplete Logic ---
        document.getElementById('search-user-input').addEventListener('input', (e) => {
            const currentValue = e.target.value.trim();
            const selectedUserId = document.getElementById('selected-user-id');
            selectedUserId.value = ''; // Reset hidden ID on every input

            // Find the selected option to get the UUID
            const selectedOption = document.querySelector(`#user-list option[value="${currentValue}"]`);
            
            if (selectedOption) {
                // If a value from the datalist is exactly matched, use its UUID
                selectedUserId.value = selectedOption.getAttribute('data-id'); 
            } else {
                // Otherwise, use the raw text (which might be a custom-typed UUID or Username)
                selectedUserId.value = currentValue;
            }
        });


        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            fetchPendingApprovals();
            loadAllUsersForSearch(); // Load all users for autocomplete
        });
    </script>
</body>
</html>