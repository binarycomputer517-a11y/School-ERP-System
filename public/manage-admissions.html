<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Admission Portal</title>
    <style>
        /* --- CLASSIC DESIGN STYLES --- */
        body { 
            font-family: 'Times New Roman', serif; 
            margin: 0; padding: 2em; 
            background-color: #EFEFEF; 
            color: #333; 
        }
        .container { 
            max-width: 1000px; margin: auto; padding: 40px; 
            background-color: #FFFFFF; 
            border: 2px solid #333; 
            box-shadow: 6px 6px 0 #AAA; 
            border-radius: 0; 
        }
        h1 { 
            color: #000; font-weight: bold; text-transform: uppercase; text-align: center; 
            border-bottom: 5px double #000; padding-bottom: 15px; margin-bottom: 30px; 
            font-size: 2.2em;
        }
        h2 { 
            color: #005A9C; font-weight: bold; text-transform: uppercase; border-bottom: 2px solid #555; 
            padding-bottom: 8px; margin-top: 25px; 
        }
        
        .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 15px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px; }

        label { display: block; margin-top: 10px; font-weight: bold; font-size: 0.9em; color: #333; }
        input, select, textarea { 
            width: 100%; padding: 8px; margin-top: 5px; box-sizing: border-box; 
            border: 1px solid #555; border-radius: 0; background-color: #FFFFFF;
        }
        button { 
            background-color: #C0392B; color: white; padding: 10px 15px; border: 2px solid #000; 
            border-radius: 0; cursor: pointer; margin-top: 15px; box-shadow: 2px 2px 0 #000;
        }
        button:hover { background-color: #A62D21; box-shadow: 1px 1px 0 #000; }
        
        .card { padding: 20px; border: 1px solid #005A9C; border-radius: 0; margin-top: 20px; background-color: #f7faff; }
        .message-box { padding: 15px; border-radius: 0; margin-top: 20px; font-weight: bold; border: 1px solid #333;}
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #cce5ff; color: #004085; }

        /* Admin Table Styles */
        #admin-view { display: none; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; border: 1px solid #333; }
        th, td { padding: 10px; text-align: left; border: 1px solid #CCC; font-size: 0.9em; }
        th { background-color: #333; color: white; text-transform: uppercase; }
        
        .status-badge { padding: 4px 8px; border-radius: 0; font-weight: bold; font-size: 0.75em; text-transform: uppercase; border: 1px solid #000; }
        .status-Submitted { background-color: #ffc107; color: #333; }
        .status-Under_Review { background-color: #005A9C; color: white; }
        .status-Accepted { background-color: #28a745; color: white; }
        .status-Rejected { background-color: #dc3545; color: white; }
        .status-Enrolled { background-color: #6f42c1; color: white; }
        .status-Paid { background-color: #d4edda; color: #155724; }
        .status-Pending { background-color: #ffc107; color: #333; }

        /* Tracking Card Styles */
        #tracking-result { border-left: 5px solid #C0392B; padding-left: 15px; margin-top: 20px; }
        #tracking-result p { margin: 5px 0; font-size: 1.1em; }
        
        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); align-items: center; justify-content: center; }
        .modal-content { background-color: #ffffff; margin: 10% auto; padding: 30px; border: 3px solid #000; width: 80%; max-width: 500px; box-shadow: 8px 8px 0 #000; position: relative; border-radius: 0; }
        .close-btn { color: #aaa; float: right; font-size: 24px; font-weight: bold; cursor: pointer; }

    </style>
</head>
<body>
    <div class="container">
        <h1>School Admission Portal</h1>
        <p>Apply for a new course or track your existing application status below.</p>

        <section id="admin-view">
            <h2>Admission Review Dashboard</h2>
            <p>Welcome, <strong id="admin-role-display">Admin/Coordinator</strong>. Applications requiring action:</p>
            
            <table id="pending-applications-table">
                <thead>
                    <tr>
                        <th>Applicant</th>
                        <th>Course</th>
                        <th>Submitted</th>
                        <th>Fee Status</th>
                        <th>Current Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="applications-tbody">
                    <tr><td colspan="6" style="text-align: center;">Loading pending applications...</td></tr>
                </tbody>
            </table>
        </section>
        
        <hr style="margin: 30px 0;">

        <section class="card">
            <h2>New Application Form</h2>
            <form id="application-form">
                <div class="grid-3">
                    <div>
                        <label for="applicant-name">Applicant Full Name:</label>
                        <input type="text" id="applicant-name" name="applicant_name" required>
                    </div>
                    <div>
                        <label for="applicant-email">Applicant Email:</label>
                        <input type="email" id="applicant-email" name="applicant_email" required>
                    </div>
                    <div>
                        <label for="dob">Date of Birth:</label>
                        <input type="date" id="dob" name="dob" required>
                    </div>
                </div>
                
                <div class="grid-3">
                    <div>
                        <label for="course-id">Desired Course/Grade:</label>
                        <select id="course-id" name="course_id" required>
                            <option value="">-- Select Course (Loading...) --</option>
                            </select>
                    </div>
                    <div>
                        <label for="parent-name">Parent/Guardian Name:</label>
                        <input type="text" id="parent-name" name="parent_name" required>
                    </div>
                    <div>
                        <label for="parent-contact">Parent Contact (Phone/Email):</label>
                        <input type="text" id="parent-contact" name="parent_contact">
                    </div>
                </div>

                <button type="submit">Submit Application (Fee $50.00)</button>
                <div id="application-message" class="message-box" style="display:none;"></div>
            </form>
        </section>

        <section class="card">
            <h2>Track Application Status</h2>
            <form id="tracking-form" class="grid-2">
                <div>
                    <label for="track-id">Application ID:</label>
                    <input type="text" id="track-id" placeholder="Enter Application UUID">
                </div>
                <div>
                    <label for="track-email">Applicant Email:</label>
                    <input type="email" id="track-email" placeholder="Enter Email Used for Application">
                </div>
                <button type="submit" style="grid-column: 1 / 3;">Check Status</button>
            </form>
            <div id="tracking-result" style="display:none;"></div>
            <div id="tracking-message" class="message-box" style="display:none;"></div>
        </section>

    </div>

    <div id="review-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="document.getElementById('review-modal').style.display='none'">&times;</span>
            <h3 id="modal-title">Review Application</h3>
            <form id="review-form">
                <p>Applicant: <strong id="applicant-name-modal"></strong></p>
                <label for="new-status">Set New Status:</label>
                <select id="new-status" required>
                    <option value="Under Review">Under Review</option>
                    <option value="Accepted">Accepted</option>
                    <option value="Rejected">Rejected</option>
                </select>
                <label for="review-reason">Notes/Rejection Reason (if applicable):</label>
                <textarea id="review-reason" rows="3"></textarea>
                <button type="submit">Apply Status</button>
            </form>
        </div>
    </div>


    <script>
        // NOTE: Adjusted API_BASE to reflect mounting in server.js
        const API_BASE = '/api/admission';
        const COURSES_API_BASE = '/api/courses'; // For fetching dynamic course list
        const TOKEN = localStorage.getItem('erp-token');
        const USER_ROLE = localStorage.getItem('user-role');
        
        // DOM elements
        const applicationForm = document.getElementById('application-form');
        const applicationMessage = document.getElementById('application-message');
        const trackingForm = document.getElementById('tracking-form');
        const trackingResult = document.getElementById('tracking-result');
        const trackingMessage = document.getElementById('tracking-message');
        const applicationsTbody = document.getElementById('applications-tbody');
        const adminView = document.getElementById('admin-view');
        const reviewModal = document.getElementById('review-modal');
        const reviewForm = document.getElementById('review-form');
        const modalTitle = document.getElementById('modal-title');
        const applicantNameModal = document.getElementById('applicant-name-modal');
        const newStatusSelect = document.getElementById('new-status');
        const courseSelect = document.getElementById('course-id');
        const submitApplicationButton = document.querySelector('#application-form button[type="submit"]');

        let currentApplicationId = null;

        // --- Helper Functions ---
        async function handleApi(url, options = {}) {
            const authHeaders = { 'Content-Type': 'application/json' };
            if (TOKEN) {
                 authHeaders['Authorization'] = `Bearer ${TOKEN}`;
            }

            const response = await fetch(url, { ...options, headers: authHeaders });
            
            if (response.status === 401 || (response.status === 403 && TOKEN)) {
                localStorage.clear();
                window.location.href = '/login'; // Redirect on real failure
                throw new Error('Unauthorized or session expired. Please log in.');
            }
            if (!response.ok) {
                const errorBody = await response.json().catch(() => ({ message: response.statusText || 'Server error.' }));
                throw new Error(errorBody.message || 'API call failed.');
            }
            return response.json();
        }
        
        function showMessage(element, text, type) {
            element.textContent = text;
            element.className = `message-box ${type}`;
            element.style.display = 'block';
        }
        
        // --- Dynamic Data Loading (Replaces Mock Data) ---
        
        async function loadCoursesForApplication() {
            try {
                // Fetch from the general /api/courses endpoint
                const courses = await handleApi(`${COURSES_API_BASE}`).catch(() => []);
                
                courseSelect.innerHTML = '<option value="">-- Select Course --</option>'; // Reset
                
                if (courses.length === 0) {
                     courseSelect.innerHTML = '<option value="">-- No Courses Found --</option>';
                     return;
                }
                
                // Assuming the course data structure has course_id and course_name
                courses.forEach(course => {
                    const id = course.course_id || course.id; 
                    const name = course.course_name || course.name; 
                    if (id && name) {
                        courseSelect.innerHTML += `<option value="${id}">${name}</option>`;
                    }
                });
                
            } catch (error) {
                console.error('Error fetching courses:', error);
                courseSelect.innerHTML = '<option value="">-- Error Loading Courses --</option>';
            }
        }

        // --- Admission Application (Guest Access) ---

        applicationForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            showMessage(applicationMessage, 'Submitting application...', 'info');

            const formData = {
                applicant_name: form.elements.applicant_name.value,
                applicant_email: form.elements.applicant_email.value,
                course_id: form.elements.course_id.value,
                dob: form.elements.dob.value,
                parent_name: form.elements.parent_name.value,
                parent_contact: form.elements.parent_contact.value,
            };

            try {
                // The /apply route is correctly public (no token needed)
                const result = await handleApi(`${API_BASE}/apply`, { 
                    method: 'POST', 
                    body: JSON.stringify(formData) 
                });
                
                // Use required_fee from server, which is better than static $50.00
                const feeAmount = result.required_fee || 50.00; 

                showMessage(applicationMessage, 
                    `‚úÖ Application submitted! Your ID is: ${result.application_id}. A fee of ‚Çπ${feeAmount.toFixed(2)} is now pending. Fee Invoice ID: ${result.fee_invoice_id}`, 
                    'success');
                form.reset();
                
            } catch (error) {
                showMessage(applicationMessage, `‚ùå Submission Failed: ${error.message}`, 'error');
            } finally {
                submitBtn.disabled = false;
            }
        });
        
        // --- Application Status Tracking (Guest Access) ---
        
        trackingForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            trackingResult.style.display = 'none';
            showMessage(trackingMessage, 'Checking status...', 'info');
            
            const applicationId = document.getElementById('track-id').value.trim();
            const applicantEmail = document.getElementById('track-email').value.trim();
            
            if (!applicationId || !applicantEmail) {
                showMessage(trackingMessage, 'Please enter both Application ID and Email.', 'error');
                return;
            }

            try {
                // This route is public (no token sent by default handleApi), which is correct
                const result = await handleApi(`${API_BASE}/application/${applicationId}`);
                
                if (result.applicant_email !== applicantEmail) {
                    throw new Error('Email does not match the application ID.');
                }
                
                trackingResult.innerHTML = `
                    <p><strong>Applicant:</strong> ${result.applicant_name}</p>
                    <p><strong>Course:</strong> ${result.course_id}</p>
                    <p><strong>Status:</strong> <span class="status-badge status-${result.status.replace(/\s/g, '_')}">${result.status}</span></p>
                    <p><strong>Fee Payment:</strong> <span class="status-badge status-${result.fee_status}">${result.fee_status} (‚Çπ${result.fee_amount.toFixed(2)})</span></p>
                    ${result.review_notes ? `<p><strong>Reviewer Notes:</strong> ${result.review_notes}</p>` : ''}
                    <p>Submitted: ${new Date(result.created_at).toLocaleDateString()}</p>
                `;
                trackingResult.style.display = 'block';
                showMessage(trackingMessage, 'Status retrieved successfully.', 'success');

                if (result.fee_status === 'Pending' && result.fee_id) {
                    // Simulating payment relies on a PUT endpoint
                    trackingResult.innerHTML += `<button onclick="simulateFeePayment('${result.fee_id}')">Simulate Pay Fee Now</button>`;
                } else if (result.fee_status === 'Pending') {
                     trackingResult.innerHTML += `<p class="error">Payment pending, but cannot simulate payment without fee invoice ID.</p>`;
                }
                
            } catch (error) {
                showMessage(trackingMessage, `‚ùå Status check failed: ${error.message}`, 'error');
                trackingResult.style.display = 'none';
            }
        });
        
        window.simulateFeePayment = async function(feeId) {
             if (!confirm('Simulate successful payment for this application fee?')) return;
             
             try {
                // Simulating payment relies on a PUT endpoint
                const result = await handleApi(`${API_BASE}/fee/${feeId}/pay`, { method: 'PUT', body: JSON.stringify({}) });
                alert(result.message);
                trackingForm.dispatchEvent(new Event('submit', { cancelable: true }));
             } catch (error) {
                 alert(`Fee payment failed: ${error.message}`);
             }
        }

        // --- Admin Dashboard (Authenticated Access) ---

        async function fetchPendingApplications() {
            applicationsTbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Loading applications...</td></tr>';
            try {
                // This route requires auth token
                const applications = await handleApi(`${API_BASE}/applications/pending`);
                
                if (applications.length === 0) {
                    applicationsTbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No applications currently pending review.</td></tr>';
                    return;
                }

                applicationsTbody.innerHTML = applications.map(app => {
                    const statusClass = `status-${app.status.replace(/\s/g, '_')}`;
                    const feeStatusClass = `status-${app.fee_status}`;
                    const feePaid = app.fee_status === 'Paid';
                    
                    const reviewEnabled = feePaid && (app.status === 'Submitted' || app.status === 'Under Review');
                    const enrollEnabled = app.status === 'Accepted';

                    return `
                        <tr>
                            <td><strong>${app.applicant_name}</strong> (${app.applicant_email})</td>
                            <td>${app.course_id}</td>
                            <td>${new Date(app.created_at).toLocaleDateString()}</td>
                            <td><span class="status-badge ${feeStatusClass}">${app.fee_status}</span></td>
                            <td><span class="status-badge ${statusClass}">${app.status}</span></td>
                            <td>
                                <button onclick="openReviewModal('${app.id}', '${app.applicant_name}')" ${!reviewEnabled ? 'disabled' : ''} style="padding: 5px; background-color: #005A9C;">Review</button>
                                <button onclick="processEnrollment('${app.id}')" ${!enrollEnabled ? 'disabled' : ''} style="background-color: #28a745; padding: 5px;">Enroll</button>
                            </td>
                        </tr>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error fetching pending applications:', error);
                applicationsTbody.innerHTML = `<tr><td colspan="6" class="error" style="text-align: center;">Failed to load data: ${error.message}</td></tr>`;
            }
        }
        
        window.openReviewModal = function(applicationId, applicantName) {
            currentApplicationId = applicationId;
            modalTitle.textContent = `Review Application: ${applicationId.slice(0, 8)}...`;
            applicantNameModal.textContent = applicantName;
            reviewForm.reset();
            reviewModal.style.display = 'block';
        }
        
        reviewForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newStatus = newStatusSelect.value;
            const reason = document.getElementById('review-reason').value;
            
            if (newStatus === 'Rejected' && !reason.trim()) {
                alert('Rejection status requires a reason/note.');
                return;
            }
            
            if (!confirm(`Confirm setting status to ${newStatus} for ${applicantNameModal.textContent}?`)) return;

            try {
                // This route requires auth token
                const result = await handleApi(`${API_BASE}/review/${currentApplicationId}`, { 
                    method: 'PUT', 
                    body: JSON.stringify({ new_status: newStatus, reason: reason }) 
                });
                
                alert(`Status successfully updated to ${result.new_status}.`);
                reviewModal.style.display = 'none';
                fetchPendingApplications(); // Refresh list

            } catch (error) {
                alert(`Failed to update status: ${error.message}`);
            }
        });

        window.processEnrollment = async function(applicationId) {
            if (!confirm('This will finalize acceptance and create a new Student user account. Confirm Enrollment?')) return;
            
            try {
                // This route requires auth token
                const result = await handleApi(`${API_BASE}/review/${applicationId}`, { 
                    method: 'PUT', 
                    body: JSON.stringify({ new_status: 'Enrolled' }) 
                });
                
                alert(`Enrollment complete! New user account created for ${result.applicant_name || 'the applicant'}.`);
                fetchPendingApplications(); // Refresh list

            } catch (error) {
                alert(`Failed to complete enrollment: ${error.message}`);
            }
        }


        // --- Initialization ---

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('applicant-name-modal').textContent = '';
            document.getElementById('admin-role-display').textContent = USER_ROLE;
            
            // Set the static button text initially using a fallback value from admission.js
            const initialFeeAmount = 50.00; 
            submitApplicationButton.textContent = `Submit Application (Fee $${initialFeeAmount.toFixed(2)})`;
            
            // üí° FIX: Load dynamic courses on initialization
            loadCoursesForApplication();


            // Check if user is Admin or Coordinator to display management panel
            if (USER_ROLE === 'Admin' || USER_ROLE === 'Coordinator' || USER_ROLE === 'Super Admin') {
                adminView.style.display = 'block';
                fetchPendingApplications();
            } else {
                 adminView.style.display = 'none';
            }
        });
    </script>
    <script src="js/global-config.js"></script>
</body>
</html>