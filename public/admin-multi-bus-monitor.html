<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fleet Command | Advanced Hub</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #005A9C; --success: #10b981; --danger: #ef4444;
            --warning: #f59e0b; --dark: #0f172a; --sidebar-bg: #ffffff;
        }
        body { font-family: 'Poppins', sans-serif; margin: 0; background: #f1f5f9; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* Glassmorphism Header */
        .admin-nav { 
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px);
            padding: 10px 25px; display: flex; align-items: center; justify-content: space-between;
            border-bottom: 1px solid #e2e8f0; z-index: 1000; height: 65px;
        }
        .nav-left h2 { font-family: 'Orbitron', sans-serif; font-size: 1.2rem; color: var(--primary); margin: 0; letter-spacing: 1px; }

        .status-badge { display: flex; gap: 10px; }
        .indicator { padding: 5px 12px; border-radius: 8px; font-size: 0.75rem; font-weight: 600; display: flex; align-items: center; gap: 6px; background: #f1f5f9; }
        
        /* Layout */
        .main-layout { display: flex; flex-grow: 1; height: calc(100vh - 65px); position: relative; }
        
        .sidebar { 
            width: 350px; background: var(--sidebar-bg); border-right: 1px solid #e2e8f0; 
            display: flex; flex-direction: column; padding: 15px; z-index: 10;
        }

        /* Advanced Search */
        .search-container { position: relative; margin-bottom: 15px; }
        .search-box { width: 100%; padding: 12px 15px 12px 40px; border-radius: 12px; border: 1.5px solid #e2e8f0; box-sizing: border-box; font-size: 0.9rem; }
        .search-container i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #94a3b8; }

        /* Notification Panel */
        .alert-toast {
            position: absolute; top: 20px; right: 20px; width: 300px; z-index: 2000;
            background: white; border-left: 5px solid var(--danger); padding: 15px;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border-radius: 8px; display: none;
            animation: slideIn 0.5s ease-out;
        }

        #busList { flex-grow: 1; overflow-y: auto; scrollbar-width: thin; }
        .bus-card { 
            background: white; border-radius: 12px; padding: 15px; margin-bottom: 12px;
            border: 1px solid #f1f5f9; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative; overflow: hidden;
        }
        .bus-card:hover { transform: scale(1.02); border-color: var(--primary); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .bus-card::after { content: ''; position: absolute; left: 0; top: 0; height: 100%; width: 4px; background: var(--success); }
        .bus-card.offline::after { background: #94a3b8; }

        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .bus-no { font-weight: 700; font-size: 1rem; color: var(--dark); }
        .speed-tag { font-size: 0.7rem; color: var(--primary); font-weight: bold; background: #e0f2fe; padding: 2px 6px; border-radius: 4px; }

        #map { flex-grow: 1; z-index: 1; }

        /* Custom Marker */
        .bus-marker {
            width: 40px; height: 40px; background: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            border: 3px solid var(--primary); box-shadow: 0 0 15px rgba(0,0,0,0.2);
            transition: all 0.5s ease;
        }
        .bus-marker i { font-size: 1.2rem; color: var(--primary); }
        .bus-marker.moving { border-color: var(--success); animation: pulse 2s infinite; }

        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(16, 185, 129, 0); } 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); } }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
    </style>
</head>
<body>

<div class="alert-toast" id="globalAlert">
    <div style="font-weight: 700; color: var(--danger);"><i class="fas fa-exclamation-circle"></i> SYSTEM ALERT</div>
    <div id="alertMsg" style="font-size: 0.85rem; color: #475569; margin-top: 5px;">Bus WB-02-1234 has deviated from the route.</div>
</div>

<div class="admin-nav">
    <div class="nav-left">
        <h2>FLEET COMMAND <span style="color:var(--success)">OS</span></h2>
    </div>
    
    <div class="status-badge">
        <div class="indicator"><i class="fas fa-satellite" style="color:var(--primary)"></i> GPS: <b>CONNECTED</b></div>
        <div class="indicator"><i class="fas fa-bus" style="color:var(--success)"></i> ONLINE: <b id="active-count">0</b></div>
        <div class="indicator"><i class="fas fa-cloud-sun" style="color:var(--warning)"></i> 28Â°C, Kolkata</div>
    </div>

    <div style="display: flex; gap: 10px;">
        <button onclick="toggleTraffic()" class="indicator" style="cursor:pointer; border:1px solid #cbd5e1;"><i class="fas fa-traffic-light"></i> Traffic</button>
        <button onclick="autoFitAll()" style="background:var(--primary); color:white; border:none; padding:8px 18px; border-radius:10px; cursor:pointer; font-weight:600;">Full Fleet View</button>
    </div>
</div>

<div class="main-layout">
    <div class="sidebar">
        <div class="search-container">
            <i class="fas fa-search"></i>
            <input type="text" class="search-box" id="busSearch" placeholder="Search by Plate, Driver or Route..." onkeyup="filterBuses()">
        </div>

        <div id="busList">
            <div style="text-align:center; margin-top:50px; color:#94a3b8;">
                <i class="fas fa-circle-notch fa-spin fa-2x"></i>
                <p>Initializing Fleet Data...</p>
            </div>
        </div>
    </div>
    <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const token = localStorage.getItem('erp-token');
    let map, markers = {}, trafficLayer;
    let isTrafficVisible = false;

    function initMap() {
        map = L.map('map', { zoomControl: false }).setView([22.57, 88.36], 13);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_labels_under/{z}/{x}/{y}{r}.png').addTo(map);
        
        // Traffic Layer (Hybrid Approach)
        trafficLayer = L.tileLayer('https://{s}.google.com/vt?lyrs=h@159,traffic&x={x}&y={y}&z={z}', {
            maxZoom: 20,
            subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
        });
    }

    function toggleTraffic() {
        if (!isTrafficVisible) { map.addLayer(trafficLayer); } 
        else { map.removeLayer(trafficLayer); }
        isTrafficVisible = !isTrafficVisible;
    }

    async function updateFleet() {
        try {
            const res = await fetch('/api/transport/admin/fleet-status', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const fleet = await res.json();
            
            const listContainer = document.getElementById('busList');
            listContainer.innerHTML = '';
            let totalBoarded = 0;
            let bounds = [];

            fleet.forEach(bus => {
                const pos = [bus.lat, bus.lng];
                bounds.push(pos);
                
                // Speed Logic (Randomly simulated for UI, replace with real bus.speed if available)
                const speed = Math.floor(Math.random() * 60); 
                const statusClass = speed > 0 ? 'moving' : '';

                // Update/Create Marker
                if (!markers[bus.vehicle_id]) {
                    const icon = L.divIcon({
                        className: 'custom-div-icon',
                        html: `<div class="bus-marker ${statusClass}" id="marker-${bus.vehicle_id}"><i class="fas fa-bus"></i></div>`,
                        iconSize: [40, 40]
                    });
                    markers[bus.vehicle_id] = L.marker(pos, { icon }).addTo(map)
                        .bindPopup(`
                            <div style="min-width:150px">
                                <b style="color:var(--primary)">${bus.vehicle_number}</b><br>
                                <hr>
                                ðŸ‘¤ Driver: ${bus.driver_name}<br>
                                âš¡ Speed: ${speed} km/h<br>
                                ðŸ‘¥ Boarded: ${bus.boarded_count}
                            </div>
                        `);
                } else {
                    markers[bus.vehicle_id].setLatLng(pos);
                    const markerEl = document.getElementById(`marker-${bus.vehicle_id}`);
                    if(markerEl) speed > 0 ? markerEl.classList.add('moving') : markerEl.classList.remove('moving');
                }

                // Add to Sidebar
                listContainer.innerHTML += `
                    <div class="bus-card ${speed === 0 ? 'offline' : ''}" onclick="zoomToBus(${bus.lat}, ${bus.lng}, '${bus.vehicle_id}')">
                        <div class="card-header">
                            <span class="bus-no">${bus.vehicle_number}</span>
                            <span class="speed-tag">${speed} KM/H</span>
                        </div>
                        <div style="font-size: 0.8rem; color: #64748b;">
                            <div style="display:flex; justify-content:space-between;">
                                <span><i class="fas fa-user-circle"></i> ${bus.driver_name}</span>
                                <span style="color:var(--success); font-weight:bold;"><i class="fas fa-users"></i> ${bus.boarded_count}</span>
                            </div>
                            <div style="margin-top:8px; font-size:0.7rem; border-top:1px solid #f1f5f9; padding-top:5px;">
                                <i class="fas fa-clock"></i> Last Sync: Just Now
                            </div>
                        </div>
                    </div>`;
            });

            document.getElementById('active-count').innerText = fleet.length;

        } catch (e) { console.error("Update sync failed"); }
    }

    function autoFitAll() {
        const busBounds = Object.values(markers).map(m => m.getLatLng());
        if (busBounds.length > 0) map.fitBounds(busBounds, { padding: [50, 50] });
    }

    function zoomToBus(lat, lng, id) {
        map.flyTo([lat, lng], 17, { duration: 1.5 });
        markers[id].openPopup();
    }

    function filterBuses() {
        const val = document.getElementById('busSearch').value.toLowerCase();
        document.querySelectorAll('.bus-card').forEach(item => {
            item.style.display = item.innerText.toLowerCase().includes(val) ? 'block' : 'none';
        });
    }

    // Simulate an Emergency Alert every 30 seconds for demo
    setInterval(() => {
        const alertBox = document.getElementById('globalAlert');
        alertBox.style.display = 'block';
        setTimeout(() => alertBox.style.display = 'none', 5000);
    }, 30000);

    initMap();
    updateFleet();
    setInterval(updateFleet, 10000);
</script>
</body>
</html>