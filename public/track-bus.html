<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Tracking | ERP Portal</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        /* 1. Map & Sidebar Layout */
        #map { 
            height: 650px; 
            border-radius: 15px; 
            z-index: 1; 
            border: 1px solid var(--glass-border);
        }
        
        .tracking-layout {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
        }

        .vehicle-sidebar {
            background: rgba(255, 255, 255, 0.4);
            border-radius: 15px;
            padding: 15px;
            height: 650px;
            overflow-y: auto;
            border: 1px solid var(--glass-border);
        }

        /* 2. Vehicle Cards */
        .vehicle-item {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-left: 5px solid var(--primary-dark);
            box-shadow: var(--shadow-sm);
        }

        .vehicle-item:hover, .vehicle-item.active {
            transform: translateX(8px);
            background: var(--primary-dark);
            color: white !important;
        }

        .vehicle-item:hover small, .vehicle-item.active small {
            color: rgba(255, 255, 255, 0.8) !important;
        }

        /* 3. Glassmorphism Map Controls */
        .leaflet-bar { border: none !important; box-shadow: var(--shadow-sm) !important; }
        .leaflet-bar a {
            background: rgba(255, 255, 255, 0.8) !important;
            backdrop-filter: blur(5px);
            color: var(--primary-dark) !important;
            border-bottom: 1px solid var(--glass-border) !important;
        }
        .leaflet-bar a:hover { background: var(--primary-dark) !important; color: white !important; }

        .leaflet-popup-content-wrapper {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            font-family: inherit;
        }

        @media (max-width: 992px) {
            .tracking-layout { grid-template-columns: 1fr; }
            .vehicle-sidebar { height: 300px; }
        }
    </style>
</head>
<body class="container-fluid">

    <nav class="glass-nav mb-4">
        <div style="display: flex; align-items: center; gap: 15px;">
            <img src="" class="global-school-logo" height="40" alt="Logo">
            <div>
                <h2 class="global-school-name" style="margin:0; font-size: 1.1rem; color: var(--primary-dark);">ERP System</h2>
                <div class="badge badge-success" style="font-size: 0.6rem; letter-spacing: 1px;">LIVE FLEET MONITOR</div>
            </div>
        </div>
        <div class="nav-links">
            <a href="manage-transport.html" class="btn btn-primary">
                <i class="fas fa-chevron-left"></i> Exit Tracking
            </a>
        </div>
    </nav>

    <div class="container" style="max-width: 1400px;">
        <div class="glass-card" style="padding: 15px;">
            <div class="tracking-layout">
                <div class="vehicle-sidebar">
                    <h3 style="font-size: 1rem; color: var(--primary-dark); margin-bottom: 20px; padding-left: 5px;">
                        <i class="fas fa-satellite-dish" style="margin-right: 8px;"></i> Active Vehicles
                    </h3>
                    <div id="vehicle-list-container">
                        <div class="skeleton" style="height: 85px; margin-bottom: 12px; border-radius:12px;"></div>
                        <div class="skeleton" style="height: 85px; margin-bottom: 12px; border-radius:12px;"></div>
                        <div class="skeleton" style="height: 85px; margin-bottom: 12px; border-radius:12px;"></div>
                    </div>
                </div>

                <div id="map"></div>
            </div>
        </div>
    </div>

    <div id="bg-text-pattern" style="position: fixed; top:0; left:0; width:100%; height:100%; z-index:-1; pointer-events:none;"></div>

    <script src="js/global-config.js"></script>
    <script>
        const map = L.map('map').setView([26.72, 88.43], 13);
        const vehicleMarkers = {};
        let currentRouteLayer = null;

        // Clean Voyager Map Tiles
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        function createBusIcon(isActive = false) {
            const color = isActive ? '#FF9933' : '#005A9C'; // Saffron for active, Blue for idle
            return L.divIcon({
                html: `<div style="filter: drop-shadow(0 3px 5px rgba(0,0,0,0.2))">
                        <svg width="36" height="36" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="color: ${color};">
                            <path d="M18.922 17.552C18.43 18.342 17.518 19 16.5 19H7.5C6.482 19 5.57 18.342 5.078 17.552L3 14V8C3 6.896 3.896 6 5 6H19C20.104 6 21 6.896 21 8V14L18.922 17.552Z" fill="white" stroke="currentColor" stroke-width="2"/>
                            <circle cx="7.5" cy="17.5" r="1.5" fill="currentColor"/>
                            <circle cx="16.5" cy="17.5" r="1.5" fill="currentColor"/>
                        </svg>
                       </div>`,
                className: 'bg-transparent',
                iconSize: [36, 36],
                iconAnchor: [18, 36]
            });
        }

        async function displayRouteOnMap(routeId) {
            if (currentRouteLayer) map.removeLayer(currentRouteLayer);

            try {
                const response = await window.authFetch(`/api/transport/routes/${routeId}/details`);
                const routeDetails = await response.json();
                
                // Route Polyline (Indian Blue)
                const routePolyline = L.polyline(routeDetails.path, { 
                    color: '#005A9C', weight: 5, opacity: 0.5, lineJoin: 'round' 
                });
                
                // Terminals (Saffron Start, Green End)
                const startMarker = L.circleMarker(routeDetails.start, { radius: 6, color: '#FF9933', fillOpacity: 1 });
                const endMarker = L.circleMarker(routeDetails.end, { radius: 6, color: '#138808', fillOpacity: 1 });
                
                currentRouteLayer = L.layerGroup([routePolyline, startMarker, endMarker]).addTo(map);
                map.fitBounds(routePolyline.getBounds(), { padding: [40, 40] });
            } catch (err) { console.error("Route Path Error:", err); }
        }

        async function fetchVehicleLocations() {
            try {
                const response = await window.authFetch('/api/transport/vehicles/locations');
                const vehicles = await response.json();
                const container = document.getElementById('vehicle-list-container');
                container.innerHTML = '';

                vehicles.forEach(v => {
                    const latLng = [parseFloat(v.last_lat), parseFloat(v.last_lng)];
                    
                    // Sync Markers
                    if (vehicleMarkers[v.id]) {
                        vehicleMarkers[v.id].setLatLng(latLng);
                    } else {
                        vehicleMarkers[v.id] = L.marker(latLng, { icon: createBusIcon() }).addTo(map);
                        vehicleMarkers[v.id].bindPopup(`<b>${v.vehicle_number}</b><br>${v.driver_name || 'No Driver'}`);
                    }

                    // Sync Sidebar
                    const div = document.createElement('div');
                    div.className = 'vehicle-item';
                    div.innerHTML = `
                        <div style="display:flex; justify-content:space-between; align-items:start;">
                            <strong>${v.vehicle_number}</strong>
                            <span class="badge badge-success" style="font-size:0.5rem">ONLINE</span>
                        </div>
                        <small style="display:block; margin-top:8px; opacity:0.8;">
                            <i class="fas fa-user-circle"></i> ${v.driver_name || 'Unknown Driver'}
                        </small>
                    `;
                    
                    div.onclick = () => {
                        document.querySelectorAll('.vehicle-item').forEach(el => el.classList.remove('active'));
                        div.classList.add('active');
                        map.setView(latLng, 16);
                        vehicleMarkers[v.id].openPopup();
                        if (v.route_id) displayRouteOnMap(v.route_id);
                    };
                    
                    container.appendChild(div);
                });
            } catch (err) { console.error("Location Sync Error:", err); }
        }

        window.onload = () => {
            fetchVehicleLocations();
            setInterval(fetchVehicleLocations, 10000); 
        };
    </script>
</body>
</html>