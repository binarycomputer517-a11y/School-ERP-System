<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Fleet Tracking | Transport ERP</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #2563eb; --success: #22c55e; --warning: #f59e0b; --danger: #ef4444; }
        body { background: #f8fafc; margin: 0; font-family: 'Inter', sans-serif; overflow: hidden; }
        
        .tracking-grid { display: grid; grid-template-columns: 1fr 380px; height: calc(100vh - 70px); }
        #map { height: 100%; width: 100%; }

        .sidebar { background: white; border-left: 1px solid #e2e8f0; display: flex; flex-direction: column; }
        .sidebar-header { padding: 20px; border-bottom: 1px solid #f1f5f9; }
        .sidebar-content { flex: 1; overflow-y: auto; padding: 15px; }

        /* --- UPDATED BUS MARKER STYLES --- */
        .bus-marker-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .bus-floating-label {
            background: rgba(30, 41, 59, 0.9);
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            white-space: nowrap;
            margin-bottom: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border: 1px solid rgba(255,255,255,0.1);
            pointer-events: none;
        }

        .bus-floating-label span {
            display: block;
            font-size: 9px;
            color: #94a3b8;
            font-weight: 400;
        }

        .bus-icon-wrapper {
            background: white;
            width: 34px;
            height: 34px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--primary);
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);
            position: relative;
        }

        .bus-icon-wrapper i {
            color: var(--primary);
            font-size: 18px;
        }

        /* Movement Pulse for Bus */
        .bus-icon-wrapper::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: var(--primary);
            opacity: 0.2;
            animation: bus-pulse 2s infinite;
        }

        @keyframes bus-pulse {
            0% { transform: scale(1); opacity: 0.4; }
            100% { transform: scale(2); opacity: 0; }
        }

        /* Existing Styles */
        .status-card { background: white; border: 1px solid #e2e8f0; padding: 15px; border-radius: 12px; margin-bottom: 12px; }
        .status-card.arriving { border-left: 4px solid var(--success); background: #f0fdf4; }
        .pulse-home { animation: shadow-pulse 2s infinite; border-radius: 50%; }
        @keyframes shadow-pulse {
            0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); }
            70% { box-shadow: 0 0 0 15px rgba(34, 197, 94, 0); }
            100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }
    </style>
</head>
<body>

    <nav style="height:70px; display:flex; align-items:center; justify-content:space-between; padding:0 20px; background:white; border-bottom:1px solid #e2e8f0;">
        <h2 style="margin:0; font-size: 20px;"><i class="fas fa-route" style="color:var(--primary)"></i> FLEET <span style="color:var(--primary)">LIVE</span></h2>
        <div style="display:flex; gap:20px; align-items:center;">
            <div id="connectionStatus" style="font-size: 13px; color: var(--success); font-weight: 600;">‚óè Live Feed Active</div>
            <span id="lastUpdate" style="font-size: 12px; color: #64748b;"></span>
            <button onclick="location.reload()" style="padding:8px 15px; border-radius:6px; border:1px solid #ddd; cursor:pointer; background:white;"><i class="fas fa-sync"></i></button>
        </div>
    </nav>

    <div class="tracking-grid">
        <div id="map"></div>
        <div class="sidebar">
            <div class="sidebar-header">
                <h3 style="margin:0;"><i class="fas fa-bullhorn" style="color:var(--warning)"></i> Proximity Alerts</h3>
                <p style="margin:5px 0 0; font-size: 12px; color:#64748b;">Scanning students within 500m of buses</p>
            </div>
            <div class="sidebar-content" id="proximityList">
                <p style="text-align:center; padding-top:50px; color:#94a3b8;">Scanning for active trips...</p>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const map = L.map('map', { zoomControl: false }).setView([22.5726, 88.3639], 14);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);

        let busMarkers = {};
        let studentMarkers = {};
        const AUTH_HEADER = { 'Authorization': `Bearer ${localStorage.getItem('erp-token')?.replace(/"/g, '')}` };

        function getDistMeters(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const p1 = lat1 * Math.PI/180, p2 = lat2 * Math.PI/180;
            const dp = (lat2-lat1) * Math.PI/180, dl = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(dp/2)**2 + Math.cos(p1)*Math.cos(p2) * Math.sin(dl/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        async function updateDashboard() {
            try {
                // Fetch Bus Driver details & Live Locations
                const res = await fetch('/api/transport/live-locations', { headers: AUTH_HEADER });
                const buses = await res.json();
                
                const sidebar = document.getElementById('proximityList');
                let alertHtml = "";

                for (const bus of buses) {
                    if (!bus.current_coords) continue;
                    const [bLat, bLng] = bus.current_coords.split(',').map(Number);

                    // --- UPDATED BUS ICON LOGIC ---
                    const busHtml = `
                        <div class="bus-marker-container">
                            <div class="bus-floating-label">
                                ${bus.vehicle_no}
                                <span>Driver: ${bus.driver_name || 'Assigned'}</span>
                            </div>
                            <div class="bus-icon-wrapper">
                                <i class="fas fa-bus"></i>
                            </div>
                        </div>`;

                    if (busMarkers[bus.id]) {
                        busMarkers[bus.id].setLatLng([bLat, bLng]);
                    } else {
                        busMarkers[bus.id] = L.marker([bLat, bLng], {
                            icon: L.divIcon({ 
                                html: busHtml, 
                                className: 'dummy', 
                                iconSize: [100, 80], 
                                iconAnchor: [50, 75] 
                            })
                        }).addTo(map);
                    }

                    // Fetch assignments to calculate proximity
                    const sRes = await fetch(`/api/transport/assignments/${bus.id}`, { headers: AUTH_HEADER });
                    const students = await sRes.json();

                    students.forEach(s => {
                        if (!s.location_coords) return;
                        const [sLat, sLng] = s.location_coords.split(',').map(Number);
                        const dist = getDistMeters(bLat, bLng, sLat, sLng);

                        if (!studentMarkers[s.student_id]) {
                            studentMarkers[s.student_id] = L.marker([sLat, sLng], {
                                icon: L.divIcon({ 
                                    html: `<i class="fas fa-home" style="color:#94a3b8; font-size:16px;"></i>`, 
                                    className: 'dummy' 
                                })
                            }).addTo(map).bindPopup(`<b>Student:</b> ${s.full_name}`);
                        }

                        if (dist < 500) {
                            alertHtml += `
                                <div class="status-card arriving">
                                    <div style="display:flex; justify-content:space-between; font-weight:bold;">
                                        <span>${s.full_name}</span>
                                        <span style="color:var(--success)">${Math.round(dist)}m</span>
                                    </div>
                                    <div style="font-size:11px; margin-top:5px; color:#64748b;">
                                        <i class="fas fa-bus"></i> Bus ${bus.vehicle_no} is arriving
                                    </div>
                                </div>`;
                            studentMarkers[s.student_id].getElement()?.classList.add('pulse-home');
                        } else {
                            studentMarkers[s.student_id].getElement()?.classList.remove('pulse-home');
                        }
                    });
                }
                
                sidebar.innerHTML = alertHtml || `<p style="text-align:center; padding-top:50px; color:#94a3b8;">No proximity alerts...</p>`;
                document.getElementById('lastUpdate').innerText = `Sync: ${new Date().toLocaleTimeString()}`;

            } catch (err) { console.error(err); }
        }

        setInterval(updateDashboard, 5000);
        updateDashboard();
    </script>
</body>
</html>