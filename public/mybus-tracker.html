<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Track My Bus (Live)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        /* Container and Map Styles */
        .container { max-width: 1000px; margin: 40px auto; padding: 20px; border: 2px solid #333; box-shadow: 4px 4px 0 #AAA; background-color: #FFFFFF; }
        #map { height: 500px; border-radius: 4px; margin-top: 15px; border: 1px solid #555; }
        
        /* Detail Box and Error */
        .bus-details { padding: 15px; background-color: #f0f0f0; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 15px; }
        .error-message { color: white; background-color: #dc3545; padding: 15px; border-radius: 4px; text-align: center; font-weight: bold; }
        .last-updated { font-size: 0.8em; color: #6c757d; margin-top: 10px; }
        .nav-links a { color: #005A9C; text-decoration: none; font-weight: bold; }
    </style>
</head>
<body>
<script>
    const token = localStorage.getItem('erp-token');
    if (!token) window.location.href = '/login';
</script>

<div class="container">
    <h1>Track My Bus (Live)</h1>
    <div class="nav-links"><a href="/student-dashboard.html">‚Üê Back to Dashboard</a></div> 
    
    <div id="error-box" style="display: none;"></div>

    <div id="tracking-info">
        <div class="bus-details" id="bus-details-box">
            <p><strong>Route Name:</strong> <span id="route-name">...</span></p>
            <p><strong>Schedule:</strong> <span id="route-schedule">...</span></p>
            <p><strong>Vehicle Number:</strong> <span id="vehicle-number">...</span></p>
            <p><strong>Driver Name:</strong> <span id="driver-name">...</span></p>
            <p><strong>Status:</strong> <span id="status" class="badge bg-warning">Initializing...</span></p>
            <div class="last-updated">Last Updated: <span id="last-updated-time">...</span></div>
        </div>
        <div id="map"></div>
    </div>
</div>

<script>
    const authHeaders = { 'Authorization': `Bearer ${token}` };
    // Default location (e.g., Kolkata or a central school location)
    const DEFAULT_LOCATION = [22.57, 88.36]; 
    
    // Initialize map on the default location (will be updated by bus data)
    const map = L.map('map').setView(DEFAULT_LOCATION, 13); 
    let busMarker = null;
    let initialLoadComplete = false;

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    // Custom icon for the bus (using SVG for better styling)
    function createBusIcon() {
        return L.divIcon({
            html: `
                <svg width="30" height="30" viewBox="0 0 24 24" fill="#005A9C" xmlns="http://www.w3.org/2000/svg" style="filter: drop-shadow(0 0 2px #000);">
                    <path d="M18.922 17.552C18.43 18.342 17.518 19 16.5 19H7.5C6.482 19 5.57 18.342 5.078 17.552L3 14V8C3 6.896 3.896 6 5 6H19C20.104 6 21 6.896 21 8V14L18.922 17.552Z" stroke="#000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="#005A9C"/>
                    <circle cx="7.5" cy="17.5" r="1.5" fill="#FFF" stroke="#000" stroke-width="1"/>
                    <circle cx="16.5" cy="17.5" r="1.5" fill="#FFF" stroke="#000" stroke-width="1"/>
                    <path d="M3 12H21" stroke="#FFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            `,
            className: 'bg-transparent',
            iconSize: [30, 30], 
            iconAnchor: [15, 30] // Bottom center of the icon
        });
    }

    async function loadMyBusDetails() {
        const errorBox = document.getElementById('error-box');
        const trackingInfo = document.getElementById('tracking-info');
        
        try {
            const res = await fetch('/api/transport/my-bus', { headers: authHeaders });

            if (!res.ok) {
                const errorBody = await res.json().catch(() => ({ message: res.statusText || 'No assignment or server error.' }));
                
                trackingInfo.style.display = 'none';
                errorBox.style.display = 'block';
                
                let errorMessage;
                if (res.status === 404) {
                    errorMessage = 'No active bus assignment found for your profile.';
                } else {
                    errorMessage = `Server Error (${res.status}): ${errorBody.details || errorBody.message || 'Could not retrieve data.'}`;
                }
                
                errorBox.innerHTML = `<p class="error-message"><i class="fas fa-exclamation-triangle"></i> ${errorMessage}</p>`;
                return;
            }

            const data = await res.json();
            
            // If successful, ensure error box is hidden and info is visible
            trackingInfo.style.display = 'block';
            errorBox.style.display = 'none';

            // --- Update Text Details ---
            document.getElementById('route-name').textContent = data.route_name || 'N/A';
            document.getElementById('route-schedule').textContent = data.route_schedule || 'N/A';
            document.getElementById('vehicle-number').textContent = data.vehicle_number || 'N/A';
            document.getElementById('driver-name').textContent = data.driver_name || 'N/A';
            
            const statusElement = document.getElementById('status');
            const statusText = data.status || 'Active';
            statusElement.textContent = statusText;
            statusElement.className = `badge ${statusText === 'In Transit' ? 'bg-primary' : statusText === 'Stopped' ? 'bg-warning' : 'bg-success'}`;
            
            document.getElementById('last-updated-time').textContent = new Date().toLocaleTimeString();

            // --- Update Map Location ---
            // Data is expected to be { liveLocation: { lat: X, lng: Y } }
            const lat = parseFloat(data.liveLocation.lat);
            const lng = parseFloat(data.liveLocation.lng);
            const latLng = [lat, lng];

            if (isNaN(lat) || isNaN(lng)) {
                console.warn('Invalid coordinates received from API. Using default map location.');
                if (!initialLoadComplete) map.setView(DEFAULT_LOCATION, 13);
                return; 
            }

            if (!busMarker) {
                // Initial marker creation
                busMarker = L.marker(latLng, { icon: createBusIcon() }).addTo(map);
                busMarker.bindPopup(`<b>${data.vehicle_number}</b><br>Status: ${statusText}`).openPopup();
            } else {
                // Update marker position
                busMarker.setLatLng(latLng);
                busMarker.getPopup().setContent(`<b>${data.vehicle_number}</b><br>Status: ${statusText}<br>Last updated: ${new Date().toLocaleTimeString()}`);
            }
            
            // --- Map Centering Logic ---
            if (!initialLoadComplete) {
                map.setView(latLng, 15); // Zoom in on bus if no route to fit to
                initialLoadComplete = true; 
            } else {
                // On subsequent updates, pan smoothly to the bus location
                map.panTo(latLng);
            }

        } catch (error) {
            console.error('Failed to load bus details:', error);
            if (!errorBox.style.display || errorBox.style.display === 'none') {
                 trackingInfo.style.display = 'none';
                 errorBox.style.display = 'block';
                 errorBox.innerHTML = `<p class="error-message">Connection Error: Could not reach the service.</p>`;
            }
        }
    }

    window.onload = () => {
        loadMyBusDetails(); // Load once immediately
        setInterval(loadMyBusDetails, 15000); // Refresh every 15 seconds
    };
</script>
<script src="js/global-config.js"></script>
</body>
</html>