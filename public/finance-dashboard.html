<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finance Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; padding: 20px; }
        .header-title { border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px; color: #333; }
        
        /* Classic Card Style */
        .card-box {
            background: white;
            border: 1px solid #ccc;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.05);
        }
        .card-box h4 {
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 15px;
            color: #0056b3;
            font-size: 1.1rem;
            font-weight: bold;
        }
        .feature-link {
            display: block;
            padding: 8px 0;
            text-decoration: none;
            color: #333;
            border-bottom: 1px dashed #eee;
        }
        .feature-link:hover { background-color: #f1f1f1; padding-left: 5px; color: #0056b3; }
        
        /* Metrics Box */
        .stat-box {
            background: #fff;
            border: 1px solid #ddd;
            padding: 15px;
            text-align: center;
            margin-bottom: 20px;
        }
        .stat-label { font-size: 0.9rem; color: #666; text-transform: uppercase; }
        .stat-value { font-size: 1.5rem; font-weight: bold; color: #333; margin-top: 5px; }
        
        /* Receipt Form */
        .receipt-form { background: #e9ecef; padding: 10px; margin-top: 15px; border: 1px solid #ced4da; }
    </style>
</head>
<body>

<div class="container">
    <div class="d-flex justify-content-between align-items-center header-title">
        <h2 class="m-0">ðŸ’° Finance Dashboard</h2>
        <div>
            <a href="/admin-dashboard.html" class="btn btn-outline-dark btn-sm">Home</a>
            <a href="/logout" class="btn btn-danger btn-sm">Logout</a>
        </div>
    </div>

    <div class="row mb-3">
        <div class="col-md-3">
            <div class="stat-box">
                <div class="stat-label">Today's Revenue</div>
                <div class="stat-value text-success" id="metric-today-revenue">...</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-box">
                <div class="stat-label">Month Collected</div>
                <div class="stat-value text-primary" id="metric-mtd-collected">...</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-box">
                <div class="stat-label">Outstanding Dues</div>
                <div class="stat-value text-danger" id="metric-outstanding-dues">...</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-box">
                <div class="stat-label">Pending Invoices</div>
                <div class="stat-value" id="metric-unpaid-invoices">...</div>
            </div>
        </div>
    </div>

    <div class="row">
        
        <div class="col-md-4">
            <div class="card-box">
                <h4>1. Fee Collection</h4>
                <a href="/fee-collection.html" class="feature-link">Manual Fee Collection</a>
                <a href="/payment-history-list.html" class="feature-link">Payment History</a>
                <a href="/student-wise-payments.html" class="feature-link">Student Ledger</a>
                <a href="/view-pending-invoice-list.html" class="feature-link">Pending Invoices</a>
                <a href="/process-student-fee-refunds.html" class="feature-link">Process Refunds</a>
                
                <div class="receipt-form">
                    <label class="small fw-bold mb-1">Redownload Receipt:</label>
                    <form id="receipt-download-form" class="d-flex gap-1">
                        <input type="text" id="payment-id-input" class="form-control form-control-sm" placeholder="TXN ID..." required>
                        <button type="submit" class="btn btn-sm btn-dark">Go</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card-box">
                <h4>2. Setup & Config</h4>
                <a href="/manage-fee-structures.html" class="feature-link">Fee Structures</a>
                <a href="/manage-transport-routes.html" class="feature-link">Transport Routes</a>
                <a href="/set-hostel-rates.html" class="feature-link">Hostel Rates</a>
                <a href="/manage-discounts-scholarships.html" class="feature-link">Discounts</a>
                <a href="/configure-late-fee.html" class="feature-link">Late Fee Config</a>
            </div>
            
            <div class="card-box">
                <h4>4. Communications</h4>
                <a href="/dues-reminder-sms.html" class="feature-link">Send SMS Reminders</a>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card-box">
                <h4>3. Reports & Accounts</h4>
                <a href="/student-dues-report.html" class="feature-link">Student Dues Report</a>
                <a href="/revenue-stream-analysis.html" class="feature-link">Revenue Analysis</a>
                <a href="/transaction-daybook.html" class="feature-link">Daily Daybook</a>
                <a href="/budget-monitoring.html" class="feature-link">Annual Budget</a>
                <a href="/gl-export.html" class="feature-link">GL Export</a>
            </div>
            
            <div class="card-box">
                <h4>5. Tools</h4>
                <a href="/bulk-invoice-generation.html" class="feature-link">Bulk Invoice Generator</a>
                <a href="/audit-logs.html" class="feature-link">Audit Logs</a>
            </div>
        </div>

    </div>
</div>

<script>
    const token = localStorage.getItem('erp-token');
    const API_BASE_URL = '/api';
    
    if (!token) window.location.href = '/login.html';

    // 1. Download Receipt Logic
    function downloadReceipt(txnId) {
        fetch(`${API_BASE_URL}/fees/receipt/${txnId.trim()}`, {
             headers: { 'Authorization': `Bearer ${token}` }
        })
        .then(res => res.ok ? res.blob() : Promise.reject('Invalid Receipt ID'))
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            window.open(url, '_blank', 'width=800,height=600');
        })
        .catch(err => alert(err));
    }

    // 2. Load Dashboard Stats
    async function loadStats() {
        const today = new Date().toISOString().split('T')[0];
        const firstDay = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0];

        try {
            // Revenue Today
            const tRes = await fetch(`${API_BASE_URL}/fees/history?startDate=${today}&endDate=${today}`, { headers: { 'Authorization': `Bearer ${token}` }});
            if(tRes.ok) {
                const data = await tRes.json();
                const total = data.reduce((s, i) => s + parseFloat(i.amount), 0);
                document.getElementById('metric-today-revenue').innerText = `â‚¹${total.toLocaleString('en-IN')}`;
            }

            // Month Revenue
            const mRes = await fetch(`${API_BASE_URL}/fees/history?startDate=${firstDay}&endDate=${today}`, { headers: { 'Authorization': `Bearer ${token}` }});
            if(mRes.ok) {
                const data = await mRes.json();
                const total = data.reduce((s, i) => s + parseFloat(i.amount), 0);
                document.getElementById('metric-mtd-collected').innerText = `â‚¹${total.toLocaleString('en-IN')}`;
            }

            // Outstanding Dues
            const sRes = await fetch(`${API_BASE_URL}/fees/reports/dashboard-stats`, { headers: { 'Authorization': `Bearer ${token}` }});
            if(sRes.ok) {
                const stats = await sRes.json();
                document.getElementById('metric-outstanding-dues').innerText = `â‚¹${parseFloat(stats.total_outstanding).toLocaleString('en-IN')}`;
                document.getElementById('metric-unpaid-invoices').innerText = stats.unpaid_count;
            }
        } catch (e) { console.error(e); }
    }

    // Init
    document.addEventListener('DOMContentLoaded', () => {
        loadStats();
        document.getElementById('receipt-download-form').addEventListener('submit', (e) => {
            e.preventDefault();
            downloadReceipt(document.getElementById('payment-id-input').value);
        });
    });
</script>

</body>
</html>