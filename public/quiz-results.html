<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exam Performance | DCA Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
        
        :root {
            --primary: #6366f1;
            --success: #10b981;
            --danger: #ef4444;
            --dark: #0f172a;
        }

        body { background-color: #f8fafc; font-family: 'Plus Jakarta Sans', sans-serif; color: var(--dark); }
        
        /* প্রিমিয়াম হেডার */
        .result-header {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: white; padding: 50px 0; border-radius: 0 0 40px 40px; text-align: center;
        }

        /* স্কোর কার্ড */
        .main-score-card {
            background: white; border-radius: 24px; padding: 30px; margin-top: -60px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1); border: none;
        }

        .stat-circle {
            width: 120px; height: 120px; border-radius: 50%; display: flex;
            flex-direction: column; align-items: center; justify-content: center;
            margin: 0 auto 15px; border: 6px solid #f1f5f9;
        }

        .stat-circle.score { border-color: var(--primary); color: var(--primary); }
        .stat-circle.accuracy { border-color: var(--success); color: var(--success); }

        /* উত্তরপত্র অ্যানালাইসিস কার্ড */
        .analysis-card {
            background: white; border-radius: 16px; padding: 20px; margin-bottom: 15px;
            border: 1px solid #e2e8f0; transition: 0.3s;
        }
        
        .analysis-card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.05); }
        
        .ans-badge {
            font-size: 0.75rem; font-weight: 800; padding: 5px 12px;
            border-radius: 50px; text-transform: uppercase;
        }

        .correct-bg { background-color: #ecfdf5; border-left: 5px solid var(--success); }
        .wrong-bg { background-color: #fef2f2; border-left: 5px solid var(--danger); }
        
        .option-dot {
            height: 12px; width: 12px; border-radius: 50%; display: inline-block; margin-right: 8px;
        }
    </style>
</head>
<body>

<div class="result-header">
    <div class="container">
        <h2 class="fw-800 mb-1">Performance Overview</h2>
        <p class="opacity-75">Subject: Fundamentals of Computer | DCA Course</p>
    </div>
</div>

<div class="container mb-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="main-score-card mb-4">
                <div class="row text-center align-items-center">
                    <div class="col-md-4">
                        <div class="stat-circle score">
                            <h2 class="fw-800 mb-0" id="finalScore">0</h2>
                            <small class="fw-bold">Marks</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-circle accuracy">
                            <h2 class="fw-800 mb-0" id="accuracy">0%</h2>
                            <small class="fw-bold">Accuracy</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <h4 class="fw-800" id="statusText">Processing...</h4>
                        <p class="text-muted small">Final Result Status</p>
                        <a href="/my-quiz.html" class="btn btn-dark rounded-pill px-4 mt-2">Back to Portal</a>
                    </div>
                </div>
            </div>

            <div id="loading" class="text-center py-5">
                <div class="spinner-grow text-primary" role="status"></div>
                <p class="mt-3 text-muted">Analyzing your response...</p>
            </div>

            <div id="detailsArea">
                </div>
        </div>
    </div>
</div>

<script>
    const QUIZ_ID = new URLSearchParams(window.location.search).get('quizId');
    const TOKEN = localStorage.getItem('erp-token');

    async function loadAnalysis() {
        if (!QUIZ_ID) return;

        try {
            // আপনার onlineExam.js এর results রুট কল করা হচ্ছে
            const res = await fetch(`/api/online-exam/results/${QUIZ_ID}`, {
                headers: { 'Authorization': `Bearer ${TOKEN}` }
            });
            const data = await res.json();

            document.getElementById('loading').style.display = 'none';
            document.getElementById('finalScore').innerText = data.score;
            
            // ক্যালকুলেশন
            let correct = data.details.filter(d => d.is_correct).length;
            let total = data.details.length;
            let accuracy = Math.round((correct / total) * 100);
            
            document.getElementById('accuracy').innerText = accuracy + '%';
            const statusText = document.getElementById('statusText');
            statusText.innerText = accuracy >= 40 ? 'EXCELLENT!' : 'KEEP TRYING';
            statusText.style.color = accuracy >= 40 ? '#10b981' : '#ef4444';

            const container = document.getElementById('detailsArea');
            container.innerHTML = '<h5 class="fw-800 mb-4 px-2">Question Analysis</h5>';

            data.details.forEach((item, index) => {
                const isCorrect = item.is_correct;
                const card = document.createElement('div');
                card.className = `analysis-card ${isCorrect ? 'correct-bg' : 'wrong-bg'}`;
                
                card.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <span class="text-muted fw-bold small">QUESTION ${index + 1}</span>
                        <span class="ans-badge ${isCorrect ? 'text-success' : 'text-danger'}">
                            <i class="fas ${isCorrect ? 'fa-check-circle' : 'fa-times-circle'} me-1"></i>
                            ${isCorrect ? 'Correct' : 'Incorrect'}
                        </span>
                    </div>
                    <h6 class="fw-700 mb-4">${item.question_text}</h6>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="p-3 rounded-3 bg-white border">
                                <small class="text-muted d-block mb-1">Your Choice</small>
                                <span class="fw-bold ${isCorrect ? 'text-success' : 'text-danger'} text-uppercase">
                                    <span class="option-dot" style="background-color: ${isCorrect ? '#10b981' : '#ef4444'}"></span>
                                    ${item.student_answer || 'No Answer'}
                                </span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="p-3 rounded-3 bg-white border">
                                <small class="text-muted d-block mb-1">Correct Answer</small>
                                <span class="fw-bold text-success text-uppercase">
                                    <span class="option-dot" style="background-color: #10b981"></span>
                                    ${item.correct_answer}
                                </span>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        } catch (err) {
            console.error(err);
        }
    }

    document.addEventListener('DOMContentLoaded', loadAnalysis);
</script>

</body>
</html>