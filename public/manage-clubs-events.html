<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Events & Clubs Management</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        /* --- CLASSIC DESIGN STYLES --- */
        body { 
            font-family: 'Times New Roman', serif; 
            margin: 0; padding: 2em; 
            background-color: #F8F8F8; 
            color: #333; 
        }
        .container { 
            max-width: 1300px; margin: auto; padding: 30px; 
            background-color: #FFFFFF; 
            border: 2px solid #333; /* Thick border */
            box-shadow: 6px 6px 0 #AAA; /* Block shadow */
            border-radius: 0; /* Sharp corners */
        }
        h1 { 
            color: #C0392B; /* Red/Maroon primary color */
            font-weight: bold; 
            text-transform: uppercase; 
            text-align: center; 
            border-bottom: 5px double #000; /* Heavy separator */
            padding-bottom: 15px; 
            margin-bottom: 30px; 
            font-size: 2.2em;
        }
        h2 { 
            color: #005A9C; /* Blue secondary color */
            font-weight: bold; 
            border-bottom: 2px solid #999; 
            padding-bottom: 5px; 
            margin-top: 25px; 
            margin-bottom: 15px;
        }
        h3 {
            color: #333; 
            font-size: 1.1em; 
            margin-top: 20px;
        }
        
        /* ---------------------------------
           *** 3-COLUMN LAYOUT STRUCTURE ***
           --------------------------------- */
        .grid-3-col {
            display: grid;
            grid-template-columns: 1fr 2fr; /* Form (1) and Table (2) */
            gap: 30px;
        }
        
        /* Event/Club Form area (left column) */
        .form-area {
            grid-column: 1 / 2;
        }
        
        /* Event/Club Table area (right column, spans 2/3 space) */
        .table-area {
            grid-column: 2 / 3;
        }
        
        /* Report tab specifically uses a different layout for input/output */
        #reports-tab .grid-3-col {
            grid-template-columns: 1fr 1fr; 
        }
        
        /* Tab Menu Styling */
        .tab-menu { 
            display: flex; 
            border-bottom: 2px solid #333; 
            margin-bottom: 20px; 
            background-color: #E8E8E8;
            padding-top: 5px;
        }
        .tab-menu button { 
            padding: 8px 15px; 
            border: 1px solid #333; 
            border-bottom: none;
            background: #F0F0F0; 
            cursor: pointer; 
            font-weight: bold; 
            margin-right: -1px; /* Overlap borders */
            border-radius: 0;
            box-shadow: none;
        }
        .tab-menu button.active { 
            background: #005A9C; 
            color: white; 
            border: 2px solid #000;
            border-bottom: 2px solid #fff; /* White space to hide container border */
            margin-bottom: -2px; /* Pull active tab forward */
            position: relative;
            z-index: 1;
        }
        .tab-content { padding: 15px 0; }
        
        /* Form & Input Styles */
        form { margin-bottom: 20px; padding: 15px; border: 1px solid #E0E0E0; background-color: #F8F8F8; }
        input[type="text"], input[type="datetime-local"], input[type="number"], select, textarea { 
            padding: 8px; 
            margin-right: 10px; 
            border: 1px solid #555; 
            border-radius: 0; 
            width: 100%; /* Full width within form container */
            margin-bottom: 10px;
            box-sizing: border-box;
            display: block;
        }
        textarea { width: 100%; }
        
        button[type="submit"], #reports-tab button { 
            background-color: #005A9C; 
            color: white; 
            padding: 10px 15px; 
            border: 2px solid #000; 
            border-radius: 0; 
            cursor: pointer; 
            margin-top: 5px; 
            box-shadow: 2px 2px 0 #000; /* Block shadow for button */
            font-weight: bold;
        }
        button[type="submit"]:hover, #reports-tab button:hover { 
            background-color: #003366; 
            box-shadow: 1px 1px 0 #000; 
        }

        /* Table Styles */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; border: 1px solid #333; }
        th, td { 
            padding: 10px; 
            text-align: left; 
            border: 1px solid #CCC; 
            font-size: 0.9em; 
            border-collapse: collapse;
        }
        th { 
            background-color: #333; 
            color: white; 
            text-transform: uppercase; 
        }

        /* Status & Action Buttons */
        .status-Upcoming { color: #005A9C; font-weight: bold; }
        .status-Active { color: #28a745; font-weight: bold; }
        .status-Completed, .status-Inactive { color: #6c757d; }
        .status-Cancelled { color: #C0392B; font-weight: bold; }

        .action-btn { 
            margin: 2px; 
            padding: 5px 8px; 
            font-size: 0.8em; 
            border: 1px solid #000;
            border-radius: 0;
            box-shadow: 1px 1px 0 #000;
            cursor: pointer; 
            font-weight: bold;
        }
        .action-btn.edit { background-color: #ffc107; color: #333; }
        .action-btn.delete { background-color: #dc3545; color: white; }
        .action-btn.view { background-color: #17a2b8; color: white; }
        .action-btn:hover { box-shadow: 0 0 0 #000; }
        
        .edit-message {
            margin-top: 10px;
            padding: 10px;
            background-color: #ffc107;
            border: 1px solid #ff9800;
            font-weight: bold;
            display: none; /* Initially hidden */
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Events and Clubs Management</h1>
    <p>Role: <strong id="user-role-display">Loading...</strong></p>

    <div class="tab-menu">
        <button id="tab-events-btn" class="active" onclick="switchTab('events')">Manage Events</button>
        <button id="tab-clubs-btn" onclick="switchTab('clubs')">Manage Clubs</button>
        <button id="tab-reports-btn" onclick="switchTab('reports')">Reports</button>
    </div>

    <div id="events-tab" class="tab-content">
        <h2>Event Management</h2>
        <div class="grid-3-col">
            <div class="form-area">
                <h3>Add New Event</h3>
                <form id="event-form">
                    <input type="hidden" id="event-edit-id" name="id">
                    <input type="text" name="event_name" placeholder="Event Name" required>
                    <textarea name="description" placeholder="Description"></textarea>
                    <input type="datetime-local" name="event_date" required>
                    <input type="number" name="budget" placeholder="Budget (Optional)">
                    <select name="status">
                        <option value="Upcoming">Upcoming</option>
                        <option value="Active">Active</option>
                        <option value="Completed">Completed</option>
                        <option value="Cancelled">Cancelled</option>
                    </select>
                    <button type="submit">Add New Event</button>
                    <div id="event-edit-message" class="edit-message"></div>
                </form>
            </div>
            <div class="table-area">
                <h3 style="margin-top: 0;">All Scheduled Events</h3>
                <table id="events-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Date</th>
                            <th>Budget</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="events-list-body">
                        <tr><td colspan="5">Loading events...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="clubs-tab" class="tab-content" style="display:none;">
        <h2>Club Management</h2>
        <div class="grid-3-col">
            <div class="form-area">
                <h3>Create New Club</h3>
                <form id="club-form">
                    <input type="hidden" id="club-edit-id" name="id">
                    <input type="text" name="club_name" placeholder="Club Name" required>
                    <textarea name="mission" placeholder="Mission/Goal"></textarea>
                    <select name="faculty_advisor_id" id="faculty_advisor_id" required>
                        <option value="">-- Select Faculty Advisor --</option>
                    </select>
                    
                    <select name="status">
                        <option value="Active">Active</option>
                        <option value="Inactive">Inactive</option>
                    </select>
                    <button type="submit">Create New Club</button>
                    <div id="club-edit-message" class="edit-message"></div>
                </form>
            </div>
            <div class="table-area">
                <h3 style="margin-top: 0;">All School Clubs</h3>
                <table id="clubs-table">
                    <thead>
                        <tr>
                            <th>Club Name</th>
                            <th>Advisor</th>
                            <th>Status</th>
                            <th>Members</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="clubs-list-body">
                        <tr><td colspan="5">Loading clubs...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div id="reports-tab" class="tab-content" style="display:none;">
        <h2>Activity Reports & Analytics</h2>
        <div class="grid-3-col">
            <div class="form-area" style="border: 1px solid #CCC; padding: 15px;">
                <h3>Report Generation Options</h3>
                <div style="margin-bottom: 20px;">
                    <select id="report-filter-type" style="width: 100%; margin-bottom: 10px;">
                        <option value="all">Filter by Type</option>
                        <option value="event">Event Attendance</option>
                        <option value="club">Club Membership</option>
                    </select>
                    <button onclick="generateReport()" style="width: 100%;">Generate Report</button>
                </div>
            </div>
            <div class="table-area" id="report-output" style="padding: 15px; border: 1px solid #CCC; background-color: #F8F8F8;">
                <p>Select a filter and click "Generate Report" to view analytics.</p>
            </div>
        </div>
    </div>
</div>

<script>
    const API_BASE = '/api/activities'; 
    const TOKEN = localStorage.getItem('erp-token');
    const USER_ROLE = localStorage.getItem('user-role');
    const USER_ID = localStorage.getItem('profile-id') || localStorage.getItem('user-id');
    
    // Global state to manage editing mode
    let isEditingItemId = null; 
    let isEditingType = null;
    
    if (!TOKEN || (USER_ROLE !== 'Admin' && USER_ROLE !== 'Staff')) { 
        alert("Access denied. Admin or Staff privileges required.");
    }

    document.getElementById('user-role-display').textContent = USER_ROLE;

    // --- Utility Functions ---
    async function handleApi(endpoint, options = {}) {
        const authHeaders = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${TOKEN}` };
        const baseUrl = endpoint.includes('/teachers') ? '/api' : API_BASE; 
        const url = `${baseUrl}${endpoint}`;
        
        const response = await fetch(url, { ...options, headers: authHeaders });
        
        if (!response.ok) {
            const errorBody = await response.json().catch(() => response.text());
            
            let errorMessage = "Server error or network failure.";
            if (typeof errorBody === 'object' && errorBody.message) {
                errorMessage = errorBody.message;
            } else if (typeof errorBody === 'string') {
                errorMessage = errorBody;
            }

            throw new Error(errorMessage);
        }
        return response.json().catch(() => ({})); 
    }
    
    function switchTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
        document.querySelectorAll('.tab-menu button').forEach(btn => btn.classList.remove('active'));
        
        document.getElementById(`${tabName}-tab`).style.display = 'block';
        document.getElementById(`tab-${tabName}-btn`).classList.add('active');
        
        if (tabName === 'events') loadEvents();
        if (tabName === 'clubs') {
            loadClubs(); 
            loadFacultyAdvisors();
        }
        // Always reset form state when switching tabs
        resetFormState(document.getElementById('event-form'), 'Event', 'Add New Event');
        resetFormState(document.getElementById('club-form'), 'Club', 'Create New Club');
    }
    
    function resetFormState(formElement, type, defaultText) {
        formElement.reset();
        isEditingItemId = null;
        isEditingType = null;
        const submitBtn = formElement.querySelector('button[type="submit"]');
        submitBtn.textContent = defaultText;
        submitBtn.style.backgroundColor = '#005A9C'; // Reset button color
        document.getElementById(`${type.toLowerCase()}-edit-message`).style.display = 'none';
    }
    
    // --- New Data Loading Function for Advisors ---
    async function loadFacultyAdvisors() {
        const advisorSelect = document.getElementById('faculty_advisor_id');
        if (!advisorSelect) return; 
        advisorSelect.innerHTML = '<option value="">-- Loading Advisors... --</option>';

        try {
            const teachers = await handleApi('/teachers'); 
            
            advisorSelect.innerHTML = '<option value="">-- Select Faculty Advisor --</option>' + 
                teachers
                    .map(t => `<option value="${t.user_id}">${t.full_name}</option>`) 
                    .join('');

        } catch (error) {
            console.error("Failed to load faculty advisors:", error);
            advisorSelect.innerHTML = '<option value="">-- Failed to load Advisors --</option>';
        }
    }


    // --- Data Loading Functions ---

    async function loadEvents() {
        const tbody = document.getElementById('events-list-body');
        tbody.innerHTML = '<tr><td colspan="5">Fetching event data...</td></tr>';
        try {
            const events = await handleApi('/events');
            tbody.innerHTML = events.map(e => `
                <tr>
                    <td>${e.event_name}</td>
                    <td>${new Date(e.event_date).toLocaleString()}</td>
                    <td>${e.budget ? 'â‚¹' + parseFloat(e.budget).toLocaleString() : 'N/A'}</td>
                    <td class="status-${e.status}">${e.status}</td>
                    <td>
                        <button class="action-btn view" onclick="viewDetails('${e.id}', 'event')">View</button>
                        <button class="action-btn edit" onclick="openEditModal('${e.id}', 'event')">Edit</button>
                        <button class="action-btn delete" onclick="deleteItem('${e.id}', 'event')">Del</button>
                    </td>
                </tr>
            `).join('');
        } catch (error) {
            tbody.innerHTML = `<tr><td colspan="5" style="color:red;">Error loading events: ${error.message}</td></tr>`;
        }
    }

    async function loadClubs() {
        const tbody = document.getElementById('clubs-list-body');
        tbody.innerHTML = '<tr><td colspan="5">Fetching club data...</td></tr>';
        try {
            const clubs = await handleApi('/clubs');
            tbody.innerHTML = clubs.map(c => `
                <tr>
                    <td>${c.club_name}</td>
                    <td>${c.advisor_name || 'N/A'}</td>
                    <td class="status-${c.status}">${c.status}</td>
                    <td>${c.member_count || 0}</td>
                    <td>
                        <button class="action-btn view" onclick="viewDetails('${c.id}', 'club')">View Members</button>
                        <button class="action-btn edit" onclick="openEditModal('${c.id}', 'club')">Edit</button>
                        <button class="action-btn delete" onclick="deleteItem('${c.id}', 'club')">Del</button>
                    </td>
                </tr>
            `).join('');
        } catch (error) {
            tbody.innerHTML = `<tr><td colspan="5" style="color:red;">Error loading clubs: ${error.message}</td></tr>`;
        }
    }

    // --- Core Action Functions ---

    /**
     * @func openEditModal
     * Fetches item data and populates the form to switch to EDIT mode.
     */
    async function openEditModal(id, type) {
        const formId = `#${type}-form`;
        const submitBtn = document.querySelector(`${formId} button[type="submit"]`);
        const form = document.querySelector(formId);
        const editMessage = document.getElementById(`${type}-edit-message`);
        
        // 1. Fetch the data for the item
        try {
            const item = await handleApi(`/${type}s/${id}`);

            // 2. Populate the form fields
            form.querySelector('input[name="event_name"], input[name="club_name"]').value = item.event_name || item.club_name;
            form.querySelector('textarea[name="description"], textarea[name="mission"]').value = item.description || item.mission;
            form.querySelector('select[name="status"]').value = item.status;

            if (type === 'event') {
                // Ensure datetime-local format
                const date = new Date(item.event_date);
                const localISOTime = new Date(date.getTime() - (date.getTimezoneOffset() * 60000)).toISOString().substring(0, 16);
                form.querySelector('input[name="event_date"]').value = localISOTime; 
                form.querySelector('input[name="budget"]').value = item.budget || '';
            } else if (type === 'club') {
                // Ensure advisors are loaded before setting value
                await loadFacultyAdvisors(); 
                form.querySelector('select[name="faculty_advisor_id"]').value = item.faculty_advisor_id;
            }

            // 3. Set global flags and update button text/style
            isEditingItemId = id;
            isEditingType = type;
            
            submitBtn.textContent = `UPDATE ${type.toUpperCase()} ID: ${id.substring(0, 8)}`;
            submitBtn.style.backgroundColor = '#cc6600'; // Change color for 'Update'
            
            editMessage.textContent = `EDITING existing ${type}. Submit the form to save changes.`;
            editMessage.style.display = 'block';

            // Scroll to form to make sure user sees the populated form
            form.scrollIntoView({ behavior: 'smooth' });

        } catch (error) {
            alert(`Failed to load ${type} data for editing: ${error.message}`);
        }
    }

    /**
     * @func viewDetails
     * Simple view/alert action for stubs (can be extended to open a modal).
     */
    function viewDetails(id, type) {
        alert(`Viewing details/members for ${type} ID: ${id}. (Requires detailed API fetch)`);
    }

    // --- Form Handlers ---
    
    document.getElementById('event-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(this));
        
        // Determine Method (POST or PUT) and URL
        const method = isEditingItemId && isEditingType === 'event' ? 'PUT' : 'POST';
        const url = isEditingItemId && isEditingType === 'event' ? `/events/${isEditingItemId}` : '/events';

        // FIX: Convert empty budget string ("") to null for the database 
        data.budget = data.budget === "" ? null : data.budget;
        data.location = data.location || null; 

        try {
            await handleApi(url, { method: method, body: JSON.stringify(data) });
            alert(`Event ${method === 'PUT' ? 'updated' : 'added'} successfully!`);
            
            // Reset state and view
            resetFormState(this, 'event', 'Add New Event');
            loadEvents();
        } catch (error) {
            alert(`${method === 'PUT' ? 'Failed to update' : 'Failed to add'} event: ` + error.message);
        }
    });

    document.getElementById('club-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(this));
        
        // Determine Method (POST or PUT) and URL
        const method = isEditingItemId && isEditingType === 'club' ? 'PUT' : 'POST';
        const url = isEditingItemId && isEditingType === 'club' ? `/clubs/${isEditingItemId}` : '/clubs';

        try {
            const response = await fetch(`${API_BASE}${url}`, {
                method: method,
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${TOKEN}` },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                alert(`Club ${method === 'PUT' ? 'updated' : 'created'} successfully!`);
                
                // Reset state and view
                resetFormState(this, 'club', 'Create New Club');
                loadClubs();
            } else {
                // Enhanced error handling for duplicate key violation
                const errorBody = await response.json().catch(() => response.text());
                let errorMessage = errorBody.message || String(errorBody);
                
                if (errorMessage.includes('duplicate key value violates unique constraint') || errorMessage.includes('clubs_club_name_key')) {
                    errorMessage = 'Club name already exists. Please choose a unique name.';
                }
                
                alert(`${method === 'PUT' ? 'Failed to update' : 'Failed to create'} club: ` + errorMessage);
            }
        } catch (error) {
            alert('Failed to process club action: ' + error.message);
        }
    });
    
    // --- Delete Stub ---

    function deleteItem(id, type) {
        if (confirm(`Are you sure you want to delete this ${type}? This action cannot be undone.`)) {
            // In a real advanced app, this would use a DELETE API call
            console.log(`[STUB] Deleting ${type} with ID: ${id}`);
            // handleApi(`/${type}s/${id}`, { method: 'DELETE' }).then(() => { ... });
            
            alert(`${type} deletion initiated. (Requires backend implementation)`);
            if (type === 'event') loadEvents(); else loadClubs();
        }
    }


    // --- Reporting Function (Stub) ---
    
    async function generateReport() {
        const filterType = document.getElementById('report-filter-type').value;
        const outputDiv = document.getElementById('report-output');
        outputDiv.innerHTML = '<p>Generating report...</p>';
        
        try {
            const reportData = await handleApi(`/reports?type=${filterType}`);
            
            if (reportData.length === 0) {
                outputDiv.innerHTML = '<p>No data found for this report type.</p>';
                return;
            }
            
            let html = `<h3>${filterType === 'event' ? 'Event Summary' : 'Club Membership Analysis'}</h3>`;
            html += '<table><thead><tr>';
            
            if (filterType === 'event') {
                html += '<th>Event</th><th>Date</th></tr></thead><tbody>';
                reportData.forEach(r => {
                    html += `<tr><td>${r.name}</td><td>${new Date(r.date).toLocaleDateString()}</td></tr>`;
                });
            } else { // club
                 html += '<th>Club</th><th>Advisor</th><th>Active Members</th></tr></thead><tbody>';
                 reportData.forEach(r => {
                    html += `<tr><td>${r.name}</td><td>${r.advisor}</td><td>${r.member_count}</td></tr>`;
                });
            }
            html += '</tbody></table>';
            
            outputDiv.innerHTML = html;
            
        } catch (error) {
            outputDiv.innerHTML = `<p style="color:red;">Failed to generate report: ${error.message}</p>`;
        }
    }

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        loadEvents(); 
        loadFacultyAdvisors(); 
    });
</script>
<script src="js/global-config.js"></script>
</body>
</html>