<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Official Consolidated Transcript</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&family=Cinzel:wght@700;900&family=Libre+Barcode+39+Text&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        :root {
            --primary-color: #0f172a; 
            --accent-color: #3b82f6; 
            --bg-color: #f8fafc;
            --border-color: #cbd5e1;
            --text-primary: #1e293b;
            --success-color: #15803d;
            --warning-color: #b45309;
            --danger-color: #b91c1c;
        }

        body {
            background: var(--bg-color);
            font-family: 'Inter', sans-serif;
            color: var(--text-primary);
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact; 
        }

        .page {
            width: 210mm;
            min-height: 297mm;
            padding: 15mm;
            margin: 10mm auto;
            background: white;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
            border-top: 8px solid var(--primary-color);
        }

        /* --- ADVANCED SECURITY FEATURES --- */

        /* 1. Dynamic Text Watermark (School Name Repeating) */
        .watermark-text-layer {
            position: absolute;
            inset: -50%;
            z-index: 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-content: center;
            gap: 60px;
            transform: rotate(-30deg);
            opacity: 0.03;
            pointer-events: none;
            overflow: hidden;
        }
        .wm-item {
            font-family: 'Cinzel', serif;
            font-size: 16px;
            font-weight: 900;
            color: #000;
            text-transform: uppercase;
            white-space: nowrap;
        }

        /* 2. Central Background Logo Watermark */
        .watermark-logo-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 500px;
            height: 500px;
            object-fit: contain;
            opacity: 0.04;
            filter: grayscale(100%);
            z-index: 0;
            pointer-events: none;
        }

        /* 3. Guilloche Pattern (Geometric Spirograph) */
        .guilloche-bg {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 650px; height: 650px;
            z-index: 0;
            opacity: 0.05;
            background: repeating-conic-gradient(from 0deg, var(--primary-color) 0deg 1deg, transparent 1deg 10deg),
                        repeating-radial-gradient(circle, var(--primary-color) 0, var(--primary-color) 1px, transparent 2px, transparent 15px);
            border-radius: 50%;
            mask-image: radial-gradient(circle, black 20%, transparent 70%);
            -webkit-mask-image: radial-gradient(circle, black 20%, transparent 70%);
            pointer-events: none;
        }

        /* 4. Microtext Security Border */
        .microtext-border {
            position: absolute;
            inset: 5px;
            border: 1px solid transparent;
            z-index: 1;
            pointer-events: none;
            overflow: hidden;
        }
        .microtext-line {
            position: absolute;
            font-size: 4px;
            color: var(--primary-color);
            text-transform: uppercase;
            white-space: nowrap;
            opacity: 0.6;
            font-family: 'Arial', sans-serif;
            font-weight: 700;
        }
        .mt-top { top: 0; left: 0; width: 100%; text-align: center; }
        .mt-bottom { bottom: 0; left: 0; width: 100%; text-align: center; }
        .mt-left { left: -145mm; top: 50%; width: 297mm; transform: rotate(-90deg); text-align: center; }
        .mt-right { right: -145mm; top: 50%; width: 297mm; transform: rotate(90deg); text-align: center; }

        /* 5. Holographic Security Strip */
        .holo-strip {
            position: absolute;
            top: 0; bottom: 0; right: 12mm;
            width: 5px;
            background: linear-gradient(to bottom, #d4af37, #fff, #b8860b, #fff, #d4af37);
            z-index: 2;
            opacity: 0.5;
            box-shadow: 1px 0 3px rgba(0,0,0,0.1);
        }

        /* --- CONTENT STYLING --- */
        
        .content { position: relative; z-index: 3; }

        /* Header */
        .header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 20px;
            margin-bottom: 30px;
        }
        .school-branding { display: flex; align-items: center; gap: 15px; }
        .school-logo { width: 85px; height: 85px; object-fit: contain; }
        .school-info h1 {
            font-size: 26px;
            font-weight: 800;
            color: var(--primary-color);
            text-transform: uppercase;
            margin: 0;
            line-height: 1.1;
        }
        .doc-title { text-align: right; }
        .doc-name {
            font-size: 20px;
            font-weight: 900;
            text-transform: uppercase;
            color: var(--primary-color);
            display: block;
        }
        .doc-badge {
            background: var(--primary-color);
            color: white;
            font-size: 11px;
            padding: 4px 12px;
            border-radius: 4px;
            font-weight: 600;
            display: inline-block;
            margin-top: 5px;
        }

        /* Student Box (Anti-Copy Pattern) */
        .student-box {
            display: flex;
            gap: 25px;
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            /* Anti-copy texture */
            background-image: repeating-linear-gradient(45deg, #f1f5f9 0, #f1f5f9 5px, #fff 5px, #fff 7px);
        }
        .student-photo-frame {
            width: 100px; height: 120px;
            background: white;
            border: 1px solid #cbd5e1;
            padding: 3px;
            border-radius: 6px;
        }
        .student-photo { width: 100%; height: 100%; object-fit: cover; border-radius: 3px; }
        
        .info-grid {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }
        .info-item label {
            display: block;
            font-size: 10px;
            text-transform: uppercase;
            color: #64748b;
            font-weight: 700;
            margin-bottom: 2px;
        }
        .info-item span {
            font-size: 14px;
            font-weight: 600;
            color: var(--primary-color);
        }
        .barcode {
            font-family: 'Libre Barcode 39 Text', cursive;
            font-size: 28px;
            color: #333;
            line-height: 1;
        }

        /* Table Design */
        .table-custom {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
            font-size: 13px;
            border: 1px solid #e2e8f0;
        }
        .table-custom th {
            background-color: #f1f5f9;
            color: #0f172a;
            font-weight: 800;
            text-transform: uppercase;
            font-size: 11px;
            padding: 12px 10px;
            border-bottom: 2px solid #cbd5e1;
            border-right: 1px solid #e2e8f0;
            text-align: center;
        }
        .table-custom th:nth-child(2) { text-align: left; } 

        .table-custom td {
            padding: 12px 10px;
            border-bottom: 1px solid #e2e8f0;
            border-right: 1px solid #e2e8f0;
            vertical-align: middle;
            color: #334155;
            text-align: center;
        }
        .table-custom td:nth-child(2) { text-align: left; font-weight: 600; color: var(--primary-color); } 
        
        .table-custom tr:last-child td { border-bottom: 2px solid #cbd5e1; }
        .table-custom tr:nth-child(even) { background-color: #f8fafc; }

        .grade-badge {
            padding: 4px 10px;
            border-radius: 4px;
            font-weight: 700;
            font-size: 11px;
            display: inline-block;
            min-width: 30px;
        }
        .grade-pass { background: #dcfce7; color: var(--success-color); }
        .grade-avg  { background: #fef9c3; color: var(--warning-color); }
        .grade-fail { background: #fee2e2; color: var(--danger-color); }

        /* Summary Footer */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        .summary-box {
            border: 1px solid #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .summary-label { font-size: 10px; font-weight: 700; text-transform: uppercase; color: #64748b; margin-bottom: 5px; }
        .summary-val { font-size: 18px; font-weight: 800; color: var(--primary-color); }

        /* Footer */
        .footer {
            margin-top: 50px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }
        .sign-area { text-align: center; }
        .sign-line {
            width: 180px;
            border-bottom: 2px solid #334155;
            margin-bottom: 8px;
        }
        .sign-title { font-size: 12px; font-weight: 700; text-transform: uppercase; }

        @media print {
            body { background: white; margin: 0; }
            .no-print { display: none !important; }
            .page { margin: 0; box-shadow: none; border: none; width: 100%; height: auto; padding: 0; }
            .table-custom th { background-color: #f1f5f9 !important; }
            .table-custom tr:nth-child(even) { background-color: #f8fafc !important; }
            @page { margin: 10mm; size: A4; }
        }
    </style>
</head>
<body>

    <div class="text-center my-4 no-print" style="position:sticky; top:20px; z-index:100;">
        <div class="bg-white p-3 rounded shadow d-inline-block border">
            <button onclick="window.print()" class="btn btn-dark fw-bold px-4">
                <i class="fas fa-print me-2"></i> Print Transcript
            </button>
            <a href="/student-dashboard.html" class="btn btn-outline-secondary fw-bold px-4 ms-2">Back</a>
        </div>
    </div>

    <div class="page">
        <div class="watermark-text-layer" id="text-watermark"></div>

        <img src="" class="watermark-logo-center" id="bg-watermark-logo" alt="Security Watermark">

        <div class="guilloche-bg"></div>

        <div class="microtext-border">
            <div class="microtext-line mt-top" id="mt-top"></div>
            <div class="microtext-line mt-bottom" id="mt-bottom"></div>
            <div class="microtext-line mt-left" id="mt-left"></div>
            <div class="microtext-line mt-right" id="mt-right"></div>
        </div>

        <div class="holo-strip"></div>

        <div class="content">
            <div class="header">
                <div class="school-branding">
                    <img src="" class="school-logo global-school-logo">
                    <div class="school-info">
                        <h1 class="global-school-name">Loading School...</h1>
                        <p class="global-school-address text-muted small m-0">...</p>
                    </div>
                </div>
                <div class="doc-title">
                    <span class="doc-name">Consolidated<br>Transcript</span>
                    <span class="doc-badge" id="acad-year">...</span>
                </div>
            </div>

            <div class="student-box">
                <div class="student-photo-frame">
                    <img src="" id="s-photo" class="student-photo" alt="Student">
                </div>
                <div class="info-grid">
                    <div class="info-item">
                        <label>Student Name</label>
                        <span id="s-name">Loading...</span>
                    </div>
                    <div class="info-item">
                        <label>Roll Number</label>
                        <span id="s-roll">...</span>
                    </div>
                    <div class="info-item">
                        <label>Date of Issue</label>
                        <span id="issue-date">...</span>
                    </div>
                    <div class="info-item">
                        <label>Course / Program</label>
                        <span id="s-course">...</span>
                    </div>
                    <div class="info-item">
                        <label>Batch</label>
                        <span id="s-batch">...</span>
                    </div>
                    <div class="info-item">
                        <label>Verification ID</label>
                        <span class="barcode" id="s-barcode">*12345*</span>
                    </div>
                </div>
            </div>

            <table class="table-custom">
                <thead>
                    <tr>
                        <th width="15%">Code</th>
                        <th width="40%">Subject</th>
                        <th width="10%">Max Marks</th>
                        <th width="10%">Mark Obt</th>
                        <th width="15%">Percentage</th>
                        <th width="10%">Grade</th>
                    </tr>
                </thead>
                <tbody id="result-body">
                    <tr><td colspan="6" class="text-center py-5">Loading results...</td></tr>
                </tbody>
            </table>

            <div class="summary-grid">
                <div class="summary-box">
                    <div class="summary-label">Grand Total</div>
                    <div class="summary-val"><span id="grand-obt">0</span> <span style="font-size:12px; font-weight:400; color:#94a3b8;">/ <span id="grand-max">0</span></span></div>
                </div>
                <div class="summary-box">
                    <div class="summary-label">Overall Percentage</div>
                    <div class="summary-val" id="overall-percent">0%</div>
                </div>
                <div class="summary-box">
                    <div class="summary-label">Final Grade</div>
                    <div class="summary-val" id="final-grade">-</div>
                </div>
                <div class="summary-box">
                    <div class="summary-label">Result Status</div>
                    <div class="summary-val" id="final-status">-</div>
                </div>
            </div>

            <div class="footer">
                <div style="display:flex; gap:15px; align-items:center;">
                    <div id="qrcode"></div>
                    <div style="font-size:10px; color:#64748b; line-height:1.4;">
                        <b>Secure Document</b><br>
                        Generated with High-Security Encryption.<br>
                        Scan QR code to verify online.
                    </div>
                </div>

                <div class="sign-area">
                    <div class="sign-line"></div>
                    <div class="sign-title">Controller of Examinations</div>
                </div>
            </div>
        </div>
    </div>

    <script src="/js/global-config.js"></script>
    <script>
        const TOKEN = localStorage.getItem('erp-token');

        function getColor(p) {
            if(p >= 80) return '#15803d'; 
            if(p >= 60) return '#ca8a04'; 
            if(p >= 40) return '#b45309'; 
            return '#b91c1c'; 
        }

        function getGradeInfo(p) {
            if(p >= 90) return { g:'O', class:'grade-pass' };
            if(p >= 80) return { g:'A+', class:'grade-pass' };
            if(p >= 70) return { g:'A', class:'grade-pass' };
            if(p >= 60) return { g:'B+', class:'grade-avg' };
            if(p >= 50) return { g:'B', class:'grade-avg' };
            if(p >= 40) return { g:'C', class:'grade-avg' };
            return { g:'F', class:'grade-fail' };
        }

        // --- Generate Repeated School Name Background ---
        function generateWatermark(text) {
            const container = document.getElementById('text-watermark');
            container.innerHTML = '';
            const repeatCount = 80; 
            for(let i=0; i<repeatCount; i++) {
                const div = document.createElement('div');
                div.className = 'wm-item';
                div.innerText = text;
                container.appendChild(div);
            }
        }

        function generateMicrotext(text) {
            const fullText = (text + " • ").repeat(80);
            document.getElementById('mt-top').innerText = fullText;
            document.getElementById('mt-bottom').innerText = fullText;
            document.getElementById('mt-left').innerText = fullText;
            document.getElementById('mt-right').innerText = fullText;
        }

        async function loadTranscript() {
            if(!TOKEN) return window.location.href = '/login.html';

            try {
                const res = await fetch('/api/online-exam/student/consolidated-report', {
                    headers: { 'Authorization': `Bearer ${TOKEN}` }
                });
                const data = await res.json();
                
                if(!res.ok) throw new Error(data.message);

                const s = data.student;
                const results = data.results || [];

                // Fill Student Info
                document.getElementById('s-name').innerText = s.first_name + ' ' + s.last_name;
                document.getElementById('s-roll').innerText = s.roll_number;
                document.getElementById('s-course').innerText = s.course_name || '-';
                document.getElementById('s-batch').innerText = s.batch_name || '-';
                document.getElementById('issue-date').innerText = new Date().toLocaleDateString('en-GB');
                document.getElementById('s-photo').src = s.profile_image_path || `https://ui-avatars.com/api/?name=${encodeURIComponent(s.first_name)}&background=random`;
                document.getElementById('s-barcode').innerText = `*${s.roll_number}*`;
                
                document.getElementById('acad-year').innerText = `${new Date().getFullYear()-1}-${new Date().getFullYear()}`;

                // Build Table
                const tbody = document.getElementById('result-body');
                tbody.innerHTML = '';

                if(results.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="6" class="text-center py-5 text-muted">No records found.</td></tr>`;
                    return;
                }

                let totalObt = 0, totalMax = 0;

                results.forEach((r, idx) => {
                    const obt = Number(r.total_score) || 0;
                    const max = Number(r.max_marks) || 0;
                    totalObt += obt;
                    totalMax += max;
                    
                    const percent = max > 0 ? ((obt / max) * 100).toFixed(2) : 0;
                    const gradeInfo = getGradeInfo(percent);

                    const row = `
                        <tr>
                            <td style="font-family:monospace; color:#64748b;">${r.subject_code || '---'}</td>
                            <td>${r.subject_name || 'Subject Name'}</td>
                            <td>${max}</td>
                            <td style="font-weight:700;">${obt}</td>
                            <td>${percent}%</td>
                            <td><span class="grade-badge ${gradeInfo.class}">${gradeInfo.g}</span></td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });

                // Summary
                const overallP = totalMax > 0 ? ((totalObt / totalMax) * 100).toFixed(2) : 0;
                document.getElementById('grand-obt').innerText = totalObt;
                document.getElementById('grand-max').innerText = totalMax;
                document.getElementById('overall-percent').innerText = overallP + '%';
                
                const finalGradeInfo = getGradeInfo(overallP);
                document.getElementById('final-grade').innerText = finalGradeInfo.g;
                document.getElementById('final-grade').style.color = getColor(overallP);

                const passed = overallP >= 40;
                const statusEl = document.getElementById('final-status');
                statusEl.innerText = passed ? "PASSED" : "FAILED";
                statusEl.className = passed ? "summary-val text-success" : "summary-val text-danger";

                // QR Code
                document.getElementById("qrcode").innerHTML = "";
                new QRCode(document.getElementById("qrcode"), {
                    text: `TRANSCRIPT:${s.roll_number}|${overallP}%|${passed?'PASS':'FAIL'}`,
                    width: 60, height: 60,
                    colorDark : "#0f172a", colorLight : "#ffffff",
                    correctLevel : QRCode.CorrectLevel.M
                });

                // --- SECURITY & WATERMARK LOGIC ---
                const checkSchoolData = setInterval(() => {
                    const nameEl = document.querySelector('.global-school-name');
                    const logoEl = document.querySelector('.global-school-logo');
                    
                    if(nameEl && nameEl.innerText && nameEl.innerText !== 'Loading...') {
                        const name = nameEl.innerText;
                        
                        // 1. Generate School Name Text Watermark
                        generateWatermark(name);
                        
                        // 2. Set Background Logo from Header Logo
                        if(logoEl && logoEl.src) {
                            document.getElementById('bg-watermark-logo').src = logoEl.src;
                        }
                        
                        // 3. Generate Microtext
                        generateMicrotext("OFFICIAL ACADEMIC TRANSCRIPT • " + name.toUpperCase());
                        
                        clearInterval(checkSchoolData);
                    }
                }, 500);

                setTimeout(() => {
                    if(!document.getElementById('text-watermark').hasChildNodes()) {
                        generateWatermark('OFFICIAL TRANSCRIPT');
                        generateMicrotext("OFFICIAL ACADEMIC TRANSCRIPT");
                        clearInterval(checkSchoolData);
                    }
                }, 5000);

            } catch (e) {
                console.error(e);
            }
        }

        document.addEventListener('DOMContentLoaded', loadTranscript);
    </script>
</body>
</html>