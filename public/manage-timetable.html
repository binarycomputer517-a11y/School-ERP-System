<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timetable Management</title>
    <style>
        /* Classic Styles */
        body { font-family: 'Times New Roman', serif; margin: 0; padding: 2em; background-color: #EFEFEF; }
        .container { max-width: 1400px; margin: auto; padding: 30px; background-color: #FFFFFF; border: 2px solid #333; box-shadow: 6px 6px 0 #AAA; border-radius: 0; }
        h1 { color: #000; font-weight: bold; text-transform: uppercase; text-align: center; border-bottom: 5px double #000; padding-bottom: 15px; margin-bottom: 30px; font-size: 2.2em; }
        h2 { color: #005A9C; font-weight: bold; text-transform: uppercase; border-bottom: 2px solid #555; padding-bottom: 8px; margin-top: 30px; font-size: 1.5em; }
        .card { padding: 20px; border: 1px solid #333; border-radius: 0; margin-bottom: 20px; background-color: #f8f8f8; }
        
        /* Layout and Form */
        .grid-layout { display: grid; grid-template-columns: 1fr 3fr; gap: 30px; }
        label { display: block; margin-top: 10px; font-weight: bold; color: #333; }
        input, select, textarea { width: 100%; padding: 8px; margin-top: 5px; box-sizing: border-box; border: 1px solid #555; border-radius: 0; }
        button { 
            background-color: #C0392B; color: white; padding: 8px 15px; border: 2px solid #000; border-radius: 0; 
            cursor: pointer; margin-top: 15px; box-shadow: 2px 2px 0 #000; font-weight: bold;
        }
        button:hover { background-color: #A62D21; box-shadow: 1px 1px 0 #000; transform: translate(1px, 1px); }
        
        /* Timetable Grid */
        .schedule-display-container {
            overflow-x: auto;
        }
        .schedule-grid { 
            display: grid; 
            grid-template-columns: 80px repeat(6, 1fr); /* Time Column + 6 Days */
            border-top: 2px solid #333;
            border-left: 2px solid #333;
            min-width: 1000px; 
        }
        .day-header, .time-label { background-color: #333; color: white; padding: 10px; font-weight: bold; text-align: center; border-right: 2px solid #333; border-bottom: 2px solid #333; }
        .day-cell { border-right: 1px solid #CCC; border-bottom: 1px solid #CCC; padding: 10px; min-height: 80px; text-align: left; background-color: #fff; }
        .day-cell.filled { background-color: #f0f0ff; border-left: 4px solid #005A9C; }
        .time-label { background-color: #005A9C; border-left: none; }
        .slot-info { font-size: 1em; font-weight: bold; }
        .slot-teacher { font-size: 0.8em; color: #555; margin-top: 2px; }
        .slot-actions { margin-top: 5px; }
        .slot-actions button { background-color: #777; padding: 2px 5px; margin: 0; font-size: 0.7em; }
        .slot-actions button:hover { background-color: #555; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Timetable Management</h1>

        <div class="card">
            <h2>Select View</h2>
            <div style="display: flex; gap: 20px;">
                <div>
                    <label for="view-course-select">Course:</label>
                    <select id="view-course-select" required>
                        <option value="">Loading...</option>
                    </select>
                </div>
                <div>
                    <label for="view-batch-select">Batch:</label>
                    <select id="view-batch-select" required disabled>
                        <option value="">Select Course</option>
                    </select>
                </div>
            </div>
            <p id="view-status" style="margin-top: 15px; font-weight: bold;"></p>
        </div>

        <div class="grid-layout">
            <div class="card">
                <h2>Add New Slot</h2>
                <form id="slot-form">
                    <input type="hidden" id="slot-id" name="id">
                    
                    <input type="hidden" id="form-course-id" name="course_id">
                    <input type="hidden" id="form-batch-id" name="batch_id">

                    <label for="form-subject-select">Subject:</label>
                    <select id="form-subject-select" name="subject_id" required>
                        <option value="">Loading...</option>
                    </select>

                    <label for="teacher-select">Teacher:</label>
                    <select id="teacher-select" name="teacher_id">
                        <option value="">(Optional) Select Teacher</option>
                    </select>

                    <label for="day-select">Day of Week:</label>
                    <select id="day-select" name="day_of_week" required>
                        <option value="">-- Select Day --</option>
                        <option value="Monday">Monday</option>
                        <option value="Tuesday">Tuesday</option>
                        <option value="Wednesday">Wednesday</option>
                        <option value="Thursday">Thursday</option>
                        <option value="Friday">Friday</option>
                        <option value="Saturday">Saturday</option>
                    </select>
                    
                    <label for="start-time">Start Time:</label>
                    <input type="time" id="start-time" name="start_time" required>

                    <label for="end-time">End Time:</label>
                    <input type="time" id="end-time" name="end_time" required>
                    
                    <label for="room-number">Room Number:</label>
                    <input type="text" id="room-number" name="room_number">

                    <button type="submit" id="submit-btn">Add Slot</button>
                    <p id="form-error" style="color:red; margin-top: 10px;"></p>
                </form>
            </div>

            <div class="card">
                <h2>Weekly Schedule View</h2>
                <div id="schedule-display" class="schedule-display-container">
                    <p>Select a Course and Batch to load the timetable.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Global Configuration ---
        const token = localStorage.getItem('erp-token');
        const userRole = localStorage.getItem('user-role');

        // Client-side Guard
        if (!token || (userRole !== 'Super Admin' && userRole !== 'Admin' && userRole !== 'Teacher')) { 
            // window.location.href = '/login'; 
            console.error("Access Denied: Must be Super Admin, Admin, or Teacher.");
        }

        const API_BASE = '/api/timetable';

        // --- Helper Functions ---
        async function handleApi(url, options = {}) {
            const authHeaders = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` };
            const response = await fetch(url, { ...options, headers: authHeaders });
            
            if (response.status === 401 || response.status === 403) {
                localStorage.clear();
                window.location.href = '/login';
                throw new Error('Unauthorized or session expired.');
            }
            if (!response.ok) {
                // If response is not OK, try to parse JSON error message
                const errorBody = await response.json().catch(() => ({ message: 'Server error with no body.' }));
                throw new Error(errorBody.message || 'API call failed.');
            }
            return response.json();
        }

        function formatTime(timeString) {
            if (!timeString) return '';
            const [h, m] = timeString.split(':');
            let hour = parseInt(h);
            const period = hour >= 12 ? 'PM' : 'AM';
            hour = hour % 12 || 12;
            return `${hour}:${m} ${period}`;
        }
        
        // --- Core Load Functions ---
        
        async function loadTeachers(teacherSelect) {
            // Note: Assuming /api/teachers/list is an authorized endpoint for managers
            try {
                const teachers = await handleApi('/api/teachers/list'); 
                teacherSelect.innerHTML = '<option value="">(Optional) Select Teacher</option>';
                teachers.forEach(t => {
                    // *** সংশোধিত: full_name বা name না পেলে Teacher ID দেখাবে ***
                    // Uses full_name or name from the teacher list API response. 
                    const teacherName = t.full_name || t.name || `Teacher ID: ${t.teacher_id || t.id}`;
                    teacherSelect.innerHTML += `<option value="${t.teacher_id || t.id}">${teacherName}</option>`;
                });
            } catch (e) {
                console.error("Failed to load teachers:", e);
                teacherSelect.innerHTML = '<option value="">Error loading teachers</option>';
            }
        }
        
        async function loadDependencies(courseSelect, formSubjectSelect, teacherSelect) {
            try {
                const [courses, subjects] = await Promise.all([
                    handleApi('/api/academicswithfees/courses'),
                    handleApi('/api/academicswithfees/subjects')
                ]);
                
                const populate = (select, items, idKey, nameKey) => {
                    select.innerHTML = `<option value="">-- Select --</option>`;
                    items.forEach(item => {
                        // Assuming code exists for subjects/courses
                        select.innerHTML += `<option value="${item[idKey]}">${item[nameKey]} (${item.course_code || item.subject_code || ''})</option>`;
                    });
                };

                populate(courseSelect, courses, 'course_id', 'course_name');
                populate(formSubjectSelect, subjects, 'subject_id', 'subject_name');
                
                await loadTeachers(teacherSelect);

            } catch (error) {
                console.error('Error loading dependencies:', error);
                document.getElementById('view-status').textContent = 'Error loading dependencies.';
            }
        }

        async function loadBatches(courseId, batchSelect) {
            if (!courseId) {
                batchSelect.innerHTML = '<option value="">Select Course</option>';
                batchSelect.disabled = true;
                return;
            }
            
            try {
                const batches = await handleApi(`/api/academicswithfees/courses/${courseId}/batches`);
                batchSelect.innerHTML = '<option value="">-- Select Batch --</option>';
                batches.forEach(b => {
                    batchSelect.innerHTML += `<option value="${b.batch_id}">${b.batch_name}</option>`;
                });
                batchSelect.disabled = false;
            } catch (err) {
                batchSelect.innerHTML = '<option value="">Error loading batches</option>';
            }
        }

        // --- Render Timetable ---
        
        const DAYS = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

        function renderTimetable(timetableData) {
            const display = document.getElementById('schedule-display');
            display.innerHTML = '';
            
            // 1. Collect all unique time slots across all days
            let timeSlots = new Set();
            for (const day of DAYS) {
                if (timetableData[day]) {
                    timetableData[day].forEach(slot => {
                        timeSlots.add(`${slot.start_time}-${slot.end_time}`);
                    });
                }
            }
            
            const sortedTimeSlots = Array.from(timeSlots).sort();
            
            if (sortedTimeSlots.length === 0) {
                 display.innerHTML = '<p style="text-align: center;">No timetable slots found for this batch.</p>';
                 return;
            }

            // Create the main grid container
            const gridContainer = document.createElement('div');
            gridContainer.className = 'schedule-grid';
            
            // Generate the fixed header row (Time + Days)
            gridContainer.innerHTML = `<div class="time-label">TIME</div>`;
            DAYS.forEach(day => {
                gridContainer.innerHTML += `<div class="day-header">${day}</div>`;
            });
            
            // 2. Generate Body Rows (Time Label + 6 Data Cells)
            sortedTimeSlots.forEach(slotKey => {
                const [startTime, endTime] = slotKey.split('-');
                
                // Time Slot Header Cell
                gridContainer.innerHTML += `<div class="time-label">${formatTime(startTime)} - ${formatTime(endTime)}</div>`;

                // Data Cells for each day
                DAYS.forEach(day => {
                    const cell = document.createElement('div');
                    cell.className = 'day-cell';
                    
                    const slotsForDay = timetableData[day] || [];
                    const matchingSlot = slotsForDay.find(s => 
                        s.start_time === startTime && s.end_time === endTime
                    );
                    
                    if (matchingSlot) {
                        cell.classList.add('filled');
                        cell.innerHTML = `
                            <div class="slot-info">
                                <strong>${matchingSlot.subject_name || matchingSlot.subject_code}</strong> (${matchingSlot.room_number || 'N/A'})
                            </div>
                            <div class="slot-teacher">
                                Taught by: ${matchingSlot.teacher_name || 'Unassigned'}
                            </div>
                            <div class="slot-actions">
                                <button onclick="deleteSlot('${matchingSlot.id}')">Delete</button>
                            </div>
                        `;
                    }
                    gridContainer.appendChild(cell);
                });
            });

            display.appendChild(gridContainer);
        }
        
        // --- Event Handlers ---
        
        // Slot Deletion Handler
        window.deleteSlot = async (slotId) => {
            if (!confirm('Are you sure you want to delete this class slot? This cannot be undone.')) return;
            
            try {
                await handleApi(`${API_BASE}/${slotId}`, { method: 'DELETE' });
                alert('Slot deleted successfully!');
                
                // Manually trigger the change event to reload the timetable
                document.getElementById('view-batch-select').dispatchEvent(new Event('change')); 
            } catch (error) {
                alert(`Error deleting slot: ${error.message}`);
            }
        };

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            
            const courseSelect = document.getElementById('view-course-select');
            const batchSelect = document.getElementById('view-batch-select');
            const formSubjectSelect = document.getElementById('form-subject-select');
            const teacherSelect = document.getElementById('teacher-select');
            const slotForm = document.getElementById('slot-form');
            const formCourseId = document.getElementById('form-course-id');
            const formBatchId = document.getElementById('form-batch-id');
            const formError = document.getElementById('form-error');

            // --- View Course/Batch Change Listeners ---

            courseSelect.addEventListener('change', (e) => {
                const courseId = e.target.value;
                loadBatches(courseId, batchSelect); 
                document.getElementById('view-status').textContent = 'Select a Batch.';
                document.getElementById('schedule-display').innerHTML = '<p>Select a Course and Batch to load the timetable.</p>';
            });
            
            batchSelect.addEventListener('change', async (e) => {
                const courseId = document.getElementById('view-course-select').value;
                const batchId = e.target.value;
                
                if (!courseId || !batchId) {
                    document.getElementById('view-status').textContent = 'Please select both Course and Batch.';
                    return;
                }
                
                document.getElementById('view-status').textContent = 'Loading timetable...';

                // CRITICAL: Update the hidden form inputs for submission
                formCourseId.value = courseId; 
                formBatchId.value = batchId;

                try {
                    // This uses the grouped route /api/timetable/:courseId/:batchId
                    const timetable = await handleApi(`${API_BASE}/${courseId}/${batchId}`);
                    renderTimetable(timetable);
                    document.getElementById('view-status').textContent = `Timetable loaded for ${batchSelect.options[batchSelect.selectedIndex].textContent}.`;
                } catch (error) {
                    document.getElementById('view-status').textContent = `Error: ${error.message}`;
                    renderTimetable({});
                }
            });
            
            // --- Slot Form Submission ---
            slotForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const submitBtn = document.getElementById('submit-btn');
                submitBtn.disabled = true;
                formError.textContent = '';
    
                // Read Course/Batch IDs from the hidden inputs
                const courseId = formCourseId.value;
                const batchId = formBatchId.value;
    
                if (!courseId || !batchId) {
                    formError.textContent = 'Please select a Course and Batch first (in the view section).';
                    submitBtn.disabled = false;
                    return;
                }
                
                const formData = {
                    course_id: courseId,
                    batch_id: batchId,
                    subject_id: slotForm.elements['subject_id'].value,
                    teacher_id: slotForm.elements['teacher_id'].value || null,
                    day_of_week: slotForm.elements['day_of_week'].value,
                    start_time: slotForm.elements['start_time'].value,
                    end_time: slotForm.elements['end_time'].value,
                    room_number: slotForm.elements['room_number'].value
                };

                try {
                    await handleApi(API_BASE, { method: 'POST', body: JSON.stringify(formData) });
                    alert('Slot added successfully!');
                    
                    // === ফর্ম রিসেট করার সময় লুকানো ইনপুটগুলি সংরক্ষণ করা ===
                    const currentCourseId = formCourseId.value;
                    const currentBatchId = formBatchId.value;
                    
                    slotForm.reset();
                    
                    // ID গুলো আবার সেট করা হলো
                    formCourseId.value = currentCourseId;
                    formBatchId.value = currentBatchId;
                    // =======================================================

                    // Reload the timetable view without full page reload
                    batchSelect.dispatchEvent(new Event('change')); 
                } catch (error) {
                    formError.textContent = `Error: ${error.message}`;
                } finally {
                    submitBtn.disabled = false;
                }
            });


            // --- Run Initial Fetches ---
            loadDependencies(courseSelect, formSubjectSelect, teacherSelect);
        });
    </script>
</body>
</html>