<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timetable Management | BCSM</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"> 
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="css/style.css">

    <style>
        /* --- HIGH CONTRAST & COMPACT STYLES --- */
        body {
            background-color: #f4f6f8 !important; /* Softer Gray */
            color: #1e293b !important; /* Dark Slate for better contrast */
            font-family: 'Inter', sans-serif !important; /* Applied New Font */
            font-size: 0.9rem;
        }

        .glass-card, .card {
            background: #ffffff !important;
            border: 1px solid #e2e8f0 !important;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1) !important;
            border-radius: 8px !important;
            padding: 15px;
        }

        h2, h4, h5, h6 {
            color: #0f172a !important; /* Very Dark Blue-Gray */
            font-weight: 700;
            letter-spacing: -0.025em; /* Tighter letter spacing for headlines */
        }

        /* --- COMPACT TIMETABLE GRID --- */
        .timetable-container {
            overflow-x: auto;
            background: #ffffff;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            padding: 5px;
        }
        
        .schedule-grid {
            display: grid;
            grid-template-columns: 80px repeat(6, minmax(130px, 1fr));
            gap: 4px;
            min-width: 900px;
        }

        /* Compact Headers */
        .day-header {
            background: #1e293b !important; /* Slate 800 */
            color: #ffffff !important;
            font-weight: 600;
            padding: 8px 4px;
            text-align: center;
            border-radius: 4px;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .time-header {
            background: #3b82f6 !important; /* Blue 500 */
            color: #ffffff !important;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            border-radius: 4px;
            font-size: 0.75rem;
            padding: 5px;
            line-height: 1.2;
        }

        /* Compact Cells */
        .day-cell {
            background: #f8fafc !important; /* Slate 50 */
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            min-height: 80px;
            padding: 4px;
        }
        
        /* Compact Slot Card */
        .slot-card {
            background: #ffffff !important;
            border-left: 4px solid #3b82f6;
            border-top: 1px solid #e2e8f0;
            border-right: 1px solid #e2e8f0;
            border-bottom: 1px solid #e2e8f0;
            padding: 8px 6px;
            border-radius: 4px;
            margin-bottom: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            position: relative;
        }
        
        .slot-subject { 
            font-weight: 700; 
            color: #0f172a !important; 
            font-size: 0.85rem; 
            line-height: 1.3;
            margin-bottom: 2px;
        }
        .slot-teacher { 
            font-size: 0.75rem; 
            color: #64748b !important; /* Slate 500 */
            display: block; 
            font-weight: 500;
        }
        .slot-room { 
            font-size: 0.75rem; 
            font-weight: 700; 
            color: #ef4444 !important; /* Red 500 */
        }
        
        /* Delete Button */
        .btn-delete-slot {
            position: absolute;
            top: 4px;
            right: 4px;
            font-size: 0.7rem;
            color: #ef4444;
            background: #fee2e2;
            border: none;
            border-radius: 4px;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-delete-slot:hover { background: #ef4444; color: white; }

        /* Form Controls */
        .form-label { margin-bottom: 3px; font-size: 0.8rem; font-weight: 600; color: #475569; }
        .form-control, .form-select { 
            font-size: 0.85rem; 
            padding: 6px 10px;
            border-color: #cbd5e1;
        }
        .form-control:focus, .form-select:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
    </style>
</head>
<body>

<div class="container-fluid" style="max-width: 1600px; padding: 20px;">
    
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h4 class="fw-bold mb-0 text-dark"><i class="fas fa-calendar-alt me-2"></i>Timetable</h4>
            <p class="text-muted mb-0 small">Manage schedules efficiently</p>
        </div>
        <a href="/admin-dashboard.html" class="btn btn-sm btn-dark rounded-pill px-3">
            <i class="fas fa-arrow-left me-2"></i> Dashboard
        </a>
    </div>

    <div class="row g-3">
        
        <div class="col-lg-3">
            <div class="glass-card mb-3">
                <h6 class="fw-bold text-primary mb-2"><i class="fas fa-eye me-2"></i>Select View</h6>
                <div class="mb-2">
                    <label class="form-label">Course</label>
                    <select id="view-course-select" class="form-select form-select-sm">
                        <option value="">Loading...</option>
                    </select>
                </div>
                <div class="mb-2">
                    <label class="form-label">Batch</label>
                    <select id="view-batch-select" class="form-select form-select-sm" disabled>
                        <option value="">Select Course First</option>
                    </select>
                </div>
                <div id="view-status" class="small fw-bold text-secondary" style="font-size: 0.75rem;"></div>
            </div>

            <div class="glass-card">
                <h6 class="fw-bold text-success mb-2"><i class="fas fa-plus-circle me-2"></i>Add Slot</h6>
                <form id="slot-form">
                    <input type="hidden" id="form-course-id">
                    <input type="hidden" id="form-batch-id">

                    <div class="mb-2">
                        <label class="form-label">Subject</label>
                        <select id="form-subject-select" name="subject_id" class="form-select form-select-sm" required>
                            <option value="">Loading...</option>
                        </select>
                    </div>
                    
                    <div class="mb-2">
                        <label class="form-label">Teacher</label>
                        <select id="teacher-select" name="teacher_id" class="form-select form-select-sm">
                            <option value="">(Optional)</option>
                        </select>
                    </div>

                    <div class="mb-2">
                        <label class="form-label">Day</label>
                        <select name="day_of_week" class="form-select form-select-sm" required>
                            <option value="Monday">Monday</option>
                            <option value="Tuesday">Tuesday</option>
                            <option value="Wednesday">Wednesday</option>
                            <option value="Thursday">Thursday</option>
                            <option value="Friday">Friday</option>
                            <option value="Saturday">Saturday</option>
                        </select>
                    </div>

                    <div class="row g-1 mb-2">
                        <div class="col-6">
                            <label class="form-label">Start</label>
                            <input type="time" name="start_time" class="form-control form-control-sm" required>
                        </div>
                        <div class="col-6">
                            <label class="form-label">End</label>
                            <input type="time" name="end_time" class="form-control form-control-sm" required>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Room</label>
                        <input type="text" name="room_number" class="form-control form-control-sm" placeholder="e.g. 101">
                    </div>

                    <button type="submit" id="submit-btn" class="btn btn-sm btn-primary w-100 rounded-pill shadow-sm fw-bold">
                        Add to Timetable
                    </button>
                    <div id="form-error" class="text-danger small mt-2 text-center fw-bold"></div>
                </form>
            </div>
        </div>

        <div class="col-lg-9">
            <div class="glass-card h-100 p-0 overflow-hidden">
                <div class="timetable-container">
                    <div id="schedule-display">
                        <div class="text-center p-5 text-muted">
                            <i class="fas fa-calendar-times fa-2x mb-2 opacity-25"></i>
                            <h6 class="text-dark">Select Course & Batch</h6>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="js/global-config.js?v=2.3.1"></script>

<script>
    const API_BASE = '/api/timetable';
    const DAYS = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

    document.addEventListener('DOMContentLoaded', () => {
        const token = localStorage.getItem('erp-token');
        if (!token) window.location.href = '/login.html';

        loadDependencies();
        setupEventListeners();
    });

    // 1. Initial Data Load
    async function loadDependencies() {
        try {
            const [coursesRes, subjectsRes, teachersRes] = await Promise.all([
                window.authFetch('/api/academicswithfees/courses'),
                window.authFetch('/api/academicswithfees/subjects'),
                window.authFetch('/api/teachers/list')
            ]);

            const courses = await coursesRes.json();
            const subjects = await subjectsRes.json();
            const teachers = await teachersRes.json();

            populateSelect('view-course-select', courses, 'course_id', 'course_name');
            populateSelect('form-subject-select', subjects, 'subject_id', 'subject_name');
            
            const tSelect = document.getElementById('teacher-select');
            tSelect.innerHTML = '<option value="">(Optional) Select Teacher</option>';
            teachers.forEach(t => {
                const name = t.full_name || t.name || `ID: ${t.id}`;
                tSelect.innerHTML += `<option value="${t.id}">${name}</option>`;
            });

        } catch (e) { console.error("Load Error:", e); }
    }

    function populateSelect(id, data, valKey, textKey) {
        const select = document.getElementById(id);
        select.innerHTML = '<option value="">Select</option>';
        data.forEach(item => {
            select.innerHTML += `<option value="${item[valKey]}">${item[textKey]}</option>`;
        });
    }

    // 2. Event Listeners
    function setupEventListeners() {
        document.getElementById('view-course-select').addEventListener('change', async function() {
            const id = this.value;
            const bSelect = document.getElementById('view-batch-select');
            
            bSelect.innerHTML = '<option>Loading...</option>';
            bSelect.disabled = true;
            
            if(!id) return;

            try {
                const res = await window.authFetch(`/api/academicswithfees/courses/${id}/batches`);
                const batches = await res.json();
                bSelect.innerHTML = '<option value="">Select Batch</option>';
                batches.forEach(b => {
                    bSelect.innerHTML += `<option value="${b.batch_id}">${b.batch_name}</option>`;
                });
                bSelect.disabled = false;
            } catch(e) {}
        });

        document.getElementById('view-batch-select').addEventListener('change', async function() {
            const courseId = document.getElementById('view-course-select').value;
            const batchId = this.value;
            
            if(!courseId || !batchId) return;

            document.getElementById('form-course-id').value = courseId;
            document.getElementById('form-batch-id').value = batchId;

            document.getElementById('view-status').innerText = 'Loading...';
            
            try {
                const res = await window.authFetch(`${API_BASE}/${courseId}/${batchId}`);
                const data = await res.json();
                renderTimetable(data);
                document.getElementById('view-status').innerText = 'Timetable Loaded';
            } catch(e) {
                document.getElementById('view-status').innerText = 'Error loading data';
            }
        });

        document.getElementById('slot-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submit-btn');
            btn.disabled = true;
            
            const fd = new FormData(e.target);
            const data = Object.fromEntries(fd.entries());
            data.course_id = document.getElementById('form-course-id').value;
            data.batch_id = document.getElementById('form-batch-id').value;

            if(!data.course_id || !data.batch_id) {
                alert("Please select a Course & Batch from the View menu first.");
                btn.disabled = false;
                return;
            }

            try {
                const res = await window.authFetch(API_BASE, {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
                
                if(res.ok) {
                    document.getElementById('view-batch-select').dispatchEvent(new Event('change'));
                    e.target.reset();
                } else {
                    const err = await res.json();
                    document.getElementById('form-error').innerText = err.message || "Failed to add";
                }
            } catch(e) { alert("Network Error"); }
            finally { btn.disabled = false; }
        });
    }

    // 3. Render Logic (Compact)
    function renderTimetable(data) {
        const container = document.getElementById('schedule-display');
        container.innerHTML = '';

        let times = new Set();
        Object.values(data).flat().forEach(s => times.add(`${s.start_time}-${s.end_time}`));
        const sortedTimes = Array.from(times).sort();

        if(sortedTimes.length === 0) {
            container.innerHTML = '<div class="text-center p-5 text-dark"><strong>No classes scheduled yet.</strong></div>';
            return;
        }

        const grid = document.createElement('div');
        grid.className = 'schedule-grid';

        grid.innerHTML = '<div class="time-header">Time</div>';
        DAYS.forEach(day => grid.innerHTML += `<div class="day-header">${day}</div>`);

        sortedTimes.forEach(timeKey => {
            const [start, end] = timeKey.split('-');
            
            grid.innerHTML += `<div class="time-header">${start.slice(0,5)}<br>-<br>${end.slice(0,5)}</div>`;

            for(let i=1; i<=6; i++) {
                const cell = document.createElement('div');
                cell.className = 'day-cell';
                
                const daySlots = data[i] || [];
                const slot = daySlots.find(s => s.start_time === start && s.end_time === end);

                if(slot) {
                    cell.innerHTML = `
                        <div class="slot-card">
                            <button class="btn-delete-slot" onclick="deleteSlot('${slot.id}')"><i class="fas fa-times"></i></button>
                            <div class="slot-subject">${slot.subject_name}</div>
                            <span class="slot-room">${slot.room_number || 'N/A'}</span>
                            <span class="slot-teacher">${slot.teacher_name || 'No Teacher'}</span>
                        </div>
                    `;
                }
                grid.appendChild(cell);
            }
        });

        container.appendChild(grid);
    }

    window.deleteSlot = async (id) => {
        if(!confirm("Delete?")) return;
        try {
            await window.authFetch(`${API_BASE}/${id}`, { method: 'DELETE' });
            document.getElementById('view-batch-select').dispatchEvent(new Event('change'));
        } catch(e) { alert("Error deleting"); }
    };

</script>

</body>
</html>