<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assign Student | Transport ERP</title>
    <link rel="stylesheet" href="css/style.css"> 
    <style>
        /* Essential overrides for this specific page layout */
        .page-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: calc(100vh - 100px);
            padding: 20px;
        }
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        @media (max-width: 600px) {
            .form-grid { grid-template-columns: 1fr; }
        }
        .fee-display {
            grid-column: span 2;
            background: rgba(0, 90, 156, 0.05);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            border: 1px dashed var(--primary-dark);
            margin: 10px 0;
        }
    </style>
</head>
<body>

<nav class="glass-nav">
    <div style="display: flex; align-items: center; gap: 15px;">
        <img src="" class="global-school-logo" height="40" alt="Logo">
        <h2 class="global-school-name" style="margin:0; font-size: 1.2rem; color: var(--primary-dark);">ERP System</h2>
    </div>
    <div class="nav-links">
        <a href="manage-transport.html" class="btn btn-primary" style="padding: 8px 20px;">
            <span>←</span> Back
        </a>
    </div>
</nav>

<div class="page-wrapper">
    <div class="container" style="max-width: 700px; width: 100%;">
        
        <div class="glass-card">
            <h1 style="text-align: center; color: var(--primary-dark); margin-bottom: 30px; font-size: 1.8rem;">
                Transport Enrollment
            </h1>
            
            <div id="status-box" class="status-message mb-3"></div>

            <form id="assign-form" class="form-grid">
                
                <div style="grid-column: span 2;">
                    <label for="student-select">Select Student</label>
                    <select id="student-select" class="form-control" name="student_id" required>
                        <option value="">Loading students...</option>
                    </select>
                </div>
                
                <div style="grid-column: span 2;">
                    <label for="route-select">Assigned Route</label>
                    <select id="route-select" class="form-control" name="route_id" required>
                        <option value="">Loading routes...</option>
                    </select>
                </div>
                
                <div>
                    <label for="boarding_stop">Boarding Point</label>
                    <input type="text" id="boarding_stop" class="form-control" name="boarding_stop" placeholder="Pick-up location" required>
                </div>
                
                <div>
                    <label for="dropping_stop">Dropping Point</label>
                    <input type="text" id="dropping_stop" class="form-control" name="dropping_stop" placeholder="Drop-off location" required>
                </div>

                <div class="fee-display">
                    <span class="stat-label">Monthly Transport Fee</span>
                    <div class="stat-value" id="fee-visual">₹0.00</div>
                    <input type="hidden" id="monthly_fee" name="monthly_fee" value="0">
                </div>

                <button type="submit" class="btn btn-primary" style="grid-column: span 2; justify-content: center; width: 100%;">
                    Assign to Route
                </button>
            </form>
        </div>
    </div>
</div>

<div id="bg-text-pattern" style="position: fixed; top:0; left:0; width:100%; height:100%; z-index:-1;"></div>

<script src="js/global-config.js"></script>
<script>
    /** * NOTE: We are now using window.authFetch (from global-config.js) 
     * to handle tokens and base URLs automatically.
     */
    
    async function populateDropdowns() {
        const studentSelect = document.getElementById('student-select');
        const routeSelect = document.getElementById('route-select');
        
        try {
            // Using your new global fetch helper
            const [studentRes, routeRes] = await Promise.all([
                window.authFetch('/api/transport/candidates'),
                window.authFetch('/api/transport/routes')
            ]);
            
            const students = await studentRes.json();
            const routes = await routeRes.json();
            
            studentSelect.innerHTML = '<option value="">-- Search Student --</option>' + 
                students.map(s => `<option value="${s.student_id}">${s.first_name} ${s.last_name} (Roll: ${s.roll_number || 'N/A'})</option>`).join('');

            routeSelect.innerHTML = '<option value="">-- Choose Route --</option>' + 
                routes.map(r => `<option value="${r.id}" data-fee="${r.monthly_fee}">${r.route_name}</option>`).join('');
            
        } catch(err) {
            showStatus('Failed to sync with server.', 'error');
        }
    }

    // Update Fee Display using the global window.formatCurrency helper
    document.getElementById('route-select').addEventListener('change', function() {
        const selected = this.options[this.selectedIndex];
        const fee = selected.getAttribute('data-fee') || 0;
        document.getElementById('monthly_fee').value = fee;
        
        const display = document.getElementById('fee-visual');
        display.innerText = window.formatCurrency ? window.formatCurrency(fee) : `₹${fee}`;
    });

    document.getElementById('assign-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = {
            student_id: document.getElementById('student-select').value,
            route_id: document.getElementById('route-select').value,
            boarding_stop: document.getElementById('boarding_stop').value,
            dropping_stop: document.getElementById('dropping_stop').value,
            monthly_fee: document.getElementById('monthly_fee').value
        };

        try {
            const response = await window.authFetch('/api/transport/assign', {
                method: 'POST',
                body: JSON.stringify(formData)
            });

            if (response.ok) {
                showStatus('Assignment Successful!', 'success');
                setTimeout(() => window.location.href = 'manage-transport.html', 1500);
            } else {
                const res = await response.json();
                throw new Error(res.message || 'Error processing request');
            }
        } catch (err) {
             showStatus(err.message, 'error');
        }
    });

    function showStatus(msg, type) {
        const el = document.getElementById('status-box');
        el.textContent = msg;
        // Map types to your new badge classes
        el.className = `status-message badge ${type === 'success' ? 'badge-success' : 'badge-danger'}`;
        el.style.display = 'block';
    }

    window.onload = populateDropdowns;
</script>
</body>
</html>