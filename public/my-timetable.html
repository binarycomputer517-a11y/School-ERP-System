<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">My Timetable</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f0f2f8; 
            font-family: 'Poppins', sans-serif; 
            font-size: 14px;
        }
        .timetable-container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 30px;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        h1 {
            color: #003366;
            margin-bottom: 25px;
        }
        .table thead th {
            background-color: #5e35b1; 
            color: white;
            text-align: center;
            vertical-align: middle;
        }
        .table tbody td {
            text-align: center;
            vertical-align: middle;
            height: 60px; 
        }
        .time-slot {
            font-weight: bold;
            background-color: #f8f9fa; 
        }
        .subject-cell {
            font-weight: 500;
        }
        .teacher-name {
            font-size: 0.85em;
            color: #6c757d; 
        }
        #loading-indicator {
            text-align: center;
            padding: 20px;
            font-style: italic;
            color: #6c757d;
        }
    </style>
</head>
<body class="p-3">
    <div class="timetable-container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 id="timetable-header">My Weekly Timetable</h1>
            <a id="back-to-dashboard" href="/dashboard.html" class="btn btn-outline-secondary">‚Üê Back to Dashboard</a>
        </div>

        <div id="timetable-display" class="table-responsive">
            <p id="loading-indicator">Loading timetable...</p>
            <table class="table table-bordered table-striped" style="display: none;">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Monday</th>
                        <th>Tuesday</th>
                        <th>Wednesday</th>
                        <th>Thursday</th>
                        <th>Friday</th>
                        <th>Saturday</th>
                    </tr>
                </thead>
                <tbody id="timetable-body">
                </tbody>
            </table>
            <p id="error-message" class="text-danger mt-3" style="display: none;"></p>
        </div>
    </div>

    <script>
        const TOKEN = localStorage.getItem('erp-token');
        const USER_ROLE = localStorage.getItem('user-role'); 
        const timetableBody = document.getElementById('timetable-body');
        const loadingIndicator = document.getElementById('loading-indicator');
        const errorMessage = document.getElementById('error-message');
        const timetableTable = document.querySelector('.table');
        const backToDashboardLink = document.getElementById('back-to-dashboard');

        const daysOfWeek = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
        
        // --- Role-based API Endpoint Configuration ---
        let API_URL;
        let mainDashboard = '/dashboard.html'; 
        let isAuthorized = true; // Flag to control script execution

        switch (USER_ROLE) {
            case 'Student':
                API_URL = '/api/timetable/student/me';
                mainDashboard = '/student-dashboard.html';
                break;
            case 'Teacher':
                API_URL = '/api/timetable/teacher/me';
                mainDashboard = '/teacher-dashboard.html';
                break;
            case 'Admin':
            case 'Super Admin':
                API_URL = '/api/timetable/teacher/me'; 
                mainDashboard = '/admin-dashboard.html';
                break;
            default:
                showError("Role not recognized. Access Denied. Redirecting to login...");
                isAuthorized = false; // Disable fetching
                setTimeout(() => window.location.href = '/login.html', 1000);
                break; 
        }

        // Update back button and title
        backToDashboardLink.href = mainDashboard;
        document.getElementById('page-title').textContent = `${USER_ROLE} Timetable`;
        document.getElementById('timetable-header').textContent = `My Weekly Timetable (${USER_ROLE})`;

        
        // Helper function to format time
        function formatTime(timeString) {
            const [h, m] = timeString.split(':');
            let hour = parseInt(h);
            const period = hour >= 12 ? 'PM' : 'AM';
            hour = hour % 12 || 12;
            return `${hour}:${m} ${period}`;
        }

        async function fetchTimetable() {
            if (!TOKEN) {
                showError("Authentication token not found. Please log in.");
                return;
            }

            try {
                loadingIndicator.style.display = 'block';
                errorMessage.style.display = 'none';
                timetableTable.style.display = 'none';

                const response = await fetch(API_URL, {
                    headers: { 'Authorization': `Bearer ${TOKEN}` }
                });

                if (!response.ok) {
                    // 404 means the route exists, but the specific data/profile wasn't found (e.g., student not enrolled, teacher not assigned)
                    if (response.status === 404 || response.status === 204) {
                        showError(`Timetable not yet assigned or profile not fully setup.`);
                        return;
                    }
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const timetableData = await response.json();

                if (!Array.isArray(timetableData) || timetableData.length === 0) {
                     showError(`No timetable data available for the current schedule.`);
                     return;
                }

                renderTimetable(timetableData);

            } catch (error) {
                console.error('Error fetching timetable:', error);
                showError(`Failed to load timetable: ${error.message}`);
            } finally {
                loadingIndicator.style.display = 'none';
            }
        }

        function renderTimetable(data) {
            timetableBody.innerHTML = ''; 
            
            // 1. Collect all unique time slots (start_time - end_time)
            let uniqueTimeSlots = new Set();
            data.forEach(entry => {
                uniqueTimeSlots.add(entry.start_time + "-" + entry.end_time);
            });
            
            const sortedTimeSlots = Array.from(uniqueTimeSlots).sort();

            // 2. Create a lookup map
            const schedule = new Map(); 
            data.forEach(entry => {
                const timeKey = entry.start_time + "-" + entry.end_time;
                const day = entry.day_of_week; 

                if (!schedule.has(timeKey)) {
                    schedule.set(timeKey, new Map());
                }
                schedule.get(timeKey).set(day, entry);
            });

            // 3. Generate table rows
            sortedTimeSlots.forEach(timeKey => {
                const [startTime, endTime] = timeKey.split('-');
                const row = document.createElement('tr');
                
                // Time Slot Header Cell
                row.innerHTML += `<td class="time-slot">${formatTime(startTime)} - ${formatTime(endTime)}</td>`; 

                daysOfWeek.forEach(day => {
                    const entry = schedule.get(timeKey)?.get(day); 
                    if (entry) {
                        // Dynamically determine the secondary info based on role
                        let secondaryInfo = '';
                        if (USER_ROLE === 'Student' || USER_ROLE === 'Admin') {
                            // Students/Admins see Teacher Name
                            secondaryInfo = `${entry.teacher_name || 'N/A'} (${entry.room_number || 'N/A'})`;
                        } else if (USER_ROLE === 'Teacher') {
                            // Teachers see Course & Batch
                            secondaryInfo = `${entry.course_name || 'N/A'} - ${entry.batch_name || 'N/A'} (${entry.room_number || 'N/A'})`;
                        }

                        row.innerHTML += `
                            <td class="subject-cell">
                                ${entry.subject_name || 'N/A'}<br>
                                <span class="teacher-name">${secondaryInfo}</span>
                            </td>`;
                    } else {
                        row.innerHTML += `<td>-</td>`;
                    }
                });
                timetableBody.appendChild(row);
            });

            if (timetableBody.children.length > 0) {
                 timetableTable.style.display = 'table';
            } else {
                 showError("No timetable data available for the current schedule.");
            }
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            timetableTable.style.display = 'none';
            loadingIndicator.style.display = 'none';
        }
        
        // --- Initial Load Check ---
        if (isAuthorized && TOKEN) {
            document.addEventListener('DOMContentLoaded', fetchTimetable);
        } else if (!isAuthorized) {
            // Redirect already handled in switch statement
        } else {
            showError("User session expired or invalid. Redirecting to login...");
            setTimeout(() => window.location.href = '/login.html', 1000);
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/global-config.js"></script> 
</body>
</html>