<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Timetable</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f0f2f8; /* Light background */
            font-family: var(--bs-body-font-family);
            font-size: 14px;
        }
        .timetable-container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 30px;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        h1 {
            color: #003366;
            margin-bottom: 25px;
        }
        .table thead th {
            background-color: #5e35b1; /* Purple header */
            color: white;
            text-align: center;
            vertical-align: middle;
        }
        .table tbody td {
            text-align: center;
            vertical-align: middle;
            height: 60px; /* Consistent row height */
        }
        .time-slot {
            font-weight: bold;
            background-color: #f8f9fa; /* Light grey for time */
        }
        .subject-cell {
            font-weight: 500;
        }
        .teacher-name {
            font-size: 0.85em;
            color: #6c757d; /* Muted color */
        }
         /* Simple loading indicator */
        #loading-indicator {
            text-align: center;
            padding: 20px;
            font-style: italic;
            color: #6c757d;
        }
    </style>
</head>
<body class="p-3">
    <div class="timetable-container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>My Weekly Timetable</h1>
            <a href="/student-dashboard.html" class="btn btn-outline-secondary">‚Üê Back to Dashboard</a>
        </div>

        <div id="timetable-display" class="table-responsive">
            <p id="loading-indicator">Loading timetable...</p>
            <table class="table table-bordered table-striped" style="display: none;">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Monday</th>
                        <th>Tuesday</th>
                        <th>Wednesday</th>
                        <th>Thursday</th>
                        <th>Friday</th>
                        <th>Saturday</th>
                    </tr>
                </thead>
                <tbody id="timetable-body">
                    </tbody>
            </table>
            <p id="error-message" class="text-danger mt-3" style="display: none;"></p>
        </div>
    </div>

    <script>
        const API_URL = '/api/timetable/student/me';
        const TOKEN = localStorage.getItem('erp-token');
        const STUDENT_ID = localStorage.getItem('student-id'); 
        const timetableBody = document.getElementById('timetable-body');
        const loadingIndicator = document.getElementById('loading-indicator');
        const errorMessage = document.getElementById('error-message');
        const timetableTable = document.querySelector('.table');

        const daysOfWeek = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
        
        // Helper function to format time (e.g., "14:30" to "2:30 PM")
        function formatTime(timeString) {
            const [h, m] = timeString.split(':');
            let hour = parseInt(h);
            const period = hour >= 12 ? 'PM' : 'AM';
            hour = hour % 12 || 12;
            return `${hour}:${m} ${period}`;
        }

        async function fetchTimetable() {
            if (!TOKEN) {
                showError("Authentication token not found. Please log in.");
                return;
            }

            try {
                loadingIndicator.style.display = 'block';
                errorMessage.style.display = 'none';
                timetableTable.style.display = 'none';

                const response = await fetch(API_URL, {
                    headers: { 'Authorization': `Bearer ${TOKEN}` }
                });

                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        throw new Error('Unauthorized. Please log in again.');
                    }
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const timetableData = await response.json();

                if (!Array.isArray(timetableData)) {
                     throw new Error('Invalid data format received from server.');
                }

                renderTimetable(timetableData);

            } catch (error) {
                console.error('Error fetching timetable:', error);
                showError(`Failed to load timetable: ${error.message}`);
            } finally {
                loadingIndicator.style.display = 'none';
            }
        }

        function renderTimetable(data) {
            timetableBody.innerHTML = ''; // Clear previous content
            
            // 1. Collect all unique time slots (start_time - end_time)
            let uniqueTimeSlots = new Set();
            data.forEach(entry => {
                uniqueTimeSlots.add(entry.start_time + "-" + entry.end_time);
            });
            
            // Convert to array and sort (lexicographical sort on time strings works for HH:MM format)
            const sortedTimeSlots = Array.from(uniqueTimeSlots).sort();

            // 2. Create a lookup map for easy access: Map<TimeSlot_Key, Map<Day, Entry>>
            const schedule = new Map(); // Key: "HH:MM-HH:MM"
            data.forEach(entry => {
                const timeKey = entry.start_time + "-" + entry.end_time;
                const day = entry.day_of_week; 

                if (!schedule.has(timeKey)) {
                    schedule.set(timeKey, new Map());
                }
                schedule.get(timeKey).set(day, entry);
            });

            // 3. Generate table rows based on determined and sorted time slots
            sortedTimeSlots.forEach(timeKey => {
                const [startTime, endTime] = timeKey.split('-');
                const row = document.createElement('tr');
                
                // Time Slot Header Cell
                row.innerHTML += `<td class="time-slot">${formatTime(startTime)} - ${formatTime(endTime)}</td>`; 

                daysOfWeek.forEach(day => {
                    const entry = schedule.get(timeKey)?.get(day); // Safely get entry for this day/time
                    if (entry) {
                         row.innerHTML += `
                            <td class="subject-cell">
                                ${entry.subject_name || 'N/A'}<br>
                                <span class="teacher-name">${entry.teacher_name || ''} (${entry.room_number || 'N/A'})</span>
                            </td>`;
                    } else {
                        // Empty cell for no class
                        row.innerHTML += `<td>-</td>`;
                    }
                });
                timetableBody.appendChild(row);
            });

             // Show the table only if data was rendered
            if (timetableBody.children.length > 0) {
                 timetableTable.style.display = 'table';
            } else {
                 showError("No timetable data available for the current schedule.");
            }
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            timetableTable.style.display = 'none';
            loadingIndicator.style.display = 'none';
        }

        document.addEventListener('DOMContentLoaded', fetchTimetable);
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>