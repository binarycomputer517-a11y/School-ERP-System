<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Online Learning Management | ERP System</title>
    <style>
        /* --- GLOBAL CLASSIC DOCUMENT STYLES --- */
        body { font-family: 'Times New Roman', serif; margin: 0; padding: 2em; background-color: #EFEFEF; color: #111; line-height: 1.5; }
        .container { max-width: 1300px; margin: auto; padding: 40px; background-color: #FFFFFF; border: 2px solid #333; box-shadow: 6px 6px 0 #AAA; }
        h1 { color: #000; font-weight: bold; text-transform: uppercase; text-align: center; border-bottom: 5px double #000; padding-bottom: 15px; margin-bottom: 30px; font-size: 2.2em; }
        h2 { color: #005A9C; font-weight: bold; text-transform: uppercase; border-bottom: 2px solid #555; padding-bottom: 8px; margin-top: 30px; font-size: 1.5em; }
        h3 { color: #555; font-weight: bold; border-bottom: 1px dotted #999; padding-bottom: 5px; margin-top: 20px; font-size: 1.1em; }
        
        .content-grid { display: grid; grid-template-columns: 450px 1fr; gap: 30px; }
        .card { background-color: #fff; border: 1px solid #333; padding: 20px; margin-bottom: 25px; }
        
        label { display: block; margin-top: 10px; font-weight: bold; color: #333; font-size: 0.85em; }
        input, select, textarea { width: 100%; padding: 8px; margin-top: 5px; box-sizing: border-box; border: 1px solid #555; background-color: #FFFFFF; font-family: inherit; }
        
        .submit-btn { background-color: #005A9C; color: #FFFFFF; font-weight: bold; padding: 12px; border: 2px solid #000; cursor: pointer; margin-top: 20px; box-shadow: 3px 3px 0 #000; width: 100%; text-transform: uppercase; }
        .btn-edit { background-color: #28A745; color: white; border: 1px solid #000; padding: 4px 8px; cursor: pointer; }
        .btn-delete { background-color: #C0392B; color: white; border: 1px solid #000; padding: 4px 8px; cursor: pointer; }
        .btn-secondary-action { font-size: 0.75em; padding: 6px; margin: 2px; background-color: #777; color: white; border: 1px solid #000; cursor: pointer; font-weight: bold; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; border: 1px solid #333; }
        th, td { text-align: left; padding: 10px 12px; border: 1px solid #CCC; font-size: 0.85em; }
        th { background-color: #333; color: #FFFFFF; text-transform: uppercase; }
        tr:nth-child(even) { background-color: #F9F9F9; }
        .helper-text { font-size: 0.7em; color: #d35400; font-style: italic; margin-top: 2px; }
    </style>
</head>
<body>

<div class="container">
    <h1>Academic LMS & Content Scheduler</h1>
    <div style="margin-bottom: 20px;"><a href="/admin-dashboard.html" style="font-weight: bold; color: #005A9C;">&larr; Exit to Dashboard</a></div>

    <div class="content-grid">
        <div class="card">
            <h2 id="form-title">Upload & Schedule</h2>
            <form id="module-form">
                <input type="hidden" id="module-id">

                <label>Module Title:</label>
                <input type="text" id="module-title" required placeholder="Enter lesson or assignment name">

                <label>Content Type:</label>
                <select id="content-type" required>
                    <option value="VIDEO">Video Lecture</option>
                    <option value="PDF">Reading/PDF</option>
                    <option value="QUIZ">Quiz/Assessment</option>
                    <option value="EXTERNAL">External Assignment</option>
                </select>

                <label>File Upload (Prefer for PDF/Docs):</label>
                <input type="file" id="content-file">
                
                <label>OR Resource URL:</label>
                <input type="url" id="content-url" placeholder="https://youtube.com/...">

                <h3>Academic Targeting</h3>
                <label>Course:</label>
                <select id="course-select" required onchange="loadBatches(document.getElementById('batch-select'), this.value)"></select>

                <label>Subject:</label>
                <select id="subject-select" required></select>

                <label>Batch (Optional):</label>
                <select id="batch-select"></select>

                <h3>Scheduling & Expiry</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div>
                        <label>Publish At:</label>
                        <input type="datetime-local" id="publish-date">
                        <div class="helper-text">Students see it after this.</div>
                    </div>
                    <div>
                        <label>Expires At:</label>
                        <input type="datetime-local" id="expiry-date">
                        <div class="helper-text">Hides from students after.</div>
                    </div>
                </div>

                <button type="submit" id="submit-module-btn" class="submit-btn">Publish Content</button>
            </form>
        </div>

        <div class="card">
            <h2>Academic Modules Overview</h2>
            <div style="background:#f4f4f4; padding:10px; border:1px solid #ccc; margin-bottom:10px;">
                <button class="btn-secondary-action" onclick="bulkUpdateStatus()">Bulk Status (F5)</button>
                <button class="btn-secondary-action" onclick="downloadAll()">Download ZIP (F15)</button>
            </div>

            <table>
                <thead>
                    <tr>
                        <th style="width: 30px;">#</th>
                        <th>Module Details</th>
                        <th>Target Group</th>
                        <th>Status/Dates</th>
                        <th style="width:120px;">Actions</th>
                    </tr>
                </thead>
                <tbody id="module-tbody">
                    <tr><td colspan="5" style="text-align:center;">Synchronizing Academic Database...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script src="js/global-config.js"></script>
<script>
    const token = localStorage.getItem('erp-token');
    const API_BASE = '/api/online-learning';
    const ACADEMIC_API = '/api/academicswithfees';

    // Helper to format date for datetime-local input
    function formatDateForInput(dateStr) {
        if (!dateStr) return '';
        const d = new Date(dateStr);
        return d.toLocaleString('sv-SE').replace(' ', 'T').slice(0, 16);
    }

    // --- Loading Logic ---
    async function loadDependencies() {
        try {
            const headers = { 'Authorization': `Bearer ${token}` };
            const [resC, resS] = await Promise.all([
                fetch(`${ACADEMIC_API}/courses`, { headers }),
                fetch(`${ACADEMIC_API}/subjects`, { headers })
            ]);
            const courses = await resC.json();
            const subjects = await resS.json();

            const cSelect = document.getElementById('course-select');
            const sSelect = document.getElementById('subject-select');
            
            cSelect.innerHTML = '<option value="">-- Select Course --</option>';
            courses.forEach(c => cSelect.innerHTML += `<option value="${c.id || c.course_id}">${c.course_name}</option>`);
            
            sSelect.innerHTML = '<option value="">-- Select Subject --</option>';
            subjects.forEach(s => sSelect.innerHTML += `<option value="${s.id || s.subject_id}">${s.subject_name}</option>`);
        } catch (e) { console.error("Sync Error", e); }
    }

    async function loadBatches(selectElement, courseId) {
        if (!courseId) { selectElement.innerHTML = '<option value="">-- All Batches --</option>'; return; }
        try {
            const res = await fetch(`${ACADEMIC_API}/courses/${courseId}/batches`, { headers: { 'Authorization': `Bearer ${token}` } });
            const batches = await res.json();
            selectElement.innerHTML = '<option value="">-- All Batches --</option>';
            batches.forEach(b => selectElement.innerHTML += `<option value="${b.batch_id}">${b.batch_name}</option>`);
        } catch (e) { selectElement.innerHTML = '<option>Error</option>'; }
    }

    async function fetchAndRenderModules() {
        const tbody = document.getElementById('module-tbody');
        try {
            const res = await fetch(`${API_BASE}/modules`, { headers: { 'Authorization': `Bearer ${token}` } });
            const modules = await res.json();
            tbody.innerHTML = modules.map(m => `
                <tr>
                    <td><input type="checkbox" name="module_select" value="${m.id}"></td>
                    <td><b>${m.title}</b><br><small>${m.content_type} | ${m.subject_name || 'N/A'}</small></td>
                    <td>${m.course_name || 'General'}<br><small>${m.batch_name || 'All Batches'}</small></td>
                    <td>
                        <span style="color:${m.status === 'Published' ? 'green' : 'orange'}">${m.status}</span><br>
                        <small>Exp: ${m.expiry_date ? new Date(m.expiry_date).toLocaleDateString() : 'Never'}</small>
                    </td>
                    <td>
                        <button class="btn-edit" onclick="editModule('${m.id}')">Edit</button>
                        <button class="btn-delete" onclick="deleteModule('${m.id}')">Del</button>
                    </td>
                </tr>
            `).join('');
        } catch (e) { tbody.innerHTML = '<tr><td colspan="5">Sync Failed.</td></tr>'; }
    }

    // --- CRUD Operations ---
    document.getElementById('module-form').onsubmit = async (e) => {
        e.preventDefault();
        const id = document.getElementById('module-id').value;
        const formData = new FormData();
        
        formData.append('title', document.getElementById('module-title').value);
        formData.append('content_type', document.getElementById('content-type').value);
        formData.append('content_url', document.getElementById('content-url').value);
        formData.append('course_id', document.getElementById('course-select').value);
        formData.append('subject_id', document.getElementById('subject-select').value);
        formData.append('batch_id', document.getElementById('batch-select').value || "");
        formData.append('publish_date', document.getElementById('publish-date').value);
        formData.append('expiry_date', document.getElementById('expiry-date').value);

        const fileInput = document.getElementById('content-file');
        if (fileInput.files[0]) formData.append('file', fileInput.files[0]);

        try {
            const url = id ? `${API_BASE}/modules/${id}` : `${API_BASE}/modules`;
            const res = await fetch(url, {
                method: id ? 'PUT' : 'POST',
                headers: { 'Authorization': `Bearer ${token}` },
                body: formData
            });

            if (!res.ok) throw new Error("Database update failed");
            alert("âœ… Database Synchronized!");
            location.reload();
        } catch (e) { alert("Error: " + e.message); }
    };

    async function editModule(id) {
        try {
            const res = await fetch(`${API_BASE}/modules/${id}`, { headers: { 'Authorization': `Bearer ${token}` } });
            const data = await res.json();
            
            document.getElementById('module-id').value = data.id;
            document.getElementById('module-title').value = data.title;
            document.getElementById('content-type').value = data.content_type;
            document.getElementById('content-url').value = data.content_url;
            document.getElementById('course-select').value = data.course_id;
            document.getElementById('subject-select').value = data.subject_id;
            
            await loadBatches(document.getElementById('batch-select'), data.course_id);
            document.getElementById('batch-select').value = data.batch_id || "";
            
            document.getElementById('publish-date').value = formatDateForInput(data.publish_date || data.created_at);
            document.getElementById('expiry-date').value = formatDateForInput(data.expiry_date);

            document.getElementById('submit-module-btn').textContent = "Update & Reschedule";
            document.getElementById('form-title').textContent = "Update Parameters";
            window.scrollTo({top: 0, behavior: 'smooth'});
        } catch (e) { alert("Failed to fetch record."); }
    }

    async function deleteModule(id) {
        if(!confirm("Remove this module permanently?")) return;
        try {
            await fetch(`${API_BASE}/modules/${id}`, { 
                method: 'DELETE', 
                headers: { 'Authorization': `Bearer ${token}` } 
            });
            fetchAndRenderModules();
        } catch (e) { alert("Delete failed"); }
    }

    function bulkUpdateStatus() { alert("F5: Processing bulk status change..."); }
    function downloadAll() { alert("F15: Generating ZIP archive of academic resources..."); }

    window.onload = () => { loadDependencies(); fetchAndRenderModules(); }
</script>
</body>
</html>