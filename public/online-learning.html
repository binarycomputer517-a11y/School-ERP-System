<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Online Learning Management</title>
    <style>
        /* --- GLOBAL CLASSIC DOCUMENT STYLES --- */
        body {
            font-family: 'Times New Roman', serif;
            margin: 0;
            padding: 2em;
            background-color: #EFEFEF; 
            color: #111; 
            line-height: 1.5;
        }
        .container {
            max-width: 1200px;
            margin: auto;
            padding: 40px;
            background-color: #FFFFFF; 
            border: 2px solid #333; 
            box-shadow: 6px 6px 0 #AAA; 
            border-radius: 0; 
        }
        h1 {
            color: #000;
            font-weight: bold;
            text-transform: uppercase;
            text-align: center;
            border-bottom: 5px double #000; 
            padding-bottom: 15px;
            margin-top: 0;
            margin-bottom: 30px;
            font-size: 2.2em;
        }
        h2 {
            color: #005A9C; 
            font-weight: bold;
            text-transform: uppercase;
            border-bottom: 2px solid #555;
            padding-bottom: 8px;
            margin-top: 30px;
            font-size: 1.5em;
        }
        h3 {
            color: #555;
            font-weight: bold;
            border-bottom: 1px dotted #999;
            padding-bottom: 5px;
            margin-top: 20px;
            font-size: 1.2em;
        }
        
        /* --- NAVIGATION --- */
        .nav-links {
            text-align: left;
            margin-bottom: 30px;
        }
        .nav-links a {
            color: #005A9C;
            text-decoration: underline;
            font-weight: bold;
        }
        .nav-links a:hover {
            color: #C0392B;
        }

        /* --- MODULE LAYOUT --- */
        .content-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
        }
        .card {
            background-color: #fff;
            border: 1px solid #333;
            padding: 20px;
            border-radius: 0;
            margin-bottom: 25px;
        }
        
        /* --- FORMS & INPUTS --- */
        label { display: block; margin-top: 10px; font-weight: bold; color: #333; font-size: 0.9em; }
        input[type="text"], input[type="url"], input[type="date"], input[type="number"], select, textarea { 
            width: 100%; 
            padding: 8px; 
            margin-top: 5px; 
            box-sizing: border-box; 
            border: 1px solid #555;
            border-radius: 0; 
            background-color: #FFFFFF;
        }
        .submit-btn { 
            background-color: #005A9C;
            color: #FFFFFF; 
            font-weight: bold; 
            padding: 8px 15px; 
            border: 2px solid #000; 
            border-radius: 0; 
            cursor: pointer; 
            margin-top: 15px;
            box-shadow: 2px 2px 0 #000;
        }
        .btn-edit, .btn-delete, .btn-secondary-action {
             font-size: 0.75em; padding: 4px 8px; margin: 2px;
             color: white;
             border: 1px solid #000;
             box-shadow: 1px 1px 0 #000;
             transition: none;
             cursor: pointer;
        }
        .btn-edit { background-color: #28A745; }
        .btn-delete { background-color: #C0392B; }
        .btn-secondary-action { background-color: #777; }
        
        /* --- TABLES --- */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; border: 1px solid #333; }
        th, td { text-align: left; padding: 10px 12px; border-bottom: 1px solid #CCC; font-size: 0.9em; }
        th { background-color: #333; color: #FFFFFF; font-weight: bold; text-transform: uppercase; border-color: #333; }
        tr:nth-child(even) { background-color: #F8F8F8; }
        .placeholder-message {
            text-align: center;
            padding: 20px 0;
            color: #777;
        }
        .modal-content {
            background-color: #FFFFFF; 
            padding: 30px; 
            border: 3px solid #C0392B; 
            width: 90%; 
            max-width: 650px; 
            border-radius: 0; 
            position: relative; 
            box-shadow: 8px 8px 0 #000;
        }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); justify-content: center; align-items: center; z-index: 2000; }
        .close-btn { color: #000; position: absolute; top: 10px; right: 20px; font-size: 30px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>
<script>
    // --- Global Configuration ---
    const token = localStorage.getItem('erp-token');
    const userRole = localStorage.getItem('user-role');

    // FIX: Client-side guard check for Super Admin, Admin, or Teacher
    if (!token || (userRole !== 'Super Admin' && userRole !== 'Admin' && userRole !== 'Teacher')) { 
        // window.location.href = '/login'; 
    }
    const authHeaders = { 'Authorization': `Bearer ${token}` };
    const ACADEMICS_API_BASE = '/api/academicswithfees'; 
    const ONLINE_LEARNING_API_BASE = '/api/online-learning';


    // --- Helper for API Calls (Centralized Error Handling) ---
    async function handleApi(url, options = {}) {
        options.headers = { ...authHeaders, 'Content-Type': 'application/json', ...options.headers };
        const response = await fetch(url, options);
        if (!response.ok) {
            const errorBody = await response.json().catch(() => ({ message: 'No detailed response body.' }));
            throw new Error(`API call failed with status: ${response.status} (${response.statusText}). Message: ${errorBody.message}`);
        }
        return response.json();
    }
    
    // --- Dependency Loading (F11, F4, F27) ---

    /**
     * Loads Batches, correctly filtered by Course. (F4, F27 dependency)
     */
    async function loadBatches(selectElement, courseId) {
        if (!selectElement) return;
        selectElement.innerHTML = '<option value="">Loading Batches...</option>';
        selectElement.disabled = true;

        if (!courseId) {
            selectElement.innerHTML = '<option value="">-- Select Course First --</option>';
            return;
        }

        try {
            // Fetch batches from the live endpoint
            const batches = await handleApi(`${ACADEMICS_API_BASE}/courses/${courseId}/batches`); 
            
            selectElement.innerHTML = '<option value="">-- Select Target Batch --</option>';
            batches.forEach(b => {
                selectElement.innerHTML += `<option value="${b.batch_id}">${b.batch_name} (${b.batch_code})</option>`;
            });
            selectElement.disabled = false;
        } catch (error) {
            console.error('Error loading batches:', error);
            selectElement.innerHTML = '<option value="">Error Loading Batches</option>';
        }
    }


    /**
     * Loads Courses and Subjects (Main page dependencies).
     */
    async function loadDependencies() {
        const courseSelect = document.getElementById('course-select');
        const subjectSelect = document.getElementById('subject-select');
        const prerequisiteSelect = document.getElementById('prerequisite-subject-select'); 

        const assignCourseSelect = document.getElementById('assign-course-select'); 
        const unassignCourseSelect = document.getElementById('unassign-course-select'); 
        const assignBatchSelect = document.getElementById('assign-batch-select');
        const unassignBatchSelect = document.getElementById('unassign-batch-select'); 
        
        try {
            // Fetch live data from the backend
            const [courses, subjects] = await Promise.all([
                handleApi(`${ACADEMICS_API_BASE}/courses`),
                handleApi(`${ACADEMICS_API_BASE}/subjects`)
            ]);

            // Populate main form dropdowns
            courseSelect.innerHTML = '<option value="">-- Select Course --</option>';
            courses.forEach(c => courseSelect.innerHTML += `<option value="${c.course_id}">${c.course_name}</option>`);

            subjectSelect.innerHTML = '<option value="">-- Select Subject --</option>';
            subjects.forEach(s => subjectSelect.innerHTML += `<option value="${s.subject_id}">${s.subject_name}</option>`);
            
            // Populate Subjects for Prerequisite Modal (F11)
            if (prerequisiteSelect) {
                 prerequisiteSelect.innerHTML = '<option value="">-- Select Prerequisite Subject --</option>';
                 subjects.forEach(s => prerequisiteSelect.innerHTML += `<option value="${s.subject_id}">${s.subject_name}</option>`);
            }
            
            // Populate Course Select for Modals (F4, F27)
            const populateCourseSelect = (selectElement) => {
                 if (!selectElement) return;
                 selectElement.innerHTML = '<option value="">-- Select Course --</option>';
                 courses.forEach(c => selectElement.innerHTML += `<option value="${c.course_id}">${c.course_name}</option>`);
            };

            populateCourseSelect(assignCourseSelect);
            populateCourseSelect(unassignCourseSelect);
            

            // Initialize modal batch selects 
            if (assignBatchSelect) assignBatchSelect.innerHTML = '<option value="">Select Course First</option>';
            if (unassignBatchSelect) unassignBatchSelect.innerHTML = '<option value="">Select Course First</option>';
            if (assignBatchSelect) assignBatchSelect.disabled = true;
            if (unassignBatchSelect) unassignBatchSelect.disabled = true;
            
            // Event listener for Assignment Modal Course Selection
            if (assignCourseSelect) {
                assignCourseSelect.addEventListener('change', (e) => loadBatches(assignBatchSelect, e.target.value));
            }
            // Event listener for Unassignment Modal Course Selection
            if (unassignCourseSelect) {
                unassignCourseSelect.addEventListener('change', (e) => loadBatches(unassignBatchSelect, e.target.value));
            }


        } catch (error) {
            console.error('Error loading dependencies:', error);
            alert('Could not load course/subject lists from the server.');
        }
    }

    /**
     * Loads the list of modules for dropdowns (F27, F8, F11, F14).
     */
    async function loadModuleDropdowns() {
        const unassignModuleSelect = document.getElementById('unassign-module-select');
        const gradingModuleSelect = document.getElementById('grading-module-select');
        const prerequisiteModuleSelect = document.getElementById('prerequisite-module-select'); 
        const timeLimitModuleSelect = document.getElementById('time-limit-module-select'); 

        if (!unassignModuleSelect && !gradingModuleSelect && !prerequisiteModuleSelect && !timeLimitModuleSelect) return;
        
        try {
            const modules = await handleApi(`${ONLINE_LEARNING_API_BASE}/modules`); 
            
            const populateSelect = (selectElement, placeholder) => {
                if (!selectElement) return;
                selectElement.innerHTML = `<option value="">-- ${placeholder} --</option>`;
                modules.forEach(m => {
                    selectElement.innerHTML += `<option value="${m.id}">${m.title}</option>`;
                });
            };

            populateSelect(unassignModuleSelect, 'Select Module to Unassign');
            populateSelect(gradingModuleSelect, 'Select Module for Grading');
            populateSelect(prerequisiteModuleSelect, 'Select Target Module');
            populateSelect(timeLimitModuleSelect, 'Select Target Module');

        } catch (error) {
            console.error('Error loading module dropdown lists:', error);
        }
    }
    
    /**
     * Fetches and renders all existing online courses/modules.
     */
    async function fetchAndRenderModules() {
        const tbody = document.getElementById('module-tbody');
        tbody.innerHTML = '<tr><td colspan="5" class="placeholder-message">Loading online modules...</td></tr>';

        try {
            const modules = await handleApi(`${ONLINE_LEARNING_API_BASE}/modules`); 
            
            tbody.innerHTML = '';
            if (modules.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="placeholder-message">No online learning modules defined.</td></tr>';
                return;
            }

            modules.forEach(m => {
                const row = `<tr>
                    <td><input type="checkbox" name="module_select" value="${m.id}"> ${m.title}</td>
                    <td>${m.course_name}</td>
                    <td>${m.subject_name}</td>
                    <td>${m.content_type}</td>
                    <td class="actions" data-module-id="${m.id}" data-course-id="${m.course_id}">
                        <button class="btn-edit" onclick="editModule('${m.id}')">Edit</button>
                        <button class="btn-delete" onclick="deleteModule('${m.id}')">Delete</button>
                        <button class="btn-secondary-action" onclick="viewStats('${m.id}')">Stats (F3)</button>
                    </td>
                </tr>`;
                tbody.innerHTML += row;
            });

        } catch (error) {
            console.error('Error fetching modules:', error);
            tbody.innerHTML = `<tr><td colspan="5" class="placeholder-message" style="color: #C0392B;">Error loading modules: ${error.message}</td></tr>`;
        }
    }

    // --- Feature Implementations (F1 - F30) ---
    
    // F1 & F2: CRUD Implementation
    window.submitModule = async function(e) {
        e.preventDefault();
        
        const form = document.getElementById('module-form');
        const submitBtn = document.getElementById('submit-module-btn');
        submitBtn.disabled = true;

        const formData = {
            id: document.getElementById('module-id').value,
            title: document.getElementById('module-title').value,
            content_type: document.getElementById('content-type').value,
            content_url: document.getElementById('content-url').value,
            course_id: document.getElementById('course-select').value,
            subject_id: document.getElementById('subject-select').value,
            status: 'Published' 
        };

        const isUpdate = !!formData.id;
        const url = isUpdate ? `${ONLINE_LEARNING_API_BASE}/modules/${formData.id}` : `${ONLINE_LEARNING_API_BASE}/modules`;
        const method = isUpdate ? 'PUT' : 'POST';

        try {
            const payload = isUpdate ? formData : Object.fromEntries(Object.entries(formData).filter(([key]) => key !== 'id'));
            await handleApi(url, { method: method, body: JSON.stringify(payload) });
            
            alert(`✅ Module ${isUpdate ? 'updated' : 'created'} successfully!`);
            form.reset();
            document.getElementById('module-id').value = '';
            fetchAndRenderModules();
            loadModuleDropdowns(); 

        } catch (error) {
            alert(`❌ Error saving module: ${error.message}`);
        } finally {
            submitBtn.disabled = false;
        }
    }

    window.editModule = function(moduleId) {
        alert(`Feature 1: Loading Module ID ${moduleId} for editing. (A real fetch request would populate the form).`);
    }
    window.deleteModule = async function(moduleId) {
        if (!confirm(`Feature 2: Confirm deletion of Module ID ${moduleId}? This is irreversible.`)) return;
        try {
            await handleApi(`${ONLINE_LEARNING_API_BASE}/modules/${moduleId}`, { method: 'DELETE' });
            alert(`Module ${moduleId} deleted.`);
            fetchAndRenderModules();
            loadModuleDropdowns(); 
        } catch (error) {
            alert(`❌ Error deleting module: ${error.message}`);
        }
    }

    // F3: View Usage Statistics
    window.viewStats = function(moduleId) {
        alert(`Feature 3: Displaying detailed Student Usage Statistics for Module ID ${moduleId}.\n(Shows individual completion rate, average time spent, quiz attempts, and common drop-off points).`);
    }

    // F5: Bulk Update Module Status
    window.bulkUpdateStatus = function() {
        const selectedModules = Array.from(document.querySelectorAll('#module-tbody input[name="module_select"]:checked'))
                                   .map(checkbox => checkbox.value);
        
        if (selectedModules.length === 0) {
            alert('Please select one or more modules in the table before performing a bulk action.');
            return;
        }

        document.getElementById('bulk-status-module-ids').value = selectedModules.join(',');
        document.getElementById('bulk-status-count').textContent = selectedModules.length;
        document.getElementById('bulk-status-modal').style.display = 'flex';
    }
    
    window.submitBulkStatus = async function(e) {
        e.preventDefault();
        const submitBtn = document.getElementById('submit-bulk-status-btn');
        submitBtn.disabled = true;

        const moduleIds = document.getElementById('bulk-status-module-ids').value.split(',').filter(id => id);
        const action = document.getElementById('bulk-action-select').value;
        
        if (!action) {
             alert('Please select an action.');
             submitBtn.disabled = false;
             return;
        }

        try {
            const result = await handleApi(`${ONLINE_LEARNING_API_BASE}/modules/bulk-status`, { 
                method: 'POST', 
                body: JSON.stringify({ module_ids: moduleIds, action: action }) 
            });
            
            alert(`✅ Bulk action "${action}" completed for ${result.updated_count} module(s) successfully!`);
            document.getElementById('bulk-status-modal').style.display = 'none';
            fetchAndRenderModules(); 
        } catch (error) {
            alert(`❌ Failed to execute bulk action: ${error.message}`);
        } finally {
            submitBtn.disabled = false;
        }
    }


    // F6: Versioning
    window.viewVersioning = function() {
        alert('Feature 6: Opening dedicated interface to view content history, compare versions with diff checking, and perform version rollbacks.');
    }

    // F7: Quiz Question Bank
    window.manageQuizBank = function() {
        alert('Feature 7: Redirecting to Quiz Question Bank management interface for creating/editing questions and managing assessment pools.');
    }
    
    // F8: Automated Grading Setup
    window.configureGrading = function() {
        const moduleId = document.getElementById('module-id').value;
        if (moduleId && moduleId !== '') { 
             document.getElementById('grading-module-select').value = moduleId;
        }
        document.getElementById('grading-modal').style.display = 'flex';
    }
    
    window.submitGradingConfig = async function(e) {
        e.preventDefault();
        const submitBtn = document.getElementById('submit-grading-btn');
        submitBtn.disabled = true;
        
        const moduleId = document.getElementById('grading-module-select').value;
        const minPassScore = document.getElementById('min-pass-score').value;
        const autoSync = document.getElementById('auto-grade-sync').checked;

        if (!moduleId) {
            alert("Please select a module.");
            submitBtn.disabled = false;
            return;
        }

        try {
            await handleApi(`${ONLINE_LEARNING_API_BASE}/modules/${moduleId}/grading-config`, { 
                method: 'PUT', 
                body: JSON.stringify({ 
                    minimum_pass_score: minPassScore,
                    auto_sync_grades: autoSync
                }) 
            });

            alert(`✅ Grading configuration saved for Module ID ${moduleId}: Pass Score ${minPassScore}%, Auto-Sync ${autoSync ? 'ON' : 'OFF'}.`);
            document.getElementById('grading-modal').style.display = 'none';
        } catch (error) {
            alert(`❌ Failed to save grading configuration: ${error.message}`);
        } finally {
            submitBtn.disabled = false;
        }
    }


    // F10: Cloning Module
    window.cloneModule = async function(moduleId) {
        const targetId = document.getElementById('module-id').value || moduleId;
        if (!targetId || targetId === '') {
            alert('Please select or load an existing module to clone.');
            return;
        }
        if (!confirm(`Confirm cloning Module ID ${targetId}? A new draft copy will be created.`)) return;
        try {
            // Need to fetch original module data first
            const originalModule = await handleApi(`${ONLINE_LEARNING_API_BASE}/modules/${targetId}`);
            const payload = {
                title: `[CLONE] ${originalModule.title} (Draft)`, 
                content_type: originalModule.content_type,
                content_url: originalModule.content_url,
                course_id: originalModule.course_id,
                subject_id: originalModule.subject_id,
                status: 'Draft' 
            };
            await handleApi(`${ONLINE_LEARNING_API_BASE}/modules`, { method: 'POST', body: JSON.stringify(payload) });
            alert(`✅ Module cloned successfully! New module titled "${payload.title}" created.`);
            fetchAndRenderModules(); 
            loadModuleDropdowns();
        } catch (error) {
            console.error('Error cloning module:', error);
            alert(`❌ Failed to clone module: ${error.message}.`);
        }
    }
    
    // F11: Set Module Prerequisites
    window.setPrerequisites = function(moduleId) {
        const targetId = document.getElementById('module-id').value || moduleId;
        document.getElementById('prerequisite-module-select').value = targetId;
        document.getElementById('prerequisite-modal').style.display = 'flex';
    }

    window.submitPrerequisites = async function(e) {
        e.preventDefault();
        const submitBtn = document.getElementById('submit-prerequisite-btn');
        submitBtn.disabled = true;
        
        const moduleId = document.getElementById('prerequisite-module-select').value;
        const prerequisiteSubjectId = document.getElementById('prerequisite-subject-select').value;
        const minScore = document.getElementById('min-prerequisite-score').value;

        if (!moduleId || !prerequisiteSubjectId) {
            alert("Please select a module and a prerequisite subject.");
            submitBtn.disabled = false;
            return;
        }

        try {
            await handleApi(`${ONLINE_LEARNING_API_BASE}/modules/${moduleId}/prerequisites`, { 
                method: 'PUT', 
                body: JSON.stringify({ 
                    prerequisite_subject_id: prerequisiteSubjectId,
                    minimum_score: minScore
                }) 
            });

            alert(`✅ Prerequisites saved for Module ID ${moduleId}. Required score: ${minScore}%.`);
            document.getElementById('prerequisite-modal').style.display = 'none';
        } catch (error) {
            alert(`❌ Failed to save prerequisites: ${error.message}`);
        } finally {
            submitBtn.disabled = false;
        }
    }
    
    // F12: Generating QR code
    window.generateQrCode = function(moduleId) {
        const targetId = document.getElementById('module-id').value || moduleId;
        alert(`Feature 12: Generating unique QR Code image for direct student access to Module ID ${targetId}. (A real implementation returns an image file or a public link).`);
    }

    // F13: Viewing student discussion threads
    window.viewDiscussions = function(moduleId) {
        const targetId = document.getElementById('module-id').value || moduleId;
        alert(`Feature 13: Redirecting to integrated Forum/Discussion tool for Module ID ${targetId} to moderate student conversations.`);
    }

    // F14: Setting a time limit
    window.setTimeLimit = function(moduleId) {
        const targetId = document.getElementById('module-id').value || moduleId;
        document.getElementById('time-limit-module-select').value = targetId;
        document.getElementById('time-limit-modal').style.display = 'flex';
    }

    window.submitTimeLimit = async function(e) {
        e.preventDefault();
        const submitBtn = document.getElementById('submit-time-limit-btn');
        submitBtn.disabled = true;

        const moduleId = document.getElementById('time-limit-module-select').value;
        const limitMinutes = document.getElementById('time-limit-minutes').value;
        const enforce = document.getElementById('enforce-limit').checked;

        if (!moduleId || !limitMinutes) {
            alert("Please select a module and specify a time limit.");
            submitBtn.disabled = false;
            return;
        }

        try {
            await handleApi(`${ONLINE_LEARNING_API_BASE}/modules/${moduleId}/time-limit`, { 
                method: 'PUT', 
                body: JSON.stringify({ 
                    limit_minutes: parseInt(limitMinutes, 10),
                    enforce_limit: enforce
                }) 
            });

            alert(`✅ Time limit saved for Module ID ${moduleId}: ${limitMinutes} minutes. Enforcement: ${enforce ? 'ON' : 'OFF'}.`);
            document.getElementById('time-limit-modal').style.display = 'none';
        } catch (error) {
            alert(`❌ Failed to save time limit: ${error.message}`);
        } finally {
            submitBtn.disabled = false;
        }
    }

    // F15: Initiating bulk download
    window.downloadAll = async function() {
        if (!confirm('Feature 15: Initiate bulk download preparation? This runs in the background and may take time.')) return;
        
        const downloadBtn = document.querySelector('[onclick="downloadAll()"]');
        downloadBtn.disabled = true;

        try {
            const result = await handleApi(`${ONLINE_LEARNING_API_BASE}/resources/download-bulk`, { method: 'POST' });

            alert(`✅ Bulk download process initiated! ${result.message}\nJob ID: ${result.job_id}.\n(A real app would send a zip file link via email/notification).`);
        } catch (error) {
            alert(`❌ Failed to initiate bulk download: ${error.message}`);
        } finally {
            downloadBtn.disabled = false;
        }
    }


    // F16: Module Re-sequencing
    window.resequenceModules = function() {
        alert('Feature 16: Opening drag-and-drop interface for reordering modules within a subject/course. (Requires a dedicated UI and API to submit the new sequence list).');
    }
    
    // F17: Notifying teacher/admin on completion
    window.notifyCompletion = function(moduleId) {
        const targetId = document.getElementById('module-id').value || moduleId;
        alert(`Feature 17: Toggling notification settings for completion of Module ID ${targetId}. (PUT request to toggle a boolean field in the DB).`);
    }

    // F18: Bulk Import Modules
    window.bulkImport = function() {
        document.getElementById('import-modal').style.display = 'flex';
    }

    window.submitBulkImport = async function(e) {
        e.preventDefault();
        const submitBtn = document.getElementById('submit-import-btn');
        submitBtn.disabled = true;

        const rawData = document.getElementById('import-data-input').value;
        const format = document.getElementById('import-format-select').value;
        let module_data = [];

        try {
            if (format === 'JSON') {
                module_data = JSON.parse(rawData);
            } else if (format === 'CSV') {
                const lines = rawData.trim().split('\n').filter(line => line.trim() !== '');
                if (lines.length > 0) {
                     const dataLines = lines[0].toLowerCase().includes('title') ? lines.slice(1) : lines; 
                     const headers = ['title', 'content_url', 'course_id', 'subject_id'];
                     
                     module_data = dataLines.map(line => {
                         const values = line.split(',');
                         return headers.reduce((obj, header, index) => {
                             obj[header] = values[index] ? values[index].trim() : null;
                             return obj;
                         }, {});
                     });
                }
            }

            if (!Array.isArray(module_data) || module_data.length === 0 || module_data.some(m => !m.title || !m.content_url)) {
                throw new Error('Parsed data is empty or missing required fields (title, content_url).');
            }

            const result = await handleApi(`${ONLINE_LEARNING_API_BASE}/modules/import`, { 
                method: 'POST', 
                body: JSON.stringify({ module_data }) 
            });

            alert(`✅ Import successful: ${result.message} (Attempted: ${result.imported_count})`);
            document.getElementById('import-modal').style.display = 'none';
            document.getElementById('bulk-import-form').reset();
            fetchAndRenderModules();
            loadModuleDropdowns();
        } catch (error) {
            alert(`❌ Import failed: ${error.message}. Please check data format and API logs.`);
        } finally {
            submitBtn.disabled = false;
        }
    }

    // F20: Viewing student reports
    window.viewReportedIssues = function() {
        document.getElementById('reports-modal').style.display = 'flex';
        fetchAndRenderReports();
    }
    
    // F21: Content Tagging/Metadata
    window.addTags = async function(moduleId) {
        const targetId = document.getElementById('module-id').value || moduleId;
        alert(`Feature 21: Opening interface to add content tags/metadata (e.g., Difficulty: Intermediate, Topic: Trigonometry) for Module ID ${targetId}.`);
    }

    // F24: Linking to Library Resource
    window.linkLibraryResource = async function(moduleId) {
        const targetId = document.getElementById('module-id').value || moduleId;
        alert(`Feature 24: Opening modal to search and link Module ID ${targetId} to a resource (e.g., a specific textbook) in the central library system.`);
    }
    
    // F25: Generating completion certificates
    window.generateCertificates = function(moduleId) {
        const targetId = document.getElementById('module-id').value || moduleId;
        alert(`Feature 25: Initiating bulk generation of PDF completion certificates for students who passed Module ID ${targetId}.`);
    }
    
    // F26: Preview as Student
    window.previewAsStudent = function(moduleId) {
        const targetId = document.getElementById('module-id').value || moduleId;
        alert(`Feature 26: Opening Module ID ${targetId} in a new window simulating the student's restricted viewing experience.`);
    }

    // F27: Bulk Unassign
    window.bulkUnassign = function() {
        document.getElementById('unassign-modal').style.display = 'flex';
    }

    window.submitUnassignment = async function(e) {
        e.preventDefault();
        const submitBtn = document.getElementById('submit-unassignment-btn');
        submitBtn.disabled = true;

        const type = document.getElementById('unassign-type-select').value;
        const moduleId = document.getElementById('unassign-module-select').value;
        const targetBatchId = document.getElementById('unassign-batch-select').value;
        const studentInput = document.getElementById('unassign-student-input').value;

        const payload = {
            module_id: moduleId,
            target_type: type,
            target_batch_id: type === 'batch' ? targetBatchId : null,
            target_students: type === 'individual' ? studentInput.split(/[\s,]+/).filter(s => s) : null
        };
        
        if (!moduleId) { alert('Please select a module to unassign.'); submitBtn.disabled = false; return; }
        if (type === 'batch' && !payload.target_batch_id) { alert('Please select a batch.'); submitBtn.disabled = false; return; }
        if (type === 'individual' && payload.target_students.length === 0) { alert('Please enter at least one student ID/Roll No.'); submitBtn.disabled = false; return; }

        try {
            const result = await handleApi(`${ONLINE_LEARNING_API_BASE}/unassign`, { 
                method: 'POST', 
                body: JSON.stringify(payload) 
            });
            
            alert(`✅ Bulk unassignment completed: ${result.unassigned_count} assignments removed.`);
            document.getElementById('unassign-modal').style.display = 'none';
            document.getElementById('bulk-unassignment-form').reset();
        } catch (error) {
            alert(`❌ Error unassigning module: ${error.message}`);
        } finally {
            submitBtn.disabled = false;
        }
    }
    
    // F28: Content Review Workflow
    window.startReviewWorkflow = function(moduleId) {
        const targetId = document.getElementById('module-id').value || moduleId;
        alert(`Feature 28: Initiating content review workflow for Module ID ${targetId}. (E.g., assign to editor/QA team and track progress to 'Published').`);
    }

    // F30: AI Content Recommendation
    window.generateRecommendation = function() {
        alert('Feature 30: Generating AI-driven recommendations for next module topics or improvements based on current content and student engagement data.');
    }
    
    // --- Other Global Functions (F4, F19, F22, F23, F29) ---
    window.openAssignmentModal = function(moduleId, moduleTitle) {
        alert(`Feature 4: Opening Bulk Assignment Modal for ${moduleTitle}. (The form is a mock assignment interface).`);
        document.getElementById('assignment-module-id').value = moduleId;
        document.getElementById('modal-module-title').textContent = moduleTitle;
        document.getElementById('assign-modal').style.display = 'flex';
    }
    window.accessibilityReview = function(moduleId) {
        alert(`Feature 19: Running automated accessibility check (WCAG/Section 508) for Module ID ${moduleId} and flagging issues in content elements.`);
    }
    window.setExpiration = function(moduleId) {
        alert(`Feature 22: Setting expiration date for Module ID ${moduleId} (e.g., disabling access after the end of the semester).`);
    }
    window.switchLocalization = function() {
        alert('Feature 29: Toggling module content to an alternate language setting for localization testing/editing.');
    }
    
    window.viewAssociatedMarks = function(moduleId) {
        const targetId = document.getElementById('module-id').value || moduleId;
        alert(`Feature 23: Redirecting to Marksheet/Gradebook view filtered by Module ID ${targetId} to see aggregated student scores.`);
    }
    
    
    // Placeholder for fetching student reports (F20)
    async function fetchAndRenderReports() {
        const tbody = document.getElementById('reports-tbody');
        if (!tbody) return;

        tbody.innerHTML = '<tr><td colspan="4">Fetching latest reports...</td></tr>';
        
        try {
            // NOTE: Using a client-side mock for reports, as this is a read-only list not critical for API routing structure
            const reports = [
                { module_name: 'Introduction to Calculus', type: 'Broken Link', details: 'Content URL leads to a 404 page.', reported_on: '2025-10-20' },
                { module_name: 'Advanced Thermodynamics', type: 'Quiz Error', details: 'Question 5 has incorrect answer marked as correct.', reported_on: '2025-10-21' },
            ];
            
            tbody.innerHTML = '';
            if (reports.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="placeholder-message">No student reports found.</td></tr>';
                return;
            }
            reports.forEach(r => {
                const row = `<tr>
                    <td>${r.module_name}</td>
                    <td>${r.type}</td>
                    <td>${r.details}</td>
                    <td>${r.reported_on}</td>
                </tr>`;
                tbody.innerHTML += row;
            });
        } catch (error) {
            // If fetching reports from server fails (unimplemented route), show error
            tbody.innerHTML = `<tr><td colspan="4" style="color: #C0392B;">Error loading reports: ${error.message}</td></tr>`;
        }
    }
    
    // Initial calls and Event Listeners wrapped in DOMContentLoaded
    document.addEventListener('DOMContentLoaded', () => {
        const moduleForm = document.getElementById('module-form');
        if (moduleForm) {
            moduleForm.addEventListener('submit', window.submitModule);
        }
        
        document.getElementById('bulk-status-form')?.addEventListener('submit', window.submitBulkStatus);
        document.getElementById('grading-config-form')?.addEventListener('submit', window.submitGradingConfig);
        document.getElementById('prerequisite-form')?.addEventListener('submit', window.submitPrerequisites);
        document.getElementById('time-limit-form')?.addEventListener('submit', window.submitTimeLimit);
        document.getElementById('bulk-import-form')?.addEventListener('submit', window.submitBulkImport);
        document.getElementById('bulk-unassignment-form')?.addEventListener('submit', window.submitUnassignment);
        
        // Setup visibility toggles for modals (F4, F27)
        const setupModalToggles = (typeSelectId, batchGroupId, studentGroupId) => {
            const typeSelect = document.getElementById(typeSelectId);
            const batchGroup = document.getElementById(batchGroupId);
            const studentGroup = document.getElementById(studentGroupId);

            if (typeSelect) {
                const toggleFields = () => {
                    if (typeSelect.value === 'batch') {
                        batchGroup.style.display = 'block';
                        studentGroup.style.display = 'none';
                    } else if (typeSelect.value === 'individual') {
                        batchGroup.style.display = 'none';
                        studentGroup.style.display = 'block';
                    } else {
                        batchGroup.style.display = 'block'; // Default to batch or initial state
                        studentGroup.style.display = 'none';
                    }
                };
                
                typeSelect.addEventListener('change', toggleFields);
                toggleFields(); 
            }
        };

        setupModalToggles('unassign-type-select', 'unassign-batch-select-group', 'unassign-student-select-group'); // F27
        setupModalToggles('assignment-type-select', 'batch-select-group', 'student-select-group'); // F4


        // Initial data loads
        loadDependencies();
        loadModuleDropdowns(); 
        fetchAndRenderModules();
    });
    
</script>


<div class="container">
    <h1>Online Learning Management (LMS)</h1>
    <div class="nav-links">
        <a href="/admin-dashboard.html">← Back to Dashboard</a>
    </div>

    <div class="content-grid">
        
        <div class="card">
            <h2>Content Uploader</h2>
            <form id="module-form" onsubmit="submitModule(event)">
                <input type="hidden" id="module-id">

                <label for="module-title">Module Title/Name:</label>
                <input type="text" id="module-title" required>

                <label for="content-type">Content Type:</label>
                <select id="content-type" required>
                    <option value="VIDEO">Video Lecture</option>
                    <option value="PDF">Reading/PDF</option>
                    <option value="QUIZ">Quiz/Assessment</option>
                    <option value="EXTERNAL">External Link</option>
                </select>

                <label for="content-url">Content URL/Link:</label>
                <input type="url" id="content-url" placeholder="e.g., https://youtube.com/..." required>

                <h3>Assignment</h3>
                <label for="course-select">Assign to Course:</label>
                <select id="course-select" required>
                    <option value="">Loading...</option>
                </select>

                <label for="subject-select">Assign to Subject:</label>
                <select id="subject-select" required>
                    <option value="">Loading...</option>
                </select>

                <button type="submit" id="submit-module-btn" class="submit-btn">Publish Module</button>
            </form>
            
            <h3 style="margin-top: 25px;">Quick Actions (F4, F10, F27-F30)</h3>
            <div id="side-actions" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button class="btn-secondary-action" onclick="openAssignmentModal(document.getElementById('module-id').value || '', 'Current Module')">Assign to Specific Batch (F4)</button>
                <button class="btn-secondary-action" onclick="cloneModule(document.getElementById('module-id').value || '')">Clone Module (F10)</button>
                <button class="btn-secondary-action" onclick="bulkUnassign()">Bulk Unassign (F27)</button>
                <button class="btn-secondary-action" onclick="startReviewWorkflow(document.getElementById('module-id').value || '')">Review Workflow (F28)</button>
                <button class="btn-secondary-action" onclick="addTags(document.getElementById('module-id').value || '')">Content Tags (F21)</button>
                <button class="btn-secondary-action" onclick="configureGrading()">Grade Setup (F8)</button>
                <button class="btn-secondary-action" onclick="generateRecommendation()">AI Recommend (F30)</button>
            </div>
        </div>

        <div class="card">
            <h2>Published Modules Overview</h2>
            
            <div id="table-actions-container" style="margin-bottom: 15px; border: 1px solid #CCC; padding: 10px; background-color: #F8F8F8;">
                <button class="btn-secondary-action" onclick="bulkUpdateStatus()">Bulk Status (F5)</button>
                <button class="btn-secondary-action" onclick="resequenceModules()">Re-sequence (F16)</button>
                <button class="btn-secondary-action" onclick="bulkImport()">Bulk Import (F18)</button>
                <button class="btn-secondary-action" onclick="downloadAll()">Download All (F15)</button>
                <button class="btn-secondary-action" onclick="viewVersioning()">View Versioning (F6)</button>
                <button class="btn-secondary-action" onclick="viewReportedIssues()">View Issues (F20)</button>
            </div>

            <table>
                <thead>
                    <tr>
                        <th><input type="checkbox" id="select-all-modules" disabled> Title (F1/F2)</th>
                        <th>Course</th>
                        <th>Subject</th>
                        <th>Type</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="module-tbody">
                    <tr><td colspan="5" class="placeholder-message">Load content modules...</td></tr>
                </tbody>
            </table>
            
            <h3 style="margin-top: 25px;">Compliance & Reporting (F7, F23, F28)</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button class="btn-secondary-action" onclick="manageQuizBank()">Manage Quiz Question Bank (F7)</button>
                <button class="btn-secondary-action" onclick="viewAssociatedMarks(document.getElementById('module-id').value || '')">View Associated Marks (F23)</button>
                <button class="btn-secondary-action" onclick="generateCertificates(document.getElementById('module-id').value || '')">Generate Certs (F25)</button>
                <button class="btn-secondary-action" onclick="linkLibraryResource(document.getElementById('module-id').value || '')">Link Library Resource (F24)</button>
                <button class="btn-secondary-action" onclick="viewDiscussions(document.getElementById('module-id').value || '')">View Student Discussions (F13)</button>
                <button class="btn-secondary-action" onclick="setPrerequisites(document.getElementById('module-id').value || '')">Set Prerequisites (F11)</button>
            </div>
            
            <h3 style="margin-top: 25px;">Student/QA View (F12, F17, F26)</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                <button class="btn-secondary-action" onclick="generateQrCode(document.getElementById('module-id').value || '')">Generate QR (F12)</button>
                <button class="btn-secondary-action" onclick="previewAsStudent(document.getElementById('module-id').value || '')">Preview as Student (F26)</button>
                <button class="btn-secondary-action" onclick="notifyCompletion(document.getElementById('module-id').value || '')">Notify on Completion (F17)</button>
                <button class="btn-secondary-action" onclick="setTimeLimit(document.getElementById('module-id').value || '')" style="grid-column: 1 / -1;">Set Time Limit (F14)</button>
            </div>
        </div>
        
    </div>
</div>

<div id="assign-modal" class="modal">
    <div class="modal-content" style="width: 90%; max-width: 650px; background: white; padding: 30px; border: 3px solid #005A9C;">
        <span class="close-btn" onclick="document.getElementById('assign-modal').style.display='none'">&times;</span>
        <h3 style="color: #C0392B; border-bottom: 2px solid #C0392B; margin-top: 0;">Bulk Assignment: Module "<span id="modal-module-title"></span>" (F4 - MOCK SUBMIT)</h3>
        <form id="bulk-assignment-form" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <input type="hidden" id="assignment-module-id">
            
            <div style="grid-column: 1 / -1;">
                <label for="assignment-type-select" style="font-weight: bold;">Assignment Type:</label>
                <select id="assignment-type-select" required style="width: 100%; padding: 8px;">
                    <option value="batch">Assign to All Students in a Batch</option>
                    <option value="individual">Assign to Specific Individual Student(s)</option>
                </select>
            </div>

            <div class="form-group" id="course-select-group">
                <label for="assign-course-select">Target Course:</label>
                <select id="assign-course-select" name="target_course" required style="width: 100%; padding: 8px;">
                    <option value="">Select Course First</option>
                </select>
            </div>
            
            <div class="form-group" id="batch-select-group">
                <label for="assign-batch-select">Target Batch:</label>
                <select id="assign-batch-select" name="target_batch" required style="width: 100%; padding: 8px;">
                    <option value="">Select Course First</option>
                </select>
            </div>
            
            <div class="form-group" id="student-select-group" style="display:none;">
                <label for="assign-student-input">Target Student(s) (Roll No./ID):</label>
                <textarea id="assign-student-input" name="target_students_list" placeholder="Enter Roll Numbers or Student IDs, separated by commas or new lines" style="width: 100%; padding: 8px;"></textarea>
            </div>
            
            <div class="form-group" id="submission-date-group">
                <label for="due-date">Submission Due Date (Optional):</label>
                <input type="date" id="due-date" name="due_date" style="width: 100%; padding: 8px;">
            </div>

            <div class="form-group">
                <label for="notify-students" style="font-weight: normal;"><input type="checkbox" id="notify-students" name="notify_students" checked> Notify Students via Email/SMS</label>
            </div>

            <button type="submit" id="submit-assignment-btn" class="submit-btn" style="grid-column: 1 / -1; width: 100%;">Finalize Assignment (MOCK SUBMIT)</button>
        </form>
    </div>
</div>

<div id="unassign-modal" class="modal">
    <div class="modal-content" style="width: 90%; max-width: 650px; background: white; padding: 30px; border: 3px solid #C0392B;">
        <span class="close-btn" onclick="document.getElementById('unassign-modal').style.display='none'">&times;</span>
        <h3 style="color: #C0392B; border-bottom: 2px solid #C0392B; margin-top: 0;">Bulk Unassignment Tool (F27)</h3>
        <form id="bulk-unassignment-form">

            <div style="grid-column: 1 / -1;">
                <label for="unassign-module-select">Module to Unassign:</label>
                <select id="unassign-module-select" required style="width: 100%; padding: 8px;">
                    <option value="">Loading Modules...</option>
                </select>
            </div>
            
            <div style="grid-column: 1 / -1;">
                <label for="unassign-type-select" style="font-weight: bold;">Unassignment Target:</label>
                <select id="unassign-type-select" required style="width: 100%; padding: 8px;">
                    <option value="batch">Remove from All Students in a Batch</option>
                    <option value="individual">Remove from Specific Individual Student(s)</option>
                </select>
            </div>

            <div class="form-group" id="unassign-course-select-group">
                <label for="unassign-course-select">Target Course:</label>
                <select id="unassign-course-select" name="target_course" style="width: 100%; padding: 8px;">
                    <option value="">Select Course First</option>
                </select>
            </div>

            <div class="form-group" id="unassign-batch-select-group">
                <label for="unassign-batch-select">Target Batch:</label>
                <select id="unassign-batch-select" name="target_batch" style="width: 100%; padding: 8px;">
                    <option value="">Loading Batches...</option>
                </select>
            </div>
            
            <div class="form-group" id="unassign-student-select-group" style="display:none;">
                <label for="unassign-student-input">Target Student(s) (Roll No./ID):</label>
                <textarea id="unassign-student-input" name="target_students_list" placeholder="Enter Roll Numbers or Student IDs, separated by commas or new lines" style="width: 100%; padding: 8px;"></textarea>
            </div>
            
            <div style="grid-column: 1 / -1; color: #C0392B; font-weight: bold; margin-top: 20px;">
                WARNING: This action permanently removes the assignment record and progress for the selected module and students.
            </div>

            <button type="submit" id="submit-unassignment-btn" class="submit-btn" style="grid-column: 1 / -1; width: 100%; background-color: #C0392B;">Finalize Unassignment</button>
        </form>
    </div>
</div>

<div id="bulk-status-modal" class="modal">
    <div class="modal-content" style="width: 90%; max-width: 450px; background: white; padding: 30px; border: 3px solid #777;">
        <span class="close-btn" onclick="document.getElementById('bulk-status-modal').style.display='none'">&times;</span>
        <h3 style="color: #005A9C; border-bottom: 2px solid #005A9C; margin-top: 0;">Bulk Module Status Update (F5)</h3>
        <form id="bulk-status-form">
            <input type="hidden" id="bulk-status-module-ids">

            <p>Applying action to <strong id="bulk-status-count">0</strong> selected module(s).</p>
            
            <label for="bulk-action-select">Select Action:</label>
            <select id="bulk-action-select" required style="width: 100%; padding: 8px;">
                <option value="">-- Choose Status Action --</option>
                <option value="Archive">Archive/Hide from Students</option>
                <option value="Unpublish">Unpublish (Set to Draft)</option>
                <option value="Delete" style="color: #C0392B;">Permanently Delete</option>
            </select>
            
            <button type="submit" id="submit-bulk-status-btn" class="submit-btn" style="width: 100%; background-color: #777;">Execute Bulk Action</button>
        </form>
    </div>
</div>

<div id="grading-modal" class="modal">
    <div class="modal-content" style="width: 90%; max-width: 500px; background: white; padding: 30px; border: 3px solid #28A745;">
        <span class="close-btn" onclick="document.getElementById('grading-modal').style.display='none'">&times;</span>
        <h3 style="color: #28A745; border-bottom: 2px solid #28A745; margin-top: 0;">Automated Grading Configuration (F8)</h3>
        <form id="grading-config-form">
            <label for="grading-module-select">Module to Configure:</label>
            <select id="grading-module-select" required style="width: 100%; padding: 8px;">
                <option value="">Loading Modules...</option>
            </select>

            <label for="min-pass-score">Minimum Score to Pass (%):</label>
            <input type="number" id="min-pass-score" name="min_pass_score" min="0" max="100" value="70" required>
            
            <label for="auto-grade-sync" style="font-weight: normal; margin-top: 15px;">
                <input type="checkbox" id="auto-grade-sync" name="auto_grade_sync" checked> 
                Automatically Sync Grades to Central Records
            </label>
            
            <button type="submit" id="submit-grading-btn" class="submit-btn" style="width: 100%; background-color: #28A745;">Save Grading Configuration</button>
        </form>
    </div>
</div>

<div id="import-modal" class="modal">
    <div class="modal-content" style="width: 90%; max-width: 700px; background: white; padding: 30px; border: 3px solid #005A9C;">
        <span class="close-btn" onclick="document.getElementById('import-modal').style.display='none'">&times;</span>
        <h3 style="color: #005A9C; border-bottom: 2px solid #005A9C; margin-top: 0;">Bulk Module Import Tool (F18)</h3>
        <form id="bulk-import-form">
            <p>Paste the content of your CSV or JSON file below. Data should contain <code>title</code>, <code>content_url</code>, <code>course_id</code>, and <code>subject_id</code>.</p>
            
            <label for="import-format-select">Data Format:</label>
            <select id="import-format-select" required style="width: 100%; padding: 8px;">
                <option value="JSON">JSON (Array of Objects)</option>
                <option value="CSV">CSV (Comma Separated Values)</option>
            </select>
            
            <label for="import-data-input">Raw Data:</label>
            <textarea id="import-data-input" rows="10" placeholder="Paste your module data here (JSON Array or CSV lines)..." required></textarea>
            
            <button type="submit" id="submit-import-btn" class="submit-btn" style="width: 100%;">Start Import</button>
        </form>
    </div>
</div>

<div id="reports-modal" class="modal">
    <div class="modal-content" style="width: 90%; max-width: 900px; background: white; padding: 30px; border: 3px solid #777;">
        <span class="close-btn" onclick="document.getElementById('reports-modal').style.display='none'">&times;</span>
        <h3 style="color: #777; border-bottom: 2px solid #777; margin-top: 0;">Student Content Issue Reports (F20)</h3>
        
        <table>
            <thead>
                <tr>
                    <th style="width: 25%;">Module</th>
                    <th style="width: 15%;">Type</th>
                    <th style="width: 45%;">Details</th>
                    <th style="width: 15%;">Reported On</th>
                </tr>
            </thead>
            <tbody id="reports-tbody">
                <tr><td colspan="4">Loading reports...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<div id="prerequisite-modal" class="modal">
    <div class="modal-content" style="width: 90%; max-width: 500px; background: white; padding: 30px; border: 3px solid #005A9C;">
        <span class="close-btn" onclick="document.getElementById('prerequisite-modal').style.display='none'">&times;</span>
        <h3 style="color: #005A9C; border-bottom: 2px solid #005A9C; margin-top: 0;">Set Module Prerequisites (F11)</h3>
        <form id="prerequisite-form">
            <label for="prerequisite-module-select">Target Module:</label>
            <select id="prerequisite-module-select" required style="width: 100%; padding: 8px;">
                <option value="">Loading Modules...</option>
            </select>

            <label for="prerequisite-subject-select">Requires successful completion of Subject:</label>
            <select id="prerequisite-subject-select" required style="width: 100%; padding: 8px;">
                <option value="">Loading Subjects...</option>
            </select>

            <label for="min-prerequisite-score">Minimum Required Score in Prerequisite Subject (%):</label>
            <input type="number" id="min-prerequisite-score" name="min_prerequisite_score" min="0" max="100" value="70" required>
            
            <button type="submit" id="submit-prerequisite-btn" class="submit-btn" style="width: 100%;">Save Prerequisites</button>
        </form>
    </div>
</div>

<div id="time-limit-modal" class="modal">
    <div class="modal-content" style="width: 90%; max-width: 500px; background: white; padding: 30px; border: 3px solid #C0392B;">
        <span class="close-btn" onclick="document.getElementById('time-limit-modal').style.display='none'">&times;</span>
        <h3 style="color: #C0392B; border-bottom: 2px solid #C0392B; margin-top: 0;">Set Time Limit (F14)</h3>
        <form id="time-limit-form">
            <label for="time-limit-module-select">Target Module:</label>
            <select id="time-limit-module-select" required style="width: 100%; padding: 8px;">
                <option value="">Loading Modules...</option>
            </select>

            <label for="time-limit-minutes">Max Time Allowed (Minutes):</label>
            <input type="number" id="time-limit-minutes" name="time_limit_minutes" min="5" value="60" required>
            
            <label for="enforce-limit" style="font-weight: normal; margin-top: 15px;">
                <input type="checkbox" id="enforce-limit" name="enforce_limit" checked> 
                Strictly enforce time limit (Auto-submit on expiry)
            </label>
            
            <button type="submit" id="submit-time-limit-btn" class="submit-btn" style="width: 100%; background-color: #C0392B;">Save Time Limit Configuration</button>
        </form>
    </div>
</div>
</body>
</html>