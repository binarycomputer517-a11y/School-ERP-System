<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Academic Syllabus | Student Portal</title>
    <style>
        /* --- CLASSIC ACADEMIC STYLING --- */
        body { font-family: 'Times New Roman', serif; margin: 0; padding: 2em; background-color: #F0F2F5; color: #1a1a1a; }
        .container { max-width: 1100px; margin: auto; background: #FFF; padding: 40px; border: 1px solid #333; box-shadow: 8px 8px 0 #888; }
        h1 { text-align: center; border-bottom: 5px double #333; padding-bottom: 15px; text-transform: uppercase; letter-spacing: 2px; }
        
        .student-header { background: #f9f9f9; padding: 20px; border-left: 6px solid #005A9C; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; }
        .course-info h2 { margin: 0; color: #005A9C; font-size: 1.4em; }
        
        /* --- SYLLABUS GRID --- */
        .syllabus-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
        .module-item { border: 1px solid #444; padding: 25px; display: flex; justify-content: space-between; align-items: center; background: #fff; position: relative; }
        .module-item:hover { border-color: #005A9C; background-color: #fdfdfd; }
        
        .content-info h3 { margin: 0 0 10px 0; font-size: 1.3em; color: #2c3e50; }
        .meta-data { font-size: 0.85em; color: #666; display: flex; gap: 15px; }
        .tag { background: #333; color: #fff; padding: 2px 8px; font-size: 0.75em; text-transform: uppercase; }
        
        .expiry-warning { font-size: 0.8em; color: #c0392b; font-weight: bold; margin-top: 10px; }
        
        .btn-start { background-color: #005A9C; color: #fff; padding: 12px 25px; text-decoration: none; font-weight: bold; border: 2px solid #000; box-shadow: 3px 3px 0 #000; text-transform: uppercase; font-size: 0.9em; transition: 0.2s; }
        .btn-start:hover { transform: translate(-2px, -2px); box-shadow: 5px 5px 0 #000; }
        .btn-start:active { transform: translate(0, 0); box-shadow: 1px 1px 0 #000; }

        .error-box { background: #fee; border: 1px solid #c00; padding: 20px; text-align: center; color: #c00; font-weight: bold; }
        .no-data { text-align: center; padding: 50px; color: #7f8c8d; font-style: italic; border: 1px dashed #bdc3c7; }
    </style>
</head>
<body>

<div class="container">
    <h1>My Academic Syllabus</h1>
    
    <div class="student-header">
        <div class="course-info">
            <h2 id="student-course">Loading Course Details...</h2>
            <p style="margin: 5px 0 0 0;">Academic Session: 2025-26</p>
        </div>
        <div style="text-align: right;">
            <a href="/student-dashboard.html" style="color: #005A9C; font-weight: bold;">&larr; Back to Dashboard</a>
        </div>
    </div>

    <div id="syllabus-content" class="syllabus-grid">
        <div class="no-data">Synchronizing with learning server...</div>
    </div>
</div>



<script>
    const token = localStorage.getItem('erp-token');
    const API_BASE = '/api/online-learning';

    async function loadSyllabus() {
        const container = document.getElementById('syllabus-content');
        const courseHeader = document.getElementById('student-course');

        if (!token) {
            container.innerHTML = '<div class="error-box">Authentication Required. Please log in as a student.</div>';
            return;
        }

        try {
            const res = await fetch(`${API_BASE}/modules`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (res.status === 403) {
                container.innerHTML = '<div class="error-box">403 Forbidden: You do not have student permissions to view this syllabus.</div>';
                return;
            }

            const modules = await res.json();

            if (!modules || modules.length === 0) {
                container.innerHTML = '<div class="no-data">No active modules found in your syllabus at this time.</div>';
                courseHeader.innerText = "General Studies";
                return;
            }

            // Update Header with the first module's course name
            courseHeader.innerText = modules[0].course_name || "Assigned Course Syllabus";

            container.innerHTML = modules.map(m => {
                const expiryDate = m.expiry_date ? new Date(m.expiry_date) : null;
                const isUrgent = expiryDate && (expiryDate - new Date() < 86400000); // 24 hours left

                return `
                    <div class="module-item">
                        <div class="content-info">
                            <span class="tag">${m.content_type}</span>
                            <h3>${m.title}</h3>
                            <div class="meta-data">
                                <span>Subject: <b>${m.subject_name || 'General'}</b></span>
                                <span>Published: ${new Date(m.created_at).toLocaleDateString()}</span>
                            </div>
                            ${expiryDate ? `
                                <div class="expiry-warning" style="${isUrgent ? 'color: red;' : ''}">
                                    ${isUrgent ? 'âš  EXPIRES SOON: ' : 'Closes on: '} ${expiryDate.toLocaleString()}
                                </div>
                            ` : ''}
                        </div>
                        <div class="actions">
                            <a href="/view-module.html?id=${m.id}" class="btn-start">Start Learning</a>
                        </div>
                    </div>
                `;
            }).join('');

        } catch (error) {
            console.error("Syllabus Error:", error);
            container.innerHTML = '<div class="error-box">Failed to connect to the learning server. Please try again later.</div>';
        }
    }

    // Initialize
    window.onload = loadSyllabus;
</script>
</body>
</html>