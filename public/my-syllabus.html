<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Course Syllabus</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .list-group-item:hover {
            background-color: #f8f9fa;
        }
        .text-primary { color: #003366 !important; }
        .text-secondary { color: #5e35b1 !important; }
    </style>
</head>
<body>
    <div class="container mt-5">
        <header class="mb-4 d-flex justify-content-between align-items-center">
            <h1 class="text-primary">My Course Syllabus</h1>
            <a href="/student-dashboard.html" class="btn btn-sm btn-outline-secondary">← Back to Dashboard</a>
        </header>

        <div id="syllabus-content" class="card shadow-sm">
            <div class="card-body">
                <div id="syllabus-list">
                    <p class="text-muted">Loading your assigned subjects...</p>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const token = localStorage.getItem('erp-token');
        // ⭐ UPDATED: Use 'profile-id' for consistency
        const studentId = localStorage.getItem('profile-id'); 

        // --- Helper function for authenticated API calls ---
        async function handleApi(url) {
            const response = await fetch(url, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!response.ok) {
                // Check for Unauthorized status, consistent with other scripts
                if (response.status === 401 || response.status === 403) {
                     throw new Error('Session expired or unauthorized. Please log in again.');
                }
                throw new Error(`API call failed with status: ${response.status}.`);
            }
            return response.json();
        }

        /**
         * Main function to fetch student course and associated subjects.
         */
        async function loadSyllabus() {
            const syllabusList = document.getElementById('syllabus-list');
            
            // Check based on the unified key
            if (!studentId || !token) {
                syllabusList.innerHTML = '<p class="text-danger">Error: Not logged in or Profile ID missing.</p>';
                return;
            }
            
            try {
                // 1. Fetch Student Profile to get course_id and course_name
                // Uses your existing API: GET /api/students/:id
                const studentData = await handleApi(`/api/students/${studentId}`);
                const courseId = studentData.course_id;
                
                if (!courseId) {
                    syllabusList.innerHTML = `<p class="text-warning">Your profile has no course assigned yet.</p>`;
                    return;
                }

                // 2. Fetch Subjects linked to the Course ID
                // Uses your existing API: GET /api/academicswithfees/courses/${courseId}/subjects
                const subjects = await handleApi(`/api/academicswithfees/courses/${courseId}/subjects`);
                
                // 3. Render the list of subjects
                if (subjects.length === 0) {
                    syllabusList.innerHTML = `<p class="text-info">No subjects have been assigned to your course (<strong>${studentData.course_name || 'N/A'}</strong>) yet.</p>`;
                    return;
                }

                const courseHeader = document.createElement('h5');
                courseHeader.className = 'mb-3 text-secondary';
                courseHeader.innerHTML = `Subjects for Course: <strong>${studentData.course_name || 'N/A'}</strong>`;
                
                syllabusList.innerHTML = ''; // Clear the "Loading..." message
                syllabusList.appendChild(courseHeader);
                
                const ul = document.createElement('ul');
                ul.className = 'list-group list-group-flush';

                ul.innerHTML = subjects.map(subject => `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong class="text-primary">${subject.subject_name}</strong>
                            <span class="text-muted ms-2">(${subject.subject_code})</span>
                        </div>
                        <a href="/download-syllabus/${subject.subject_id}" class="btn btn-sm btn-outline-primary">
                            Download Syllabus PDF
                        </a>
                    </li>
                `).join('');
                
                syllabusList.appendChild(ul);

            } catch (error) {
                console.error("Failed to load syllabus:", error);
                syllabusList.innerHTML = `<p class="text-danger">Failed to load syllabus: ${error.message}. Please check your network or login status.</p>`;
            }
        }

        // Run the function when the page loads
        document.addEventListener('DOMContentLoaded', loadSyllabus);
    </script>
</body>
</html>