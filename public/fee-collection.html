<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fee Collection | School ERP</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap');
        :root {
            --primary-color: #4a90e2;
            --success-color: #2ecc71;
            --danger-color: #e74c3c;
            --light-gray: #f4f7f9;
            --dark-gray: #333;
        }
        body { font-family: 'Poppins', sans-serif; background: var(--light-gray); color: var(--dark-gray); margin: 0; padding: 0; }
        .container { max-width: 1100px; margin: 30px auto; padding: 20px; }
        .nav-links { text-align: center; margin-bottom: 20px; }
        .nav-links a { text-decoration: none; color: var(--primary-color); font-weight: 500; }
        
        .grid-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card { background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); }
        h2 { margin-top: 0; color: var(--primary-color); border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; }
        
        /* Form Elements */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 500; }
        select, input, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        
        /* Student Info Box */
        .info-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #eee; }
        .info-label { color: #666; }
        .info-value { font-weight: 600; }
        .balance-positive { color: var(--danger-color); }
        .balance-negative { color: var(--success-color); }

        /* Buttons */
        .btn { width: 100%; padding: 12px; border: none; border-radius: 4px; color: #fff; font-weight: 600; cursor: pointer; margin-top: 10px; }
        .btn-primary { background: var(--primary-color); }
        .btn-primary:hover { opacity: 0.9; }

        /* History Table */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; font-weight: 600; }
        .receipt-link { color: var(--primary-color); text-decoration: none; font-size: 0.9em; }
        .receipt-link:hover { text-decoration: underline; }

        /* Responsive */
        @media (max-width: 768px) { .grid-layout { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="container">
    <h1 style="text-align: center;">Fee Collection Terminal</h1>
    <div class="nav-links">
        <a href="/finance-dashboard.html">← Back to Finance Dashboard</a>
    </div>

    <div class="grid-layout">
        
        <div class="card">
            <h2>1. Select Student</h2>
            <div class="form-group">
                <label>Search Student</label>
                <select id="student-select">
                    <option value="">-- Select Student --</option>
                </select>
            </div>

            <div id="payment-form" style="display: none;">
                <h2 style="margin-top: 20px;">2. Receive Payment</h2>
                <div class="form-group">
                    <label>Payment Date</label>
                    <input type="date" id="payment-date" readonly disabled>
                </div>
                <div class="form-group">
                    <label>Amount to Collect (INR)</label>
                    <input type="number" id="pay-amount" placeholder="Enter amount..." min="1">
                </div>
                <div class="form-group">
                    <label>Payment Mode</label>
                    <select id="pay-mode">
                        <option value="Cash">Cash</option>
                        <option value="UPI">UPI / GPay / PhonePe</option>
                        <option value="Bank Transfer">Bank Transfer (NEFT/IMPS)</option>
                        <option value="Cheque">Cheque</option>
                        <option value="Card">Credit/Debit Card</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Remarks / Transaction ID</label>
                    <textarea id="pay-notes" rows="2" placeholder="Optional notes..."></textarea>
                </div>
                <button class="btn btn-primary" onclick="processPayment()">Collect Fee</button>
            </div>
        </div>

        <div class="card">
            <h2>Student Summary</h2>
            <div id="student-info-box">
                <p style="text-align: center; color: #888; padding: 20px;">Please select a student to view details.</p>
            </div>
            
            <div id="history-section" style="display: none;">
                <h2 style="margin-top: 30px;">Payment History</h2>
                <div style="overflow-x: auto;">
                    <table id="history-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Mode</th>
                                <th>Amount</th>
                                <th>Receipt</th>
                            </tr>
                        </thead>
                        <tbody id="history-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    const token = localStorage.getItem('erp-token');
    const authHeaders = { 'Authorization': `Bearer ${token}` };

    if (!token) window.location.href = '/login';

    // Set Today's Date
    document.getElementById('payment-date').valueAsDate = new Date();

    // 1. Load Student List on Init
    async function loadStudentList() {
        try {
            const response = await fetch('/api/students', { headers: authHeaders });
            const students = await response.json();
            
            const select = document.getElementById('student-select');
            students.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.student_id; // Ensure this matches DB column
                // Display Name + Roll Number
                opt.text = `${s.first_name} ${s.last_name} (${s.roll_number || 'No Roll'})`;
                select.appendChild(opt);
            });
        } catch (error) {
            console.error('Error loading students:', error);
            alert('Failed to load student list.');
        }
    }

    // 2. Fetch Specific Student Data
    async function loadStudentDetails(studentId) {
        if (!studentId) {
            document.getElementById('payment-form').style.display = 'none';
            document.getElementById('history-section').style.display = 'none';
            document.getElementById('student-info-box').innerHTML = '<p style="text-align: center; color: #888;">Please select a student.</p>';
            return;
        }

        try {
            // FIX: Using correct route prefix /api/fees/...
            const response = await fetch(`/api/fees/student/${studentId}`, { headers: authHeaders });
            if (!response.ok) throw new Error('Student not found');
            
            const data = await response.json();

            // Render Info Box
            const balanceClass = data.balance > 0 ? 'balance-positive' : 'balance-negative';
            const balanceText = data.balance > 0 ? `Due: ₹${data.balance}` : `Excess: ₹${Math.abs(data.balance)}`;
            
            document.getElementById('student-info-box').innerHTML = `
                <div class="info-row"><span class="info-label">Name:</span> <span class="info-value">${data.student_name}</span></div>
                <div class="info-row"><span class="info-label">Course:</span> <span class="info-value">${data.course_name || 'N/A'}</span></div>
                <div class="info-row"><span class="info-label">Total Fee Structure:</span> <span class="info-value">₹${data.total_fees}</span></div>
                <div class="info-row"><span class="info-label">Total Paid:</span> <span class="info-value" style="color:green;">₹${data.total_paid}</span></div>
                <div class="info-row" style="border:none; padding-top:15px;">
                    <span class="info-label">Current Balance:</span> 
                    <span class="info-value ${balanceClass}" style="font-size: 1.2em;">${balanceText}</span>
                </div>
            `;

            // Render Payment History
            const tbody = document.getElementById('history-tbody');
            tbody.innerHTML = '';
            
            // FIX: Ensure data.payments is an array before looping
            const payments = data.payments || []; 

            if (payments.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#999;">No previous payments found.</td></tr>';
            } else {
                payments.forEach(p => {
                    const date = new Date(p.payment_date).toLocaleDateString('en-IN');
                    const row = `
                        <tr>
                            <td>${date}</td>
                            <td>${p.payment_mode}</td>
                            <td>₹${p.amount_paid}</td>
                            <td><a href="#" class="receipt-link" onclick="downloadReceipt('${p.paymentid}')">View</a></td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            }

            // Show sections
            document.getElementById('payment-form').style.display = 'block';
            document.getElementById('history-section').style.display = 'block';
            
            // Auto-fill amount if balance is positive
            if(data.balance > 0) {
                document.getElementById('pay-amount').value = data.balance;
            } else {
                document.getElementById('pay-amount').value = '';
            }

        } catch (error) {
            console.error(error);
            alert('Error fetching student details.');
        }
    }

    // 3. Process Payment
    async function processPayment() {
        const studentId = document.getElementById('student-select').value;
        const amount = document.getElementById('pay-amount').value;
        const mode = document.getElementById('pay-mode').value;
        const notes = document.getElementById('pay-notes').value;

        if (!amount || amount <= 0) { return alert('Please enter a valid amount.'); }

        const btn = document.querySelector('.btn-primary');
        btn.disabled = true;
        btn.innerText = 'Processing...';

        try {
            const response = await fetch('/api/fees/collect', {
                method: 'POST',
                headers: { ...authHeaders, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    student_id: studentId,
                    amount_paid: amount,
                    payment_mode: mode,
                    notes: notes
                })
            });

            const result = await response.json();

            if (response.ok) {
                alert('Payment Successful!');
                // Reload details to show updated balance and history
                loadStudentDetails(studentId);
                // Clear input
                document.getElementById('pay-amount').value = '';
                document.getElementById('pay-notes').value = '';
                
                // Optional: Auto download receipt
                if (result.paymentId && confirm('Download Receipt now?')) {
                    downloadReceipt(result.paymentId);
                }
            } else {
                alert('Error: ' + result.message);
            }
        } catch (error) {
            console.error(error);
            alert('Failed to process payment.');
        } finally {
            btn.disabled = false;
            btn.innerText = 'Collect Fee';
        }
    }

    // 4. Download Receipt
    function downloadReceipt(paymentId) {
        // Direct link to PDF endpoint
        window.open(`/api/fees/receipt/${paymentId}?token=${token}`, '_blank'); 
        // Note: For cleaner auth, usually we fetch Blob, but window.open is simpler if we handle token in URL or cookies. 
        // Since we use Bearer header, simpler approach for PDF download:
        
        fetch(`/api/fees/receipt/${paymentId}`, { headers: authHeaders })
        .then(res => {
            if(!res.ok) throw new Error('Receipt not found');
            return res.blob();
        })
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Receipt_${paymentId}.pdf`;
            document.body.appendChild(a);
            a.click();
            a.remove();
        })
        .catch(err => alert(err.message));
    }

    // Event Listeners
    document.addEventListener('DOMContentLoaded', loadStudentList);
    document.getElementById('student-select').addEventListener('change', (e) => loadStudentDetails(e.target.value));

</script>
<script src="js/global-config.js"></script>
</body>
</html>