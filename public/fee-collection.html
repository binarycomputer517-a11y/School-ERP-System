<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fee Collection Terminal | School ERP</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');
        :root {
            --primary-color: #34495e; /* Dark Blue/Gray - Professional */
            --primary-light: #4a90e2; 
            --success-color: #2ecc71; /* Green */
            --danger-color: #e74c3c; /* Red */
            --warning-color: #f39c12; /* Orange */
            --light-gray: #f9fafb; /* Very light background */
            --dark-gray: #333;
            --info-bg: #e8f6ff; /* Light Blue for Summary */
        }
        body { 
            font-family: 'Poppins', sans-serif; 
            background: var(--light-gray); 
            color: var(--dark-gray); 
            margin: 0; 
            padding: 0; 
        }
        .container { 
            max-width: 1200px; 
            margin: 30px auto; 
            padding: 20px; 
        }
        
        /* Header and Navigation */
        h1 { font-size: 2.2rem; font-weight: 700; color: var(--primary-color); margin-bottom: 5px; }
        .nav-links { text-align: center; margin-bottom: 30px; }
        .nav-links a { text-decoration: none; color: var(--primary-light); font-weight: 500; padding: 5px 10px; border-radius: 4px; transition: background 0.3s; }
        .nav-links a:hover { background: rgba(52, 73, 94, 0.1); }
        
        /* Layout and Cards */
        .grid-layout { display: grid; grid-template-columns: 1.5fr 1fr; gap: 25px; }
        .card { 
            background: #fff; 
            padding: 30px; 
            border-radius: 12px; 
            box-shadow: 0 8px 15px rgba(0,0,0,0.08); 
            border: 1px solid #ddd;
        }
        h2 { 
            margin-top: 0; 
            color: var(--primary-color); 
            border-bottom: 2px solid #f0f0f0; 
            padding-bottom: 10px; 
            font-size: 1.4rem;
            font-weight: 600;
        }
        
        /* Form Elements */
        .form-group { margin-bottom: 20px; }
        label { 
            display: block; 
            margin-bottom: 5px; 
            font-weight: 600; 
            font-size: 0.95rem;
            color: #555;
        }
        select, input[type="date"], input[type="number"], textarea { 
            width: 100%; 
            padding: 12px; 
            border: 1px solid #ccc; 
            border-radius: 8px; 
            box-sizing: border-box; 
            transition: border-color 0.3s;
        }
        /* Input Group Style */
        .input-group { display: flex; width: 100%; }
        .input-group-prepend { 
            background: #e9ecef; 
            border: 1px solid #ccc;
            border-right: none;
            padding: 12px;
            border-radius: 8px 0 0 8px;
            font-weight: 700;
            color: #555;
        }
        .input-group input { border-radius: 0 8px 8px 0; border-left: none; }


        /* Student Info Box */
        #student-info-box { min-height: 180px; background: var(--info-bg); border-radius: 8px; padding: 15px; }
        .info-row { 
            display: flex; 
            justify-content: space-between; 
            padding: 8px 0; 
            border-bottom: 1px dashed #c0d8e8; 
        }
        .info-label { color: #555; font-size: 0.9rem; }
        .info-value { font-weight: 700; color: var(--dark-gray); }
        .balance-due { color: var(--danger-color); font-size: 1.3em; } 
        .balance-excess { color: var(--success-color); font-size: 1.3em; }
        .balance-zero { color: var(--primary-color); font-size: 1.3em; } 
        
        /* Buttons */
        .btn { 
            width: 100%; 
            padding: 12px; 
            border: none; 
            border-radius: 8px; 
            color: #fff; 
            font-weight: 600; 
            cursor: pointer; 
            margin-top: 15px; 
            font-size: 1.1rem;
            transition: background 0.3s;
        }
        .btn-primary { background: var(--success-color); }
        .btn-primary.collect-due { background: var(--danger-color); }
        .btn-primary:hover { opacity: 0.9; }
        .btn-primary:disabled { background: #ccc; cursor: not-allowed; }

        /* History Table */
        .history-card { margin-top: 25px; padding: 15px; background: #fff; border-radius: 8px; }
        .history-table th, .history-table td { padding: 10px; font-size: 0.9rem; }
        .history-table th { background: #f0f0f0; font-weight: 600; color: #555; }
        .receipt-link { color: var(--primary-light); text-decoration: none; font-weight: 500; }

        /* Responsive */
        @media (max-width: 768px) { .grid-layout { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="container">
    <div class="text-center mb-4">
        <h1 class="mb-2"><i class="fas fa-coins"></i> Fee Collection Terminal</h1>
        <div class="nav-links">
            <a href="/finance-dashboard.html" class="fw-bold"><i class="fas fa-arrow-left"></i> Back to Finance Dashboard</a>
        </div>
    </div>

    <div class="grid-layout">
        
        <div class="card">
            <h2><i class="fas fa-user-check"></i> 1. Select Student</h2>
            <div class="form-group">
                <label for="student-select">Student Name / Roll No</label>
                <select id="student-select" onchange="loadStudentDetails(this.value)">
                    <option value="">-- Loading Students... --</option>
                </select>
            </div>

            <div id="payment-form" style="display: none;">
                <h2 style="margin-top: 20px;"><i class="fas fa-cash-register"></i> 2. Receive Payment</h2>
                
                <div class="form-group">
                    <label>Payment Date</label>
                    <input type="date" id="payment-date" readonly disabled>
                </div>
                
                <div class="form-group">
                    <label>Amount to Collect (INR)</label>
                    <div class="input-group">
                        <span class="input-group-prepend">₹</span>
                        <input type="number" id="pay-amount" placeholder="Enter amount..." min="0.01" step="0.01">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Payment Mode</label>
                    <select id="pay-mode">
                        <option value="Cash">Cash</option>
                        <option value="UPI">UPI / GPay / PhonePe</option>
                        <option value="Bank Transfer">Bank Transfer (NEFT/IMPS)</option>
                        <option value="Cheque">Cheque</option>
                        <option value="Card">Credit/Debit Card</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Remarks / Transaction ID</label>
                    <textarea id="pay-notes" rows="2" placeholder="Optional notes (e.g., Transaction Ref, Cheque No)..."></textarea>
                </div>
                
                <button class="btn btn-primary" onclick="processPayment()" id="collect-btn">
                    <i class="fas fa-spinner fa-spin" style="display:none;" id="btn-spinner"></i>
                    <span id="btn-text">Collect Fee</span>
                </button>
            </div>
        </div>

        <div class="card">
            <h2><i class="fas fa-file-invoice-dollar"></i> Student Summary</h2>
            <div id="student-info-box">
                <p style="text-align: center; color: #888; padding: 40px 20px; border: 1px dashed #ddd; border-radius: 8px;">
                    <i class="fas fa-info-circle"></i> Select a student to view financial details.
                </p>
            </div>
            
            <div id="history-section" style="display: none;">
                <div class="history-card">
                    <h2><i class="fas fa-history"></i> Payment History</h2>
                    <div style="overflow-x: auto;">
                        <table class="history-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Mode</th>
                                    <th>Amount</th>
                                    <th>Receipt</th>
                                </tr>
                            </thead>
                            <tbody id="history-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    const token = localStorage.getItem('erp-token');
    const authHeaders = { 'Authorization': `Bearer ${token}` };

    if (!token) window.location.href = '/login.html';
    
    // Helper: Currency Formatter
    const formatCurrency = (amount) => {
        return new Intl.NumberFormat('en-IN', {
            style: 'currency',
            currency: 'INR',
            minimumFractionDigits: 2
        }).format(parseFloat(amount));
    };

    // Helper: Date Formatter
    const formatDate = (dateString) => {
        if(!dateString) return '-';
        return new Date(dateString).toLocaleDateString('en-GB');
    };
    
    function showLoader(show) {
        const loader = document.getElementById('loader');
        // This relies on an external loader overlay, but if missing, use simple alert
        if (loader) loader.style.display = show ? 'flex' : 'none'; 
    }

    // Set Today's Date
    document.getElementById('payment-date').valueAsDate = new Date();

    // 1. Load Student List on Init
    async function loadStudentList() {
        showLoader(true);
        try {
            const response = await fetch('/api/students', { headers: authHeaders });
            const students = await response.json();
            
            const select = document.getElementById('student-select');
            
            // Critical Sorting Fix: Handle null usernames
            students.sort((a, b) => {
                const nameA = a.username || a.first_name || '';
                const nameB = b.username || b.first_name || '';
                return nameA.localeCompare(nameB);
            });

            students.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.student_id; 
                const displayName = s.username || `${s.first_name || ''} ${s.last_name || ''}`.trim() || 'Student (Unknown)';
                opt.text = `${displayName} (Roll: ${s.roll_number || 'N/A'})`;
                select.appendChild(opt);
            });
        } catch (error) {
            console.error('Error loading students:', error);
            alert('Failed to load student list.');
        } finally {
            showLoader(false);
        }
    }

    // 2. Fetch Specific Student Data (Financial Summary & History)
    async function loadStudentDetails(studentId) {
        const infoBox = document.getElementById('student-info-box');
        const paymentForm = document.getElementById('payment-form');
        const historySection = document.getElementById('history-section');
        const collectBtn = document.getElementById('collect-btn');
        const btnText = document.getElementById('btn-text');

        infoBox.innerHTML = '<p style="text-align: center; color: #888; padding: 40px 20px;"><i class="fas fa-spinner fa-spin"></i> Loading...</p>';
        paymentForm.style.display = 'none';
        historySection.style.display = 'none';
        collectBtn.disabled = true; // Disable until data loads

        if (!studentId) return;

        showLoader(true);
        try {
            // ⭐ CRITICAL FIX 1: Change API path from /api/fees to /api/finance
            const financeRes = await fetch(`/api/finance/student/${studentId}`, { headers: authHeaders });
            
            // CRITICAL FIX: Ensure all nested properties exist even on 404/failure
            const financeData = financeRes.status === 404 ? 
                { 
                    summary: { total_billed: 0, total_paid: 0, total_due: 0 }, 
                    payments: [],
                    student_name: 'N/A', 
                    course_name: 'N/A',
                    batch_name: 'N/A',
                    total_fees: 0, // Ensure these are defined for rendering
                    total_paid: 0,
                    balance: 0
                } 
                : await financeRes.json();
            
            // ⭐ CRITICAL FIX 2: Fetch Library Fines (assuming /api/library/fines/student/:id is implemented)
            // Use .catch to handle network/404 errors safely
            const fineFetch = await fetch(`/api/library/fines/student/${studentId}`, { headers: authHeaders })
                .catch(err => {
                    console.warn("Library fine route error/404:", err.message);
                    return { ok: false }; 
                });
            
            const fineData = fineFetch.ok ? await fineFetch.json() : { total_pending_fine: 0 };
            const totalPendingFine = parseFloat(fineData.total_pending_fine || 0);

            // Calculate Total Balance Due
            const feeBalance = parseFloat(financeData.balance || 0);
            const totalDue = feeBalance + totalPendingFine;

            let balanceClass = '';
            let balanceText = '';
            let dueAmount = 0;

            if (totalDue > 0) {
                balanceClass = 'balance-due';
                balanceText = `Total Due: ${formatCurrency(totalDue)}`;
                dueAmount = totalDue;
                collectBtn.classList.add('collect-due');
                btnText.innerText = `COLLECT FULL DUE`;
            } else if (totalDue < 0) {
                balanceClass = 'balance-excess';
                balanceText = `Excess: ${formatCurrency(Math.abs(totalDue))}`;
                dueAmount = 0; // Cannot auto-fill excess payment, suggest minimum payment
                collectBtn.classList.remove('collect-due');
                btnText.innerText = `COLLECT PAYMENT`;
            } else {
                balanceClass = 'balance-zero';
                balanceText = `Cleared: ${formatCurrency(0)}`;
                dueAmount = 0;
                collectBtn.classList.remove('collect-due');
                btnText.innerText = `COLLECT PAYMENT`;
            }
            
            // Render Info Box
            infoBox.innerHTML = `
                <div class="info-row"><span class="info-label"><i class="fas fa-user-graduate"></i> Name:</span> <span class="info-value">${financeData.student_name || 'N/A'}</span></div>
                <div class="info-row"><span class="info-label"><i class="fas fa-book"></i> Course:</span> <span class="info-value">${financeData.course_name || 'N/A'} (${financeData.batch_name || '-'})</span></div>
                <div class="info-row"><span class="info-label"><i class="fas fa-calendar-alt"></i> Total Billed (Fees):</span> <span class="info-value">${formatCurrency(financeData.total_fees)}</span></div>
                <div class="info-row"><span class="info-label"><i class="fas fa-check-circle"></i> Total Paid:</span> <span class="info-value text-success">${formatCurrency(financeData.total_paid)}</span></div>
                ${totalPendingFine > 0 ? 
                    `<div class="info-row" style="background: rgba(255, 193, 7, 0.1); border-color: #ffc107;">
                        <span class="info-label"><i class="fas fa-book-open"></i> Pending Library Fines:</span> 
                        <span class="info-value text-danger fw-bold">${formatCurrency(totalPendingFine)}</span>
                    </div>` 
                    : ''}
                <div class="info-row" style="border:none; padding-top:15px; background: var(--info-bg); border-radius: 0 0 8px 8px;">
                    <span class="info-label fw-bold"><i class="fas fa-wallet"></i> CLOSING BALANCE:</span> 
                    <span class="info-value ${balanceClass}" style="font-size: 1.2em;">${balanceText}</span>
                </div>
            `;


            // Render Payment History
            const tbody = document.getElementById('history-tbody');
            tbody.innerHTML = '';
            
            const payments = financeData.payments || []; 

            if (payments.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center py-3 text-muted">No previous payments found.</td></tr>';
            } else {
                payments.forEach(p => {
                    const date = formatDate(p.payment_date);
                    const row = `
                        <tr>
                            <td>${date}</td>
                            <td>${p.payment_mode}</td>
                            <td class="fw-bold">${formatCurrency(p.amount_paid)}</td>
                            <td>
                                <a href="#" class="receipt-link" onclick="event.preventDefault(); downloadReceipt('${p.transaction_id || p.paymentId}')">
                                    <i class="fas fa-file-pdf"></i> View
                                </a>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            }

            // Show sections & enable button
            paymentForm.style.display = 'block';
            historySection.style.display = 'block';
            collectBtn.disabled = false;
            
            // Auto-fill amount due
            document.getElementById('pay-amount').value = dueAmount.toFixed(2);

        } catch (error) {
            console.error(error);
            // Use the specific 404 message for the financial data not found case
            const displayMessage = error.message.includes('404') || error.message.includes('financial data not found') 
                ? 'Student financial data not found. Generate invoice or check ID.' 
                : error.message;

            infoBox.innerHTML = `<p style="text-align: center; color: var(--danger-color); padding: 40px 20px;">
                <i class="fas fa-exclamation-triangle"></i> Error loading details: ${displayMessage}
            </p>`;
        } finally {
            showLoader(false);
        }
    }

    // 3. Process Payment
    async function processPayment() {
        const studentId = document.getElementById('student-select').value;
        const amount = document.getElementById('pay-amount').value;
        const mode = document.getElementById('pay-mode').value;
        const notes = document.getElementById('pay-notes').value;

        if (!amount || parseFloat(amount) <= 0) { return alert('Please enter a valid amount greater than zero.'); }

        const btn = document.getElementById('collect-btn');
        const btnText = document.getElementById('btn-text');
        const btnSpinner = document.getElementById('btn-spinner');

        btn.disabled = true;
        btnText.style.display = 'none';
        btnSpinner.style.display = 'inline';

        try {
            // ⭐ CRITICAL FIX 3: Change API path from /api/fees to /api/finance
            const response = await fetch('/api/finance/collect', {
                method: 'POST',
                headers: { ...authHeaders, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    student_id: studentId,
                    amount_paid: amount,
                    payment_mode: mode,
                    notes: notes
                })
            });

            const result = await response.json();

            if (response.ok) {
                alert('Payment Successful! Receipt Ref: ' + result.receipt_number);
                
                await loadStudentDetails(studentId);
                
                // Clear inputs
                document.getElementById('pay-amount').value = '0.00';
                document.getElementById('pay-notes').value = '';
                
                if (result.receipt_number && confirm('Payment recorded. Would you like to download the receipt now?')) {
                    downloadReceipt(result.receipt_number);
                }
            } else {
                alert('Error: ' + result.message);
            }
        } catch (error) {
            console.error(error);
            alert('Failed to process payment. Check network or server logs.');
        } finally {
            btn.disabled = false;
            btnText.style.display = 'inline';
            btnSpinner.style.display = 'none';
        }
    }

    // 4. Download Receipt
    function downloadReceipt(refId) {
        // ⭐ CRITICAL FIX 4: Change API path from /api/fees to /api/finance
        fetch(`/api/finance/receipt/${refId}`, { headers: authHeaders })
        .then(res => {
            if(!res.ok) throw new Error('Receipt not found or failed to generate.');
            return res.blob();
        })
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Receipt_${refId}.pdf`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            window.URL.revokeObjectURL(url); // Clean up
        })
        .catch(err => alert(`Download Failed: ${err.message}`));
    }

    // Event Listeners
    document.addEventListener('DOMContentLoaded', loadStudentList);
</script>
<script src="js/global-config.js"></script>
</body>
</html>