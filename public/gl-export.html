<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>General Ledger (GL) Export</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f4f7f6; padding: 20px; }
        .container { max-width: 800px; margin: 40px auto; background: white; padding: 40px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid #ddd; }
        h2 { text-align: center; color: #2c3e50; text-transform: uppercase; margin-bottom: 10px; }
        .back-link { display: block; text-align: center; margin-bottom: 30px; text-decoration: none; color: #3498db; }
        
        .export-card { background: #f8f9fa; border: 1px solid #e9ecef; padding: 20px; border-radius: 6px; }
        .form-group { margin-bottom: 20px; }
        label { font-weight: 600; display: block; margin-bottom: 5px; color: #555; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        
        .btn-export { width: 100%; padding: 12px; background-color: #0056b3; color: white; border: none; border-radius: 4px; font-size: 16px; cursor: pointer; transition: background 0.2s; }
        .btn-export:hover { background-color: #004494; }
        
        .error-msg { color: #c0392b; background: #f9d7da; padding: 10px; border-radius: 4px; margin-top: 15px; display: none; text-align: center; }
    </style>
</head>
<body>

<div class="container">
    <h2>General Ledger (GL) Export</h2>
    <a href="/finance-dashboard.html" class="back-link">← Back to Finance Dashboard</a>

    <div class="export-card">
        <h3 style="margin-top: 0; color: #0056b3;">Export Criteria</h3>
        <hr>
        
        <div class="row" style="display: flex; gap: 20px;">
            <div class="form-group" style="flex: 1;">
                <label>Start Date:</label>
                <input type="date" id="startDate">
            </div>
            <div class="form-group" style="flex: 1;">
                <label>End Date:</label>
                <input type="date" id="endDate">
            </div>
        </div>

        <div class="form-group">
            <label>Export Format:</label>
            <select disabled style="background: #e9ecef;">
                <option>CSV (Comma Separated)</option>
            </select>
        </div>

        <button class="btn-export" onclick="generateGL()">Generate & Download GL Export</button>
        
        <div id="errorBox" class="error-msg"></div>
    </div>
</div>

<script>
    const token = localStorage.getItem('erp-token');
    const API_BASE = '/api/fees'; // Correct Base URL for fees module

    // Set Defaults (This Month)
    const today = new Date();
    document.getElementById('endDate').valueAsDate = today;
    document.getElementById('startDate').valueAsDate = new Date(today.getFullYear(), today.getMonth(), 1);

    async function generateGL() {
        const start = document.getElementById('startDate').value;
        const end = document.getElementById('endDate').value;
        const errorBox = document.getElementById('errorBox');
        
        errorBox.style.display = 'none';

        if (!start || !end) {
            showError("Please select both start and end dates.");
            return;
        }

        try {
            // 1. Fetch Data
            const res = await fetch(`${API_BASE}/reports/gl-export?startDate=${start}&endDate=${end}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (!res.ok) throw new Error("Failed to fetch GL data from server.");
            
            const data = await res.json();

            if (data.length === 0) {
                showError("No transactions found for the selected period.");
                return;
            }

            // 2. Convert JSON to CSV
            downloadCSV(data, `GL_Export_${start}_to_${end}.csv`);

        } catch (error) {
            console.error(error);
            showError(error.message);
        }
    }

    function downloadCSV(data, filename) {
        if (!data || data.length === 0) return;

        // CSV Header
        const headers = ['Date', 'Type', 'Category', 'Description', 'Debit (Exp)', 'Credit (Inc)'];
        const csvRows = [headers.join(',')];

        // CSV Rows
        data.forEach(row => {
            const date = new Date(row.date).toLocaleDateString('en-IN');
            // Escape commas in description
            const desc = `"${(row.description || '').replace(/"/g, '""')}"`; 
            
            const values = [
                date,
                row.type,
                row.category,
                desc,
                row.debit,
                row.credit
            ];
            csvRows.push(values.join(','));
        });

        // Create Blob and Link
        const csvString = csvRows.join('\n');
        const blob = new Blob([csvString], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.setAttribute('hidden', '');
        a.setAttribute('href', url);
        a.setAttribute('download', filename);
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    function showError(msg) {
        const box = document.getElementById('errorBox');
        box.innerText = "❌ " + msg;
        box.style.display = 'block';
    }
</script>

</body>
</html>