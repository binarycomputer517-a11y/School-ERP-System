<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enterprise Branch Profile | BCSM ERP</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=JetBrains+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        :root {
            --primary: #005A9C;
            --primary-dark: #003366;
            --success: #27ae60;
            --warning: #f39c12;
            --accent: #e67e22;
            --background: #f4f7f6;
            --surface: #ffffff;
            --text-main: #2d3436;
            --text-muted: #636e72;
            --border: #dfe6e9;
        }

        body { font-family: 'Poppins', sans-serif; background: var(--background); margin: 0; padding: 20px; color: var(--text-main); }
        .container { max-width: 1150px; margin: auto; }

        /* Header UI */
        .profile-header { 
            background: linear-gradient(135deg, var(--primary-dark), var(--primary)); 
            border-radius: 24px; padding: 45px; color: white; display: flex; align-items: center; gap: 35px;
            box-shadow: 0 12px 35px rgba(0,0,0,0.12); margin-bottom: 35px;
        }
        .branch-logo { 
            width: 130px; height: 130px; border-radius: 20px; background: white; 
            padding: 10px; object-fit: contain; box-shadow: 0 8px 20px rgba(0,0,0,0.2);
            border: 4px solid rgba(255,255,255,0.3);
        }
        .header-info h1 { margin: 0; font-size: 2.2rem; font-weight: 700; }
        .status-pill { 
            background: rgba(46, 204, 113, 0.2); padding: 6px 18px; border-radius: 50px; 
            font-size: 0.85rem; display: inline-block; margin-top: 12px; border: 1px solid rgba(255,255,255,0.4);
            font-weight: 600;
        }

        /* Layout Grid */
        .profile-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 30px; }
        .card { background: var(--surface); border-radius: 22px; padding: 30px; box-shadow: 0 10px 25px rgba(0,0,0,0.04); border: 1px solid var(--border); margin-bottom: 30px; }
        .card h3 { margin: 0 0 20px 0; border-bottom: 2px solid #f8f9fa; padding-bottom: 18px; color: var(--primary-dark); display: flex; align-items: center; gap: 12px; font-size: 1.2rem; }

        .info-row { display: flex; justify-content: space-between; padding: 14px 0; border-bottom: 1px solid #f5f6f7; }
        .info-row:last-child { border-bottom: none; }
        .label { color: var(--text-muted); font-weight: 500; font-size: 0.9rem; text-transform: uppercase; }
        .value { font-weight: 600; color: var(--text-main); }

        /* Infrastructure Icons */
        .infra-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 10px; }
        .infra-item { background: #f8fafc; padding: 15px; border-radius: 15px; text-align: center; border: 1px solid var(--border); }
        .infra-item i { font-size: 1.5rem; color: var(--primary); margin-bottom: 8px; }
        .infra-item div { font-weight: 700; font-size: 1.1rem; }
        .infra-item span { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; }

        /* Sidebar UI */
        .manager-photo { width: 110px; height: 110px; border-radius: 50%; object-fit: cover; border: 5px solid #f0f4f8; margin-bottom: 15px; }
        #singleBranchMap { height: 280px; border-radius: 18px; border: 1px solid var(--border); margin-top: 15px; }
        
        .social-bar { display: flex; justify-content: center; gap: 15px; margin-top: 25px; }
        .social-icon { width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; transition: 0.3s; }
        .fb { background: #1877F2; } .ig { background: #E4405F; }

        .btn-action { padding: 12px 25px; border-radius: 12px; border: none; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 10px; transition: 0.3s; text-decoration: none; }
        .btn-print { background: var(--primary); color: white; float: right; }

        @media print { .btn-print, .social-bar, .no-print { display: none; } .container { padding: 0; } }
    </style>
</head>
<body>

<div class="container">
    <div class="no-print" style="margin-bottom: 20px; overflow: hidden;">
        <button class="btn-action btn-print" onclick="window.print()"><i class="fas fa-file-pdf"></i> Generate Audit Report</button>
    </div>
    
    <div class="profile-header">
        <img id="view_logo" src="/uploads/default.png" alt="Logo" class="branch-logo">
        <div class="header-info">
            <h1 id="view_branch_name">Branch Node Loading...</h1>
            <div id="view_branch_code" style="font-family:'JetBrains Mono'; background:rgba(255,255,255,0.1); padding:2px 8px; border-radius:4px; display:inline-block; margin-top:10px; border:1px solid rgba(255,255,255,0.2);">----</div>
            <br>
            <div id="view_status" class="status-pill">Active Cluster Node</div>
        </div>
    </div>

    <div class="profile-grid">
        <div class="main-content">
            
            <div class="card">
                <h3><i class="fas fa-id-card"></i> Legal & Compliance</h3>
                <div class="info-row"><span class="label">Tax ID (PAN)</span><span class="value" id="view_pan">NOT SET</span></div>
                <div class="info-row"><span class="label">GST Registration</span><span class="value" id="view_gst">NOT SET</span></div>
                <div class="info-row"><span class="label">Official Email</span><span class="value" id="view_email">NOT SET</span></div>
            </div>

            <div class="card">
                <h3><i class="fas fa-building"></i> Infrastructure Audit</h3>
                <div class="infra-grid">
                    <div class="infra-item">
                        <i class="fas fa-laptop-code"></i>
                        <div id="view_labs">0</div>
                        <span>Computer Labs</span>
                    </div>
                    <div class="infra-item">
                        <i class="fas fa-door-open"></i>
                        <div id="view_classrooms">0</div>
                        <span>Cap. / Classroom</span>
                    </div>
                    <div class="infra-item">
                        <i class="fas fa-users-cog"></i>
                        <div id="view_faculty">0</div>
                        <span>Total Faculty</span>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3><i class="fas fa-university"></i> Banking Node</h3>
                <div class="info-row"><span class="label">Primary Bank</span><span class="value" id="view_bank">---</span></div>
                <div class="info-row"><span class="label">Account No.</span><span class="value" id="view_acc" style="font-family: 'JetBrains Mono';">---</span></div>
                <div class="info-row"><span class="label">IFSC Routing</span><span class="value" id="view_ifsc">---</span></div>
            </div>

            <div class="card">
                <h3><i class="fas fa-map-marked-alt"></i> Geospatial Identity</h3>
                <div class="info-row"><span class="label">Postal Pin Code</span><span class="value" id="view_pin">---</span></div>
                <div class="info-row"><span class="label">Physical Address</span><span class="value" id="view_address" style="text-align: right; max-width: 60%;">---</span></div>
                <div id="singleBranchMap"></div>
            </div>
        </div>

        <div class="sidebar">
            <div class="card" style="text-align:center;">
                <h3><i class="fas fa-user-tie"></i> Governance</h3>
                <img id="view_manager_photo" src="/uploads/default.png" alt="Manager" class="manager-photo">
                <h4 id="view_manager_name" style="margin: 10px 0 5px;">Head of Operations</h4>
                <p id="view_manager_phone" style="color: var(--success); font-weight: 700; margin-bottom: 20px;">---</p>
                
                <div class="social-bar">
                    <a id="view_fb" target="_blank" class="social-icon fb"><i class="fab fa-facebook-f"></i></a>
                    <a id="view_ig" target="_blank" class="social-icon ig"><i class="fab fa-instagram"></i></a>
                </div>
            </div>

            <div class="card">
                <h3><i class="fas fa-microchip"></i> Node Health</h3>
                <div class="info-row"><span class="label">Enrollment Load</span><span class="value" id="view_total_students">0</span></div>
                <div class="info-row"><span class="label">System Latency</span><span class="value" style="color:var(--success);">0.12ms</span></div>
                <div class="info-row"><span class="label">Cloud Sync</span><span class="value">ACTIVE</span></div>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const TOKEN = localStorage.getItem('erp-token');
    const urlParams = new URLSearchParams(window.location.search);
    const branchId = urlParams.get('id');

    async function fetchBranchProfile() {
        if(!branchId) {
            alert("Security: Unauthorized Identifier Access");
            window.location.href = 'manage-branches.html';
            return;
        }

        try {
            const res = await fetch(`/api/branches/${branchId}`, {
                headers: { 'Authorization': `Bearer ${TOKEN}` }
            });
            const b = await res.json();

            const cleanPath = (p) => p ? p.replace('/public', '') : '/uploads/default.png';

            document.getElementById('view_branch_name').textContent = b.branch_name;
            document.getElementById('view_branch_code').textContent = b.branch_code;
            document.getElementById('view_pan').textContent = b.pan_number || 'REQUIRED';
            document.getElementById('view_gst').textContent = b.gst_number || 'REQUIRED';
            document.getElementById('view_email').textContent = b.email || 'N/A';
            document.getElementById('view_bank').textContent = b.bank_name || 'N/A';
            document.getElementById('view_acc').textContent = b.account_number || 'N/A';
            document.getElementById('view_ifsc').textContent = b.ifsc_code || 'N/A';
            document.getElementById('view_pin').textContent = b.pin_code || '---';
            document.getElementById('view_address').textContent = b.address || 'N/A';
            document.getElementById('view_manager_name').textContent = b.branch_manager_name || 'Unassigned';
            document.getElementById('view_manager_phone').textContent = b.manager_phone || b.phone_number || '---';
            document.getElementById('view_total_students').textContent = b.total_students || 0;
            
            // Sync New Infrastructure Data
            document.getElementById('view_labs').textContent = b.lab_count || 0;
            document.getElementById('view_classrooms').textContent = b.class_capacity || 0;
            document.getElementById('view_faculty').textContent = b.faculty_count || 0;

            document.getElementById('view_logo').src = cleanPath(b.logo_url);
            document.getElementById('view_manager_photo').src = cleanPath(b.manager_photo);
            
            if(b.facebook_url) document.getElementById('view_fb').href = b.facebook_url;
            else document.getElementById('view_fb').style.display = 'none';

            // Map Logic
            if(b.latitude && b.longitude) {
                const lat = parseFloat(b.latitude);
                const lon = parseFloat(b.longitude);
                const map = L.map('singleBranchMap').setView([lat, lon], 15);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                L.marker([lat, lon]).addTo(map).bindPopup(`<b>${b.branch_name}</b>`).openPopup();
            } else {
                document.getElementById('singleBranchMap').innerHTML = `
                <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; background:#f8fafc; color:#95a5a6; border-radius:18px;">
                    <i class="fas fa-satellite-dish" style="font-size:2rem; margin-bottom:10px;"></i>
                    <p style="font-size:0.8rem;">GPS Metadata Not Synchronized</p>
                </div>`;
            }

        } catch (err) {
            console.error("Critical Sync Failure:", err);
        }
    }

    document.addEventListener('DOMContentLoaded', fetchBranchProfile);
</script>
</body>
</html>