<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Bus Attendance</title>
    <style>
        /* --- CLASSIC DESIGN STYLES --- */
        body { 
            font-family: 'Times New Roman', serif; 
            margin: 0; padding: 2em; 
            background-color: #F8F8F8; 
            color: #333; 
        }
        .container { 
            max-width: 900px; margin: auto; padding: 30px; 
            background-color: #FFFFFF; 
            border: 2px solid #333; 
            box-shadow: 6px 6px 0 #AAA; 
        }
        h1 { 
            color: #C0392B; font-weight: bold; text-transform: uppercase; text-align: center; 
            border-bottom: 5px double #000; padding-bottom: 15px; margin-bottom: 30px; 
            font-size: 2.2em;
        }
        .nav-links { margin-bottom: 20px; }
        .nav-links a { color: #005A9C; text-decoration: none; font-weight: bold; }

        /* Controls */
        .controls { 
            background: #eee; padding: 15px; margin-bottom: 20px; border: 1px solid #ccc; 
        }
        label { font-weight: bold; margin-right: 10px; }
        select { padding: 8px; border: 1px solid #333; min-width: 200px; }
        
        /* Student List */
        .student-list { list-style: none; padding: 0; }
        .student-item { 
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px; border-bottom: 1px solid #ddd; background: #fff;
        }
        .student-item:hover { background-color: #f9f9f9; }
        
        .student-info strong { font-size: 1.1em; color: #000; }
        .student-info span { color: #666; font-size: 0.9em; margin-left: 10px; }

        /* Buttons */
        .actions button {
            padding: 8px 15px; margin-left: 5px; cursor: pointer;
            border: 1px solid #333; font-weight: bold;
        }
        .btn-board { background-color: #2ECC71; color: white; }
        .btn-alight { background-color: #E67E22; color: white; }
        .btn-reset { background-color: #95A5A6; color: white; }
        
        /* Status Badges */
        .status-badge {
            padding: 5px 10px; border-radius: 4px; font-weight: bold; font-size: 0.8em; margin-right: 10px;
        }
        .status-Boarded { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status-Alighted { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        
        .empty-msg { text-align: center; color: #777; font-style: italic; padding: 20px; }
    </style>
</head>
<body>

<div class="container">
    <h1>Bus Attendance</h1>
    <div class="nav-links"><a href="manage-transport.html">‚Üê Back to Transport Management</a></div>

    <div class="controls">
        <label for="route-select">Select Route:</label>
        <select id="route-select" onchange="loadStudents()">
            <option value="">-- Select Route --</option>
        </select>
        
        <span style="margin-left: 20px;">
            <label>Trip:</label> 
            <input type="radio" name="trip" value="pickup" checked> Pickup
            <input type="radio" name="trip" value="drop"> Drop
        </span>
    </div>

    <ul id="student-list" class="student-list">
        <li class="empty-msg">Please select a route to view students.</li>
    </ul>
</div>

<script>
    const token = localStorage.getItem('erp-token');
    if (!token) window.location.href = 'index.html';

    const authHeaders = { 
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
    };

    // 1. Load Routes into Dropdown
    async function loadRoutes() {
        try {
            const res = await fetch('/api/transport/routes', { headers: authHeaders });
            const routes = await res.json();
            const select = document.getElementById('route-select');
            routes.forEach(r => {
                select.innerHTML += `<option value="${r.id}">${r.route_name}</option>`;
            });
        } catch (err) {
            console.error("Error loading routes", err);
        }
    }

    // 2. Load Students for Selected Route
    async function loadStudents() {
        const routeId = document.getElementById('route-select').value;
        const list = document.getElementById('student-list');
        
        if (!routeId) {
            list.innerHTML = '<li class="empty-msg">Please select a route.</li>';
            return;
        }

        list.innerHTML = '<li class="empty-msg">Loading students...</li>';

        try {
            const res = await fetch(`/api/transport/routes/${routeId}/attendance-sheet`, { headers: authHeaders });
            const students = await res.json();

            if (students.length === 0) {
                list.innerHTML = '<li class="empty-msg">No students assigned to this route.</li>';
                return;
            }

            list.innerHTML = students.map(s => `
                <li class="student-item">
                    <div class="student-info">
                        <strong>${s.student_name}</strong>
                        <span>(Roll: ${s.roll_number || 'N/A'})</span>
                    </div>
                    <div class="actions">
                        ${getStatusBadge(s.current_status)}
                        <button class="btn-board" onclick="markAttendance('${s.student_id}', '${routeId}', 'Boarded')">Board</button>
                        <button class="btn-alight" onclick="markAttendance('${s.student_id}', '${routeId}', 'Alighted')">Alight</button>
                    </div>
                </li>
            `).join('');
            
        } catch (err) {
            console.error(err);
            list.innerHTML = '<li class="empty-msg">Error loading student list.</li>';
        }
    }

    // Helper: Badge HTML
    function getStatusBadge(status) {
        if (!status) return '';
        return `<span class="status-badge status-${status}">${status}</span>`;
    }

    // 3. Mark Attendance
    async function markAttendance(studentId, routeId, status) {
        try {
            const res = await fetch('/api/transport/attendance', {
                method: 'POST',
                headers: authHeaders,
                body: JSON.stringify({ student_id: studentId, route_id: routeId, status: status })
            });

            if (res.ok) {
                // Reload list to show updated status
                loadStudents();
            } else {
                alert("Failed to mark attendance.");
            }
        } catch (err) {
            console.error(err);
            alert("Error connecting to server.");
        }
    }

    // Initialize
    window.onload = loadRoutes;
</script>
<script src="js/global-config.js"></script>
</body>
</html>