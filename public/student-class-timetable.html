<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Schedule | BCSM ERP</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #003366; --accent: #FF9933; --success: #138808; }
        body { font-family: 'Outfit', sans-serif; background: #f4f7f6; }
        .smart-header { background: var(--primary); color: white; padding: 60px 0 110px 0; border-radius: 0 0 50px 50px; }
        .day-tabs { background: white; padding: 10px; border-radius: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); margin-top: -55px; display: flex; overflow-x: auto; gap: 8px; position: relative; z-index: 10; }
        .day-tab { padding: 12px 25px; border-radius: 25px; cursor: pointer; white-space: nowrap; font-weight: 600; color: #64748b; }
        .day-tab.active { background: var(--primary); color: white; transform: scale(1.05); }
        .slot-card { background: white; border-radius: 30px; padding: 25px; border: none; transition: 0.4s; box-shadow: 0 10px 20px rgba(0,0,0,0.02); }
        .slot-card.ongoing { border: 2px solid var(--success); }
        .slot-card.passed { filter: grayscale(1) opacity(0.5); }
        .live-glow { width: 10px; height: 10px; background: var(--success); border-radius: 50%; display: inline-block; box-shadow: 0 0 10px var(--success); animation: pulse 1.5s infinite; margin-right: 8px; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.4); opacity: 0.5; } 100% { transform: scale(1); } }
    </style>
</head>
<body>
    <div class="smart-header text-center">
        <div class="container">
            <h2 class="fw-bold"><i class="fas fa-calendar-alt me-2"></i>My Academic Schedule</h2>
            <a href="/student-dashboard.html" class="btn btn-outline-secondary btn-sm ms-2 fw-bold px-4">Back</a>
        </div>
    </div>
    <div class="container">
        <div class="day-tabs mb-5" id="tabs"></div>
        <div id="schedule-feed" class="row g-4 mb-5"></div>
    </div>
    <script>
        const DAYS = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
        let currentDay = DAYS[Math.max(0, new Date().getDay() - 1)];
        let scheduleData = [];

        document.addEventListener('DOMContentLoaded', async () => {
            renderTabs();
            await loadData();
        });

        function renderTabs() {
            document.getElementById('tabs').innerHTML = DAYS.map(d => `<div class="day-tab ${d === currentDay ? 'active' : ''}" onclick="setDay('${d}')">${d}</div>`).join('');
        }

        function setDay(d) { currentDay = d; renderTabs(); renderFeed(); }

        async function loadData() {
            const token = localStorage.getItem('erp-token');
            const res = await fetch('/api/timetable/student/me', { headers: { 'Authorization': `Bearer ${token}` } });
            scheduleData = await res.json();
            renderFeed();
        }

        function renderFeed() {
            const feed = document.getElementById('schedule-feed');
            const filtered = scheduleData.filter(s => s.day_of_week === currentDay);
            feed.innerHTML = '';
            filtered.forEach(s => {
                const state = getSlotState(s.start_time, s.end_time);
                feed.innerHTML += `
                    <div class="col-md-6 col-lg-4">
                        <div class="slot-card ${state}">
                            <div class="fw-bold text-primary small mb-2">${state === 'ongoing' ? '<span class="live-glow"></span>' : ''}${s.start_time.slice(0,5)} - ${s.end_time.slice(0,5)}</div>
                            <h5 class="fw-bold mb-1">${s.subject_name}</h5>
                            <p class="text-muted small mb-3"><i class="fas fa-user-tie me-1"></i> ${s.teacher_name || 'Staff'}</p>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="small fw-bold"><i class="fas fa-map-marker-alt"></i> RM: ${s.room_number || 'TBA'}</span>
                                ${state !== 'passed' ? `<a href="#" class="btn btn-sm btn-outline-primary rounded-pill px-3">Join Hub</a>` : ''}
                            </div>
                        </div>
                    </div>`;
            });
        }

        function getSlotState(start, end) {
            const now = new Date();
            const todayName = DAYS[now.getDay() - 1];
            if(todayName !== currentDay) return 'upcoming';
            const cur = now.getHours() * 60 + now.getMinutes();
            const [sh, sm] = start.split(':').map(Number);
            const [eh, em] = end.split(':').map(Number);
            if(cur > (eh*60+em)) return 'passed';
            if(cur >= (sh*60+sm)) return 'ongoing';
            return 'upcoming';
        }
    </script>
</body>
</html>