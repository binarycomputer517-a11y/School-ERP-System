<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View My Academic Transcript</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f8; font-family: sans-serif; }
        .container { max-width: 800px; margin-top: 50px; }
        .card { border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        h1 { color: #000080; font-weight: bold; }
        .loader-container { 
            text-align: center; 
            padding: 50px; 
            color: #5e35b1; 
            font-size: 1.1em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card p-4">
            <h1 class="mb-4">My Official Transcript</h1>
            
            <div id="loading-area" class="loader-container">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">Fetching your academic record...</p>
                <p class="text-muted small">Your consolidated marksheet will open in a new window for viewing and printing.</p>
                <a href="/student-dashboard.html" class="btn btn-sm btn-outline-secondary mt-3">← Back to Dashboard</a>
            </div>
            
            <div id="error-area" style="display: none;">
                <p class="text-danger">Error: Could not retrieve your student roll number or marks data. Please ensure you are logged in.</p>
                <button onclick="window.location.reload()" class="btn btn-primary">Try Again</button>
            </div>
        </div>
    </div>
    
    <script src="exam-manager-client.js"></script>

    <script>
        // --- Custom Logic to connect Student ID/Roll to the Transcript Viewer ---
        
        // Helper function to fetch student data (copied from your student-dashboard logic)
        async function fetchStudentData(studentId, token) {
            const response = await fetch(`/api/students/${studentId}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!response.ok) throw new Error('Failed to fetch student profile.');
            return response.json();
        }

        async function initViewMarks() {
            const studentId = localStorage.getItem('student-id'); 
            const token = localStorage.getItem('erp-token');
            const loadingArea = document.getElementById('loading-area');
            const errorArea = document.getElementById('error-area');

            if (!studentId || !token || typeof window.viewMarksheet !== 'function') {
                loadingArea.style.display = 'none';
                errorArea.style.display = 'block';
                return;
            }

            try {
                // 1. Fetch student data to get the mandatory Roll Number
                const studentData = await fetchStudentData(studentId, token);
                const rollNumber = studentData.roll_number;

                if (!rollNumber) {
                     throw new Error('Student profile is missing a Roll Number.');
                }
                
                // 2. Execute the powerful viewMarksheet function from exam-manager-client.js
                // This function fetches the marks, calculates grades, and renders the print-ready window.
                await window.viewMarksheet(rollNumber);
                
                // 3. Keep the initial page clean (or redirect) after the print window opens
                loadingArea.innerHTML = '<p class="text-success mt-3">✅ Your marksheet is open in a new tab. Please switch tabs to view/print.</p><a href="/student-dashboard.html" class="btn btn-outline-primary">Return to Dashboard</a>';


            } catch (error) {
                console.error('Transcript Initialization Error:', error);
                loadingArea.style.display = 'none';
                errorArea.style.display = 'block';
                errorArea.querySelector('p').textContent = `Error: ${error.message}. Please check console for details.`;
            }
        }
        
        // Wait for both the DOM and the external script (exam-manager-client.js) to load
        document.addEventListener('DOMContentLoaded', initViewMarks);
    </script>
    <script src="js/global-config.js"></script>
</body>
</html>