<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Question Management</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background-color: #f0f2f5; margin: 20px; }
        .container { max-width: 1400px; margin: auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1, h2 { color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        .grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-top: 20px; }
        .panel { border: 1px solid #ddd; border-radius: 5px; background: #fdfdfd; display: flex; flex-direction: column; }
        .panel h2 { padding: 10px 15px; margin: 0; background: #f9f9f9; border-bottom: 1px solid #ddd; font-size: 1.2em; }
        #central-bank-list, #linked-questions-list { padding: 10px 15px; max-height: 600px; overflow-y: auto; flex-grow: 1; }
        .question-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 8px; border-bottom: 1px solid #eee; background: white; margin-bottom: 5px; border-radius: 4px; }
        .question-item:hover { background-color: #f8f9fa; }
        .add-btn { background-color: #28a745; color: white; border: none; padding: 5px 12px; border-radius: 4px; cursor: pointer; }
        .remove-btn { background-color: #dc3545; color: white; border: none; padding: 5px 12px; border-radius: 4px; cursor: pointer; }
        .linked-tag { color: #6c757d; font-weight: bold; font-size: 0.9em; padding: 5px; }
        #save-links-btn { background-color: #007bff; color: white; padding: 15px; font-size: 1.1em; border: none; border-radius: 5px; width: 100%; cursor: pointer; margin-top: 20px; font-weight: bold; }
        #save-links-btn:disabled { background-color: #ccc; cursor: not-allowed; }
    </style>
</head>
<body>

    <div class="container">
        <h1 id="quiz-title">Quiz Question Manager</h1>
        <div class="grid-container">
            <div class="panel">
                <h2>Central Question Bank (Total: <span id="central-count">0</span>)</h2>
                <div id="central-bank-list"><p>Loading questions...</p></div>
            </div>
            <div class="panel">
                <h2>Questions Linked to This Quiz (Total: <span id="linked-count">0</span>)</h2>
                <div id="linked-questions-list"><p>No questions linked yet.</p></div>
            </div>
        </div>
        <button id="save-links-btn" onclick="saveLinks()">Save Question Links & Order</button>
    </div>

    <script>
        let QUIZ_ID = null;
        let allCentralQuestions = [];
        let linkedQuestions = [];

        // --- Auth Helper ---
        async function handleApi(url, options = {}) {
            const token = localStorage.getItem('erp-token');
            if (!token) { window.location.href = '/login.html'; return; }
            
            options.headers = { 
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json',
                ...options.headers 
            };

            const response = await fetch(url, options);
            if (!response.ok) throw new Error(`Status: ${response.status}`);
            return response.status === 204 ? null : response.json();
        }

        // --- Initial Load ---
        async function init() {
            const params = new URLSearchParams(window.location.search);
            QUIZ_ID = params.get('quizId');
            if (!QUIZ_ID) { alert("Quiz ID missing!"); return; }
            document.getElementById('quiz-title').textContent = `Managing Quiz: ${QUIZ_ID}`;
            
            await loadData();
        }

        async function loadData() {
            try {
                // ১. আগে লিঙ্ক করা প্রশ্নগুলো নিয়ে আসা (Persistence Fix)
                linkedQuestions = await handleApi(`/api/online-exam/quizzes/${QUIZ_ID}/links`);
                
                // ২. তারপর সব প্রশ্ন নিয়ে আসা
                allCentralQuestions = await handleApi(`/api/online-exam/question-bank`);
                
                renderAll();
            } catch (err) {
                console.error(err);
                alert("Failed to load data.");
            }
        }

        function renderAll() {
            renderLinkedSide();
            renderBankSide();
        }

        // --- UI Rendering ---
        function renderBankSide() {
            const list = document.getElementById('central-bank-list');
            document.getElementById('central-count').textContent = allCentralQuestions.length;
            
            const linkedIds = new Set(linkedQuestions.map(q => q.question_id));

            list.innerHTML = allCentralQuestions.map(q => {
                const isLinked = linkedIds.has(q.question_id);
                return `
                    <div class="question-item">
                        <span>${q.question_text} (ID: ${q.question_id})</span>
                        ${isLinked ? '<span class="linked-tag">Linked</span>' : 
                        `<button class="add-btn" onclick="addToList(${q.question_id}, '${q.question_text.replace(/'/g, "\\'")}')">Add</button>`}
                    </div>
                `;
            }).join('');
        }

        function renderLinkedSide() {
            const list = document.getElementById('linked-questions-list');
            document.getElementById('linked-count').textContent = linkedQuestions.length;

            if (linkedQuestions.length === 0) {
                list.innerHTML = '<p style="text-align:center; padding:20px;">Add questions from the bank.</p>';
                return;
            }

            list.innerHTML = linkedQuestions.map((q, index) => `
                <div class="question-item">
                    <span><strong>${index + 1}.</strong> ${q.question_text}</span>
                    <button class="remove-btn" onclick="removeFromList(${q.question_id})">Remove</button>
                </div>
            `).join('');
        }

        // --- Logic ---
        function addToList(id, text) {
            if (linkedQuestions.some(q => q.question_id === id)) return;
            linkedQuestions.push({ question_id: id, question_text: text });
            renderAll();
        }

        function removeFromList(id) {
            linkedQuestions = linkedQuestions.filter(q => q.question_id !== id);
            renderAll();
        }

        // --- Save to DB (Full Sync) ---
        async function saveLinks() {
            const btn = document.getElementById('save-links-btn');
            btn.disabled = true;
            btn.textContent = "Saving to Database...";

            try {
                // কুইজ আইডির অ্যারে তৈরি করা
                const idArray = linkedQuestions.map(q => q.question_id);
                
                await handleApi(`/api/online-exam/quizzes/${QUIZ_ID}/link-questions`, {
                    method: 'PUT',
                    body: JSON.stringify({ questionIds: idArray }) // আপনার ব্যাকএন্ড questionIds আশা করছে
                });

                alert("✅ Successfully saved! Data will persist on refresh.");
                await loadData(); // রিফ্রেশ না করে পুনরায় ডাটা লোড করা
            } catch (err) {
                alert("❌ Save failed: " + err.message);
            } finally {
                btn.disabled = false;
                btn.textContent = "Save Question Links & Order";
            }
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>