<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Ledger | School ERP</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; padding: 30px; font-family: 'Segoe UI', sans-serif; }
        .container { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); max-width: 1000px; }
        .header-info { border-bottom: 2px solid #eee; padding-bottom: 15px; margin-bottom: 20px; }
        .table th { background-color: #34495e; color: white; text-align: center; }
        .text-debit { color: #c0392b; font-weight: bold; text-align: right; }
        .text-credit { color: #27ae60; font-weight: bold; text-align: right; }
        .text-balance { color: #2980b9; font-weight: bold; text-align: right; }
        .no-print { margin-bottom: 20px; }
        
        @media print {
            .no-print { display: none !important; }
            body { background-color: white; padding: 0; }
            .container { box-shadow: none; border: none; padding: 0; }
        }
    </style>
</head>
<body>

<div class="container">
    
    <div class="no-print">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <a href="/finance-dashboard.html" class="btn btn-outline-secondary">‚Üê Back to Dashboard</a>
            <button onclick="window.print()" class="btn btn-primary">üñ®Ô∏è Print Ledger</button>
        </div>

        <div class="card p-3 bg-light border-0">
            <label class="form-label fw-bold">Select Student to View Ledger:</label>
            <select id="studentSelect" class="form-select" onchange="fetchLedger()">
                <option value="">-- Loading Students... --</option>
            </select>
        </div>
    </div>

    <div id="ledgerReport" style="display:none;">
        <div class="header-info">
            <div class="row">
                <div class="col-6">
                    <h4 class="text-uppercase text-primary mb-1">School ERP System</h4>
                    <p class="text-muted small mb-0">123 Education Lane, West Bengal</p>
                    <p class="text-muted small">Phone: +91-9876543210</p>
                </div>
                <div class="col-6 text-end">
                    <h5 id="stName" class="fw-bold">Student Name</h5>
                    <p class="mb-0">Roll No: <span id="stRoll" class="fw-bold"></span></p>
                    <p class="mb-0 text-muted"><span id="stBatch"></span></p>
                    <p class="small text-muted mt-1">Date: <span id="genDate"></span></p>
                </div>
            </div>
            <h3 class="text-center mt-3 text-decoration-underline">Student Account Ledger</h3>
        </div>

        <div class="table-responsive">
            <table class="table table-bordered table-striped">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Ref No</th>
                        <th>Description</th>
                        <th>Debit (Bill)</th>
                        <th>Credit (Paid)</th>
                        <th>Balance</th>
                    </tr>
                </thead>
                <tbody id="ledgerBody"></tbody>
                <tfoot class="table-light fw-bold">
                    <tr>
                        <td colspan="3" class="text-end">Grand Total:</td>
                        <td class="text-end text-danger" id="totalDebit">0.00</td>
                        <td class="text-end text-success" id="totalCredit">0.00</td>
                        <td class="text-end text-primary" id="finalBalance">0.00</td>
                    </tr>
                </tfoot>
            </table>
        </div>
        
        <div class="row mt-5 pt-4">
            <div class="col-6 text-center">
                <div style="border-top: 1px dashed #000; width: 60%; margin: 0 auto;">Parent Signature</div>
            </div>
            <div class="col-6 text-center">
                <div style="border-top: 1px dashed #000; width: 60%; margin: 0 auto;">Accountant Signature</div>
            </div>
        </div>
    </div>

</div>

<script>
    const token = localStorage.getItem('erp-token');
    const API_BASE = '/api';

    // 1. Load Student List
    async function loadStudents() {
        try {
            const res = await fetch(`${API_BASE}/students`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const students = await res.json();
            
            const select = document.getElementById('studentSelect');
            select.innerHTML = '<option value="">-- Select Student --</option>';
            
            students.forEach(s => {
                const option = document.createElement('option');
                option.value = s.student_id;
                option.text = `${s.first_name} ${s.last_name} (${s.enrollment_no})`;
                select.appendChild(option);
            });
        } catch (error) {
            console.error("Error loading students", error);
        }
    }

    // 2. Fetch Ledger Data
    async function fetchLedger() {
        const studentId = document.getElementById('studentSelect').value;
        if (!studentId) {
            document.getElementById('ledgerReport').style.display = 'none';
            return;
        }

        try {
            const res = await fetch(`${API_BASE}/fees/ledger/${studentId}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if(!res.ok) throw new Error("Failed to fetch ledger data");
            
            const data = await res.json();
            renderLedger(data);

        } catch (error) {
            alert("Error: " + error.message);
        }
    }

    // 3. Render Logic
    function renderLedger(data) {
        const { student, ledger } = data;
        const tbody = document.getElementById('ledgerBody');
        
        document.getElementById('ledgerReport').style.display = 'block';
        document.getElementById('stName').innerText = student.username;
        document.getElementById('stRoll').innerText = student.roll_number || 'N/A';
        document.getElementById('stBatch').innerText = `${student.course_name || ''} ${student.batch_name ? '- ' + student.batch_name : ''}`;
        document.getElementById('genDate').innerText = new Date().toLocaleDateString();

        tbody.innerHTML = '';
        let runningBalance = 0;
        let sumDebit = 0;
        let sumCredit = 0;

        if (ledger.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center py-3">No transactions found for this student.</td></tr>';
            return;
        }

        ledger.forEach(row => {
            const debit = parseFloat(row.debit);
            const credit = parseFloat(row.credit);
            
            // Balance Calculation: Previous Balance + New Bill - New Payment
            runningBalance = runningBalance + debit - credit;
            
            sumDebit += debit;
            sumCredit += credit;

            tbody.innerHTML += `
                <tr>
                    <td class="text-center">${new Date(row.date).toLocaleDateString('en-IN')}</td>
                    <td class="text-center small">${row.ref_no}</td>
                    <td>${row.description}</td>
                    <td class="text-debit">${debit > 0 ? '‚Çπ' + debit.toFixed(2) : '-'}</td>
                    <td class="text-credit">${credit > 0 ? '‚Çπ' + credit.toFixed(2) : '-'}</td>
                    <td class="text-balance">‚Çπ${runningBalance.toFixed(2)}</td>
                </tr>
            `;
        });

        document.getElementById('totalDebit').innerText = '‚Çπ' + sumDebit.toFixed(2);
        document.getElementById('totalCredit').innerText = '‚Çπ' + sumCredit.toFixed(2);
        document.getElementById('finalBalance').innerText = '‚Çπ' + runningBalance.toFixed(2);
    }

    // Initialize
    loadStudents();
</script>

</body>
</html>