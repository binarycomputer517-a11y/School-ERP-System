<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Profile | ERP System</title>
    
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root {
            --bg-dark: #050505;
            --panel-bg: rgba(20, 25, 35, 0.85);
            --primary: #00f3ff;
            --secondary: #7000ff;
            --success: #00ff9d;
            --danger: #ff0055;
            --warning: #ffbe0b;
            --text-main: #e0e6ed;
            --text-muted: #94a3b8;
            --border: 1px solid rgba(0, 243, 255, 0.2);
            --glass: blur(10px);
        }

        * { box-sizing: border-box; outline: none; }

        body {
            font-family: 'Rajdhani', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }

        /* Background Grid */
        body::before {
            content: "";
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: linear-gradient(rgba(0, 243, 255, 0.03) 1px, transparent 1px),
            linear-gradient(90deg, rgba(0, 243, 255, 0.03) 1px, transparent 1px);
            background-size: 30px 30px;
            z-index: -1;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
        }

        /* --- Sidebar --- */
        .profile-sidebar {
            background: var(--panel-bg);
            border: var(--border);
            padding: 20px;
            text-align: center;
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .avatar-frame {
            width: 150px; height: 150px;
            margin: 0 auto 15px;
            padding: 5px;
            border: 2px dashed var(--primary);
            border-radius: 50%;
            overflow: hidden;
        }

        .avatar-frame img {
            width: 100%; height: 100%;
            object-fit: cover;
            border-radius: 50%;
            background: #000;
        }

        .student-name { font-size: 1.8rem; margin: 10px 0 5px; color: #fff; text-shadow: 0 0 10px var(--primary); }
        .student-id { color: var(--primary); font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; }
        
        .sidebar-stats {
            margin-top: 20px;
            display: flex;
            justify-content: space-around;
            border-top: 1px solid rgba(255,255,255,0.1);
            padding-top: 15px;
        }
        .stat-box small { display: block; color: var(--text-muted); font-size: 0.7rem; }
        .stat-box span { font-size: 1.2rem; font-weight: bold; color: #fff; }

        /* --- Main Content --- */
        .main-content { display: flex; flex-direction: column; gap: 20px; }

        .tabs-nav { display: flex; background: var(--panel-bg); border: var(--border); padding: 5px; overflow-x: auto; }
        .tab-btn {
            background: transparent; border: none; color: var(--text-muted);
            padding: 12px 25px; cursor: pointer; font-family: 'Rajdhani', sans-serif;
            font-weight: 700; font-size: 1.1rem; text-transform: uppercase; transition: 0.3s;
        }
        .tab-btn:hover { color: var(--primary); }
        .tab-btn.active { color: var(--bg-dark); background: var(--primary); box-shadow: 0 0 15px var(--primary); }

        .tab-pane { display: none; background: var(--panel-bg); border: var(--border); padding: 25px; animation: fadeIn 0.4s ease; min-height: 400px;}
        .tab-pane.active { display: block; }

        .section-title {
            font-size: 1.4rem; color: var(--primary); border-bottom: 1px solid rgba(0, 243, 255, 0.3);
            padding-bottom: 10px; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;
        }

        .info-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
        .info-item { background: rgba(255,255,255,0.03); padding: 15px; border-left: 3px solid var(--secondary); }
        .info-item label { display: block; color: var(--text-muted); font-size: 0.8rem; margin-bottom: 5px; text-transform: uppercase; }
        .info-item .value { font-size: 1.1rem; font-weight: 600; color: #fff; }

        /* Empty State */
        .no-data {
            text-align: center; color: var(--text-muted); padding: 40px;
            border: 1px dashed var(--text-muted); font-family: 'JetBrains Mono';
        }

        /* Fee Widget */
        .fee-widget { background: rgba(0,0,0,0.3); padding: 20px; margin-top: 20px; border: 1px solid var(--text-muted); }
        .progress-container { height: 20px; background: #333; border-radius: 10px; overflow: hidden; margin: 10px 0; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, var(--primary), var(--secondary)); width: 0%; transition: width 1s ease-in-out; }
        
        /* Tables */
        table { width: 100%; margin-top: 20px; border-collapse: collapse; font-family: 'JetBrains Mono'; font-size: 0.9rem; }
        th { text-align: left; padding: 10px; color: var(--primary); border-bottom: 2px solid var(--text-muted); }
        td { padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); }

        /* Heatmap */
        .attendance-heatmap { display: grid; grid-template-columns: repeat(auto-fill, minmax(30px, 1fr)); gap: 5px; margin-top: 15px; }
        .heat-box { height: 30px; background: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; font-size: 0.7rem; }
        .heat-present { background: rgba(0, 255, 157, 0.6); color: #000; }
        .heat-absent { background: rgba(255, 0, 85, 0.6); color: #fff; }
        .heat-leave { background: var(--warning); color: #000; }

        /* Timeline */
        .timeline { border-left: 2px solid var(--primary); margin-left: 10px; padding-left: 20px; }
        .timeline-item { position: relative; margin-bottom: 25px; }
        .timeline-item::before {
            content: ''; position: absolute; left: -26px; top: 5px; width: 10px; height: 10px;
            background: var(--bg-dark); border: 2px solid var(--primary); border-radius: 50%;
        }
        .t-date { color: var(--primary); font-size: 0.85rem; font-family: 'JetBrains Mono'; }
        .t-content { background: rgba(255,255,255,0.05); padding: 10px; margin-top: 5px; border-radius: 4px; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Mobile */
        @media (max-width: 768px) {
            .container { grid-template-columns: 1fr; }
            .profile-sidebar { position: static; }
        }
        
        /* ðŸš€ PRINT SUMMARY MODIFICATIONS ðŸš€ */
        @media print {
            body { 
                background: #fff; 
                color: #000; 
                /* Ensure all content fits on one A4 page without excessive margins */
                margin: 0; 
                padding: 10mm;
            }
            .container { 
                display: block; /* Stack sidebar and main content */
                max-width: 100%;
            }
            
            /* Hide non-summary UI elements */
            .tabs-nav, .back-nav, button { 
                display: none; 
            }
            body::before, .avatar-frame { 
                border: none; 
                background: none; 
            }

            /* Main Content and Sidebar Layout for Print */
            .main-content {
                padding-top: 20px;
            }
            .profile-sidebar { 
                border: none; 
                background: none; 
                padding: 0; 
                margin-bottom: 20px;
                position: static; /* Important for flow */
                width: 100%;
                text-align: left; /* Adjust sidebar alignment for print */
            }
            .profile-sidebar h1, .profile-sidebar div {
                text-align: left;
            }
            .sidebar-stats {
                justify-content: flex-start;
                gap: 40px;
                border: none;
                padding-top: 0;
            }
            .stat-box {
                border: 1px solid #ccc;
                padding: 10px;
            }


            /* Display ALL panes for a complete summary, but simplify their appearance */
            .tab-pane { 
                display: block !important; /* Forces all tabs to display */
                border: 1px solid #ccc; 
                background: none; 
                color: #000; 
                page-break-inside: avoid;
                margin-top: 20px;
                padding: 15px;
            }
            
            /* Remove background/glass effects in print */
            .profile-sidebar, .tab-pane, .tabs-nav {
                background: none !important;
                border: 1px solid #ccc !important;
            }
            
            /* Re-style titles for print */
            .section-title {
                color: #333;
                border-bottom: 1px solid #ddd;
            }
            
            /* Ensure maps and charts are visible and legible */
            #map-container { 
                filter: none !important; 
                border: 1px solid #ddd !important;
                height: 150px !important; /* Smaller map for summary */
            }
            #charts-container {
                grid-template-columns: 1fr; /* Stack charts vertically */
            }
            #charts-container > div {
                 background: #f7f7f7 !important; /* Light background for charts */
            }

            /* Hide elements intended for interactive use or excessive detail */
            #invoice-table, #timeline-container, .attendance-heatmap {
                display: none; /* Hiding tables, heatmap, and full timeline for a brief A4 summary */
            }
            
            /* Keep essential finance summary */
            .fee-widget {
                border: 1px solid #ccc;
                background: #f7f7f7;
            }

        }
    </style>
</head>
<body>

<div class="container">
    
    <aside class="profile-sidebar">
        <div style="margin-bottom: 20px; text-align: left;" class="back-nav">
            <a href="/students-list.html" style="color: var(--text-muted); text-decoration: none; font-weight:bold;"><i class="fas fa-arrow-left"></i> BACK</a>
        </div>

        <div class="avatar-frame">
            <img id="p-photo" src="" alt="Profile Photo">
        </div>
        
        <h1 class="student-name" id="p-name">Loading...</h1>
        <div class="student-id" id="p-admission-id">---</div>
        <div id="p-status-container" style="margin-top: 10px;"></div>

        <div class="sidebar-stats">
            <div class="stat-box">
                <small>Attendance</small>
                <span id="p-attendance-stat">--</span>
            </div>
            <div class="stat-box">
                <small>Due Fees</small>
                <span id="p-due-stat" style="color: var(--danger)">--</span>
            </div>
        </div>

        <div style="margin-top: 25px; display: grid; gap: 10px;">
            <button onclick="window.print()" class="tab-btn" style="border: 1px solid var(--text-muted); font-size: 0.9rem;">
                <i class="fas fa-print"></i> PRINT
            </button>
            <button onclick="generateIdCard()" class="tab-btn" style="border: 1px solid var(--primary); font-size: 0.9rem; color: var(--primary);">
                <i class="fas fa-id-card"></i> ID CARD
            </button>
        </div>
    </aside>

    <main class="main-content">
        
        <nav class="tabs-nav">
            <button class="tab-btn active" onclick="switchTab('overview')">Overview</button>
            <button class="tab-btn" onclick="switchTab('academic')">Academic</button>
            <button class="tab-btn" onclick="switchTab('finance')">Finance</button>
            <button class="tab-btn" onclick="switchTab('history')">Timeline</button>
        </nav>

        <div id="overview" class="tab-pane active">
            <h2 class="section-title"><i class="fas fa-user-astronaut"></i> Personal Data</h2>
            <div class="info-grid">
                <div class="info-item"><label>Full Name</label><div class="value" id="d-fullname"></div></div>
                <div class="info-item"><label>Date of Birth</label><div class="value" id="d-dob"></div></div>
                <div class="info-item"><label>Gender</label><div class="value" id="d-gender"></div></div>
                <div class="info-item"><label>Blood Group</label><div class="value" id="d-blood"></div></div>
                <div class="info-item"><label>Phone</label><div class="value" id="d-phone"></div></div>
                <div class="info-item"><label>Email</label><div class="value" id="d-email"></div></div>
            </div>

            <h2 class="section-title" style="margin-top: 30px;"><i class="fas fa-users"></i> Guardian Info</h2>
            <div class="info-grid">
                <div class="info-item"><label>Father's Name</label><div class="value" id="d-father"></div></div>
                <div class="info-item"><label>Mother's Name</label><div class="value" id="d-mother"></div></div>
                <div class="info-item"><label>Emergency Contact</label><div class="value" id="d-emergency"></div></div>
            </div>

            <h2 class="section-title" style="margin-top: 30px;"><i class="fas fa-map-marker-alt"></i> Address</h2>
            <div class="info-item">
                <label>Present Address</label>
                <div class="value" id="d-address"></div>
            </div>
            <div id="map-container" style="height: 250px; border: 1px solid var(--text-muted); margin-top: 15px; display:none;"></div>
        </div>

        <div id="academic" class="tab-pane">
            <h2 class="section-title"><i class="fas fa-chart-line"></i> Performance</h2>
            <div id="charts-container" style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px;">
                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px;">
                    <canvas id="examChart"></canvas>
                </div>
                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px;">
                    <canvas id="skillsChart"></canvas>
                </div>
            </div>
            <div id="no-academic-data" class="no-data" style="display:none;">No academic records found.</div>

            <h2 class="section-title" style="margin-top: 30px;"><i class="fas fa-calendar-alt"></i> Attendance History</h2>
            <div class="attendance-heatmap" id="attendance-grid"></div>
            <div id="no-attendance-data" class="no-data" style="display:none;">No attendance logs available.</div>
        </div>

        <div id="finance" class="tab-pane">
            <h2 class="section-title"><i class="fas fa-credit-card"></i> Fee Status</h2>
            
            <div id="finance-content">
                <div class="fee-widget">
                    <div style="display: flex; justify-content: space-between; align-items: end; margin-bottom: 5px;">
                        <span>Payment Progress</span>
                        <span id="fee-percentage" style="color: var(--primary); font-weight: bold;">0%</span>
                    </div>
                    <div class="progress-container">
                        <div class="progress-bar" id="fee-bar"></div>
                    </div>
                    <div class="fee-details" style="display: flex; justify-content: space-between;">
                        <span style="color: var(--success);">PAID: <span id="val-paid">â‚¹0</span></span>
                        <span style="color: var(--danger);">DUE: <span id="val-due">â‚¹0</span></span>
                    </div>
                </div>

                <table id="invoice-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Description</th>
                            <th style="text-align: right;">Amount</th>
                            <th style="text-align: center;">Status</th>
                        </tr>
                    </thead>
                    <tbody id="invoice-list"></tbody>
                </table>
            </div>
            
            <div id="no-finance-data" class="no-data" style="display:none;">
                Financial records not initialized for this student.
            </div>
        </div>

        <div id="history" class="tab-pane">
            <h2 class="section-title"><i class="fas fa-history"></i> Activity Log</h2>
            <div class="timeline" id="timeline-container"></div>
            <div id="no-timeline-data" class="no-data" style="display:none;">No activity history recorded.</div>
        </div>

    </main>
</div>

<script>
    const API_BASE_URL = window.API_BASE_URL || '/api';
    const token = localStorage.getItem('erp-token');
    if (!token) window.location.href = '/login.html';

    const urlParams = new URLSearchParams(window.location.search);
    const studentId = urlParams.get('id');
    let mapInstance = null;

    document.addEventListener('DOMContentLoaded', async () => {
        if (!studentId) {
            document.querySelector('.container').innerHTML = "<h1 style='color:red; text-align:center;'>Error: Missing Student ID</h1>";
            return;
        }
        
        try {
            const studentRes = await fetch(`${API_BASE_URL}/students/${studentId}`, { headers: { 'Authorization': `Bearer ${token}` } });
            
            if (!studentRes.ok) throw new Error("Failed to load student");
            const studentData = await studentRes.json();
            
            populateBasicInfo(studentData);
            populateFinance(studentData);
            populateAcademic(studentData);
            populateTimeline(studentData);

        } catch (error) {
            console.error(error);
            document.querySelector('.container').innerHTML = `<h2 style='color:red; text-align:center;'>Error Loading Profile: ${error.message}</h2>`;
        }
    });

    // 1. Basic Info Populator
    function populateBasicInfo(data) {
        const set = (id, val) => {
            const el = document.getElementById(id);
            if(el) el.textContent = val || 'N/A';
        };
        
        document.title = `${data.first_name}'s Profile`;
        set('p-name', `${data.first_name} ${data.last_name}`);
        set('p-admission-id', data.admission_id || data.student_id);
        
        // Status Badge
        const statusDiv = document.getElementById('p-status-container');
        statusDiv.innerHTML = `<span style="padding: 5px 10px; border: 1px solid var(--success); color: var(--success); font-weight:bold; text-transform:uppercase;">${data.status || 'Active'}</span>`;

        // --- FIXED IMAGE LOGIC ---
        const photoEl = document.getElementById('p-photo');
        const imagePath = data.profile_image_path || data.profile_image; 
        const defaultAvatar = `https://ui-avatars.com/api/?name=${data.first_name}+${data.last_name}&background=0a0f18&color=00f3ff&bold=true`;

        if (imagePath) {
            if (imagePath.startsWith('data:image')) {
                photoEl.src = imagePath; // Base64
            } else if (imagePath.startsWith('http')) {
                photoEl.src = imagePath; // Full URL
            } else {
                const cleanPath = imagePath.replace(/^\//, ''); 
                photoEl.src = `${API_BASE_URL}/${cleanPath}`; // Relative path
            }
        } else {
            photoEl.src = defaultAvatar;
        }
        photoEl.onerror = () => { photoEl.src = defaultAvatar; };
        // --------------------------

        set('p-attendance-stat', data.attendance_percentage ? `${data.attendance_percentage}%` : 'N/A');
        set('p-due-stat', data.total_fees_due ? `â‚¹${data.total_fees_due}` : 'N/A');

        set('d-fullname', `${data.first_name} ${data.last_name}`);
        set('d-dob', data.dob ? new Date(data.dob).toLocaleDateString() : 'N/A');
        set('d-gender', data.gender);
        set('d-blood', data.blood_group);
        set('d-phone', data.phone_number);
        set('d-email', data.email);
        set('d-father', data.father_name);
        set('d-mother', data.mother_name);
        set('d-emergency', data.emergency_contact_number || data.emergency_contact);
        set('d-address', data.permanent_address || data.present_address);

        // Map Setup
        if (data.location_coords) {
            const [lat, lng] = data.location_coords.split(',').map(c => parseFloat(c.trim()));
            if (!isNaN(lat) && !isNaN(lng)) {
                document.getElementById('map-container').style.display = 'block';
                initMap(lat, lng);
            }
        }
    }

    // 2. Finance
    function populateFinance(data) {
        const hasFinanceData = (data.total_course_fee !== undefined) || (data.payment_history && data.payment_history.length > 0);
        if (!hasFinanceData) {
            document.getElementById('finance-content').style.display = 'none';
            document.getElementById('no-finance-data').style.display = 'block';
            return;
        }

        const total = parseFloat(data.total_course_fee) || 0;
        const due = parseFloat(data.total_fees_due) || 0;
        const paid = total - due;
        
        if (total > 0) {
            const percent = Math.round((paid / total) * 100);
            document.getElementById('fee-bar').style.width = `${percent}%`;
            document.getElementById('fee-percentage').textContent = `${percent}%`;
            document.getElementById('val-paid').textContent = `â‚¹${paid}`;
            document.getElementById('val-due').textContent = `â‚¹${due}`;
        }

        const tbody = document.getElementById('invoice-list');
        tbody.innerHTML = '';
        if (data.payment_history && Array.isArray(data.payment_history)) {
            data.payment_history.forEach(pay => {
                const row = `<tr>
                    <td>${new Date(pay.payment_date).toLocaleDateString()}</td>
                    <td>${pay.description || 'Fee Payment'}</td>
                    <td style="text-align:right">â‚¹${pay.amount}</td>
                    <td style="text-align:center">${pay.status || 'Completed'}</td>
                </tr>`;
                tbody.innerHTML += row;
            });
        } else {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">No transaction history.</td></tr>';
        }
    }

    // 3. Academic
    function populateAcademic(data) {
        const hasExamData = data.exam_results && Array.isArray(data.exam_results) && data.exam_results.length > 0;
        if (hasExamData) {
            const labels = data.exam_results.map(e => e.exam_name);
            const scores = data.exam_results.map(e => e.percentage || e.total_marks);
            
            new Chart(document.getElementById('examChart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Performance (%)',
                        data: scores,
                        borderColor: '#00f3ff',
                        tension: 0.3
                    }]
                },
                options: { responsive: true, scales: { y: { beginAtZero: true, max: 100 } } }
            });
        } else {
            document.getElementById('charts-container').style.display = 'none';
            document.getElementById('no-academic-data').style.display = 'block';
        }

        const attendanceGrid = document.getElementById('attendance-grid');
        attendanceGrid.innerHTML = '';
        if (data.attendance_logs && Array.isArray(data.attendance_logs) && data.attendance_logs.length > 0) {
            data.attendance_logs.forEach(log => {
                const box = document.createElement('div');
                box.className = `heat-box ${log.status === 'Present' ? 'heat-present' : 'heat-absent'}`;
                box.title = `${new Date(log.date).toDateString()}: ${log.status}`;
                box.textContent = new Date(log.date).getDate();
                attendanceGrid.appendChild(box);
            });
        } else {
            document.getElementById('no-attendance-data').style.display = 'block';
        }
    }

    // 4. Timeline
    function populateTimeline(data) {
        const container = document.getElementById('timeline-container');
        container.innerHTML = '';
        if (data.activity_logs && Array.isArray(data.activity_logs) && data.activity_logs.length > 0) {
            data.activity_logs.forEach(log => {
                const item = `<div class="timeline-item">
                    <div class="t-date">${new Date(log.timestamp).toLocaleString()}</div>
                    <div class="t-content">${log.message}</div>
                </div>`;
                container.innerHTML += item;
            });
        } else {
            document.getElementById('no-timeline-data').style.display = 'block';
        }
    }

    // --- Map Initialization (Fixed) ---
    function initMap(lat, lng) {
        if (typeof L === 'undefined') {
            console.error("Leaflet library not loaded.");
            return;
        }
        if (mapInstance) mapInstance.remove();
        
        mapInstance = L.map('map-container').setView([lat, lng], 14);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap contributors &copy; CARTO',
            subdomains: 'abcd',
            maxZoom: 20
        }).addTo(mapInstance);
        L.marker([lat, lng]).addTo(mapInstance);
    }

    window.switchTab = (tabId) => {
        document.querySelectorAll('.tab-pane').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        event.currentTarget.classList.add('active');
        
        if(tabId === 'overview' && mapInstance) {
            setTimeout(() => mapInstance.invalidateSize(), 200);
        }
    };

    window.generateIdCard = () => {
        window.open(`${API_BASE_URL}/reports/generate-id?studentId=${studentId}`, '_blank');
    };
</script>

</body>
</html>