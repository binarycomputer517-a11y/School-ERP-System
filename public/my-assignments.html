<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Assignments | Student Portal</title>
    <style>
        /* --- ACADEMIC STYLING --- */
        body { font-family: 'Times New Roman', serif; margin: 0; padding: 2em; background-color: #F4F7F6; color: #333; }
        .container { max-width: 1100px; margin: auto; background: #FFF; padding: 40px; border: 1px solid #222; box-shadow: 10px 10px 0 #999; }
        h1 { text-align: center; border-bottom: 5px double #222; padding-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; }
        
        /* Assignment Cards */
        .assignment-card { border: 1px solid #444; padding: 25px; margin-bottom: 20px; display: grid; grid-template-columns: 1fr 220px; gap: 20px; align-items: center; background: #fff; }
        .assignment-card:hover { border-color: #005A9C; background: #fafafa; }
        
        .info h3 { margin: 0 0 10px 0; color: #005A9C; font-size: 1.4em; }
        .info p { margin: 5px 0; font-size: 0.95em; color: #555; }
        
        .status-tag { display: inline-block; padding: 5px 12px; font-size: 0.75em; font-weight: bold; border: 1px solid #000; text-transform: uppercase; margin-bottom: 10px; }
        .status-not-submitted { background: #eee; color: #333; }
        .status-pending-review { background: #fff3cd; color: #856404; }
        .status-graded { background: #d4edda; color: #155724; }

        .btn-action { background: #005A9C; color: white; padding: 12px; border: 2px solid #000; cursor: pointer; font-weight: bold; text-align: center; text-decoration: none; box-shadow: 3px 3px 0 #000; display: block; width: 100%; box-sizing: border-box; font-size: 0.9em; }
        .btn-action:hover { background: #003d6b; }
        .btn-action:disabled { background: #999; cursor: not-allowed; box-shadow: none; border-color: #777; }

        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 30px; border: 3px solid #005A9C; width: 450px; box-shadow: 10px 10px 0 #000; }
        
        .error-display { color: #c0392b; font-weight: bold; text-align: center; padding: 30px; border: 2px dashed #c0392b; background: #fff; }
    </style>
</head>
<body>

<div class="container">
    <h1>Academic Assignments & Submissions</h1>
    <div style="margin-bottom: 25px;">
        <a href="/student-dashboard.html" style="font-weight: bold; color: #005A9C; text-decoration: none; border-bottom: 1px solid #005A9C;">&larr; Return to Dashboard</a>
    </div>
    
    <div id="assignment-list">
        <div style="text-align: center; padding: 40px; font-style: italic;">Loading assignment records...</div>
    </div>
</div>

<div id="submit-modal" class="modal">
    <div class="modal-content">
        <h2 style="margin-top: 0; color: #005A9C; text-transform: uppercase;">Submit Your Work</h2>
        <form id="upload-form">
            <input type="hidden" id="submit-id">
            
            <label style="display: block; margin-bottom: 8px; font-weight: bold;">Attach Assignment File (PDF/DOC/Image):</label>
            <input type="file" id="submission-file" required style="margin-bottom: 15px; width: 100%;">
            
            <label style="display: block; margin-bottom: 8px; font-weight: bold;">Notes for Instructor:</label>
            <textarea id="student-notes" rows="3" style="width: 100%; padding: 10px; border: 1px solid #333; box-sizing: border-box;" placeholder="Optional comments..."></textarea>
            
            <div style="margin-top: 25px; display: flex; gap: 15px;">
                <button type="submit" class="btn-action" style="flex: 2;">CONFIRM SUBMISSION</button>
                <button type="button" class="btn-action" style="background: #777; flex: 1; box-shadow: 3px 3px 0 #333;" onclick="closeModal()">CANCEL</button>
            </div>
        </form>
    </div>
</div>



<script>
    const token = localStorage.getItem('erp-token');

    // উন্নত টোকেন পার্সিং লজিক (null আইডি সমস্যা এড়াতে)
    function getStudentId() {
        if (!token) return null;
        try {
            const payload = JSON.parse(atob(token.split('.')[1]));
            return payload.studentId || payload.id || localStorage.getItem('student-id');
        } catch (e) {
            console.error("Token error:", e);
            return localStorage.getItem('student-id');
        }
    }

    const currentStudentId = getStudentId();

    async function loadAssignments() {
        const listDiv = document.getElementById('assignment-list');

        if (!currentStudentId || currentStudentId === "null") {
            listDiv.innerHTML = `<div class="error-display">Profile Identity Missing. Please log out and log in again to sync your student ID.</div>`;
            return;
        }

        try {
            const res = await fetch(`/api/online-learning/assignments/student/${currentStudentId}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (!res.ok) throw new Error("Synchronization failure with server.");

            const assignments = await res.json();

            if (assignments.length === 0) {
                listDiv.innerHTML = '<div style="text-align:center; padding:50px; border:1px dashed #ccc;">No assignments have been assigned to your profile yet.</div>';
                return;
            }

            listDiv.innerHTML = assignments.map(a => {
                const statusSlug = a.submission_status.toLowerCase().replace(/\s+/g, '-');
                const isLocked = a.submission_status !== 'Not Submitted';

                return `
                    <div class="assignment-card">
                        <div class="info">
                            <span class="status-tag status-${statusSlug}">${a.submission_status}</span>
                            <h3>${a.title}</h3>
                            <p><b>Reference Material:</b> <a href="${a.content_url}" target="_blank" style="color:#005A9C;">View Study Content</a></p>
                            <p><b>Grade:</b> ${a.marks_obtained || '--'} / ${a.max_marks}</p>
                            ${a.feedback ? `<div style="margin-top:12px; padding:10px; background:#e3f2fd; border-left:4px solid #005A9C; font-size:0.9em;"><b>Teacher Feedback:</b> ${a.feedback}</div>` : ''}
                        </div>
                        <div class="actions">
                            ${!isLocked ? 
                                `<button class="btn-action" onclick="openModal('${a.id}')">UPLOAD WORK</button>` : 
                                `<button class="btn-action" style="background: #27ae60; border-color: #1e8449; cursor:default;" disabled>✔ SUBMITTED</button>`
                            }
                        </div>
                    </div>
                `;
            }).join('');

        } catch (err) {
            listDiv.innerHTML = `<div class="error-display">Connection Error: Unable to fetch data. Please check your internet.</div>`;
        }
    }

    function openModal(id) {
        document.getElementById('submit-id').value = id;
        document.getElementById('submit-modal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('submit-modal').style.display = 'none';
        document.getElementById('upload-form').reset();
    }

    document.getElementById('upload-form').onsubmit = async (e) => {
        e.preventDefault();
        const file = document.getElementById('submission-file').files[0];
        if (!file) return alert("Please select a file.");

        const formData = new FormData();
        formData.append('submission_id', document.getElementById('submit-id').value);
        formData.append('student_notes', document.getElementById('student-notes').value);
        formData.append('submission_file', file);

        try {
            const res = await fetch('/api/online-learning/assignments/submit', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` },
                body: formData
            });

            const result = await res.json();
            if (!res.ok) throw new Error(result.message || "Upload failed");

            alert("✅ Assignment successfully uploaded for review!");
            closeModal();
            loadAssignments();
        } catch (err) {
            alert("❌ Error: " + err.message);
        }
    };

    window.onload = loadAssignments;
</script>
</body>
</html>