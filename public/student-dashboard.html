<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BCSM Student Portal - Full Final Edition</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"> 
    <style>
        :root {
            --primary-dark: #003366; 
            --primary-accent: #1e88e5; 
            --secondary-purple: #5e35b1; 
            --secondary-light: #7a44f2;
            --bg-body: #f0f2f8;
            --glass-bg: rgba(255, 255, 255, 0.75);
            --sidebar-width: 280px;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background: linear-gradient(135deg, #f0f2f8 0%, #e0e4f1 100%);
            min-height: 100vh;
            margin: 0;
            overflow-x: hidden;
        }

        /* --- Layout --- */
        #wrapper { display: flex; width: 100%; }

        #sidebar {
            min-width: var(--sidebar-width);
            max-width: var(--sidebar-width);
            background: var(--secondary-purple);
            color: #fff;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            min-height: 100vh;
            position: sticky;
            top: 0;
            height: 100vh;
            overflow-y: auto;
            z-index: 1060;
        }

        #sidebar.inactive { margin-left: calc(-1 * var(--sidebar-width)); }

        #content { width: 100%; padding: 25px; transition: all 0.3s; }

        /* --- Sidebar Navigation --- */
        .sidebar-header { padding: 25px 20px; background: rgba(0,0,0,0.15); text-align: center; }
        .nav-card { background: transparent !important; border: none; }
        .nav-card .card-header {
            color: rgba(255,255,255,0.85);
            padding: 12px 20px; cursor: pointer; font-size: 14px;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .nav-card .card-header:hover { background: rgba(255,255,255,0.1); color: #fff; }
        .list-group-item {
            background: rgba(0,0,0,0.1) !important; color: #d1d1d1 !important;
            border: none !important; font-size: 13px;
            padding: 10px 25px 10px 45px !important; transition: 0.2s;
            text-decoration: none; display: block;
        }
        .list-group-item:hover { background: var(--primary-accent) !important; color: white !important; padding-left: 50px !important; }

        /* --- Dashboard UI --- */
        .glass-card { background: var(--glass-bg); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.4); border-radius: 20px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08); margin-bottom: 20px; }
        .profile-card { background: linear-gradient(135deg, var(--secondary-light) 0%, var(--secondary-purple) 100%); border-radius: 20px; padding: 25px; color: white; box-shadow: 0 10px 30px rgba(94, 53, 177, 0.3); margin-bottom: 25px; }
        #student-photo { width: 90px; height: 90px; border-radius: 50%; border: 3px solid rgba(255,255,255,0.3); object-fit: cover; }

        /* --- Bottom Nav & Badges --- */
        .bottom-nav {
            display: none; position: fixed; bottom: 0; left: 0; right: 0;
            height: 65px; background: #fff; box-shadow: 0 -2px 15px rgba(0,0,0,0.1);
            z-index: 1050; justify-content: space-around; align-items: center;
            border-top-left-radius: 20px; border-top-right-radius: 20px;
        }
        .bottom-nav-item { text-align: center; color: #666; text-decoration: none; font-size: 11px; flex: 1; position: relative; }
        .bottom-nav-item i { font-size: 20px; display: block; margin-bottom: 2px; }
        .nav-badge { position: absolute; top: -5px; right: 25%; background: #ff3b30; color: white; border-radius: 50%; padding: 2px 6px; font-size: 10px; border: 2px solid #fff; }

        @media (max-width: 992px) {
            #sidebar { position: fixed; margin-left: calc(-1 * var(--sidebar-width)); }
            #sidebar.active { margin-left: 0; }
            .bottom-nav { display: flex; }
            body { padding-bottom: 75px; }
            #sidebarCollapse { display: none; }
        }
    </style>
</head>
<body>

<div id="wrapper">
    <nav id="sidebar">
        <div class="sidebar-header">
            <h4 class="fw-bold mb-0"><i class="fas fa-university me-2"></i>BCSM Portal</h4>
        </div>

        <div class="mt-2">
            <div class="card nav-card">
                <div class="card-header" data-bs-toggle="collapse" data-bs-target="#mAcademics">
                    <span><i class="fas fa-book-open me-2"></i>Academics</span>
                    <i class="fas fa-chevron-down small"></i>
                </div>
                <div id="mAcademics" class="collapse show">
                    <div class="list-group">
                        <a href="/registration-certificate.html" class="list-group-item">Registration Cert.</a>
                        <a href="/student-class-timetable.html" class="list-group-item">Class Timetable</a>
                        <a href="/my-exam-schedule.html" class="list-group-item">Exam Schedule</a>
                        <a href="/student-admit-card.html" class="list-group-item">Admit Card</a>
                        <a href="/my-syllabus.html" class="list-group-item">Syllabus</a>
                        <a href="/my-assignments.html" class="list-group-item">Assignments</a>
                        <a href="/my-study-material.html" class="list-group-item">Study Material</a>
                        <a href="/my-quiz.html" class="list-group-item">Online Quiz</a>
                        <a href="/view-transcript.html" class="list-group-item">View Marks</a>
                        <a href="/my-view-attendance.html" class="list-group-item">View Attendance</a>
                        <a href="/student-certificate.html" class="list-group-item">My Certificate</a>
                    </div>
                </div>
            </div>

            <div class="card nav-card">
                <div class="card-header" data-bs-toggle="collapse" data-bs-target="#mFinance">
                    <span><i class="fas fa-file-invoice-dollar me-2"></i>Finance</span>
                    <i class="fas fa-chevron-down small"></i>
                </div>
                <div id="mFinance" class="collapse">
                    <div class="list-group">
                        <a href="/online-payment.html" class="list-group-item">Pay Fees Online</a>
                        <a href="/my-payment-history.html" class="list-group-item">Payment History</a>
                        <a href="/my-fee-receipts.html" class="list-group-item">Fee Receipts</a>
                        <a href="/my-scholarship.html" class="list-group-item">Scholarship Status</a>
                    </div>
                </div>
            </div>

            <div class="card nav-card">
                <div class="card-header" data-bs-toggle="collapse" data-bs-target="#mLibrary">
                    <span><i class="fas fa-book-reader me-2"></i>Library</span>
                    <i class="fas fa-chevron-down small"></i>
                </div>
                <div id="mLibrary" class="collapse">
                    <div class="list-group">
                        <a href="/library-search.html" class="list-group-item">Search Books</a>
                        <a href="/library-issued.html" class="list-group-item">Issued Books</a>
                        <a href="/mylibrary-history.html" class="list-group-item">Reading History</a>
                        <a href="/mylibraryfines.html" class="list-group-item">View Fines</a>
                        <a href="/myebooks.html" class="list-group-item">e-Resources</a>
                    </div>
                </div>
            </div>

            <div class="card nav-card">
                <div class="card-header" data-bs-toggle="collapse" data-bs-target="#mServices">
                    <span><i class="fas fa-concierge-bell me-2"></i>Services</span>
                    <i class="fas fa-chevron-down small"></i>
                </div>
                <div id="mServices" class="collapse">
                    <div class="list-group">
                        <a href="/my-bus.html" class="list-group-item">View Bus Route</a>
                        <a href="/mybus-tracker.html" class="list-group-item">Track Bus (Live)</a>
                        <a href="/mymess-menu.html" class="list-group-item">View Mess Menu</a>
                        <a href="/myhostel-leave.html" class="list-group-item">Hostel Leave</a>
                    </div>
                </div>
            </div>

            <div class="card nav-card">
                <div class="card-header" data-bs-toggle="collapse" data-bs-target="#mProfile">
                    <span><i class="fas fa-user-circle me-2"></i>Profile & More</span>
                    <i class="fas fa-chevron-down small"></i>
                </div>
                <div id="mProfile" class="collapse">
                    <div class="list-group">
                        <a href="/student-profile.html" class="list-group-item">Full Profile</a>
                        <a href="/change-password.html" class="list-group-item">Change Password</a>
                        <a href="/apply-leave.html" class="list-group-item">Apply for Leave</a>
                        <a href="/leave-status.html" class="list-group-item">Leave Status</a>
                        <a href="/my-id-card.html" class="list-group-item">My ID Card</a>
                        <a href="/my-school-calendar.html" class="list-group-item">Event Calendar</a>
                        <a href="/my-messages.html" class="list-group-item">Messages</a>
                        <a href="/my-feedback.html" class="list-group-item">Feedback</a>
                        <a href="/gallery.html" class="list-group-item">School Gallery</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div id="content">
        <header class="d-flex justify-content-between align-items-center mb-4">
            <button type="button" id="sidebarCollapse" class="btn btn-primary shadow-sm">
                <i class="fas fa-bars"></i>
            </button>
            <div class="d-flex align-items-center gap-3">
                <div class="position-relative d-none d-md-block" style="cursor: pointer;">
                    <i class="fas fa-bell fs-4 text-primary"></i>
                    <span class="nav-badge" style="right:-5px">3</span>
                </div>
                <button class="btn btn-danger btn-sm rounded-pill px-4 shadow-sm" onclick="logout()">
                    <i class="fas fa-sign-out-alt me-1"></i> Logout
                </button>
            </div>
        </header>

        <div class="profile-card">
            <div class="row align-items-center">
                <div class="col-md-auto mb-3 mb-md-0 text-center">
                    <img id="student-photo" src="https://placehold.co/100x100?text=Profile" alt="Photo">
                </div>
                <div class="col-md">
                    <h4 id="welcome-message" class="fw-bold mb-3 text-center text-md-start">Welcome back!</h4>
                    <div class="row g-2 text-center text-md-start">
                        <div class="col-6 col-md-3"><small class="opacity-75 d-block">Student ID</small><span id="student-id" class="fw-bold">...</span></div>
                        <div class="col-6 col-md-3"><small class="opacity-75 d-block">Grade</small><span id="student-grade" class="fw-bold">...</span></div>
                        <div class="col-6 col-md-3"><small class="opacity-75 d-block">Roll / Sec</small><span class="fw-bold"><span id="student-roll">...</span> / <span id="student-section">...</span></span></div>
                        <div class="col-6 col-md-3"><small class="opacity-75 d-block">Email</small><span id="student-email" class="fw-bold small">...</span></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-3">
            <div class="col-md-6">
                <div class="card glass-card p-3 h-100">
                    <h6 class="fw-bold text-primary border-bottom pb-2 mb-3"><i class="fas fa-chart-pie me-2"></i>Finance Summary</h6>
                    <div class="d-flex justify-content-between my-2"><span>Total Due:</span> <span id="fee-due" class="fw-bold">...</span></div>
                    <div class="d-flex justify-content-between my-2"><span>Total Paid:</span> <span id="fee-paid" class="text-success fw-bold">...</span></div>
                    <div class="d-flex justify-content-between my-2 border-top pt-2"><span>Balance:</span> <span id="fee-balance" class="text-danger fw-bold">...</span></div>
                    <a href="/online-payment.html" class="btn btn-primary btn-sm w-100 mt-3">Pay Now</a>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card glass-card p-3 h-100">
                    <h6 class="fw-bold text-primary border-bottom pb-2 mb-3"><i class="fas fa-bell me-2"></i>Notice Board</h6>
                    <ul class="list-unstyled small mb-0" id="notice-board-list">
                        <li><i class="fas fa-spinner fa-spin me-2"></i>Loading announcements...</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="card glass-card mt-4 p-3">
            <h6 class="fw-bold mb-3"><i class="fas fa-chalkboard-teacher me-2"></i>My Assigned Teachers</h6>
            <div id="my-teachers-list" class="row g-2">
                <div class="col-12 text-muted small">Loading teachers...</div>
            </div>
        </div>
    </div>
</div>

<div class="bottom-nav">
    <a href="#" class="bottom-nav-item active">
        <i class="fas fa-home"></i>
        <span>Home</span>
    </a>
    <a href="/my-messages.html" class="bottom-nav-item">
        <i class="fas fa-bell"></i>
        <span class="nav-badge">3</span>
        <span>Alerts</span>
    </a>
    <a href="javascript:void(0)" class="bottom-nav-item" id="mobileMenuBtn">
        <i class="fas fa-th-large"></i>
        <span>Menu</span>
    </a>
    <a href="/student-profile.html" class="bottom-nav-item">
        <i class="fas fa-user-circle"></i>
        <span>Profile</span>
    </a>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="js/global-config.js"></script>
<script>
    // --- Layout Logic ---
    const sidebar = document.getElementById('sidebar');
    document.getElementById('sidebarCollapse').addEventListener('click', () => {
        sidebar.classList.toggle('inactive');
    });
    document.getElementById('mobileMenuBtn').addEventListener('click', () => {
        sidebar.classList.toggle('active');
    });

    // --- Original API & Auth Logic ---
    function logout() { localStorage.clear(); window.location.href = '/login.html'; }

    async function authFetch(url) {
        const token = localStorage.getItem('erp-token');
        if (!token) logout();
        const res = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
        if (res.status === 401) logout();
        return res.json();
    }

    async function init() {
        const sid = localStorage.getItem('student_id') || localStorage.getItem('profile-id');
        if (!sid) return;

        try {
            // Student Info
            const p = await authFetch(`/api/students/${sid}`);
            document.getElementById('welcome-message').innerHTML = `Hi, ${p.first_name || 'Student'}! ðŸ‘‹`;
            document.getElementById('student-id').textContent = p.admission_id || sid;
            document.getElementById('student-grade').textContent = p.course_name || 'N/A';
            document.getElementById('student-roll').textContent = p.roll_number || 'N/A';
            document.getElementById('student-section').textContent = p.batch_name || 'N/A';
            document.getElementById('student-email').textContent = p.email || 'N/A';
            if(p.profile_image_path) document.getElementById('student-photo').src = p.profile_image_path;

            // Finance Summary
            const f = await authFetch(`/api/students/${sid}/fees`);
            document.getElementById('fee-due').textContent = `â‚¹${f.total_billed || 0}`;
            document.getElementById('fee-paid').textContent = `â‚¹${f.total_paid || 0}`;
            document.getElementById('fee-balance').textContent = `â‚¹${f.balance_due || 0}`;

            // Teachers List
            const t = await authFetch(`/api/students/${sid}/teachers`);
            document.getElementById('my-teachers-list').innerHTML = t.map(i => `
                <div class="col-6 col-md-3">
                    <div class="p-2 border rounded bg-white text-center small shadow-sm">
                        <b>${i.full_name}</b><br>
                        <span class="text-muted" style="font-size:10px">${i.subject_name}</span>
                    </div>
                </div>
            `).join('') || '<div class="col-12 text-muted small">No teachers found.</div>';

            // Notices
            const n = await authFetch(`/api/announcements/role/student`);
            document.getElementById('notice-board-list').innerHTML = n.slice(0, 3).map(i => `
                <li class="border-bottom mb-2 pb-1">
                    <b>${i.title}</b><br>
                    <small class="text-muted ps-2">${new Date(i.created_at).toDateString()}</small>
                </li>
            `).join('') || '<li class="small">No notices available.</li>';

        } catch (e) { console.error("Init Error:", e); }
    }
    document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>