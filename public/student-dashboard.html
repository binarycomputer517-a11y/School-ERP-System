<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: var(--bs-body-font-family);
            margin: 0;
            background-color: #f0f2f8;
            color: #333;
            font-size: 14px;
        }
        
        .dashboard-container {
            max-width: 1400px;
            margin: 25px auto;
            padding: 30px;
            background-color: #f0f2f8;
            border-radius: 12px;
        }

        h1 {
            font-family: Georgia, "Times New Roman", Times, serif;
            color: #003366;
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-size: 28px;
            font-weight: bold;
        }

        .logout-link {
            font-size: 14px;
            color: #dc3545;
            text-decoration: none;
            font-weight: bold;
            cursor: pointer;
        }
        .logout-link:hover { text-decoration: underline; }

        /* Purple welcome banner */
        .profile-card {
            background: linear-gradient(135deg, #7a44f2 0%, #5e35b1 100%);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(94, 53, 177, 0.3);
        }
        .profile-label {
            font-weight: 500;
            color: #d1c4e9;
            font-size: 12px;
            display: block;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .profile-value {
            font-size: 16px;
            color: #ffffff;
            font-weight: 600;
        }

        /* Summary cards */
        .summary-item {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .summary-item:last-child { border-bottom: none; padding-bottom: 0; }
        .summary-item:first-child { padding-top: 0; }

        .summary-item-label { color: #555; }
        .summary-item-value { font-weight: bold; color: #111; }
        .summary-item-value.text-danger { color: #dc3545 !important; }
        .summary-item-value.text-success { color: #198754 !important; }
        
        .notice-list-item {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }
        .notice-list-item:last-child { border-bottom: none; }
        .notice-title { font-weight: 600; color: #003366; }
        .notice-date { font-size: 12px; color: #777; }

        /* Sidebar Navigation */
        .col-md-3 .card {
            background-color: #5e35b1;
            border: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-radius: 12px;
        }
        .col-md-3 .card-header {
            background-color: transparent;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            padding: 1rem 1rem;
        }
        .col-md-3 .card-header h5 {
            color: #ffffff;
            font-weight: 600;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .col-md-3 .list-group-flush {
            border-radius: 0 0 12px 12px;
        }
        .col-md-3 .list-group-item {
            background-color: transparent;
            color: #e8eaf6;
            border: none;
            padding: 12px 1rem;
            font-weight: 500;
        }
        .col-md-3 .list-group-item-action:hover,
        .col-md-3 .list-group-item-action:focus {
            background-color: rgba(255, 255, 255, 0.1);
            color: #ffffff;
        }

        /* Content Cards */
        .col-md-9 .card {
            background-color: #ffffff;
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        .col-md-9 .list-group {
            border-radius: 12px;
            overflow: hidden;
        }
        .col-md-9 .card-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #eee;
        }
        .col-md-9 .card-header h5 { color: #333; }
        .col-md-9 .card-title { color: #003366; }
        .col-md-9 h5.fw-bold { color: #333; }

        /* Collapse/Hover Logic */
        .nav-card .card-header[data-bs-toggle="collapse"] { cursor: pointer; }
        .nav-card .card-header .menu-icon {
            transition: transform 0.2s ease-in-out;
            font-weight: bold;
        }
        .nav-card .card-header[aria-expanded="true"] .menu-icon {
            transform: rotate(45deg);
        }
        .nav-card .list-group {
            border-bottom-left-radius: 12px;
            border-bottom-right-radius: 12px;
            overflow: hidden;
        }
    </style>
    <script>
        
        // --- 1. Logout Function ---
        function logout() {
            localStorage.removeItem('erp-token');
            localStorage.removeItem('user-role');
            localStorage.removeItem('user-name');
            localStorage.removeItem('profile-id');
            localStorage.removeItem('active_session_id');
            localStorage.removeItem('active_branch_id');
            window.location.href = '/login.html'; 
        }

        // --- 2. Fetch Student Profile ---
        async function fetchStudentData() {
            const studentId = localStorage.getItem('profile-id'); 
            const token = localStorage.getItem('erp-token');
            
            if (!studentId || !token) {
                window.location.href = '/login.html';
                return;
            }

            try {
                const response = await fetch(`/api/students/${studentId}`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.status === 403) throw new Error("Permission Denied. Check Backend Roles.");
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const data = await response.json();
                
                // CRITICAL: Ensure we update the ID if the server returns a better one
                if (data.student_id && data.student_id !== studentId) {
                    localStorage.setItem('profile-id', data.student_id);
                }

                const fullName = `${data.first_name || ''} ${data.last_name || ''}`.trim();

                document.getElementById('welcome-message').textContent = `Welcome, ${fullName || 'Student'}!`;
                document.getElementById('student-id').textContent = data.enrollment_no || data.student_id || 'N/A'; 
                document.getElementById('student-grade').textContent = data.course_name || 'N/A'; 
                document.getElementById('student-section').textContent = data.batch_name || 'N/A';
                document.getElementById('student-roll').textContent = data.enrollment_no || 'N/A'; 
                document.getElementById('student-email').textContent = data.email || 'N/A';

                if (data.profile_image_path) {
                    document.getElementById('student-photo').src = data.profile_image_path;
                }

            } catch (error) {
                console.error('Failed to fetch student data:', error);
                document.getElementById('welcome-message').textContent = 'Welcome! (Error loading profile)';
            }
        }

        // --- 3. Fetch Fees (Corrected for Array Response) ---
        async function fetchFeeData() {
            const studentId = localStorage.getItem('profile-id');
            const token = localStorage.getItem('erp-token');
            if (!studentId) return;

            try {
                const response = await fetch(`/api/students/${studentId}/fees`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json(); 

                // FIX: Handle Array Response
                if (Array.isArray(data) && data.length > 0) {
                    const fee = data[0]; // Get most recent fee record

                    const tuition = parseFloat(fee.tuition_fee || 0);
                    const paid = parseFloat(fee.amount_paid || 0);
                    const balance = tuition - paid;

                    document.getElementById('fee-tuition').textContent = `‚Çπ${tuition}`;
                    document.getElementById('fee-library').textContent = `‚Çπ0`; // Placeholder
                    document.getElementById('fee-transport').textContent = `‚Çπ0`; // Placeholder
                    
                    document.getElementById('fee-due').textContent = `‚Çπ${tuition}`;
                    document.getElementById('fee-paid').textContent = `‚Çπ${paid}`;
                    
                    const balEl = document.getElementById('fee-balance');
                    balEl.textContent = `‚Çπ${balance}`;
                    balEl.className = 'summary-item-value ' + (balance > 0 ? 'text-danger' : 'text-success');
                } else {
                    // Default / No Data
                    document.getElementById('fee-tuition').textContent = '‚Çπ0';
                    document.getElementById('fee-due').textContent = '‚Çπ0';
                    document.getElementById('fee-paid').textContent = '‚Çπ0';
                    document.getElementById('fee-balance').textContent = '‚Çπ0';
                }
            } catch (error) {
                console.error("Fee error:", error);
                document.getElementById('fee-summary-card').innerHTML = '<div class="card-body"><p class="text-danger small">No fee records found.</p></div>';
            }
        }

        // --- 4. Fetch Library (Corrected Logic) ---
        async function fetchLibraryData() {
            const studentId = localStorage.getItem('profile-id');
            const token = localStorage.getItem('erp-token');
            if (!studentId) return;

            try {
                const response = await fetch(`/api/students/${studentId}/library`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                
                // Backend returns list of issued books
                const issuedCount = Array.isArray(data) ? data.length : 0;
                
                document.getElementById('books-issued').textContent = issuedCount;
                document.getElementById('library-fines').textContent = `‚Çπ0`; // Placeholder
                
            } catch (error) {
                console.error("Library error:", error);
            }
        }

        // --- 5. Fetch Announcements ---
        async function fetchAnnouncements() {
            const token = localStorage.getItem('erp-token');
            const listElement = document.getElementById('notice-board-list');
            if (!listElement) return;

            try {
                const response = await fetch(`/api/announcements/role/student`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const data = await response.json();
                
                if (!Array.isArray(data) || data.length === 0) {
                    listElement.innerHTML = '<li class="list-group-item">No recent announcements.</li>';
                    return;
                }
                
                listElement.innerHTML = ''; 
                data.slice(0, 5).forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item notice-list-item';
                    const itemDate = new Date(item.created_at).toLocaleDateString();
                    li.innerHTML = `
                        <div class="d-flex justify-content-between">
                            <span class="notice-title">${item.title}</span>
                            <span class="notice-date">${itemDate}</span>
                        </div>
                        <p class="mb-0 small">${item.content ? item.content.substring(0, 80) + '...' : ''}</p>
                    `;
                    listElement.appendChild(li);
                });
            } catch (error) {
                console.error("Announcements error:", error);
                listElement.innerHTML = '<li class="list-group-item">No recent announcements.</li>';
            }
        }

        // --- 6. Fetch Teachers (Corrected for 'full_name') ---
        async function fetchMyTeachers() {
            const studentId = localStorage.getItem('profile-id');
            const token = localStorage.getItem('erp-token');
            const listElement = document.getElementById('my-teachers-list');
            if (!studentId || !listElement) return;

            try {
                const response = await fetch(`/api/students/${studentId}/teachers`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const data = await response.json();
                listElement.innerHTML = ''; 

                if (!Array.isArray(data) || data.length === 0) {
                    listElement.innerHTML = '<li class="list-group-item">No teachers assigned yet.</li>';
                    return;
                }

                data.forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item d-flex justify-content-between align-items-center';
                    // FIX: Using full_name to match DB
                    li.innerHTML = `
                        <span>
                            <strong class="text-primary">${item.subject_name}</strong>
                            <span class="text-muted ms-2">${item.full_name}</span>
                        </span>
                        <a href="mailto:${item.email || ''}" class="btn btn-sm btn-outline-secondary">Contact</a>
                    `;
                    listElement.appendChild(li);
                });
            } catch (error) {
                console.error("Teachers error:", error);
                listElement.innerHTML = '<li class="list-group-item text-danger">Could not load teacher list.</li>';
            }
        }

        // --- 7. Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            fetchStudentData(); 
            fetchFeeData();
            fetchLibraryData();
            fetchAnnouncements();
            fetchMyTeachers();

            // Hover-to-Show Menus Logic
            const menuCards = document.querySelectorAll('.col-md-3 .nav-card');
            menuCards.forEach(card => {
                const collapseElement = card.querySelector('.collapse');
                const header = card.querySelector('.card-header');
                if (!collapseElement || !header) return;

                const bsCollapse = new bootstrap.Collapse(collapseElement, { toggle: false });

                card.addEventListener('mouseenter', () => {
                    bsCollapse.show();
                    header.setAttribute('aria-expanded', 'true');
                });
                card.addEventListener('mouseleave', () => {
                    bsCollapse.hide();
                    header.setAttribute('aria-expanded', 'false');
                });
            });
        });
    </script>
</head>
<body class="p-3 p-md-4">
    <div class="dashboard-container">

        <header class="d-flex justify-content-between align-items-center mb-3">
            <h1>Student Dashboard</h1>
            <a class="logout-link" onclick="logout()">Logout</a>
        </header>

        <p id="welcome-message" class="text-secondary mb-4" style="font-size: 18px; font-weight: 500;">Welcome...</p>
        
        <div class="profile-card">
            <div class="row g-3 align-items-center">
                <div class="col-md-2 text-center">
                    <img id="student-photo" 
                         src="https://placehold.co/100x100/e8eaf6/5e35b1?text=Photo" 
                         alt="Profile Photo" 
                         class="img-fluid rounded-circle" 
                         style="width: 100px; height: 100px; border: 3px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
                </div>
                <div class="col-md-10">
                    <div class="row g-3">
                        <div class="col-md-3 col-6">
                            <span class="profile-label">Student ID</span>
                            <span class="profile-value" id="student-id">...</span>
                        </div>
                        <div class="col-md-3 col-6">
                            <span class="profile-label">Grade / Class</span>
                            <span class="profile-value" id="student-grade">...</span>
                        </div>
                        <div class="col-md-3 col-6">
                            <span class="profile-label">Section & Roll No.</span>
                            <span class="profile-value"><span id="student-section">...</span> / <span id="student-roll">...</span></span>
                        </div>
                        <div class="col-md-3 col-6">
                            <span class="profile-label">Email</span>
                            <span class="profile-value" id="student-email">...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row g-4 mt-3">

            <div class="col-md-3">
                <div class="card shadow-sm mb-3 nav-card">
                    <div class="card-header" data-bs-toggle="collapse" data-bs-target="#menuAcademics">
                        <h5 class="mb-0 d-flex justify-content-between align-items-center">
                            Academics
                            <span class="menu-icon">+</span>
                        </h5>
                    </div>
                    <div id="menuAcademics" class="collapse">
                        <div class="list-group list-group-flush">
                            <a href="/my-timetable.html" class="list-group-item list-group-item-action">üìÖ View Timetable</a>
                            <a href="/my-exam-schedule.html" class="list-group-item list-group-item-action">üóìÔ∏è View Exam Schedule</a>
                            <a href="/my-syllabus.html" class="list-group-item list-group-item-action">üìö View Syllabus</a>
                            <a href="/my-assignments.html" class="list-group-item list-group-item-action">‚úçÔ∏è View/Submit Assignments</a>
                            <a href="/my-study-material.html" class="list-group-item list-group-item-action">üìñ Download Study Material</a>
                            <a href="/my-quiz.html" class="list-group-item list-group-item-action">üñ•Ô∏è Online Quiz Portal</a>
                            <a href="/my-view-marks.html" class="list-group-item list-group-item-action">‚≠ê View Detailed Marks</a>
                            <a href="/my-view-attendance.html" class="list-group-item list-group-item-action">üìä View Detailed Attendance</a>
                            <a href="/my-report-card.html" class="list-group-item list-group-item-action">üéì Download Report Card</a>
                        </div>
                    </div>
                </div>

                <div class="card shadow-sm mb-3 nav-card">
                    <div class="card-header" data-bs-toggle="collapse" data-bs-target="#menuFinance">
                        <h5 class="mb-0 d-flex justify-content-between align-items-center">
                            Finance
                            <span class="menu-icon">+</span>
                        </h5>
                    </div>
                    <div id="menuFinance" class="collapse">
                        <div class="list-group list-group-flush">
                            <a href="/online-payment.html" class="list-group-item list-group-item-action">üí≥ Pay Fees Online</a>
                            <a href="/my-payment-history.html" class="list-group-item list-group-item-action">üßæ View Payment History</a>
                            <a href="/my-fee-receipts.html" class="list-group-item list-group-item-action">üì• Download Fee Receipts</a>
                            <a href="/my-scholarship.html" class="list-group-item list-group-item-action">üèÖ View Scholarship Status</a>
                        </div>
                    </div>
                </div>

                <div class="card shadow-sm mb-3 nav-card">
                    <div class="card-header" data-bs-toggle="collapse" data-bs-target="#menuLibrary">
                        <h5 class="mb-0 d-flex justify-content-between align-items-center">
                            Library
                            <span class="menu-icon">+</span>
                        </h5>
                    </div>
                    <div id="menuLibrary" class="collapse">
                        <div class="list-group list-group-flush">
                            <a href="/library-search.html" class="list-group-item list-group-item-action">üîç Search Book Catalog</a>
                            <a href="/library-issued.html" class="list-group-item list-group-item-action">üìò View Issued Books</a>
                            <a href="/library-history.html" class="list-group-item list-group-item-action">üìñ View Reading History</a>
                            <a href="/library-fines.html" class="list-group-item list-group-item-action">View Library Fines</a>
                            <a href="/ebooks.html" class="list-group-item list-group-item-action">e-Library & Resources</a>
                        </div>
                    </div>
                </div>

                <div class="card shadow-sm mb-3 nav-card">
                    <div class="card-header" data-bs-toggle="collapse" data-bs-target="#menuServices">
                        <h5 class="mb-0 d-flex justify-content-between align-items-center">
                            Services
                            <span class="menu-icon">+</span>
                        </h5>
                    </div>
                    <div id="menuServices" class="collapse">
                        <div class="list-group list-group-flush">
                            <a href="/my-bus.html" class="list-group-item list-group-item-action">üöå View Bus Route</a>
                            <a href="/bus-tracker.html" class="list-group-item list-group-item-action">üìç Track My Bus (Live)</a>
                            <a href="/mess-menu.html" class="list-group-item list-group-item-action">üçï View Mess Menu</a>
                            <a href="/hostel-leave.html" class="list-group-item list-group-item-action">Apply for Hostel Leave</a>
                        </div>
                    </div>
                </div>

                <div class="card shadow-sm mb-3 nav-card">
                    <div class="card-header" data-bs-toggle="collapse" data-bs-target="#menuProfile">
                        <h5 class="mb-0 d-flex justify-content-between align-items-center">
                            Profile
                            <span class="menu-icon">+</span>
                        </h5>
                    </div>
                    <div id="menuProfile" class="collapse">
                        <div class="list-group list-group-flush">
                            <a href="/student-profile.html" class="list-group-item list-group-item-action">üë§ View Full Profile</a>
                            <a href="/change-password.html" class="list-group-item list-group-item-action">üîí Change Password</a>
                            <a href="/apply-leave.html" class="list-group-item list-group-item-action">üìù Apply for Leave</a>
                            <a href="/leave-status.html" class="list-group-item list-group-item-action">‚è±Ô∏è View Leave Status</a>
                            <a href="/my-id-card.html" class="list-group-item list-group-item-action">üí≥ Download ID Card</a>
                        </div>
                    </div>
                </div>

                <div class="card shadow-sm mb-3 nav-card">
                    <div class="card-header" data-bs-toggle="collapse" data-bs-target="#menuCommunication">
                        <h5 class="mb-0 d-flex justify-content-between align-items-center">
                            Communication
                            <span class="menu-icon">+</span>
                        </h5>
                    </div>
                    <div id="menuCommunication" class="collapse">
                        <div class="list-group list-group-flush">
                            <a href="/school-calendar.html" class="list-group-item list-group-item-action">üìÖ School Event Calendar</a>
                            <a href="/messages.html" class="list-group-item list-group-item-action">‚úâÔ∏è Messages (Inbox)</a>
                            <a href="/feedback.html" class="list-group-item list-group-item-action">Submit Feedback</a>
                            <a href="/gallery.html" class="list-group-item list-group-item-action">üì∑ View School Gallery</a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-9">
                <h5 class="mt-0 fw-bold">My Teachers</h5>
                <ul class="list-group mb-4 shadow-sm" id="my-teachers-list">
                    <li class="list-group-item">Loading teachers...</li>
                </ul>

                <div class="row g-4">
                    <div class="col-lg-6">
                        <div class="card shadow-sm mb-4" id="fee-summary-card">
                            <div class="card-body">
                                <h5 class="card-title mb-3 fw-bold" style="color: #003366;">Fee Summary</h5>
                                <div class="summary-item">
                                    <span class="summary-item-label">Tuition Fee</span>
                                    <span class="summary-item-value" id="fee-tuition">...</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-item-label">Library Fee</span>
                                    <span class="summary-item-value" id="fee-library">...</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-item-label">Transport Fee</span>
                                    <span class="summary-item-value" id="fee-transport">...</span>
                                </div>
                                <hr style="opacity: 0.1; margin: 10px 0;">
                                <div class="summary-item">
                                    <span class="summary-item-label">Total Due</span>
                                    <span class="summary-item-value" id="fee-due">...</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-item-label">Total Paid</span>
                                    <span class="summary-item-value text-success" id="fee-paid">...</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-item-label">Balance</span>
                                    <span class="summary-item-value" id="fee-balance">...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="card shadow-sm mb-4" id="library-summary-card">
                            <div class="card-body">
                                <h5 class="card-title mb-3 fw-bold" style="color: #003366;">Library Summary</h5>
                                <div class="summary-item">
                                    <span class="summary-item-label">Books Issued</span>
                                    <span class="summary-item-value" id="books-issued">...</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-item-label">Total Fines</span>
                                    <span class="summary-item-value" id="library-fines">...</span>
                                </div>
                                <a href="/library-issued.html" class="btn btn-primary btn-sm mt-3 w-100">View Details</a>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card shadow-sm">
                    <div class="card-header">
                        <h5 class="mb-0 fw-bold" style="color: #003366;">Recent Announcements</h5>
                    </div>
                    <div class="card-body p-0">
                        <ul class="list-group list-group-flush" id="notice-board-list">
                            <li class="list-group-item text-muted">Loading announcements...</li>
                        </ul>
                    </div>
                </div>

            </div>
        </div>

    </div> 
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>