<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messaging & Collaboration | ERP</title>
    <!-- CHANGED: Use CDN for Socket.IO to ensure it loads even if the local path fails -->
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        :root {
            /* UNIQUE DARK MODE PALETTE */
            --primary-color: #4f46e5; /* Deep Indigo/Blue Accent */
            --primary-dark: #3730a3;
            --sidebar-bg: #111827; /* Very Dark Slate */
            --bg-color: #1f2937; /* Main App Background */
            --border-color: #374151; 
            --text-main: #f3f4f6; /* Light Text */
            --text-muted: #9ca3af; 
            --incoming-bg: #374151; /* Incoming Bubble / Chat Header */
            --outgoing-bg: #4f46e5; /* Indigo/Accent Bubble */
        }

        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            padding: 0; 
            background-color: var(--bg-color); 
            color: var(--text-main); 
            height: 100vh;
        }

        /* --- Layout --- */
        .app-container { 
            display: flex; 
            height: 100vh; 
            width: 100%;
            overflow: hidden; 
            background-color: var(--bg-color);
        }

        /* --- Sidebar --- */
        .sidebar { 
            width: 280px; 
            min-width: 280px;
            background-color: var(--sidebar-bg); 
            border-right: 1px solid var(--border-color);
            display: flex; 
            flex-direction: column; 
            z-index: 10;
            color: var(--text-main);
        }

        .sidebar-header { 
            padding: 20px 15px; 
            background-color: #1f2937; 
            border-bottom: 1px solid var(--border-color); 
        }

        .sidebar-header h2 { 
            margin: 0; 
            font-size: 1.4rem; 
            color: var(--primary-color); 
            font-weight: 600;
        }

        .sidebar-user-info {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-top: 5px;
        }

        .new-chat-btn { 
            margin: 15px; 
            padding: 10px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 4px; 
            font-weight: 600;
            box-shadow: 0 4px 6px rgba(79, 70, 229, 0.3);
        }

        .conversation-list { 
            flex-grow: 1; 
            overflow-y: auto; 
            list-style: none; 
            padding: 0; 
            margin: 0; 
        }

        .conversation-item { 
            padding: 12px 15px; 
            border-bottom: 1px solid #1f2937; 
            cursor: pointer; 
            transition: background-color 0.1s;
        }

        .conversation-item:hover { background-color: #1f2937; }
        
        .conversation-item.active { 
            background-color: var(--primary-color); 
            color: white;
            border-left: 4px solid var(--primary-color);
            padding-left: 11px;
        }

        .conversation-topic { font-weight: 600; font-size: 1rem; margin-bottom: 3px; }
        .conversation-meta { font-size: 0.8rem; color: var(--text-muted); }
        .conversation-item.active .conversation-meta { color: #f3f4f6; }


        /* --- Chat Area (Dark) --- */
        .chat-area { flex-grow: 1; display: flex; flex-direction: column; background-color: var(--bg-color); }
        
        .chat-header { 
            padding: 15px 20px; 
            background-color: var(--incoming-bg); 
            border-bottom: 1px solid var(--border-color); 
        }

        .chat-header h3 { margin: 0; font-size: 1.2rem; color: var(--text-main); }
        .participant-list { font-size: 0.85rem; color: var(--text-muted); margin-top: 2px; }

        .message-feed { flex-grow: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; background-color: var(--bg-color); }
        
        /* Message Bubbles */
        .message-row { display: flex; margin-bottom: 10px; width: 100%; }
        .message-row.incoming { justify-content: flex-start; }
        .message-row.outgoing { justify-content: flex-end; }
        
        .message-bubble { 
            max-width: 60%; 
            padding: 10px 15px; 
            border-radius: 8px; 
            box-shadow: 0 1px 1px rgba(0,0,0,0.1);
        }
        
        .message-row.incoming .message-bubble { 
            background-color: var(--incoming-bg); 
            border: 1px solid #4b5563;
            color: var(--text-main);
        }
        
        .message-row.outgoing .message-bubble { 
            background-color: var(--primary-color); 
            color: white; 
            border: 1px solid var(--primary-dark);
        }

        .message-sender { font-size: 0.75rem; font-weight: 600; color: #b0b8c3; display: block; margin-bottom: 3px; }
        .message-meta { font-size: 0.7rem; color: #9ca3af; text-align: right; margin-top: 4px; }


        /* Input Area */
        .chat-input-area { padding: 15px 20px; border-top: 1px solid var(--border-color); background-color: var(--incoming-bg); display: flex; align-items: center; }
        .chat-input-area input { 
            flex-grow: 1; 
            padding: 10px 15px; 
            border: 1px solid var(--border-color); 
            border-radius: 4px;
            background-color: #4b5563; 
            color: var(--text-main);
        }
        .chat-input-area input::placeholder { color: #a0aec0; }

        .chat-input-area button { 
            padding: 10px 20px; 
            background-color: var(--primary-color); 
            color: white; 
            border-radius: 4px; 
            font-weight: 600; 
        }

        /* --- Modals & Dropdown --- */
        .modal { 
            display: none; 
            position: fixed; 
            z-index: 100; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%; 
            background-color: rgba(0,0,0,0.5); 
            
            /* CENTERING */
            display: flex;
            align-items: center; 
            justify-content: center;
        }

        .modal-content { 
            background-color: var(--incoming-bg); 
            border: 1px solid #4b5563; 
            padding: 25px; 
            width: 500px; 
            max-width: 90%; 
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .form-group { margin-bottom: 15px; position: relative; }
        .suggestions-dropdown { 
            border: 1px solid var(--primary-color); 
            box-shadow: 0 4px 8px rgba(0,0,0,0.3); 
            background-color: #374151;
            z-index: 1000;
        }
        .suggestion-item { color: var(--text-main); border-bottom: 1px solid #4b5563; }
        .suggestion-item:hover { background-color: #4b5563; } 
        .suggestion-item strong { color: var(--primary-color); }
        .participant-tags li { background: var(--incoming-bg); border: 1px solid #4b5563; color: var(--text-main); }
        .participant-tags li strong { color: var(--primary-color); }
    </style>
</head>
<body>
    
    <div class="app-container">
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>MESSAGES</h2>
                <div class="sidebar-user-info" id="current-username-display">Loading...</div>
            </div>
            <button class="new-chat-btn" onclick="openNewChatModal()">+ New Conversation</button>
            <ul id="conversation-list" class="conversation-list"><li style="padding:20px;text-align:center;color:var(--text-muted);">Loading...</li></ul>
        </div>

        <div class="chat-area">
            <div id="chat-header" class="chat-header" style="display:none;">
                <h3 id="current-convo-topic"></h3>
                <div id="current-convo-participants" class="participant-list"></div>
            </div>
            <div id="message-feed" class="message-feed">
                <div id="chat-placeholder" style="text-align: center; color: var(--text-muted); margin-top: 15%;">Select a conversation to start chatting.</div>
            </div>
            <form id="message-form" class="chat-input-area" style="display:none;">
                <input type="text" id="message-input" placeholder="Type a message..." required autocomplete="off">
                <button type="submit">Send</button>
            </form>
        </div>
    </div>

    <div id="new-chat-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('new-chat-modal')">&times;</span>
            <h3 style="margin-top: 0; color: var(--primary-color);">Start Conversation</h3>
            <form id="new-chat-form">
                <div class="form-group">
                    <label>Topic (Optional):</label>
                    <input type="text" id="new-chat-topic" class="form-control" placeholder="e.g., Finance Meeting">
                </div>
                
                <div class="form-group">
                    <label>Add People (Start typing name):</label>
                    <input type="text" id="participant-search" class="form-control" placeholder="Type here to search..." autocomplete="off">
                    <div id="suggestions-dropdown" class="suggestions-dropdown"></div>
                </div>

                <ul id="new-chat-participants" class="participant-tags"></ul>
                <button type="submit" class="btn-primary" style="margin-top:10px;">Create Conversation</button>
            </form>
        </div>
    </div>

    <div id="edit-message-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('edit-message-modal')">&times;</span>
            <h3>Edit Message</h3>
            <form id="edit-message-form">
                <input type="hidden" id="edit-message-id">
                <div class="form-group">
                    <label>Content:</label>
                    <input type="text" id="edit-message-content" class="form-control" required>
                </div>
                <button type="submit" class="btn-primary">Save Changes</button>
            </form>
        </div>
    </div>

 <script>
    // --- AUTH & CONFIG ---
    const API_BASE = '/api/messaging';

    // FIX: Define closeModal globally
    function closeModal(id) {
        const modalEl = document.getElementById(id);
        if (modalEl) {
            modalEl.style.display = 'none';
        }
    }
    
    function parseJwt(token) { try { return JSON.parse(decodeURIComponent(atob(token.split('.')[1].replace(/-/g, '+').replace(/_/g, '/')).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''))); } catch (e) { return null; } }

    const TOKEN = localStorage.getItem('erp-token') || localStorage.getItem('token');
    let USER_ID = localStorage.getItem('user-id') || localStorage.getItem('userId');
    
    if (!USER_ID && TOKEN) { const d = parseJwt(TOKEN); if (d) USER_ID = d.userId || d.id || d.sub; }
    const USER_NAME = localStorage.getItem('username') || 'User';
    const USER_ROLE = localStorage.getItem('role') || 'Staff';

    // --- SOCKET INITIALIZATION WITH ERROR HANDLING ---
    let socket;
    try {
        if (typeof io !== 'undefined') {
            socket = io(); 
        } else {
            console.error('Socket.io library not loaded. Real-time features disabled.');
            // Mock socket to prevent crashes
            socket = { emit: () => {}, on: () => {} };
        }
    } catch (e) {
        console.error('Socket initialization failed:', e);
        socket = { emit: () => {}, on: () => {} };
    }


    const els = {
        usernameDisplay: document.getElementById('current-username-display'),
        convoList: document.getElementById('conversation-list'),
        chatHeader: document.getElementById('chat-header'),
        topic: document.getElementById('current-convo-topic'),
        participants: document.getElementById('current-convo-participants'),
        feed: document.getElementById('message-feed'),
        placeholder: document.getElementById('chat-placeholder'),
        form: document.getElementById('message-form'),
        input: document.getElementById('message-input'),
        search: document.getElementById('participant-search'),
        dropdown: document.getElementById('suggestions-dropdown')
    };

    let state = { currentConvoId: null, activeParticipants: [], suggestions: [] };

    // --- CORE FUNCTIONS (DEFINED GLOBALLY) ---
    
    window.loadConversations = async function() { 
        const list = await api(`${API_BASE}/conversations`);
        if (!list || !list.length) return els.convoList.innerHTML = '<li style="padding:15px;text-align:center;color:var(--text-muted);">No chats.</li>';
        
        els.convoList.innerHTML = list.map(c => {
            const topic = c.topic || (c.participants_names || 'Unnamed').split(',')[0];
            const activeClass = c.id === state.currentConvoId ? 'active' : '';
            return `<li class="conversation-item ${activeClass}" onclick="selectChat('${c.id}', '${topic.replace(/'/g,"\\'")}', ${c.is_group}, '${(c.participants_names||'').replace(/'/g,"\\'")}')">
                <div class="conversation-topic">${topic}</div>
                <div class="conversation-meta">${new Date(c.last_message_at).toLocaleDateString()}</div>
            </li>`;
        }).join('');
    };

    window.loadMessages = async function(id) {
        const msgs = await api(`${API_BASE}/messages/${id}`);
        els.feed.innerHTML = '';
        msgs.forEach(appendMsg);
        els.feed.scrollTop = els.feed.scrollHeight;
        api(`${API_BASE}/conversations/${id}/read`, {method:'POST'});
    };


    // --- INIT & API ---
    if (!TOKEN || !USER_ID) {
        els.feed.innerHTML = '<div style="text-align:center;padding:50px;color:var(--text-muted);"><h3>Authentication Error</h3><p>Please log in.</p></div>';
    } else {
        els.usernameDisplay.textContent = `${USER_NAME} (${USER_ROLE})`;
        loadConversations();
    }

    async function api(url, options = {}) {
        const headers = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${TOKEN}` };
        try {
            const res = await fetch(url, { ...options, headers });
            if (res.status === 401) { alert('Session expired'); throw new Error('Unauthorized'); }
            if (res.status === 204) return null;
            if (!res.ok) {
                const errorBody = await res.json().catch(() => ({ message: res.statusText || 'Server error.' }));
                console.error("API Response Error:", errorBody.message);
                throw new Error(errorBody.message || 'API call failed.');
            }
            return res.json();
        } catch (e) { console.error("API Failure:", e.message); throw e; }
    }

    window.selectChat = async (id, topic, isGroup, parts) => {
        state.currentConvoId = id;
        socket.emit('join_conversation', id);
        
        document.querySelectorAll('.conversation-item').forEach(i => i.classList.remove('active'));
        
        els.topic.textContent = topic;
        els.participants.textContent = isGroup ? parts : 'Private Chat';
        els.chatHeader.style.display = 'flex';
        els.form.style.display = 'flex';
        els.placeholder.style.display = 'none';
        els.feed.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-muted);">Loading...</div>';
        
        try {
            await loadMessages(id);
        } catch(e) {
             els.feed.innerHTML = `<div style="text-align:center;padding:20px;color:red;">Failed to load messages: ${e.message}</div>`;
        }
    };

    function appendMsg(m) {
        const isMine = m.sender_id == USER_ID;
        const content = m.content === '[Message Deleted]' ? `<i style="color:var(--text-muted);">${m.content}</i>` : m.content;
        els.feed.insertAdjacentHTML('beforeend', `<div class="message-row ${isMine?'outgoing':'incoming'}"><div class="message-bubble"><span class="message-sender">${isMine?'You':m.sender_name}</span><div>${content}</div><div class="message-meta">${new Date(m.created_at).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</div></div></div>`);
    }

    els.form.addEventListener('submit', async(e)=>{
        e.preventDefault();
        const txt = els.input.value.trim();
        if(!txt) return;
        els.input.value = '';
        try {
            await api(`${API_BASE}/messages/${state.currentConvoId}`, {method:'POST', body:JSON.stringify({content:txt})});
        } catch(e) {
            alert("Failed to send message.");
            els.input.value = txt;
        }
    });

    // --- SMART DROPDOWN LOGIC ---
    
    const triggerSearch = async (query) => {
        try {
            const users = await api(`${API_BASE}/users/search?query=${query}`);
            state.suggestions = users || [];
            
            if (state.suggestions.length === 0) {
                els.dropdown.innerHTML = '<div class="suggestion-item" style="cursor:default;color:var(--text-muted);">No users found</div>';
            } else {
                els.dropdown.innerHTML = state.suggestions.map(u => `
                    <div class="suggestion-item" onclick="selectUser('${u.id}')">
                        <strong>${u.name}</strong> <span class="suggestion-id" style="color:var(--text-muted);">(${u.id.substring(0,6)}...)</span>
                    </div>
                `).join('');
            }
            els.dropdown.style.display = 'block';
        } catch(e) {
            els.dropdown.innerHTML = `<div class="suggestion-item" style="cursor:default;color:red;">Error searching users.</div>`;
            els.dropdown.style.display = 'block';
        }
    };

    window.openNewChatModal = () => {
        state.activeParticipants = [USER_ID];
        els.search.value = '';
        els.dropdown.style.display = 'none';
        renderParticipants();
        document.getElementById('new-chat-modal').style.display = 'flex';
        
        setTimeout(() => {
            els.search.focus();
            triggerSearch(''); 
        }, 100); 
    };

    els.search.addEventListener('input', (e) => {
        const query = e.target.value.trim();
        triggerSearch(query);
    });
    
    els.search.addEventListener('focus', () => {
         if (els.search.value.length === 0) {
            triggerSearch('');
        }
    });

    window.selectUser = (id) => {
        const user = state.suggestions.find(u => u.id === id);
        if(user && !state.activeParticipants.includes(user.id)) {
            state.activeParticipants.push(user.id);
            renderParticipants();
        }
        els.search.value = '';
        els.dropdown.style.display = 'none';
    };

    document.addEventListener('click', (e) => {
        if (!els.search.contains(e.target) && !els.dropdown.contains(e.target)) {
            els.dropdown.style.display = 'none';
        }
    });

    function renderParticipants() {
        const list = document.getElementById('new-chat-participants');
        list.innerHTML = `<li style="background:var(--incoming-bg); border-left: 4px solid var(--primary-color);"><strong>You</strong></li>`;
        state.activeParticipants.forEach(id => {
            if(id === USER_ID) return;
            const u = state.suggestions.find(x => x.id === id) || {name: 'User'};
            list.innerHTML += `<li style="background:var(--incoming-bg);"><span>${u.name}</span> <span style="color:var(--primary-color);cursor:pointer;" onclick="removePart('${id}')">Ã—</span></li>`;
        });
    }
    window.removePart = (id) => { state.activeParticipants = state.activeParticipants.filter(p => p!==id); renderParticipants(); };

    document.getElementById('new-chat-form').addEventListener('submit', async(e)=>{
        e.preventDefault();
        if(state.activeParticipants.length < 2) return alert('Add at least one person');
        try {
            await api(`${API_BASE}/conversations`, {method:'POST', body:JSON.stringify({
                participant_ids: state.activeParticipants.filter(id => id !== USER_ID),
                topic: document.getElementById('new-chat-topic').value
            })});
            closeModal('new-chat-modal');
            loadConversations();
        } catch(e) {
             alert("Failed to create conversation: " + e.message);
        }
    });
    
    // --- EDIT / DELETE HANDLERS ---
    
    window.initEdit = (id, c) => { 
        document.getElementById('edit-message-id').value = id; 
        document.getElementById('edit-message-content').value = c; 
        document.getElementById('edit-message-modal').style.display = 'flex';
    }
    
    document.getElementById('edit-message-form').addEventListener('submit', async(e)=>{ 
        e.preventDefault(); 
        const messageId = document.getElementById('edit-message-id').value;
        const newContent = document.getElementById('edit-message-content').value;
        
        if (!messageId) { return alert("Error: Message ID missing. Cannot save."); } 
        
        try {
            await api(`${API_BASE}/messages/${messageId}`, {method:'PUT', body:JSON.stringify({newContent:newContent})}); 
            closeModal('edit-message-modal'); 
            loadMessages(state.currentConvoId); 
        } catch(e) {
             alert("Failed to save changes: " + e.message);
        }
    });
    
    window.deleteMsg = async(id) => { 
        if(confirm('Delete?')) { 
            try {
                await api(`${API_BASE}/messages/${id}`, {method:'DELETE'}); 
                loadMessages(state.currentConvoId); 
            } catch(e) {
                alert("Failed to delete message: " + e.message);
            }
        }
    };

    </script>
</body>
</html>