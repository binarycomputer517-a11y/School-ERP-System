<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messaging System</title>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        :root {
            --primary: #4f46e5;
            --primary-dark: #3730a3;
            --bg-dark: #111827;
            --bg-light: #1f2937;
            --border: #374151; 
            --text: #f3f4f6;
            --text-muted: #9ca3af; 
            --bubble-in: #374151;
        }

        body { font-family: sans-serif; margin: 0; background-color: var(--bg-light); color: var(--text); height: 100vh; overflow: hidden; }
        .app-container { display: flex; height: 100%; }
        
        /* Sidebar */
        .sidebar { width: 280px; background-color: var(--bg-dark); border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .sidebar-header { padding: 20px; border-bottom: 1px solid var(--border); }
        .new-chat-btn { margin: 15px; padding: 10px; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer; }
        .conversation-list { flex-grow: 1; overflow-y: auto; list-style: none; padding: 0; margin: 0; }
        .conversation-item { padding: 15px; border-bottom: 1px solid var(--border); cursor: pointer; }
        .conversation-item:hover { background: #1f2937; }
        .conversation-item.active { background: var(--primary); border-left: 4px solid white; }

        /* Chat Area */
        .chat-area { flex-grow: 1; display: flex; flex-direction: column; }
        .chat-header { padding: 15px; background: var(--bubble-in); border-bottom: 1px solid var(--border); display: none; justify-content: space-between; align-items: center; }
        .message-feed { flex-grow: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; }
        
        /* Bubbles */
        .message-row { display: flex; margin-bottom: 10px; width: 100%; }
        .message-row.incoming { justify-content: flex-start; }
        .message-row.outgoing { justify-content: flex-end; }
        .message-bubble { max-width: 60%; padding: 10px 15px; border-radius: 8px; position: relative; }
        .incoming .message-bubble { background: var(--bubble-in); border: 1px solid var(--border); }
        .outgoing .message-bubble { background: var(--primary); color: white; }
        .message-sender { font-size: 0.75rem; font-weight: bold; display: block; margin-bottom: 4px; opacity: 0.8; }
        .message-meta { font-size: 0.7rem; text-align: right; margin-top: 5px; opacity: 0.7; }
        
        /* ACTION BUTTONS (The Fix) */
        .message-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 5px; font-size: 0.75rem; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 4px; }
        .message-actions span { cursor: pointer; text-decoration: underline; opacity: 0.9; }
        .message-actions span:hover { font-weight: bold; opacity: 1; }

        /* Input */
        .chat-input-area { padding: 15px; border-top: 1px solid var(--border); background: var(--bubble-in); display: none; }
        .chat-input-area input { flex-grow: 1; padding: 10px; border-radius: 4px; border: 1px solid var(--border); background: #4b5563; color: white; margin-right: 10px; }
        .chat-input-area button { padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer; }

        /* Modals */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal-content { background: var(--bubble-in); padding: 25px; width: 400px; border-radius: 8px; border: 1px solid var(--border); }
        .form-control { width: 100%; padding: 8px; margin: 10px 0; background: #111827; border: 1px solid var(--border); color: white; box-sizing: border-box; }
        .dropdown { position: absolute; background: #374151; border: 1px solid var(--primary); width: 100%; max-height: 150px; overflow-y: auto; display: none; z-index: 1000; left: 0; top: 100%; }
        .dropdown div { padding: 10px; cursor: pointer; border-bottom: 1px solid #4b5563; }
        .dropdown div:hover { background: #4b5563; }
        
        /* Participant List Style */
        .participant-list-ui { list-style: none; padding: 0; margin: 10px 0; border: 1px solid var(--border); border-radius: 4px; padding: 10px; background: #111827; max-height: 100px; overflow-y: auto; }
        .participant-list-ui li { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #333; }
        .participant-list-ui li:last-child { border-bottom: none; }
        .remove-user-btn { color: #ef4444; cursor: pointer; font-weight: bold; margin-left: 10px; }
    </style>
</head>
<body>
    
    <div class="app-container">
        <div class="sidebar">
            <div class="sidebar-header">
                <h3 style="margin:0">MESSAGES</h3>
                <small id="user-display">Loading...</small>
            </div>
            <button class="new-chat-btn" onclick="openNewChatModal()">+ New Chat</button>
            <ul id="conversation-list" class="conversation-list"></ul>
        </div>

        <div class="chat-area">
            <div id="chat-header" class="chat-header">
                <h3 id="convo-topic" style="margin:0">Topic</h3>
                <small id="convo-parts"></small>
            </div>
            <div id="message-feed" class="message-feed">
                <div style="text-align:center; margin-top: 20%; color: var(--text-muted);">Select a conversation</div>
            </div>
            <form id="message-form" class="chat-input-area">
                <input type="text" id="message-input" placeholder="Type a message..." autocomplete="off">
                <button type="submit">Send</button>
            </form>
        </div>
    </div>

    <div id="new-chat-modal" class="modal">
        <div class="modal-content">
            <h3>New Conversation <span onclick="closeModal('new-chat-modal')" style="float:right;cursor:pointer">&times;</span></h3>
            <form id="new-chat-form">
                <label style="font-size:0.9em;color:var(--text-muted)">Topic (Optional)</label>
                <input type="text" id="new-chat-topic" class="form-control" placeholder="e.g. Marketing Team">
                
                <label style="font-size:0.9em;color:var(--text-muted)">Add Participants</label>
                <div style="position:relative">
                    <input type="text" id="participant-search" class="form-control" placeholder="Type name to search..." autocomplete="off">
                    <div id="suggestions-dropdown" class="dropdown"></div>
                </div>

                <ul id="selected-participants" class="participant-list-ui">
                    <li><span style="color:var(--text-muted)">You (Admin)</span></li>
                </ul>

                <button type="submit" class="new-chat-btn" style="width:100%; margin:10px 0 0 0;">Create Conversation</button>
            </form>
        </div>
    </div>

    <div id="edit-message-modal" class="modal">
        <div class="modal-content">
            <h3>Edit Message <span onclick="closeModal('edit-message-modal')" style="float:right;cursor:pointer">&times;</span></h3>
            <form id="edit-message-form">
                <input type="hidden" id="edit-message-id">
                <input type="text" id="edit-message-content" class="form-control" required>
                <button type="submit" class="new-chat-btn" style="width:100%; margin:10px 0 0 0;">Save Changes</button>
            </form>
        </div>
    </div>

<script>
    const API_BASE = '/api/messaging';
    
    // --- AUTHENTICATION ---
    const TOKEN = localStorage.getItem('erp-token') || localStorage.getItem('token');
    let USER_ID = localStorage.getItem('user-id');
    const USER_NAME = localStorage.getItem('username') || 'User';

    // Decode token if USER_ID is missing but we have a token
    if (!USER_ID && TOKEN) {
        try { const p = JSON.parse(atob(TOKEN.split('.')[1])); USER_ID = p.userId || p.id; } catch(e){}
    }
    
    // Update Sidebar User Info
    const userDisplay = document.getElementById('user-display');
    if(userDisplay) userDisplay.textContent = USER_NAME;

    // --- SOCKET.IO SETUP ---
    let socket = { emit:()=>{}, on:()=>{} };
    try { 
        if(typeof io !== 'undefined') {
            socket = io(); 
            // Join my own room for notifications
            if(USER_ID) socket.emit('join_room', USER_ID);
        }
    } catch(e){ console.error('Socket fail', e); }

    // --- STATE MANAGEMENT ---
    let currentConvoId = null;
    let selectedUsers = []; // Stores {id, name} for new chat
    let topSearchResult = null; // For "Press Enter to Add" logic

    // --- INITIAL LOAD ---
    if(TOKEN) loadConversations();

    async function loadConversations() {
        try {
            const list = await api(`${API_BASE}/conversations`);
            const el = document.getElementById('conversation-list');
            
            if(!list || !list.length) {
                el.innerHTML = '<li style="padding:20px; text-align:center; color: #9ca3af;">No chats found.</li>';
                return;
            }
            
            el.innerHTML = list.map(c => `
                <li class="conversation-item ${c.id === currentConvoId ? 'active' : ''}" 
                    onclick="selectChat('${c.id}', '${(c.topic||'Chat').replace(/'/g,"\\'")}', '${(c.participants_names||'').replace(/'/g,"\\'")}')">
                    <div style="font-weight:bold; margin-bottom:4px;">${c.topic || 'No Topic'}</div>
                    <small style="color:var(--text-muted)">${new Date(c.last_message_at).toLocaleDateString()}</small>
                </li>
            `).join('');
        } catch(e) { console.error(e); }
    }

    async function loadMessages(id) {
        try {
            const res = await api(`${API_BASE}/messages/${id}`);
            const feed = document.getElementById('message-feed');
            feed.innerHTML = '';
            res.messages.forEach(appendMsg);
            feed.scrollTop = feed.scrollHeight;
            // Mark as read in background
            api(`${API_BASE}/conversations/${id}/read`, {method:'POST'}).catch(()=>{});
        } catch(e) {
            document.getElementById('message-feed').innerHTML = '<div style="text-align:center; padding:20px; color:red;">Failed to load messages</div>';
        }
    }

    // --- MESSAGE RENDERING ---
    function appendMsg(m) {
        const isMine = m.sender_id == USER_ID;
        const feed = document.getElementById('message-feed');
        
        const contentHtml = m.is_deleted ? '<i style="opacity:0.6">[Message Deleted]</i>' : m.content;
        
        let actions = '';
        if(isMine && !m.is_deleted) {
            const safeContent = m.content.replace(/'/g, "\\'").replace(/"/g, '&quot;');
            actions = `
                <div class="message-actions">
                    <span onclick="initEdit('${m.id}', '${safeContent}')">Edit</span>
                    <span onclick="deleteMsg('${m.id}')">Delete</span>
                </div>`;
        }

        feed.insertAdjacentHTML('beforeend', `
            <div class="message-row ${isMine ? 'outgoing' : 'incoming'}">
                <div class="message-bubble">
                    <span class="message-sender">${isMine ? 'You' : m.sender_name}</span>
                    <div>${contentHtml}</div>
                    <div class="message-meta">
                        ${new Date(m.created_at).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}
                        ${m.is_edited ? '(edited)' : ''}
                    </div>
                    ${actions}
                </div>
            </div>
        `);
    }

    // --- CHAT INTERACTION ---
    window.selectChat = (id, topic, parts) => {
        currentConvoId = id;
        document.getElementById('chat-header').style.display = 'flex';
        document.getElementById('message-form').style.display = 'flex';
        document.getElementById('convo-topic').textContent = topic;
        document.getElementById('convo-parts').textContent = parts;
        document.getElementById('message-feed').innerHTML = '<div style="padding:20px;text-align:center">Loading...</div>';
        
        // Update active class
        document.querySelectorAll('.conversation-item').forEach(i => i.classList.remove('active'));
        // Find the clicked item (approximate matching)
        // Note: Ideally we'd pass 'this' or select by ID, but this re-render is simple
        
        if(socket.emit) socket.emit('join_conversation', id);
        loadMessages(id);
    };

    document.getElementById('message-form').addEventListener('submit', async(e) => {
        e.preventDefault();
        const inp = document.getElementById('message-input');
        const txt = inp.value.trim();
        if(!txt) return;
        
        inp.value = ''; // Clear immediately for UX
        try {
            await api(`${API_BASE}/messages/${currentConvoId}`, {method:'POST', body:JSON.stringify({content:txt})});
            setTimeout(() => loadMessages(currentConvoId), 300); // Reload to confirm
        } catch(e) {
            alert("Failed to send");
            inp.value = txt; // Restore if failed
        }
    });

    // --- NEW CHAT LOGIC (IMPROVED) ---
    window.openNewChatModal = () => {
        document.getElementById('new-chat-modal').style.display = 'flex';
        selectedUsers = [];
        renderSelectedUsers();
        document.getElementById('participant-search').value = '';
        document.getElementById('participant-search').focus();
    };

    const searchInp = document.getElementById('participant-search');
    const dropdown = document.getElementById('suggestions-dropdown');

    // Handle Input Typing
    searchInp.addEventListener('input', async(e) => {
        const q = e.target.value.trim();
        if(!q) {
            dropdown.style.display = 'none';
            topSearchResult = null;
            return;
        }
        
        try {
            const users = await api(`${API_BASE}/users/search?query=${q}`);
            if(users.length === 0) {
                 dropdown.innerHTML = `<div style="padding:10px;color:#ccc">No users found</div>`;
                 topSearchResult = null;
            } else {
                topSearchResult = users[0]; // Save top result for Enter key
                dropdown.innerHTML = users.map(u => 
                    `<div onclick="addParticipant('${u.id}', '${u.name.replace(/'/g, "\\'")}')">${u.name}</div>`
                ).join('');
            }
            dropdown.style.display = 'block';
        } catch(e) { console.error(e); }
    });

    // Handle "Enter" Key in Search Box
    searchInp.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault(); // Don't submit the main form!
            if (topSearchResult) {
                addParticipant(topSearchResult.id, topSearchResult.name);
            }
        }
    });

    window.addParticipant = (id, name) => {
        if(id === USER_ID) return alert('You are automatically included.');
        if(selectedUsers.some(u => u.id === id)) {
            dropdown.style.display = 'none';
            searchInp.value = '';
            return; // Already added
        }
        
        selectedUsers.push({ id, name });
        renderSelectedUsers();
        
        dropdown.style.display = 'none';
        searchInp.value = '';
        searchInp.focus(); // Keep focus for typing next name
        topSearchResult = null;
    };

    window.removeParticipant = (index) => {
        selectedUsers.splice(index, 1);
        renderSelectedUsers();
    };

    function renderSelectedUsers() {
        const list = document.getElementById('selected-participants');
        let html = '<li><span style="color:var(--text-muted)">You (Admin)</span></li>';
        
        selectedUsers.forEach((u, idx) => {
            html += `
                <li>
                    <span>${u.name}</span>
                    <span class="remove-user-btn" onclick="removeParticipant(${idx})">&times;</span>
                </li>
            `;
        });
        list.innerHTML = html;
    }

    // Submit New Chat
    document.getElementById('new-chat-form').addEventListener('submit', async(e)=>{
        e.preventDefault();
        
        if(selectedUsers.length === 0) {
            alert('Please search for a user and CLICK their name to add them.');
            return;
        }

        const topic = document.getElementById('new-chat-topic').value;
        const participant_ids = selectedUsers.map(u => u.id);
        
        try {
            await api(`${API_BASE}/conversations`, {method:'POST', body:JSON.stringify({
                participant_ids,
                topic
            })});
            
            document.getElementById('new-chat-modal').style.display = 'none';
            loadConversations();
        } catch(err) {
            alert(err.message);
        }
    });

    // --- UTILS ---
    window.closeModal = (id) => document.getElementById(id).style.display = 'none';

    window.initEdit = (id, content) => {
        document.getElementById('edit-message-id').value = id;
        document.getElementById('edit-message-content').value = content;
        document.getElementById('edit-message-modal').style.display = 'flex';
    };

    document.getElementById('edit-message-form').addEventListener('submit', async(e)=>{
        e.preventDefault();
        const id = document.getElementById('edit-message-id').value;
        const txt = document.getElementById('edit-message-content').value;
        await api(`${API_BASE}/messages/${id}`, {method:'PUT', body:JSON.stringify({newContent:txt})});
        closeModal('edit-message-modal');
        loadMessages(currentConvoId);
    });

    window.deleteMsg = async(id) => {
        if(!confirm('Delete this message?')) return;
        await api(`${API_BASE}/messages/${id}`, {method:'DELETE'});
        loadMessages(currentConvoId);
    };

    // Global click to close dropdowns
    document.addEventListener('click', (e) => {
        if (!searchInp.contains(e.target) && !dropdown.contains(e.target)) {
            dropdown.style.display = 'none';
        }
        // Close modals on outside click
        if (e.target.classList.contains('modal')) {
            e.target.style.display = 'none';
        }
    });

    async function api(url, opts={}) {
        opts.headers = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${TOKEN}` };
        const res = await fetch(url, opts);
        if(!res.ok) {
            const err = await res.json().catch(()=>({message:res.statusText}));
            throw new Error(err.message);
        }
        return res.status !== 204 ? res.json() : null;
    }
</script>
</body>
</html>