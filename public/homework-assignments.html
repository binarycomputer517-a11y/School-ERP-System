<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assignment & Grading Dashboard | ERP</title>
    <style>
        /* --- CLASSIC ERP STYLING --- */
        body { font-family: 'Times New Roman', serif; margin: 0; padding: 2em; background-color: #F8F8F8; color: #111; line-height: 1.6; }
        .container { max-width: 1400px; margin: auto; padding: 30px; background-color: #FFFFFF; border: 2px solid #333; box-shadow: 6px 6px 0 #AAA; }
        h1 { color: #C0392B; font-weight: bold; text-transform: uppercase; text-align: center; border-bottom: 5px double #000; padding-bottom: 15px; margin-bottom: 20px; font-size: 2.2em; }
        h2 { color: #005A9C; font-weight: bold; border-bottom: 2px solid #999; padding-bottom: 5px; margin-top: 20px; text-transform: uppercase; font-size: 1.1em; }
        
        .tab-container { display: flex; border-bottom: 2px solid #333; margin-bottom: 20px; background: #EEE; }
        .tab { padding: 12px 25px; cursor: pointer; border: 1px solid #333; border-bottom: none; margin-right: 5px; font-weight: bold; background: #DDD; font-size: 0.9em; }
        .tab.active { background: #FFF; border-top: 4px solid #C0392B; padding-top: 9px; margin-top: -1px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .grid-layout { display: grid; grid-template-columns: 400px 1fr; gap: 30px; }
        form { padding: 20px; border: 1px solid #333; background-color: #FDFDFD; margin-top: 10px; }
        label { display: block; margin-top: 12px; font-weight: bold; font-size: 0.85em; color: #444; }
        input, select, textarea { padding: 10px; width: 100%; margin-bottom: 5px; border: 1px solid #555; box-sizing: border-box; font-family: inherit; font-size: 0.95em; }
        
        .btn { padding: 8px 15px; border: 2px solid #000; cursor: pointer; box-shadow: 2px 2px 0 #000; font-weight: bold; text-transform: uppercase; font-size: 0.8em; }
        .btn-primary { background-color: #005A9C; color: white; border-color: #003366; }
        .btn-edit { background-color: #FFC107; color: #000; margin-right: 5px; }
        .btn-delete { background-color: #DC3545; color: white; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; border: 1px solid #333; background: #FFF; }
        th, td { padding: 12px; text-align: left; border: 1px solid #CCC; font-size: 0.9em; }
        th { background-color: #333; color: white; text-transform: uppercase; font-size: 0.75em; letter-spacing: 1px; }
        tr:nth-child(even) { background: #F9F9F9; }
        tr:hover { background: #FFFDE7; }
    </style>
</head>
<body>

<div class="container">
    <a href="/admin-dashboard.html" style="float: right; font-weight: bold; color: #005A9C; text-decoration: underline;">&larr; Exit to Admin</a>
    <h1>Academic Assignment Management</h1>

    <div class="tab-container">
        <div class="tab active" onclick="switchTab('manage-tab', this)">1. Create & Manage Assignments</div>
        <div class="tab" id="review-tab-btn" onclick="switchTab('review-tab', this)">2. Submissions Review & Grading</div>
    </div>

    <div id="manage-tab" class="tab-content active">
        <div class="grid-layout">
            <div class="card">
                <h2 id="form-title">Assignment Details</h2>
                <form id="assignment-form">
                    <input type="hidden" name="id" id="assignment-id">
                    <label>Target Course:</label>
                    <select id="course-select" required onchange="loadBatches(this.value)"></select>
                    <label>Target Batch:</label>
                    <select id="batch-select"><option value="">-- All Batches --</option></select>
                    <label>Subject Category:</label>
                    <select id="subject-select" required></select>
                    <label>Assignment Title:</label>
                    <input type="text" id="title" required>
                    <label>Deadline:</label>
                    <input type="datetime-local" id="due_date" required>
                    <label>Max Marks:</label>
                    <input type="number" id="max_marks" value="10">
                    <button type="submit" id="submit-btn" class="btn btn-primary" style="width: 100%; margin-top: 15px;">Publish Assignment</button>
                </form>
            </div>
            <div class="card">
                <h2>Current Assignments</h2>
                <table id="assignments-table">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Target</th>
                            <th>Deadline</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="assignments-tbody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="review-tab" class="tab-content">
        <h2>Submissions Pending Review</h2>
        <table>
            <thead>
                <tr>
                    <th>Student Name</th>
                    <th>Assignment</th>
                    <th>Submitted At</th>
                    <th>Files</th>
                    <th>Score</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="review-tbody"></tbody>
        </table>
    </div>
</div>



<script>
    const token = localStorage.getItem('erp-token');
    const API_BASE = '/api/online-learning';

    function switchTab(tabId, el) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        el.classList.add('active');
        if(tabId === 'review-tab') fetchPendingSubmissions();
    }

    // --- Loading Logics ---
    async function loadDependencies() {
        const headers = { 'Authorization': `Bearer ${token}` };
        const courses = await fetch('/api/academicswithfees/courses', { headers }).then(r => r.json());
        const subjects = await fetch('/api/academicswithfees/subjects', { headers }).then(r => r.json());
        
        document.getElementById('course-select').innerHTML = '<option value="">-- Course --</option>' + courses.map(c => `<option value="${c.course_id}">${c.course_name}</option>`).join('');
        document.getElementById('subject-select').innerHTML = '<option value="">-- Subject --</option>' + subjects.map(s => `<option value="${s.id || s.subject_id}">${s.subject_name}</option>`).join('');
    }

    async function loadBatches(courseId) {
        const res = await fetch(`/api/academicswithfees/courses/${courseId}/batches`, { headers: { 'Authorization': `Bearer ${token}` }});
        const batches = await res.json();
        document.getElementById('batch-select').innerHTML = '<option value="">-- All Batches --</option>' + batches.map(b => `<option value="${b.batch_id}">${b.batch_name}</option>`).join('');
    }

    // --- Submission Review & Grading ---
    async function fetchPendingSubmissions() {
        const tbody = document.getElementById('review-tbody');
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Scanning submissions...</td></tr>';
        
        try {
            const res = await fetch(`${API_BASE}/submissions/pending`, { headers: { 'Authorization': `Bearer ${token}` }});
            if (res.status === 404) throw new Error("API Route Missing");
            const data = await res.json();
            
            if(data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">âœ… No pending reviews.</td></tr>';
                return;
            }

            tbody.innerHTML = data.map(sub => `
                <tr>
                    <td><b>${sub.student_name}</b></td>
                    <td>${sub.assignment_title}</td>
                    <td>${new Date(sub.submitted_at).toLocaleString()}</td>
                    <td><a href="${sub.submission_file_url}" target="_blank" style="color:red; font-weight:bold;">[VIEW FILE]</a></td>
                    <td>
                        <input type="number" id="marks-${sub.id}" placeholder="Max ${sub.max_marks}" style="width:80px; padding:5px;">
                        <textarea id="feedback-${sub.id}" placeholder="Feedback" style="display:block; margin-top:5px; height:40px;"></textarea>
                    </td>
                    <td><button class="btn btn-primary" onclick="gradeSubmission('${sub.id}')">GRADED</button></td>
                </tr>
            `).join('');
        } catch (e) {
            tbody.innerHTML = `<tr><td colspan="6" style="color:red; text-align:center;">404: Teacher Review Route not found in onlineLearning.js</td></tr>`;
        }
    }

    async function gradeSubmission(subId) {
        const marks = document.getElementById(`marks-${subId}`).value;
        const feedback = document.getElementById(`feedback-${subId}`).value;
        if(!marks) return alert("Score is required.");

        const res = await fetch(`${API_BASE}/submissions/grade`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ submission_id: subId, marks, feedback })
        });

        if(res.ok) { alert("Grading complete!"); fetchPendingSubmissions(); }
    }

    // --- Basic CRUD ---
    async function fetchAssignments() {
        const res = await fetch(`${API_BASE}/modules`, { headers: { 'Authorization': `Bearer ${token}` }});
        const data = await res.json();
        document.getElementById('assignments-tbody').innerHTML = data.map(a => `
            <tr>
                <td>${a.title}</td>
                <td>${a.course_name}</td>
                <td>${new Date(a.due_date).toLocaleDateString()}</td>
                <td><button class="btn btn-delete" onclick="deleteAssignment('${a.id}')">DEL</button></td>
            </tr>
        `).join('');
    }

    async function deleteAssignment(id) {
        if(!confirm("Sure?")) return;
        await fetch(`${API_BASE}/modules/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` }});
        fetchAssignments();
    }

    document.getElementById('assignment-form').onsubmit = async (e) => {
        e.preventDefault();
        const payload = {
            course_id: document.getElementById('course-select').value,
            batch_id: document.getElementById('batch-select').value || null,
            subject_id: document.getElementById('subject-select').value,
            title: document.getElementById('title').value,
            due_date: document.getElementById('due_date').value,
            max_marks: document.getElementById('max_marks').value,
            content_type: 'ASSIGNMENT'
        };
        await fetch(`${API_BASE}/modules`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        alert("Published!");
        fetchAssignments();
    };

    window.onload = () => { loadDependencies(); fetchAssignments(); };
</script>
</body>
</html>