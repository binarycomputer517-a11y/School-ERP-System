<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Official Exam Result | School ERP</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <style>
        :root {
            --primary-blue: #005A9C;
            --success-green: #28a745;
            --danger-red: #dc3545;
            --neutral-grey: #6c757d;
        }

        body { font-family: 'Arial', sans-serif; background-color: #f4f4f9; padding: 20px; margin: 0; }
        
        .container { 
            max-width: 1000px; width: 100%; margin: 20px auto; background: white; padding: 30px; 
            box-shadow: 0 0 15px rgba(0,0,0,0.2); border-radius: 12px; position: relative; border: 5px solid var(--primary-blue); 
        }

        .container::before, .container::after {
            content: ''; position: absolute; left: 0; right: 0; height: 10px;
            background: linear-gradient(to right, #6366f1, #a855f7, #ec4899); z-index: 1;
        }
        .container::before { top: 0; } .container::after { bottom: 0; }

        .student-profile-header {
            display: flex; align-items: center; gap: 25px; padding: 20px;
            background: #f8fafc; border-radius: 15px; border: 1px solid #e2e8f0; margin-bottom: 25px;
        }

        .profile-pic-container {
            width: 100px; height: 100px; border-radius: 12px; border: 3px solid var(--primary-blue);
            overflow: hidden; background: #fff;
        }
        .profile-pic-container img { width: 100%; height: 100%; object-fit: cover; }

        h1 { color: var(--primary-blue); text-align: center; font-size: 2.2em; margin-bottom: 20px; border-bottom: 3px dashed var(--primary-blue); padding-bottom: 10px; }
        
        .summary-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 30px; padding: 15px; background-color: #eaf6ff; border-radius: 8px; }
        .summary-item { background: white; padding: 15px; border-radius: 5px; text-align: center; border: 1px solid #bbddee; }
        .summary-item strong { display: block; color: var(--primary-blue); margin-bottom: 5px; font-size: 0.85em; text-transform: uppercase; }
        .summary-item span { font-size: 1.3em; font-weight: bold; }

        .score-val { font-size: 3.5em; font-weight: 900; color: var(--success-green); text-align: center; }

        #omr-sheet-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; margin-top: 20px; padding: 15px; background: #f9f9f9; border-radius: 10px; }
        .omr-question-block { border: 1px solid #ddd; border-radius: 8px; padding: 10px; background: white; display: flex; flex-direction: column; align-items: center; }
        .omr-bubbles { display: flex; gap: 4px; margin-top: 8px; }
        
        .omr-bubble {
            width: 22px; height: 22px; border-radius: 50%; border: 1.5px solid #888;
            display: flex; align-items: center; justify-content: center; font-size: 0.75em; font-weight: bold; color: #555;
        }

        /* OMR Logic Colors */
        .omr-bubble.correct-option { border-color: var(--success-green); color: var(--success-green); background: #e8f5e9; border-width: 2px; }
        .omr-bubble.student-selected { background-color: var(--neutral-grey); border-color: var(--neutral-grey); color: white; }
        .omr-bubble.student-selected.correct-option { background-color: var(--success-green) !important; border-color: var(--success-green) !important; color: white !important; }
        .omr-bubble.student-selected:not(.correct-option) { background-color: var(--danger-red) !important; border-color: var(--danger-red) !important; color: white !important; }

        .btn-home { display: block; width: 220px; margin: 30px auto; padding: 12px; background: var(--primary-blue); color: white; text-align: center; text-decoration: none; border-radius: 50px; font-weight: bold; }

        @media print {
            .btn-home, button, .fas { display: none !important; }
            .container { box-shadow: none; border: 2px solid var(--primary-blue); margin: 0; width: 100%; }
        }
    </style>
</head>
<body>

    <div class="container animate__animated animate__fadeIn">
        <h1>OFFICIAL RESULT SHEET</h1>
        
        <div class="student-profile-header">
            <div class="profile-pic-container">
                <img id="student-pic" src="" alt="Student">
            </div>
            <div class="student-info">
                <h4 id="student-name">Loading Profile...</h4>
                <div class="row g-2">
                    <div class="col-md-6"><p>ROLL: <span id="student-roll">-</span></p></div>
                    <div class="col-md-6"><p>COURSE: <span id="student-course">-</span></p></div>
                    <div class="col-md-6"><p>BATCH: <span id="student-batch">-</span></p></div>
                    <div class="col-md-6"><p>SUBJECT: <span id="student-subject">-</span></p></div>
                </div>
            </div>
        </div>

        <div id="result-summary">
            <h3 id="exam-title" style="text-align: center; color: #333;">Exam Title</h3>
            <div class="score-val" id="total-score">0</div>
            <p class="text-center fw-bold text-muted">TOTAL MARKS OBTAINED</p>

            <div class="summary-grid">
                <div class="summary-item"><strong>Correct</strong><span id="correct-count" style="color: var(--success-green);">0</span></div>
                <div class="summary-item"><strong>Incorrect</strong><span id="incorrect-count" style="color: var(--danger-red);">0</span></div>
                <div class="summary-item"><strong>Unanswered</strong><span id="unanswered-count" style="color: var(--neutral-grey);">0</span></div>
                <div class="summary-item"><strong>Violations</strong><span id="violation-count" style="color: #c0392b;">0</span></div>
                <div class="summary-item"><strong>Max Marks</strong><span id="max-marks">0</span></div>
                <div class="summary-item"><strong>Status</strong><span id="status" style="color: var(--primary-blue);">-</span></div>
            </div>
        </div>

        <h4 class="text-center mt-4" style="color: var(--primary-blue);">Detailed OMR Analysis</h4>
        <div id="omr-sheet-grid"></div>

        <div class="mt-5">
            <h4 class="text-center" style="color: var(--primary-blue); margin-bottom: 20px;">
                <i class="fas fa-list-check me-2"></i> ANSWER KEY DETAILS
            </h4>
            <div class="table-responsive shadow-sm" style="border-radius: 12px; overflow: hidden;">
                <table class="table table-hover align-middle mb-0" style="background: white;">
                    <thead style="background-color: var(--primary-blue); color: white;">
                        <tr>
                            <th class="text-center">Q.No</th>
                            <th>Question</th>
                            <th class="text-center">Your Ans</th>
                            <th class="text-center">Correct Ans</th>
                            <th class="text-center">Status</th>
                        </tr>
                    </thead>
                    <tbody id="answer-key-body"></tbody>
                </table>
            </div>
        </div>

        <div class="text-center mt-4">
            <button onclick="window.print()" class="btn btn-outline-secondary rounded-pill px-4 me-2">
                <i class="fas fa-print me-2"></i> PRINT PDF
            </button>
            <a href="/my-quiz.html" class="btn-home d-inline-block">BACK TO DASHBOARD</a>
        </div>
    </div>

    

    <script>
        const QUIZ_ID = new URLSearchParams(window.location.search).get('quizId');
        const TOKEN = localStorage.getItem('erp-token');

        if (!TOKEN) window.location.href = '/login.html';

        async function fetchResults() {
            try {
                const response = await fetch(`/api/online-exam/results/${QUIZ_ID}`, {
                    headers: { 'Authorization': `Bearer ${TOKEN}` }
                });
                const data = await response.json();

                // Profile & Summary Populate
                document.getElementById('student-name').innerText = data.summary.student_name || 'N/A';
                document.getElementById('student-roll').innerText = data.summary.roll_number || 'N/A';
                document.getElementById('student-course').innerText = data.summary.course_name || 'N/A';
                document.getElementById('student-batch').innerText = data.summary.batch_name || 'N/A';
                document.getElementById('student-subject').innerText = data.summary.subject_name || 'N/A';
                document.getElementById('student-pic').src = data.summary.profile_pic || `https://ui-avatars.com/api/?name=${encodeURIComponent(data.summary.student_name)}&background=005A9C&color=fff`;

                document.getElementById('exam-title').innerText = data.summary.title || 'Exam Result';
                document.getElementById('total-score').innerText = data.summary.total_score ?? 0;
                document.getElementById('correct-count').innerText = data.summary.correct_count ?? 0;
                document.getElementById('incorrect-count').innerText = data.summary.incorrect_count ?? 0;
                document.getElementById('unanswered-count').innerText = data.summary.unanswered_count ?? 0;
                document.getElementById('violation-count').innerText = data.summary.violation_count ?? 0;
                document.getElementById('max-marks').innerText = data.summary.max_marks ?? 0;
                document.getElementById('status').innerText = (data.summary.status || 'Submitted').toUpperCase();

                // OMR & Table Rendering
                const grid = document.getElementById('omr-sheet-grid');
                const tableBody = document.getElementById('answer-key-body');
                const options = ['a', 'b', 'c', 'd'];

                data.details.forEach((item, index) => {
                    // Case-insensitive normalization
                    const sAns = (item.student_answer || "").toString().toLowerCase().trim();
                    const cAns = (item.correct_answer || "").toString().toLowerCase().trim();
                    const isCorrect = (sAns === cAns);

                    // OMR Block
                    const block = document.createElement('div');
                    block.className = 'omr-question-block';
                    block.innerHTML = `<strong>Q.${index + 1}</strong>`;
                    const bubbles = document.createElement('div');
                    bubbles.className = 'omr-bubbles';

                    options.forEach(opt => {
                        const bubble = document.createElement('div');
                        bubble.className = 'omr-bubble';
                        bubble.innerText = opt.toUpperCase();
                        
                        const currentOpt = opt.toLowerCase();
                        // Logic to highlight correct and selected bubbles
                        if (cAns === currentOpt) bubble.classList.add('correct-option');
                        if (sAns === currentOpt) bubble.classList.add('student-selected');
                        
                        bubbles.appendChild(bubble);
                    });
                    block.appendChild(bubbles);
                    grid.appendChild(block);

                    // Table Row logic
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="text-center fw-bold">${index + 1}</td>
                        <td class="small text-muted">${item.question_text || '---'}</td>
                        <td class="text-center"><span class="badge ${sAns === "" ? 'bg-secondary' : (isCorrect ? 'bg-success' : 'bg-danger')}">${sAns.toUpperCase() || 'N/A'}</span></td>
                        <td class="text-center fw-bold text-success">${cAns.toUpperCase()}</td>
                        <td class="text-center">${isCorrect ? '<i class="fas fa-check-circle text-success"></i>' : (sAns === "" ? '<i class="fas fa-minus text-muted"></i>' : '<i class="fas fa-times-circle text-danger"></i>')}</td>
                    `;
                    tableBody.appendChild(row);
                });

            } catch (err) {
                console.error(err);
                alert("Error loading results.");
            }
        }
        document.addEventListener('DOMContentLoaded', fetchResults);
    </script>
</body>
</html>