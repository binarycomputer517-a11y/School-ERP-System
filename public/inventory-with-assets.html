<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ERP Management Portal - Inventory & Assets</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        /* BASE STYLES - ADOPTED FROM NEW STYLE.CSS (Professional Classic/Blocky Design) */
        body { 
            font-family: 'Times New Roman', serif; /* New Font */
            margin: 0; 
            padding: 2em; 
            background-color: #F8F8F8; /* Light background */
            color: #333; 
            line-height: 1.6;
        }
        .container { 
            max-width: 1300px; /* Adjusted Max Width */
            margin: auto; 
            padding: 30px; 
            background-color: #FFFFFF; 
            border: 2px solid #333; /* Thick border */
            box-shadow: 6px 6px 0 #AAA; /* Block shadow */
            border-radius: 0; /* Sharp corners */
        }
        h1 { 
            color: #C0392B; /* Red/Maroon primary color */
            font-weight: bold; 
            text-transform: uppercase; 
            text-align: center; 
            border-bottom: 5px double #000; /* Heavy separator */
            padding-bottom: 15px; 
            margin-bottom: 30px; 
            font-size: 2.2em;
        }
        h2 { 
            color: #005A9C; /* Blue secondary color */
            font-weight: bold; 
            border-bottom: 2px solid #999; 
            padding-bottom: 5px; 
            margin-top: 25px; 
            margin-bottom: 15px;
        }
        
        /* TAB NAVIGATION - Reworked for blocky look */
        .tab-buttons { 
            display: flex; 
            margin-bottom: 20px; 
            border-bottom: 2px solid #333; /* New Separator */
            background-color: #E8E8E8;
            padding-top: 5px;
        }
        .tab-button { 
            padding: 8px 15px; 
            margin-right: -1px; /* Overlap borders */
            border: 1px solid #333; 
            border-bottom: none; 
            background-color: #F0F0F0; 
            cursor: pointer;
            border-radius: 0; /* Sharp corners */
            font-weight: bold; transition: all 0.15s;
            box-shadow: none;
        }
        .tab-button.active { 
            background-color: #005A9C; 
            color: white; 
            border: 2px solid #000; 
            border-bottom: 2px solid #fff; /* Hide container border */
            margin-bottom: -2px; /* Pull active tab forward */
            position: relative;
            z-index: 1;
        }
        .tab-content { padding-top: 10px; border-top: none; } /* Border moved to tab-buttons */
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }

        /* COMMON LAYOUT & FORM STYLES */
        .grid-main { display: grid; grid-template-columns: 3fr 1fr; gap: 30px; }
        .grid-form { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .grid-inv-form { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        .grid-po { display: grid; grid-template-columns: 3fr 1fr; gap: 15px; }

        label { display: block; margin-top: 10px; font-weight: bold; font-size: 0.9em; }
        input, select, textarea { 
            padding: 8px; /* Adjusted padding */
            margin-top: 5px; 
            box-sizing: border-box; 
            border: 1px solid #555; /* Darker border */
            border-radius: 0; /* Sharp corners */
            width: 100%; 
            margin-bottom: 10px;
            display: block;
        }
        
        /* BUTTON STYLES - Reworked for blocky look */
        button { 
            background-color: #005A9C; /* Secondary Blue */
            color: white; 
            padding: 10px 15px; 
            border: 2px solid #000; 
            border-radius: 0; 
            cursor: pointer; 
            margin-top: 15px; 
            box-shadow: 2px 2px 0 #000; /* Block shadow for button */
            font-weight: bold;
            transition: box-shadow 0.1s, transform 0.1s, background-color 0.3s;
        }
        button:hover { 
            background-color: #003366; 
            box-shadow: 1px 1px 0 #000; 
            transform: translate(1px, 1px);
        }
        .inv-btn { 
            background-color: #C0392B; /* Primary Red/Maroon for Inventory Actions */
        }
        .inv-btn:hover { 
            background-color: #9A2C1F; /* Darker red */
        }
        .card { 
            padding: 20px; 
            border: 1px solid #333; /* Darker card border */
            border-radius: 0; 
            margin-top: 20px; 
            background-color: #fcfdff; 
        }
        
        /* MESSAGE & ERROR STYLES */
        .message-box { padding: 15px; border-radius: 0; margin-top: 10px; font-weight: bold; border: 1px solid; }
        .error { background-color: #f8d7da; color: #721c24; border-color: #f5c6cb; }
        .success { background-color: #d4edda; color: #155724; border-color: #c3e6cb; }
        .info { background-color: #cce5ff; color: #004085; border-color: #b8daff; }

        /* TABLE & STATUS STYLES (ASSET) */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; border: 1px solid #333; }
        th, td { padding: 10px; text-align: left; border: 1px solid #CCC; font-size: 0.9em; }
        th { 
            background-color: #333; /* Black Header */
            color: white; 
            text-transform: uppercase;
        }

        .status-Active { color: #28a745; font-weight: bold; } /* Green */
        .status-In_Repair { color: #ffc107; font-weight: bold; } /* Yellow */
        .status-Retired { color: #6c757d; font-weight: bold; } /* Gray */
        .status-Missing { color: #C0392B; font-weight: bold; } /* Red/Maroon */

        /* TABLE & STATUS STYLES (INVENTORY) - Using the same header style as Assets */
        .inv-table th { background-color: #333; color: white; }
        .status-In_Stock { color: #155724; font-weight: bold; } /* Dark Green */
        .status-Low_Stock { color: #ff9800; font-weight: bold; } /* Orange */
        .status-Out_of_Stock { color: #721c24; font-weight: bold; } /* Dark Red */
        
        .action-btns button { 
            margin: 2px; 
            padding: 5px 8px; 
            font-size: 12px; 
            border: 1px solid #000;
            border-radius: 0;
            box-shadow: 1px 1px 0 #000; /* Smaller block shadow */
            transition: box-shadow 0.1s, transform 0.1s;
            margin-top: 0;
        }
        .action-btns button:hover { 
            box-shadow: 0 0 0 #000; 
            transform: translate(1px, 1px);
        }

        /* MODAL STYLES */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); }
        .modal-content { background-color: #fff; margin: 5% auto; padding: 20px; border-radius: 0; width: 90%; max-width: 800px; border: 2px solid #333; }
        .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        
        #po-items-container input { margin-bottom: 8px; }

        /* NEW FEATURE STYLES */
        .prediction-box {
            padding: 10px;
            background-color: #fff3e0;
            border: 1px solid #ffb74d;
            border-radius: 0;
            margin-top: 10px;
            font-size: 0.9em;
        }
        .prediction-status {
            font-weight: bold;
            color: #d84315;
        }
        .depreciation-info {
            font-size: 0.85em;
            margin-top: 5px;
            color: #6a6a6a;
        }
        /* Style for the PO Print View Modal Content */
        #po-print-view h1 { 
            font-size: 1.8em; 
            color: #000; 
            border-bottom: 3px solid #000; 
            margin-bottom: 15px;
            text-align: left; /* Override center align for PDF print */
            text-transform: none;
            padding-bottom: 5px;
        }
        #po-print-view table { margin-top: 15px; font-size: 0.9em; }
        #po-print-view th, #po-print-view td { border: 1px solid #333; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ERP Management Portal</h1>
        <p>Current Role: <strong id="user-role-display">Loading...</strong></p>

        <div class="tab-buttons">
            <button class="tab-button active" onclick="openTab(event, 'inventory')">üì¶ Inventory (Consumables)</button>
            <button class="tab-button" onclick="openTab(event, 'assets')">üè¢ Fixed Assets</button>
        </div>

        <div class="tab-content">
            <div id="inventory" class="tab-pane active">
                <div class="grid-main">
                    <div>
                        <div class="card">
                            <h2 style="color: #C0392B;">All Inventory Items</h2>
                            <table id="inventory-table" class="inv-table">
                                <thead>
                                    <tr>
                                        <th>Name / Category</th>
                                        <th>Current Stock</th>
                                        <th>Threshold</th>
                                        <th>Status</th>
                                        <th>Unit Cost</th>
                                        <th>Prediction (Days)</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="inv-items-tbody">
                                    <tr><td colspan="7">Loading inventory data...</td></tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="card" style="margin-top: 30px;">
                            <h2 style="color: #C0392B;">Record Stock Movement</h2>
                            <form id="movement-form">
                                <div class="grid-inv-form">
                                    <div>
                                        <label for="move-item-id">Item:</label>
                                        <select id="move-item-id" name="item_id" required></select>
                                    </div>
                                    <div>
                                        <label for="movement-type">Type:</label>
                                        <select id="movement-type" name="movement_type" required>
                                            <option value="IN_PURCHASE">IN (Purchase/Restock)</option>
                                            <option value="IN_RETURN">IN (Return)</option>
                                            <option value="OUT_ISSUE">OUT (Issue/Use)</option>
                                            <option value="OUT_DISPOSAL">OUT (Disposal/Write-off)</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="quantity">Quantity:</label>
                                        <input type="number" id="quantity" name="quantity" min="1" required>
                                    </div>
                                </div>
                                <div class="grid-inv-form">
                                    <div>
                                        <label for="recipient-id">Recipient ID (for OUT movements):</label>
                                        <input type="text" id="recipient-id" name="recipient_id" placeholder="Optional User UUID">
                                    </div>
                                    <div>
                                        <label for="reference-id">Reference ID (PO/Ticket No.):</label>
                                        <input type="text" id="reference-id" name="reference_id" placeholder="Optional PO or Ticket ID">
                                    </div>
                                    <div>
                                        <label for="inv-notes">Notes:</label>
                                        <input type="text" id="inv-notes" name="notes" placeholder="Details of use/disposal">
                                    </div>
                                </div>
                                <button type="submit" class="inv-btn">Record Movement</button>
                                <div id="movement-message" class="message-box" style="display:none;"></div>
                            </form>
                        </div>
                        
                        <div class="card" style="margin-top: 30px;">
                            <h2 style="color: #C0392B;">Purchase Order History</h2>
                            <table id="po-history-table" class="inv-table">
                                <thead>
                                    <tr>
                                        <th>PO ID</th>
                                        <th>Vendor</th>
                                        <th>Cost</th>
                                        <th>Status</th>
                                        <th>Created Date</th>
                                        <th>Details</th>
                                    </tr>
                                </thead>
                                <tbody id="po-history-tbody">
                                    <tr><td colspan="6">Click Load History button below...</td></tr>
                                </tbody>
                            </table>
                            <div style="display: flex; justify-content: space-between; gap: 10px;">
                                <button id="load-po-history-btn" class="inv-btn" style="flex-grow: 1;">Load History</button>
                                <button id="export-po-csv-btn" class="inv-btn" style="flex-grow: 1; background-color: #005A9C;">Export CSV</button>
                            </div>
                        </div>
                    </div>

                    <div>
                        <div class="card">
                            <h2 style="color: #C0392B;">Add New Item</h2>
                            <form id="add-item-form">
                                <label for="item-name">Name:</label>
                                <input type="text" name="name" required>
                                
                                <div class="grid-inv-form" style="grid-template-columns: 1fr 1fr 1fr;">
                                    <div><label for="category">Category:</label><input type="text" name="category" required placeholder="e.g., IT, Lab, Office"></div>
                                    <div><label for="unit-cost">Unit Cost (‚Çπ):</label><input type="number" name="unit_cost" step="0.01" required></div>
                                    <div><label for="threshold">Low Stock Threshold:</label><input type="number" name="low_stock_threshold" required></div>
                                </div>
                                
                                <label for="location-id">Storage Location ID:</label>
                                <input type="text" name="location_id" placeholder="e.g., IT-A1-Shelf-3">

                                <label for="vendor-id">Preferred Vendor:</label>
                                <select id="vendor-id-select" name="vendor_id"></select>

                                <button type="submit" class="inv-btn">Add Item</button>
                                <div id="item-message" class="message-box" style="display:none;"></div>
                            </form>
                        </div>

                        <div class="card" style="margin-top: 30px;">
                            <h2 style="color: #C0392B;">Create Purchase Order (PO)</h2>
                            <form id="purchase-order-form">
                                <div class="grid-po">
                                    <div>
                                        <label for="po-vendor-id">Select Vendor:</label>
                                        <select id="po-vendor-id" name="vendor_id" required></select>
                                    </div>
                                    <div>
                                        <label for="delivery-date">Expected Delivery Date:</label>
                                        <input type="date" id="delivery-date" name="expected_delivery_date">
                                    </div>
                                </div>
                                
                                <label>Items to Order:</label>
                                <div id="po-items-container">
                                    </div>
                                <button type="button" id="add-po-item-btn" class="inv-btn">Add Item to PO</button>

                                <h3 style="margin-top: 20px;">Total Cost: ‚Çπ<span id="po-total-cost">0.00</span></h3>
                                <input type="hidden" name="total_cost" id="po-total-cost-input">

                                <button type="submit" class="inv-btn">Generate PO</button>
                                <div id="po-message" class="message-box" style="display:none;"></div>
                            </form>
                        </div>
                        
                        <div class="card" style="margin-top: 30px;">
                            <h2 style="color: #C0392B;">Vendor Management</h2>
                            <form id="add-vendor-form">
                                <label for="vendor-name-new">Vendor Name:</label>
                                <input type="text" id="vendor-name-new" name="name" required>
                                
                                <div class="grid-inv-form" style="grid-template-columns: 1fr 1fr;">
                                    <div><label for="contact-person">Contact Person:</label><input type="text" name="contact_person" required></div>
                                    <div><label for="vendor-phone">Phone:</label><input type="text" name="phone"></div>
                                </div>
                                
                                <label for="vendor-email">Email:</label>
                                <input type="email" name="email">

                                <button type="submit" class="inv-btn">Register New Vendor</button>
                                <div id="vendor-message" class="message-box" style="display:none;"></div>
                            </form>
                            
                            <h3 style="margin-top: 20px;">All Vendors</h3>
                            <table id="vendor-list-table">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Contact</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="vendors-tbody">
                                    <tr><td colspan="3">Loading vendors...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="assets" class="tab-pane">
                <div class="grid-main" style="grid-template-columns: 3fr 1fr;">
                    <div>
                        <div class="card">
                            <h2>Asset Registry</h2>
                            <table id="asset-registry-table">
                                <thead>
                                    <tr>
                                        <th>Tag/Name</th>
                                        <th>Purchase Cost / Value</th>
                                        <th>Current Location</th>
                                        <th>Assigned To</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="assets-tbody">
                                    <tr><td colspan="6">Loading asset data...</td></tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="card" style="margin-top: 30px;">
                            <h2>Maintenance Request/Log</h2>
                            <form id="maintenance-form" class="grid-form">
                                <div>
                                    <label for="maint-asset-id">Asset Tag:</label>
                                    <input type="text" id="maint-asset-tag" placeholder="Enter Asset Tag Number" required>
                                </div>
                                <div>
                                    <label for="maintenance-type">Type:</label>
                                    <select id="maintenance-type" name="type" required>
                                        <option value="Repair">Repair (Major Issue)</option>
                                        <option value="Scheduled">Scheduled Maintenance</option>
                                        <option value="Calibration">Calibration</option>
                                        <option value="Upgrade">Upgrade</option>
                                    </select>
                                </div>
                                
                                <div style="grid-column: 1 / 3;">
                                    <label for="details">Details:</label>
                                    <textarea id="details" name="details" rows="2" required></textarea>
                                </div>

                                <div>
                                    <label for="scheduled-date">Scheduled Date:</label>
                                    <input type="date" id="scheduled-date" name="scheduled_date">
                                </div>
                                <div>
                                    <label for="maintenance-cost">Cost (‚Çπ):</label>
                                    <input type="number" id="maintenance-cost" name="maintenance_cost" step="0.01">
                                </div>
                                
                                <button type="submit" style="grid-column: 1 / 3;">Log Maintenance/Request</button>
                            </form>
                            <div id="maint-message" class="message-box" style="display:none;"></div>
                        </div>
                    </div>

                    <div>
                        <div class="card">
                            <h2>Register New Asset</h2>
                            <form id="register-asset-form">
                                <label for="tag-number">Asset Tag Number:</label>
                                <input type="text" name="tag_number" required placeholder="e.g., ASSET-IT-001">

                                <label for="name">Name:</label>
                                <input type="text" name="name" required placeholder="e.g., Dell Optiplex 7000">
                                
                                <div class="grid-form">
                                    <div><label for="asset-category">Category:</label><input type="text" name="category" placeholder="e.g., Desktop, Furniture"></div>
                                    <div><label for="purchase-cost">Purchase Cost (‚Çπ):</label><input type="number" name="purchase_cost" step="0.01" required></div>
                                </div>

                                <div class="grid-form">
                                    <div><label for="purchase-date">Purchase Date:</label><input type="date" name="purchase_date" required></div>
                                    <div><label for="useful-life">Useful Life (Years):</label><input type="number" name="useful_life_years" value="5"></div>
                                </div>
                                
                                <label for="location-id">Initial Location:</label>
                                <select id="location-id-select" name="current_location_id"></select>

                                <button type="submit">Register Asset</button>
                                <div id="register-message" class="message-box" style="display:none;"></div>
                            </form>
                        </div>

                        <div class="card" style="margin-top: 30px;">
                            <h2>Assign Asset</h2>
                            <form id="assign-asset-form">
                                <label for="assign-asset-id">Asset Tag to Assign:</label>
                                <input type="text" id="assign-asset-tag" name="asset_tag" required placeholder="Asset Tag Number">
                                
                                <label for="user-id">Assign to User ID (Staff/Student):</label>
                                <input type="text" id="user-id" name="user_id" required placeholder="User UUID">
                                
                                <label for="assigned-location">Assigned Location:</label>
                                <select id="assigned-location-select" name="assigned_location_id"></select>

                                <label for="assign-notes">Notes:</label>
                                <textarea id="assign-notes" name="notes" rows="2"></textarea>

                                <button type="submit">Deploy Asset</button>
                                <div id="assign-message" class="message-box" style="display:none;"></div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="edit-item-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('edit-item-modal')">√ó</span>
            <h3>Edit Item: <span id="edit-item-name-display"></span></h3>
            <form id="edit-item-form">
                <input type="hidden" id="edit-item-id" name="id">
                <label for="edit-name">Name:</label>
                <input type="text" id="edit-name" name="name" required>
                
                <div class="grid-inv-form">
                    <div><label for="edit-category">Category:</label><input type="text" id="edit-category" name="category" required></div>
                    <div><label for="edit-unit-cost">Unit Cost (‚Çπ):</label><input type="number" id="edit-unit-cost" name="unit_cost" step="0.01" required></div>
                    <div><label for="edit-threshold">Threshold:</label><input type="number" id="edit-threshold" name="low_stock_threshold" required></div>
                </div>
                
                <label for="edit-location">Location ID:</label>
                <input type="text" id="edit-location" name="location_id">

                <label for="edit-vendor">Preferred Vendor:</label>
                <select id="edit-vendor-id-select" name="vendor_id"></select>

                <button type="submit" class="inv-btn">Save Changes</button>
            </form>
        </div>
    </div>

    <div id="log-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('log-modal')">√ó</span>
            <h3>Movement History for <span id="log-item-name"></span></h3>
            <table id="movement-log-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Type</th>
                        <th>Quantity Change</th>
                        <th>New Stock</th>
                        <th>Recorded By</th>
                        <th>Notes/Ref</th>
                    </tr>
                </thead>
                <tbody id="log-tbody"></tbody>
            </table>
        </div>
    </div>

    <div id="maint-log-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('maint-log-modal')">√ó</span>
            <h3>Maintenance History for <span id="maint-log-asset-tag"></span></h3>
            <table id="maintenance-log-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Type</th>
                        <th>Cost</th>
                        <th>Requester</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody id="maint-log-tbody"></tbody>
            </table>
        </div>
    </div>

    <div id="po-print-view" style="display: none; position: absolute; top: -9999px;">
        <div id="po-print-content"></div>
    </div>


    <script>
        const API_BASE_INV = '/api/inventory';
        const API_BASE_ASSET = '/api/asset';
        const TOKEN = localStorage.getItem('erp-token');
        const USER_ROLE = localStorage.getItem('user-role');
        const USER_ID = localStorage.getItem('profile-id') || localStorage.getItem('user-id');
        
        // Authorization Check
        if (!TOKEN || !(USER_ROLE === 'Admin' || USER_ROLE === 'Super Admin' || USER_ROLE === 'Staff')) {
             window.location.href = '/login'; 
        }

        // --- GLOBAL VARIABLES ---
        let allItems = [];      // For inventory
        let allVendors = [];    // For inventory
        let allAssets = [];     // For assets
        let allLocations = [];  // For assets
        let stockPredictions = []; // For inventory prediction feature
        let poHistoryRecords = []; // Store PO records for export

        // --- DOM Elements ---
        const userRoleDisplay = document.getElementById('user-role-display');
        const invItemsTbody = document.getElementById('inv-items-tbody');
        const moveItemIdSelect = document.getElementById('move-item-id');
        const vendorIdSelects = document.querySelectorAll('#vendor-id-select, #po-vendor-id, #edit-vendor-id-select');
        const poItemsContainer = document.getElementById('po-items-container');
        const poTotalCostEl = document.getElementById('po-total-cost');
        const poTotalCostInput = document.getElementById('po-total-cost-input');
        const assetsTbody = document.getElementById('assets-tbody');
        const locationIdSelects = document.querySelectorAll('#location-id-select, #assigned-location-select');
        const poPrintContent = document.getElementById('po-print-content'); // For PDF rendering


        // --- Helper Functions ---
        async function handleApi(url, options = {}) {
            const authHeaders = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${TOKEN}` };
            const response = await fetch(url, { ...options, headers: authHeaders });
            
            if (response.status === 401 || response.status === 403) {
                // Smoothly handle expired/unauthorized sessions
                localStorage.clear();
                // window.location.href = '/login'; 
                throw new Error('Unauthorized or session expired. Redirecting to login.');
            }
            if (!response.ok) {
                const errorBody = await response.json().catch(() => ({ message: response.statusText || 'Server error.' }));
                throw new Error(errorBody.message || 'API call failed.');
            }
            return response.json();
        }
        
        function showMessage(element, text, type) {
            element.textContent = text;
            element.className = `message-box ${type}`;
            element.style.display = 'block';
        }
        
        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }
        
        function openTab(evt, tabName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-pane");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].className = tabcontent[i].className.replace(" active", "");
            }
            document.getElementById(tabName).className += " active";
            tablinks = document.getElementsByClassName("tab-button");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            evt.currentTarget.className += " active";
            
            // Trigger data load based on tab
            if (tabName === 'assets') {
                loadLocations().then(() => loadAssets());
            } else if (tabName === 'inventory') {
                loadVendors().then(() => loadItems());
            }
        }


        // =========================================================
        // A. ASSET MANAGEMENT LOGIC
        // =========================================================
        
        function getAssetIdByTag(tag) {
            return allAssets.find(a => a.tag_number === tag)?.id;
        }

        async function loadLocations() {
            try {
                allLocations = await handleApi(`${API_BASE_ASSET}/locations`);
                
                locationIdSelects.forEach(select => {
                    select.innerHTML = '<option value="">-- Select Location --</option>';
                    allLocations.forEach(loc => {
                        select.innerHTML += `<option value="${loc.id}">${loc.location_name}</option>`;
                    });
                });
            } catch (error) {
                console.error("Error loading locations:", error);
                locationIdSelects.forEach(select => select.innerHTML = '<option value="">-- Error Loading Locations --</option>');
            }
        }

        async function loadAssets() {
            assetsTbody.innerHTML = '<tr><td colspan="6">Loading asset data...</td></tr>';
            try {
                // Fetch assets and calculate depreciation/book value on the backend
                allAssets = await handleApi(`${API_BASE_ASSET}/all`);
                assetsTbody.innerHTML = '';
                
                allAssets.forEach(asset => {
                    const statusClass = `status-${asset.status.replace(/\s/g, '_')}`;
                    const purchaseCost = parseFloat(asset.purchase_cost).toFixed(2);
                    const bookValue = parseFloat(asset.current_book_value || purchaseCost).toFixed(2);
                    const depreciation = parseFloat(asset.accumulated_depreciation || 0).toFixed(2);

                    // Conditional rendering for the 'Del' button for Admin/Super Admin 
                    const deleteButton = (USER_ROLE === 'Admin' || USER_ROLE === 'Super Admin') ? 
                        `<button onclick="alert('TODO: Delete Asset ${asset.tag_number} is only for Super Admin/Admin')" style="background-color: #c62828;">Del</button>` : '';

                    assetsTbody.innerHTML += `
                        <tr>
                            <td><strong>${asset.tag_number}</strong><br><small>${asset.name}</small></td>
                            <td>
                                ‚Çπ${bookValue}
                                <div class="depreciation-info">P: ‚Çπ${purchaseCost} / Dep: ‚Çπ${depreciation}</div>
                            </td>
                            <td>${asset.location_name || 'Unassigned'}</td>
                            <td>${asset.assigned_user_name || 'Unassigned'}</td>
                            <td class="${statusClass}">${asset.status}</td>
                            <td class="action-btns">
                                <button onclick="openMaintenanceLogModal('${asset.id}', '${asset.tag_number}')" style="background-color: #ffc107;">Maint Log</button>
                                <button onclick="alert('TODO: Edit details for ${asset.tag_number}')" style="background-color: #005A9C;">Edit</button>
                                ${deleteButton}
                            </td>
                        </tr>
                    `;
                });

            } catch (error) {
                console.error("Error loading assets:", error);
                assetsTbody.innerHTML = `<tr><td colspan="6" class="error">Failed to load assets: ${error.message}</td></tr>`;
            }
        }

        window.openMaintenanceLogModal = async function(assetId, assetTag) {
            document.getElementById('maint-log-asset-tag').textContent = assetTag;
            const logTbody = document.getElementById('maint-log-tbody');
            logTbody.innerHTML = '<tr><td colspan="5">Loading history...</td></tr>';
            document.getElementById('maint-log-modal').style.display = 'block';
            
            try {
                const log = await handleApi(`${API_BASE_ASSET}/maintenance/log/${assetId}`);
                
                logTbody.innerHTML = log.map(m => `
                    <tr>
                        <td>${new Date(m.scheduled_date || m.created_at).toLocaleDateString()}</td>
                        <td>${m.maintenance_type}</td>
                        <td>‚Çπ${parseFloat(m.maintenance_cost).toFixed(2)}</td>
                        <td>${m.requester_name || 'Admin'}</td>
                        <td>${m.details.substring(0, 50)}...</td>
                    </tr>
                `).join('') || '<tr><td colspan="5">No maintenance history found.</td></tr>';

            } catch (error) {
                logTbody.innerHTML = `<tr><td colspan="5" class="error">Failed to load history: ${error.message}</td></tr>`;
            }
        }
        
        // --- Event Listeners (Asset) ---
        // Note: These listeners are now inside DOMContentLoaded and assigned directly below.

        // =========================================================
        // B. INVENTORY MANAGEMENT LOGIC
        // =========================================================

        async function loadStockPredictions() {
            try {
                stockPredictions = await handleApi(`${API_BASE_INV}/analytics/stock-prediction`);
            } catch (error) {
                console.warn("Could not load stock predictions:", error);
                stockPredictions = [];
            }
        }

        async function loadVendors() {
            const vendorsTbody = document.getElementById('vendors-tbody');
            vendorsTbody.innerHTML = '<tr><td colspan="3">Loading vendors...</td></tr>';

            try {
                allVendors = await handleApi(`${API_BASE_INV}/vendors`);
                
                // Populate ALL vendor dropdowns
                vendorIdSelects.forEach(select => {
                    select.innerHTML = '<option value="">-- Select Vendor (Optional) --</option>';
                    allVendors.forEach(v => {
                        select.innerHTML += `<option value="${v.id}">${v.name}</option>`;
                    });
                });
                
                // Populate the new Vendor List table
                vendorsTbody.innerHTML = allVendors.map(v => `
                    <tr>
                        <td><strong>${v.name}</strong></td>
                        <td>${v.contact_person} (${v.phone || v.email || 'N/A'})</td>
                        <td class="action-btns">
                            <button onclick="alert('TODO: Edit Vendor ${v.name}')" style="background-color: #ffc107;">Edit</button>
                            <button style="background-color: #c62828;">Del</button>
                        </td>
                    </tr>
                `).join('') || '<tr><td colspan="3">No vendors registered.</td></tr>';

            } catch (error) {
                console.error("Error loading vendors:", error);
                vendorsTbody.innerHTML = `<tr><td colspan="3" class="error">Failed to load vendors: ${error.message}</td></tr>`;
                vendorIdSelects.forEach(select => select.innerHTML = '<option value="">-- Error Loading Vendors --</option>');
            }
        }

        async function loadItems() {
            invItemsTbody.innerHTML = '<tr><td colspan="7">Loading inventory data...</td></tr>';
            moveItemIdSelect.innerHTML = '<option value="">-- Select Item --</option>';
            try {
                // Fetch core data and then prediction data sequentially
                await loadStockPredictions(); 
                allItems = await handleApi(`${API_BASE_INV}/items`);
                
                invItemsTbody.innerHTML = '';
                
                allItems.forEach(item => {
                    const statusClass = `status-${item.status.replace(/\s/g, '_')}`;
                    const prediction = stockPredictions.find(p => p.item_id === item.id);
                    
                    const predictionHtml = renderStockPrediction(item, prediction);
                    
                    // Conditional rendering for Admin/Super Admin on delete
                    const deleteButton = (USER_ROLE === 'Admin' || USER_ROLE === 'Super Admin') ? 
                        `<button onclick="deleteItem('${item.id}')" style="background-color: #c62828;">Del</button>` : 
                        `<button style="background-color: #ccc;" disabled>Del</button>`;
                    
                    invItemsTbody.innerHTML += `
                        <tr>
                            <td><strong>${item.name}</strong><br><small>Location: ${item.location_id || 'N/A'}</small></td>
                            <td>${item.current_stock}</td>
                            <td>${item.low_stock_threshold}</td>
                            <td class="${statusClass}">${item.status}</td>
                            <td>‚Çπ${parseFloat(item.unit_cost).toFixed(2)}</td>
                            <td>${predictionHtml}</td>
                            <td class="action-btns">
                                <button onclick="openEditItemModal('${item.id}')" class="inv-btn" style="background-color: #005A9C;">Edit</button>
                                <button onclick="openLogModal('${item.id}', '${item.name}')" class="inv-btn" style="background-color: #ffc107;">History</button>
                                ${deleteButton}
                            </td>
                        </tr>
                    `;
                    
                    moveItemIdSelect.innerHTML += `<option value="${item.id}">${item.name} (Stock: ${item.current_stock})</option>`;
                });

            } catch (error) {
                console.error("Error loading items:", error);
                invItemsTbody.innerHTML = `<tr><td colspan="7" class="error">Failed to load inventory: ${error.message}</td></tr>`;
            }
        }
        
        function renderStockPrediction(item, prediction) {
            if (!prediction || parseFloat(prediction.daily_usage) === 0) {
                return `<div class="prediction-box">No recent usage.</div>`;
            }

            const days = parseInt(prediction.days_to_threshold, 10);
            const suggestedQty = parseInt(prediction.suggested_po_qty, 10);
            const status = days <= 7 ? 'CRITICAL' : days <= 30 ? 'WARN' : 'OK';

            let message = '';
            if (item.current_stock <= item.low_stock_threshold && suggestedQty > 0) {
                 message = `<span class="prediction-status" style="color: #c0392b;">THRESHOLD HIT:</span> Order ${suggestedQty} units.`;
            } else if (days < 90) {
                 message = `Depletion in <span class="prediction-status">${days} days</span>.`;
            } else {
                 return `<div class="prediction-box">Stable usage.</div>`;
            }

            return `<div class="prediction-box">
                        ${message}
                        <div style="margin-top: 5px; font-size: 0.8em;">(Usage: ${parseFloat(prediction.daily_usage).toFixed(2)}/day)</div>
                    </div>`;
        }

        window.openEditItemModal = function(itemId) {
            const item = allItems.find(i => i.id === itemId);
            if (!item) { alert('Item data missing.'); return; }
            
            document.getElementById('edit-item-name-display').textContent = item.name;
            document.getElementById('edit-item-id').value = item.id;
            document.getElementById('edit-name').value = item.name;
            document.getElementById('edit-category').value = item.category;
            document.getElementById('edit-unit-cost').value = parseFloat(item.unit_cost).toFixed(2);
            document.getElementById('edit-threshold').value = item.low_stock_threshold;
            document.getElementById('edit-location').value = item.location_id || '';
            document.getElementById('edit-vendor-id-select').value = item.vendor_id || '';
            
            document.getElementById('edit-item-modal').style.display = 'block';
        };

        window.deleteItem = async function(itemId) {
            if (!confirm('WARNING: Deleting an item is permanent and removes all associated stock movement history. Continue?')) return;
            try {
                await handleApi(`${API_BASE_INV}/items/${itemId}`, { method: 'DELETE' });
                loadItems();
                alert('Item deleted successfully.');
            } catch (error) {
                alert(`Deletion failed: ${error.message}`);
            }
        }

        window.openLogModal = async function(itemId, itemName) {
            document.getElementById('log-item-name').textContent = itemName;
            const logTbody = document.getElementById('log-tbody');
            logTbody.innerHTML = '<tr><td colspan="6">Loading history...</td></tr>';
            document.getElementById('log-modal').style.display = 'block';
            
            try {
                const log = await handleApi(`${API_BASE_INV}/movement/${itemId}`);
                
                logTbody.innerHTML = log.map(m => `
                    <tr>
                        <td>${new Date(m.created_at).toLocaleDateString()}</td>
                        <td>${m.movement_type.replace('_', ' ')}</td>
                        <td>${m.quantity_changed > 0 ? '+' : ''}${m.quantity_changed}</td>
                        <td>${m.current_stock_after}</td>
                        <td>${m.recorded_by_id.slice(0, 8)}...</td>
                        <td>${m.notes || m.reference_id || 'N/A'}</td>
                    </tr>
                `).join('') || '<tr><td colspan="6">No movement records found.</td></tr>';

            } catch (error) {
                logTbody.innerHTML = `<tr><td colspan="6" class="error">Failed to load history: ${error.message}</td></tr>`;
            }
        }

        function updatePoTotal() {
            let total = 0;
            const itemInputs = poItemsContainer.querySelectorAll('.po-item-row');
            
            itemInputs.forEach(row => {
                const quantity = parseFloat(row.querySelector('.po-quantity').value) || 0;
                const price = parseFloat(row.querySelector('.po-price').value) || 0;
                total += quantity * price;
            });

            poTotalCostEl.textContent = total.toFixed(2);
            poTotalCostInput.value = total.toFixed(2);
        }

        function addPoItemInput(itemId = '', quantity = 1, price = 0) {
            
            const itemRow = document.createElement('div');
            itemRow.className = 'po-item-row';
            itemRow.innerHTML = `
                <select class="po-item-id" style="width: 35%;" required>
                    <option value="">-- Select Item --</option>
                    ${allItems.map(i => `<option value="${i.id}" data-cost="${i.unit_cost}">${i.name} (Stock: ${i.current_stock})</option>`).join('')}
                </select>
                <input type="number" class="po-quantity" placeholder="Qty" value="${quantity}" min="1" style="width: 15%; margin-left: 5px;" required>
                <input type="number" class="po-price" step="0.01" placeholder="Price/Unit" value="${price.toFixed(2)}" style="width: 20%; margin-left: 5px;" required>
                <button type="button" onclick="this.parentNode.remove(); updatePoTotal();" style="background-color: #e74c3c; padding: 5px 10px; margin: 0 0 0 10px; width: 25%;">Remove</button>
            `;
            
            const inputs = itemRow.querySelectorAll('.po-quantity, .po-price, .po-item-id');
            inputs.forEach(input => {
                input.addEventListener('change', (e) => {
                    if (e.target.classList.contains('po-item-id')) {
                        const selectedOption = e.target.options[e.target.selectedIndex];
                        const unitCost = selectedOption.dataset.cost;
                        const priceInput = itemRow.querySelector('.po-price');
                        if (unitCost) {
                            priceInput.value = parseFloat(unitCost).toFixed(2);
                        }
                    }
                    updatePoTotal();
                });
            });

            poItemsContainer.appendChild(itemRow);
            updatePoTotal();
        }
        
        // --- PO History and Export Functions ---
        async function loadPoHistory() {
            const tbody = document.getElementById('po-history-tbody');
            tbody.innerHTML = '<tr><td colspan="6">Fetching PO records...</td></tr>';
            
            try {
                poHistoryRecords = await handleApi(`${API_BASE_INV}/purchase-order/history`);
                
                if (poHistoryRecords.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6">No purchase orders found.</td></tr>';
                    return;
                }

                tbody.innerHTML = poHistoryRecords.map(po => `
                    <tr>
                        <td>${po.id.slice(0, 8)}...</td>
                        <td>${po.vendor_name}</td>
                        <td>‚Çπ${parseFloat(po.total_cost).toFixed(2)}</td>
                        <td><span class="status-badge status-${po.status.replace(/\s/g, '_')}">${po.status}</span></td>
                        <td>${new Date(po.created_at).toLocaleDateString()}</td>
                        <td>
                            <button onclick="generatePoPdf('${po.id}')" class="inv-btn" style="padding: 3px 6px;">Print/PDF</button>
                        </td>
                    </tr>
                `).join('');

            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="6" class="error">Failed to load PO history: ${error.message}</td></tr>`;
            }
        }
        
        // --- Client-side CSV Export ---
        function exportPoHistoryToCsv() {
            if (poHistoryRecords.length === 0) {
                alert('Please load history data before exporting.');
                return;
            }
            
            // Define headers
            const headers = [
                'ID', 'Vendor Name', 'Total Cost', 'Status', 'Delivery Date', 'Created By', 'Created At'
            ];
            
            // Prepare CSV rows
            const rows = poHistoryRecords.map(record => [
                `"${record.id}"`, // Quote ID for safety
                `"${record.vendor_name}"`,
                record.total_cost,
                record.status,
                record.expected_delivery_date ? new Date(record.expected_delivery_date).toLocaleDateString() : 'N/A',
                record.created_by_name,
                new Date(record.created_at).toLocaleDateString()
            ].join(','));
            
            // Construct CSV content
            let csvContent = headers.join(',') + '\n' + rows.join('\n');

            // Create Blob and trigger download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', 'Purchase_Order_History.csv');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
// --- Client-side PDF Generation ---
async function generatePoPdf(poId) {
    const poData = poHistoryRecords.find(p => p.id === poId);
    if (!poData) { alert('PO data not found for printing.'); return; }
    
    // 1. Build the HTML content
    poPrintContent.innerHTML = buildPoHtml(poData);
    
    // 2. CRITICAL FIX: 10ms delay to ensure the DOM is fully rendered before capturing
    await new Promise(resolve => setTimeout(resolve, 10)); 

    // 3. Configure and generate PDF
    const options = {
        margin: 0.5,
        filename: `PO_${poData.id.slice(0, 8)}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { 
            scale: 2,
            logging: false
        },
        jsPDF: { unit: 'in', format: 'A4', orientation: 'portrait' }
    };

    try {
        await html2pdf().set(options).from(document.getElementById('po-print-view')).save();
    } catch (error) {
        alert('Failed to generate PDF. Check console for details. Error: ' + error.message);
        console.error("PDF Generation Error Details:", error);
    }
}

function buildPoHtml(poData) {
    // FIX: Ensure item display is robust for PDF rendering
    const items = poData.ordered_items_json || [];
    const itemsRows = items.map((item, index) => {
        // Fallback to item ID slice if item_name is not present in the PO record JSON
        const itemName = item.item_name || (item.item_id ? item.item_id.slice(0, 8) + '...' : 'N/A');
        
        return `
            <tr>
                <td style="padding: 10px; border: 1px solid #CCC;">${index + 1}</td>
                <td style="padding: 10px; border: 1px solid #CCC;">${itemName}</td>
                <td style="padding: 10px; border: 1px solid #CCC;">${item.quantity}</td>
                <td style="padding: 10px; border: 1px solid #CCC;">‚Çπ${parseFloat(item.price).toFixed(2)}</td>
                <td style="padding: 10px; border: 1px solid #CCC;">‚Çπ${(item.quantity * item.price).toFixed(2)}</td>
            </tr>
        `;
    }).join('');

    return `
        <div style="width: 100%; padding: 30px; box-sizing: border-box; font-family: 'Times New Roman', serif; color: #333;">
            <h1 style="font-size: 2.2em; color: #C0392B; font-weight: bold; text-transform: uppercase; text-align: center; border-bottom: 5px double #000; padding-bottom: 15px; margin-bottom: 30px;">PURCHASE ORDER</h1>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                <div>
                    <strong>PO Number:</strong> ${poData.id.slice(0, 8).toUpperCase()}<br>
                    <strong>Date:</strong> ${new Date(poData.created_at).toLocaleDateString()}
                </div>
                <div style="text-align: right;">
                    <strong>Status:</strong> ${poData.status}<br>
                    <strong>Expected Delivery:</strong> ${poData.expected_delivery_date || 'N/A'}
                </div>
            </div>

            <div style="margin-bottom: 20px; border: 1px solid #333; padding: 15px; background-color: #F0F0F0;">
                <h3 style="color: #005A9C; margin-top: 0; border-bottom: 2px solid #999; padding-bottom: 5px;">Vendor & Creator</h3>
                <strong>Vendor:</strong> ${poData.vendor_name}<br>
                <strong>Created By:</strong> ${poData.created_by_name}
            </div>

            <table style="width: 100%; border-collapse: collapse; margin-top: 15px; border: 1px solid #333;">
                <thead>
                    <tr style="background-color: #333; color: white;">
                        <th style="width: 5%; padding: 10px; border: 1px solid #333;">#</th>
                        <th style="width: 35%; padding: 10px; border: 1px solid #333;">Item ID / Name</th>
                        <th style="width: 15%; padding: 10px; border: 1px solid #333;">Quantity</th>
                        <th style="width: 20%; padding: 10px; border: 1px solid #333;">Unit Price</th>
                        <th style="width: 25%; padding: 10px; border: 1px solid #333;">Total</th>
                    </tr>
                </thead>
                <tbody>
                    ${itemsRows}
                    <tr>
                        <td colspan="4" style="text-align: right; font-weight: bold; padding: 10px; border: 1px solid #333; background-color: #E8E8E8;">GRAND TOTAL</td>
                        <td style="padding: 10px; border: 1px solid #333;">‚Çπ${parseFloat(poData.total_cost).toFixed(2)}</td>
                    </tr>
                </tbody>
            </table>
            
            <p style="margin-top: 50px; font-size: 0.9em; text-align: center;">--- End of Purchase Order ---</p>
        </div>
    `;
}

        // --- Initialization & Event Listeners (FIXED: All event listeners are now safely inside DOMContentLoaded) ---
        document.addEventListener('DOMContentLoaded', () => {
            userRoleDisplay.textContent = USER_ROLE;
            
            // Set default tab state
            document.getElementById('inventory').className += " active";
            
            // Add listener for the new PO History button
            const loadPoHistoryBtn = document.getElementById('load-po-history-btn');
            if (loadPoHistoryBtn) {
                loadPoHistoryBtn.addEventListener('click', loadPoHistory);
            }
            
            // Add listener for CSV Export button
            const exportPoCsvBtn = document.getElementById('export-po-csv-btn');
            if (exportPoCsvBtn) {
                exportPoCsvBtn.addEventListener('click', exportPoHistoryToCsv);
            }
            
            // =========================================================
            // A. ASSET MANAGEMENT - EVENT LISTENERS
            // =========================================================
            document.getElementById('register-asset-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const data = Object.fromEntries(new FormData(form));
                showMessage(document.getElementById('register-message'), 'Registering asset...', 'info');

                try {
                    const result = await handleApi(`${API_BASE_ASSET}/register`, { method: 'POST', body: JSON.stringify(data) });
                    showMessage(document.getElementById('register-message'), `‚úÖ ${result.message}`, 'success');
                    form.reset();
                    loadAssets();
                } catch (error) {
                    showMessage(document.getElementById('register-message'), `‚ùå Failed: ${error.message}`, 'error');
                }
            });
            
            document.getElementById('assign-asset-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const submitBtn = form.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                
                const assetTag = form.elements.asset_tag.value.trim();
                const assetId = getAssetIdByTag(assetTag);
                
                if (!assetId) {
                    showMessage(document.getElementById('assign-message'), `‚ùå Asset Tag ${assetTag} not found.`, 'error');
                    submitBtn.disabled = false;
                    return;
                }

                const data = {
                    asset_id: assetId,
                    user_id: form.elements.user_id.value,
                    assigned_location_id: form.elements.assigned_location_id.value,
                    notes: form.elements.notes.value,
                };
                
                showMessage(document.getElementById('assign-message'), 'Deploying asset...', 'info');

                try {
                    const result = await handleApi(`${API_BASE_ASSET}/assign`, { method: 'POST', body: JSON.stringify(data) });
                    showMessage(document.getElementById('assign-message'), `‚úÖ ${result.message}`, 'success');
                    form.reset();
                    loadAssets();
                } catch (error) {
                    showMessage(document.getElementById('assign-message'), `‚ùå Failed: ${error.message}`, 'error');
                } finally {
                    submitBtn.disabled = false;
                }
            });

            document.getElementById('maintenance-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const submitBtn = form.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                
                const assetTag = form.elements['maint-asset-tag'].value.trim();
                const assetId = getAssetIdByTag(assetTag);
                
                if (!assetId) {
                    showMessage(document.getElementById('maint-message'), `‚ùå Asset Tag ${assetTag} not found.`, 'error');
                    submitBtn.disabled = false;
                    return;
                }

                const data = {
                    asset_id: assetId,
                    type: form.elements.type.value,
                    details: form.elements.details.value,
                    maintenance_cost: form.elements.maintenance_cost.value || 0,
                    scheduled_date: form.elements.scheduled_date.value,
                };
                
                showMessage(document.getElementById('maint-message'), 'Logging maintenance...', 'info');

                try {
                    const result = await handleApi(`${API_BASE_ASSET}/maintenance`, { method: 'POST', body: JSON.stringify(data) });
                    showMessage(document.getElementById('maint-message'), `‚úÖ ${result.message}`, 'success');
                    form.reset();
                    loadAssets();
                } catch (error) {
                    showMessage(document.getElementById('maint-message'), `‚ùå Failed: ${error.message}`, 'error');
                } finally {
                    submitBtn.disabled = false;
                }
            });

            // =========================================================
            // B. INVENTORY MANAGEMENT - EVENT LISTENERS
            // =========================================================
            document.getElementById('add-item-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const data = Object.fromEntries(new FormData(form));
                showMessage(document.getElementById('item-message'), 'Adding item...', 'info');

                try {
                    const result = await handleApi(`${API_BASE_INV}/items`, { method: 'POST', body: JSON.stringify(data) });
                    showMessage(document.getElementById('item-message'), `‚úÖ ${result.message}`, 'success');
                    form.reset();
                    loadItems();
                } catch (error) {
                    showMessage(document.getElementById('item-message'), `‚ùå Failed: ${error.message}`, 'error');
                }
            });
            
            // NEW VENDOR FORM LISTENER
            document.getElementById('add-vendor-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const submitBtn = form.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                
                const data = Object.fromEntries(new FormData(form));
                showMessage(document.getElementById('vendor-message'), 'Registering vendor...', 'info');

                try {
                    const result = await handleApi(`${API_BASE_INV}/vendors`, { 
                        method: 'POST', 
                        body: JSON.stringify(data) 
                    });
                    showMessage(document.getElementById('vendor-message'), `‚úÖ ${result.message}`, 'success');
                    form.reset();
                    loadVendors().then(() => loadItems()); // Refresh vendors and items (for item dropdown update)
                } catch (error) {
                    showMessage(document.getElementById('vendor-message'), `‚ùå Failed: ${error.message}`, 'error');
                } finally {
                    submitBtn.disabled = false;
                }
            });


            document.getElementById('edit-item-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const itemId = form.elements.id.value;
                const data = Object.fromEntries(new FormData(form));
                delete data.id; 

                try {
                    await handleApi(`${API_BASE_INV}/items/${itemId}`, { method: 'PUT', body: JSON.stringify(data) });
                    closeModal('edit-item-modal');
                    loadItems();
                    alert('Item updated successfully!');
                } catch (error) {
                    alert(`Update failed: ${error.message}`);
                }
            });
            
            document.getElementById('movement-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const data = Object.fromEntries(new FormData(form));
                data.quantity = parseInt(data.quantity, 10);
                
                showMessage(document.getElementById('movement-message'), 'Recording movement...', 'info');

                try {
                    const result = await handleApi(`${API_BASE_INV}/move`, { method: 'POST', body: JSON.stringify(data) });
                    showMessage(document.getElementById('movement-message'), `‚úÖ ${result.message}`, 'success');
                    form.reset();
                    loadItems(); 
                } catch (error) {
                    showMessage(document.getElementById('movement-message'), `‚ùå Failed: ${error.message}`, 'error');
                }
            });
            
            document.getElementById('add-po-item-btn').addEventListener('click', () => addPoItemInput());

            document.getElementById('purchase-order-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const submitBtn = form.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                
                const itemsOrdered = [];
                let isValid = true;
                
                form.querySelectorAll('.po-item-row').forEach(row => {
                    const item_id = row.querySelector('.po-item-id').value;
                    const quantity = parseFloat(row.querySelector('.po-quantity').value);
                    const price = parseFloat(row.querySelector('.po-price').value);
                    
                    if (item_id && quantity > 0 && price >= 0) {
                        itemsOrdered.push({ item_id, quantity, price });
                    } else if (item_id) {
                         isValid = false;
                    }
                });
                
                if (!isValid) {
                    showMessage(document.getElementById('po-message'), '‚ùå Please check quantities and prices for all selected items.', 'error');
                    submitBtn.disabled = false;
                    return;
                }
                if (itemsOrdered.length === 0) {
                    showMessage(document.getElementById('po-message'), '‚ùå Please add at least one item to the order.', 'error');
                    submitBtn.disabled = false;
                    return;
                }

                const data = {
                    vendor_id: form.elements.vendor_id.value,
                    items_ordered: itemsOrdered,
                    expected_delivery_date: form.elements.expected_delivery_date.value,
                    total_cost: poTotalCostInput.value
                };
                
                showMessage(document.getElementById('po-message'), 'Creating Purchase Order...', 'info');

                try {
                    const result = await handleApi(`${API_BASE_INV}/purchase-order`, { method: 'POST', body: JSON.stringify(data) });
                    showMessage(document.getElementById('po-message'), `‚úÖ PO submitted! ID: ${result.po_id}`, 'success');
                    form.reset();
                    poItemsContainer.innerHTML = '';
                    updatePoTotal();
                    loadPoHistory(); // Refresh history table immediately
                } catch (error) {
                    showMessage(document.getElementById('po-message'), `‚ùå Failed: ${error.message}`, 'error');
                } finally {
                    submitBtn.disabled = false;
                }
            });


            // --- Initial Data Loading ---
            
            // Asset data loads
            loadLocations().then(() => loadAssets());
            
            // Inventory data loads
            loadVendors().then(() => loadItems());
            
            // Open the default tab
            document.querySelector('.tab-button').click();
        });
    </script>
</body>
</html>