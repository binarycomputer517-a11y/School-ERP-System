<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Issued Books</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { background-color: #f8f9fa; font-family: Arial, sans-serif; }
        .container { max-width: 900px; margin-top: 50px; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1 { color: #003366; border-bottom: 2px solid #003366; padding-bottom: 10px; margin-bottom: 30px; }
        .table thead th { background-color: #003366; color: white; }
        
        /* Status Indicators */
        .status-overdue { color: white; background-color: #dc3545; padding: 4px 8px; border-radius: 4px; font-weight: bold; }
        .status-pending { color: #856404; background-color: #fff3cd; padding: 4px 8px; border-radius: 4px; font-weight: bold; }
        .status-ok { color: #155724; background-color: #d4edda; padding: 4px 8px; border-radius: 4px; font-weight: bold; }
        
        .action-cell button { font-size: 0.9em; padding: 5px 10px; }
    </style>
</head>
<body>
    <div class="container">
        <a href="/student-dashboard.html" class="btn btn-sm btn-outline-secondary mb-3"><i class="fas fa-arrow-left"></i> Back to Dashboard</a>
        
        <h1>Books Issued to Me</h1>
        
        <p id="loading-status" class="text-info text-center">Loading issued book records...</p>
        
        <div class="table-responsive">
            <table class="table table-bordered table-hover align-middle">
                <thead>
                    <tr>
                        <th>Title & Author</th>
                        <th>Accession No.</th>
                        <th>Issued On</th>
                        <th>Due Date</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="issued-books-body">
                </tbody>
            </table>
        </div>

        <div id="summary-info" class="alert alert-warning mt-4 d-none">
            <i class="fas fa-exclamation-triangle"></i> You have <span id="overdue-count">0</span> books overdue. Please return them immediately to avoid fines.
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const token = localStorage.getItem('erp-token');
        const body = document.getElementById('issued-books-body');
        const loadingStatus = document.getElementById('loading-status');
        const summaryInfo = document.getElementById('summary-info');
        
        if (!token) {
            window.location.href = '/login.html';
        }

        const API_BASE_URL = '/api/library';

        async function fetchIssuedBooks() {
            loadingStatus.textContent = 'Fetching issued book data...';
            body.innerHTML = '';
            summaryInfo.classList.add('d-none');
            
            try {
                // Use the dedicated route defined in routes/library.js
                const response = await fetch(`${API_BASE_URL}/student/issued`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.status === 403 || response.status === 401) {
                    throw new Error('Authorization failed. Please log in again.');
                }
                
                if (!response.ok) {
                    const err = await response.json().catch(() => ({ message: 'Server error fetching data.' }));
                    throw new Error(err.message || `HTTP error! Status: ${response.status}`);
                }

                const records = await response.json();
                
                loadingStatus.classList.add('d-none');
                let overdueCount = 0;

                if (records.length === 0) {
                    body.innerHTML = '<tr><td colspan="6" class="text-center text-secondary">No books are currently issued to you.</td></tr>';
                    return;
                }

                records.forEach(record => {
                    const isOverdue = record.is_overdue; // Boolean from backend query
                    
                    const statusClass = isOverdue ? 'status-overdue' : 'status-ok';
                    const statusText = isOverdue ? 'OVERDUE' : 'Issued (On Time)';
                    
                    if (isOverdue) overdueCount++;

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><strong>${record.title}</strong><br><small>by ${record.author}</small></td>
                        <td>${record.accession_number}</td>
                        <td>${new Date(record.issue_date).toLocaleDateString()}</td>
                        <td>${new Date(record.due_date).toLocaleDateString()}</td>
                        <td><span class="${statusClass}">${statusText}</span></td>
                        <td class="action-cell">
                            <button class="btn btn-sm btn-outline-info" onclick="requestRenewal('${record.circulation_id}')">Request Renewal</button>
                        </td>
                    `;
                    body.appendChild(row);
                });
                
                // Update summary info
                if (overdueCount > 0) {
                    document.getElementById('overdue-count').textContent = overdueCount;
                    summaryInfo.classList.remove('d-none');
                }

            } catch (error) {
                console.error("Issued Book Fetch Error:", error);
                loadingStatus.classList.remove('d-none');
                loadingStatus.className = 'text-danger text-center';
                loadingStatus.textContent = `Error: ${error.message}. Please try logging in again.`;
            }
        }

        function requestRenewal(circulationId) {
            if (confirm("Are you sure you want to request a renewal for this book?")) {
                // Placeholder: Implement renewal POST request to /api/library/renew/:circulationId
                alert(`Renewal request sent for Circulation ID: ${circulationId}`);
                // Re-fetch data after successful request
                // fetchIssuedBooks(); 
            }
        }

        document.addEventListener('DOMContentLoaded', fetchIssuedBooks);
    </script>
    <script src="js/global-config.js"></script>
</body>
</html>